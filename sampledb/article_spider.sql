-- phpMyAdmin SQL Dump
-- version 4.6.5.2
-- https://www.phpmyadmin.net/
--
-- Host: localhost
-- Generation Time: 2017-07-08 02:54:02
-- 服务器版本： 10.1.21-MariaDB
-- PHP Version: 5.6.30

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `article_spider`
--

-- --------------------------------------------------------

--
-- 表的结构 `article`
--

CREATE TABLE `article` (
  `title` varchar(200) NOT NULL,
  `create_date` date NOT NULL,
  `url` varchar(300) NOT NULL,
  `url_object_id` varchar(50) NOT NULL,
  `fav_nums` int(11) NOT NULL,
  `praise_nums` int(11) NOT NULL,
  `tag_list` varchar(200) DEFAULT NULL,
  `content` longtext,
  `front_image_url` varchar(300) NOT NULL,
  `front_image_path` varchar(300) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT;

--
-- 转存表中的数据 `article`
--

INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('数据结构中各种树', '2017-07-07', 'http://blog.jobbole.com/111680/', '02798e0da54694b76c5f84ea9e994105', 3, 1, 'IT技术, , 数据结构, 树', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/maybe2030/p/4732377.html\">Poll的笔记</a>   </div><p>数据结构中有很多树的结构，其中包括二叉树、二叉搜索树、2-3树、红黑树等等。本文中对数据结构中常见的几种树的概念和用途进行了汇总，不求严格精准，但求简单易懂。</p>\n<h1 class=\"First\"><strong>1. 二叉树</strong></h1>\n<p>二叉树是数据结构中一种重要的数据结构，也是树表家族最为基础的结构。</p>\n<p><strong>二叉树的定义：</strong>二叉树的每个结点至多只有二棵子树(不存在度大于2的结点)，二叉树的子树有左右之分，次序不能颠倒。二叉树的第i层至多有2<sup>i-1</sup>个结点；深度为k的二叉树至多有2<sup>k-1</sup>个结点；对任何一棵二叉树T，如果其终端结点数为n<sub>0</sub>，度为2的结点数为n<sub>2</sub>，则n<sub>0</sub>=n<sub>2</sub>+1。</p>\n<p><strong>二叉树的示例</strong>：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg\"><img class=\"aligncenter wp-image-111682 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg\" alt=\"2009050402\" width=\"390\" height=\"312\"></a></p>\n<p><strong>满二叉树和完全二叉树：</strong></p>\n<p>满二叉树：除最后一层无任何子节点外，每一层上的所有结点都有两个子结点。也可以这样理解，除叶子结点外的所有结点均有两个子结点。节点数达到最大值，所有叶子结点必须在同一层上。</p>\n<p>满二叉树的性质：</p>\n<p>1) 一颗树深度为h，最大层数为k，深度与最大层数相同，k=h;</p>\n<p>2) 叶子数为2<sup>h</sup>;</p>\n<p>3) 第k层的结点数是：2<sup>k-1</sup>;</p>\n<p>4) 总结点数是：2<sup>k-1</sup>，且总节点数一定是奇数。</p>\n<p>完全二叉树：若设二叉树的深度为h，除第 h 层外，其它各层 (1～(h-1)层) 的结点数都达到最大个数，第h层所有的结点都连续集中在最左边，这就是完全二叉树。</p>\n<p><strong>注：</strong>完全二叉树是效率很高的数据结构，堆是一种完全二叉树或者近似完全二叉树，所以效率极高，像十分常用的排序算法、Dijkstra算法、Prim算法等都要用堆才能优化，二叉排序树的效率也要借助平衡性来提高，而平衡性基于完全二叉树。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/a5952ec741b60202c7b377bfb8e8f368.png\"><img class=\"aligncenter wp-image-111683 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a5952ec741b60202c7b377bfb8e8f368.png\" alt=\"141749056837546\" width=\"534\" height=\"180\"></a></p>\n<p><strong>二叉树的性质</strong>：</p>\n<p>1) 在非空二叉树中，第i层的结点总数不超过2<sup>i-1</sup>, i&gt;=1;</p>\n<p>2) 深度为h的二叉树最多有2<sup>h</sup>-1个结点(h&gt;=1)，最少有h个结点;</p>\n<p>3) 对于任意一棵二叉树，如果其叶结点数为N<sub>0</sub>，而度数为2的结点总数为N<sub>2</sub>，则N<sub>0</sub>=N<sub>2</sub>+1;</p>\n<p>4) 具有n个结点的完全二叉树的深度为log<sub>2</sub>(n+1);</p>\n<p>5)有N个结点的完全二叉树各结点如果用顺序方式存储，则结点之间有如下关系：</p>\n<p>若I为结点编号则 如果I&gt;1，则其父结点的编号为I/2；</p>\n<p>如果2I&lt;=N，则其左儿子（即左子树的根结点）的编号为2I；若2I&gt;N，则无左儿子；</p>\n<p>如果2I+1&lt;=N，则其右儿子的结点编号为2I+1；若2I+1&gt;N，则无右儿子。</p>\n<p>6)给定N个节点，能构成h(N)种不同的二叉树，其中h(N)为卡特兰数的第N项，h(n)=C(2*n, n)/(n+1)。</p>\n<p>7)设有i个枝点，I为所有枝点的道路长度总和，J为叶的道路长度总和J=I+2<sup>i</sup>。</p>\n<h1 class=\"First\">2. 二叉查找树</h1>\n<p><strong>二叉查找树定义</strong>：又称为是二叉排序树（Binary Sort Tree）或二叉搜索树。二叉排序树或者是一棵空树，或者是具有下列性质的二叉树：</p>\n<p>1) 若左子树不空，则左子树上所有结点的值均小于它的根结点的值；</p>\n<p>2) 若右子树不空，则右子树上所有结点的值均大于或等于它的根结点的值；</p>\n<p>3) 左、右子树也分别为二叉排序树；</p>\n<p>4) 没有键值相等的节点。</p>\n<p><strong>二叉查找树的性质：</strong><strong>对二叉查找树进行中序遍历，即可得到有序的数列。</strong></p>\n<p><strong>二叉查找树的时间复杂度：<strong>它和二分查找一样，插入和查找的时间复杂度均为O(logn)，<span style=\"color: #ff0000\">但是在最坏的情况下仍然会有O(n)的时间复杂度。</span>原因在于插入和删除元素的时候，树没有保持平衡（比如，我们查找上图（b）中的“93”，我们需要进行n次查找操作）。我们追求的是在最坏的情况下仍然有较好的时间复杂度，这就是平衡查找树设计的初衷。</strong></strong></p>\n<p><span style=\"color: #ff0000\"><strong><strong>二叉查找树的高度决定了二叉查找树的查找效率。</strong></strong></span></p>\n<p><strong>二叉查找树的插入过程如下：</strong></p>\n<p>1) 若当前的二叉查找树为空，则插入的元素为根节点;</p>\n<p>2) 若插入的元素值小于根节点值，则将元素插入到左子树中;</p>\n<p>3) 若插入的元素值不小于根节点值，则将元素插入到右子树中。</p>\n<p><strong>二叉查找树的删除，分三种情况进行处理：</strong></p>\n<p>1) p为叶子节点，直接删除该节点，再修改其父节点的指针（注意分是根节点和不是根节点），如图a;</p>\n<p>2) p为单支节点（即只有左子树或右子树）。让p的子树与p的父亲节点相连，删除p即可（注意分是根节点和不是根节点），如图b;</p>\n<p>3) p的左子树和右子树均不空。找到p的后继y，因为y一定没有左子树，所以可以删除y，并让y的父亲节点成为y的右子树的父亲节点，并用y的值代替p的值；或者方法二是找到p的前驱x，x一定没有右子树，所以可以删除x，并让x的父亲节点成为y的左子树的父亲节点。如图c。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2361a6d889a036b92d6fa44c8984d27e.png\"><img class=\"aligncenter wp-image-111684 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2361a6d889a036b92d6fa44c8984d27e.png\" alt=\"2012032717571645\" width=\"572\" height=\"205\"></a></p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/05b0ae29caf51cf3aeb26e30ee6996ec.png\"><img class=\"aligncenter wp-image-111685 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/05b0ae29caf51cf3aeb26e30ee6996ec.png\" alt=\"2012032717583358\" width=\"611\" height=\"210\"></a><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2c51f44d9bfb87f38f9bf040552b6b31.png\"><img class=\"aligncenter wp-image-111686 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2c51f44d9bfb87f38f9bf040552b6b31.png\" alt=\"2012032717584562\" width=\"553\" height=\"148\"></a></p>\n<p>二叉树相关实现源码：</p>\n<p>插入操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6bac4739086448469\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstruct node\r\n{\r\n    int val;\r\n    pnode lchild;\r\n    pnode rchild;\r\n};\r\n\r\npnode BT = NULL;\r\n\r\n\r\n//递归方法插入节点 \r\npnode insert(pnode root, int x)\r\n{\r\n    pnode p = (pnode)malloc(LEN);\r\n    p-&gt;val = x;\r\n    p-&gt;lchild = NULL;\r\n    p-&gt;rchild = NULL;\r\n    if(root == NULL){\r\n        root = p;    \r\n    }    \r\n    else if(x &lt; root-&gt;val){\r\n        root-&gt;lchild = insert(root-&gt;lchild, x);    \r\n    }\r\n    else{\r\n        root-&gt;rchild = insert(root-&gt;rchild, x);    \r\n    }\r\n    return root;\r\n}\r\n\r\n//非递归方法插入节点 \r\nvoid insert_BST(pnode q, int x)\r\n{\r\n    pnode p = (pnode)malloc(LEN);\r\n    p-&gt;val = x;\r\n    p-&gt;lchild = NULL;\r\n    p-&gt;rchild = NULL;\r\n    if(q == NULL){\r\n        BT = p;\r\n        return ;    \r\n    }        \r\n    while(q-&gt;lchild != p &amp;&amp; q-&gt;rchild != p){\r\n        if(x &lt; q-&gt;val){\r\n            if(q-&gt;lchild){\r\n                q = q-&gt;lchild;    \r\n            }    \r\n            else{\r\n                q-&gt;lchild = p;\r\n            }        \r\n        }    \r\n        else{\r\n            if(q-&gt;rchild){\r\n                q = q-&gt;rchild;    \r\n            }    \r\n            else{\r\n                q-&gt;rchild = p;    \r\n            }\r\n        }\r\n    }\r\n    return;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4739086448469-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4739086448469-60\">60</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-1\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">node</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-6\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-8\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-10\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-11\"><span class=\"crayon-c\">//递归方法插入节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-12\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">pnode </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-13\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pnode</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">malloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LEN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-28\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-30\"><span class=\"crayon-c\">//非递归方法插入节点 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-31\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-32\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">pnode</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">malloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LEN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-36\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-43\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-44\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-46\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-47\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-51\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-56\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4739086448469-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4739086448469-60\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0072 seconds] -->\r\n<p>删除操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6bac4745510298116\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbool delete_BST(pnode p, int x) //返回一个标志，表示是否找到被删元素 \r\n{\r\n    bool find = false;\r\n    pnode q;\r\n    p = BT;\r\n    while(p &amp;&amp; !find){  //寻找被删元素 \r\n        if(x == p-&gt;val){  //找到被删元素 \r\n            find = true;    \r\n        }    \r\n        else if(x &lt; p-&gt;val){ //沿左子树找 \r\n            q = p;\r\n            p = p-&gt;lchild;    \r\n        }\r\n        else{   //沿右子树找 \r\n            q = p;\r\n            p = p-&gt;rchild;    \r\n        }\r\n    }\r\n    if(p == NULL){   //没找到 \r\n        cout &lt;&lt; \"没有找到\" &lt;&lt; x &lt;&lt; endl;    \r\n    }\r\n    \r\n    if(p-&gt;lchild == NULL &amp;&amp; p-&gt;rchild == NULL){  //p为叶子节点 \r\n        if(p == BT){  //p为根节点 \r\n            BT = NULL;    \r\n        }\r\n        else if(q-&gt;lchild == p){   \r\n            q-&gt;lchild = NULL;\r\n        }        \r\n        else{\r\n            q-&gt;rchild = NULL;    \r\n        }\r\n        free(p);  //释放节点p \r\n    }\r\n    else if(p-&gt;lchild == NULL || p-&gt;rchild == NULL){ //p为单支子树 \r\n        if(p == BT){  //p为根节点 \r\n            if(p-&gt;lchild == NULL){\r\n                BT = p-&gt;rchild;    \r\n            }    \r\n            else{\r\n                BT = p-&gt;lchild;    \r\n            }\r\n        }    \r\n        else{\r\n            if(q-&gt;lchild == p &amp;&amp; p-&gt;lchild){ //p是q的左子树且p有左子树 \r\n                q-&gt;lchild = p-&gt;lchild;    //将p的左子树链接到q的左指针上 \r\n            }    \r\n            else if(q-&gt;lchild == p &amp;&amp; p-&gt;rchild){\r\n                q-&gt;lchild = p-&gt;rchild;    \r\n            }\r\n            else if(q-&gt;rchild == p &amp;&amp; p-&gt;lchild){\r\n                q-&gt;rchild = p-&gt;lchild;    \r\n            }\r\n            else{\r\n                q-&gt;rchild = p-&gt;rchild;\r\n            }\r\n        }\r\n        free(p);\r\n    }\r\n    else{ //p的左右子树均不为空 \r\n        pnode t = p;\r\n        pnode s = p-&gt;lchild;  //从p的左子节点开始 \r\n        while(s-&gt;rchild){  //找到p的前驱，即p左子树中值最大的节点 \r\n            t = s;   \r\n            s = s-&gt;rchild;    \r\n        }\r\n        p-&gt;val = s-&gt;val;   //把节点s的值赋给p \r\n        if(t == p){\r\n            p-&gt;lchild = s-&gt;lchild;    \r\n        }    \r\n        else{\r\n            t-&gt;rchild = s-&gt;lchild;    \r\n        }\r\n        free(s); \r\n    }\r\n    return find;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4745510298116-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4745510298116-77\">77</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-1\"><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//返回一个标志，表示是否找到被删元素 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">find</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">find</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//寻找被删元素 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//找到被删元素 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">find</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//沿左子树找 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//沿右子树找 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//没找到 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"没有找到\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-22\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为叶子节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为根节点 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-28\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-31\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//释放节点p </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p为单支子树 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//p为根节点 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-38\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-39\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">BT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p是q的左子树且p有左子树 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-46\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//将p的左子树链接到q的左指针上 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-49\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-50\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-51\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-55\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">q</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-56\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-58\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-60\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//p的左右子树均不为空 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-62\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//从p的左子节点开始 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span><span class=\"crayon-c\">//找到p的前驱，即p左子树中值最大的节点 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-64\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-65\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-66\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-67\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">   </span><span class=\"crayon-c\">//把节点s的值赋给p </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-69\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-70\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-71\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-72\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">t</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-74\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-75\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4745510298116-76\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">find</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4745510298116-77\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0176 seconds] -->\r\n<p>查找操作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6bac474a617366063\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npnode search_BST(pnode p, int x)\r\n{\r\n    bool solve = false;\r\n    while(p &amp;&amp; !solve){\r\n        if(x == p-&gt;val){\r\n            solve = true;    \r\n        }    \r\n        else if(x &lt; p-&gt;val){\r\n            p = p-&gt;lchild;    \r\n        }\r\n        else{\r\n            p = p-&gt;rchild;    \r\n        }\r\n    }\r\n    if(p == NULL){\r\n        cout &lt;&lt; \"没有找到\" &lt;&lt; x &lt;&lt; endl;    \r\n    } \r\n    return p;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac474a617366063-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac474a617366063-19\">19</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-1\"><span class=\"crayon-e\">pnode </span><span class=\"crayon-e\">search_BST</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">pnode</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">solve</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">solve</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-6\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">solve</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">val</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-9\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rchild</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"没有找到\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">    </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac474a617366063-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac474a617366063-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p></p>\n<h1 class=\"First\">3. 平衡二叉树</h1>\n<p>我们知道，对于一般的二叉搜索树（Binary Search Tree），其期望高度（即为一棵平衡树时）为log<sub>2</sub>n，其各操作的时间复杂度O(log<sub>2</sub>n)同时也由此而决定。但是，在某些极端的情况下（如在插入的序列是有序的时），二叉搜索树将退化成近似链或链，此时，其操作的时间复杂度将退化成线性的，即O(n)。我们可以通过随机化建立二叉搜索树来尽量的避免这种情况，但是在进行了多次的操作之后，由于在删除时，我们总是选择将待删除节点的后继代替它本身，这样就会造成总是右边的节点数目减少，以至于树向左偏沉。这同时也会造成树的平衡性受到破坏，提高它的操作的时间复杂度。于是就有了我们下边介绍的平衡二叉树。</p>\n<p><strong>平衡二叉树定义：</strong>平衡二叉树（Balanced Binary Tree）又被称为AVL树（有别于AVL算法），且具有以下性质：它是一 棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树。平衡二叉树的常用算法有红黑树、AVL树等。在平衡二叉搜索树中，我们可以看到，其高度一般都良好地维持在O(log<sub>2</sub>n)，大大降低了操作的时间复杂度。</p>\n<p>最小二叉平衡树的节点的公式如下：</p>\n<p>F(n)=F(n-1)+F(n-2)+1</p>\n<p>这个类似于一个递归的数列，可以参考Fibonacci数列，1是根节点，F(n-1)是左子树的节点数量，F(n-2)是右子树的节点数量。</p>\n<h2 class=\"First\">3.1 平衡查找树之AVL树</h2>\n<p>有关AVL树的具体实现，可以参考<a href=\"http://www.cppblog.com/cxiaojia/archive/2012/08/20/187776.html\" target=\"_blank\">C小加的博客《一步一步写平衡二叉树（AVL）》</a>。</p>\n<p><strong>AVL树定义：</strong>AVL树是最先发明的自平衡二叉查找树。AVL树得名于它的发明者 G.M. Adelson-Velsky 和 E.M. Landis，他们在 1962 年的论文 “An algorithm for the organization of information” 中发表了它。在AVL中任何节点的两个儿子子树的高度最大差别为1，所以它也被称为高度平衡树，n个结点的AVL树最大深度约1.44log<sub>2</sub>n。查找、插入和删除在平均和最坏情况下都是O(logn)。增加和删除可能需要通过一次或多次树旋转来重新平衡这个树。<strong>这个方案很好的解决了二叉查找树退化成链表的问题，把插入，查找，删除的时间复杂度最好情况和最坏情况都维持在O(logN)。但是频繁旋转会使插入和删除牺牲掉O(logN)左右的时间，不过相对二叉查找树来说，时间上稳定了很多。</strong></p>\n<p><strong>AVL树的自平衡操作——旋转：</strong></p>\n<p>AVL树最关键的也是最难的一步操作就是<strong>旋转</strong>。旋转主要是为了实现AVL树在实施了插入和删除操作以后，树重新回到平衡的方法。下面我们重点研究一下AVL树的旋转。</p>\n<p>对于一个平衡的节点，由于任意节点最多有两个儿子，因此高度不平衡时，此节点的两颗子树的高度差2.容易看出，这种不平衡出现在下面四种情况：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/bbc1d195a4adf1a9cc10bb85b0f1c2c6.jpg\"><img class=\"aligncenter wp-image-111687 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bbc1d195a4adf1a9cc10bb85b0f1c2c6.jpg\" alt=\"2012082016021366\" width=\"785\" height=\"306\"></a></p>\n<p>1) 6节点的左子树3节点高度比右子树7节点大2，左子树3节点的左子树1节点高度大于右子树4节点，这种情况成为左左。</p>\n<p>2) 6节点的左子树2节点高度比右子树7节点大2，左子树2节点的左子树1节点高度小于右子树4节点，这种情况成为左右。</p>\n<p>3) 2节点的左子树1节点高度比右子树5节点小2，右子树5节点的左子树3节点高度大于右子树6节点，这种情况成为右左。</p>\n<p>4) 2节点的左子树1节点高度比右子树4节点小2，右子树4节点的左子树3节点高度小于右子树6节点，这种情况成为右右。</p>\n<p>从图2中可以可以看出，1和4两种情况是对称的，这两种情况的旋转算法是一致的，只需要经过一次旋转就可以达到目标，我们称之为单旋转。2和3两种情况也是对称的，这两种情况的旋转算法也是一致的，需要进行两次旋转，我们称之为双旋转。</p>\n<p><strong>单旋转</strong></p>\n<p>单旋转是针对于左左和右右这两种情况的解决方案，这两种情况是对称的，只要解决了左左这种情况，右右就很好办了。图3是左左情况的解决方案，节点k2不满足平衡特性，因为它的左子树k1比右子树Z深2层，而且k1子树中，更深的一层的是k1的左子树X子树，所以属于左左情况。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/61ee0c83b3783cb05eac2ed3528eae3b.jpg\"><img class=\"aligncenter wp-image-111688 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/61ee0c83b3783cb05eac2ed3528eae3b.jpg\" alt=\"avltree35\" width=\"530\" height=\"229\"></a></p>\n<p>为使树恢复平衡，我们把k2变成这棵树的根节点，因为k2大于k1，把k2置于k1的右子树上，而原本在k1右子树的Y大于k1，小于k2，就把Y置于k2的左子树上，这样既满足了二叉查找树的性质，又满足了平衡二叉树的性质。</p>\n<p>这样的操作只需要一部分指针改变，结果我们得到另外一颗二叉查找树，它是一棵AVL树，因为X向上一移动了一层，Y还停留在原来的层面上，Z向下移动了一层。整棵树的新高度和之前没有在左子树上插入的高度相同，插入操作使得X高度长高了。因此，由于这颗子树高度没有变化，所以通往根节点的路径就不需要继续旋转了。</p>\n<p><strong>双旋转</strong></p>\n<p>对于左右和右左这两种情况，单旋转不能使它达到一个平衡状态，要经过两次旋转。双旋转是针对于这两种情况的解决方案，同样的，这样两种情况也是对称的，只要解决了左右这种情况，右左就很好办了。图4是左右情况的解决方案，节点k3不满足平衡特性，因为它的左子树k1比右子树Z深2层，而且k1子树中，更深的一层的是k1的右子树k2子树，所以属于左右情况。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ad609dadbff982036a8e32c792436d7.jpg\"><img class=\"aligncenter wp-image-111690 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2ad609dadbff982036a8e32c792436d7.jpg\" alt=\"2012082016534455\" width=\"785\" height=\"247\"></a></p>\n<p>为使树恢复平衡，我们需要进行两步，第一步，把k1作为根，进行一次右右旋转，旋转之后就变成了左左情况，所以第二步再进行一次左左旋转，最后得到了一棵以k2为根的平衡二叉树。</p>\n<p><strong>AVL树实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6bac4752517806589\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//AVL树节点信息\r\ntemplate&lt;class T&gt;\r\nclass TreeNode\r\n{\r\n    public:\r\n        TreeNode():lson(NULL),rson(NULL),freq(1),hgt(0){}\r\n        T data;//值\r\n        int hgt;//高度\r\n        unsigned int freq;//频率\r\n        TreeNode* lson;//指向左儿子的地址\r\n        TreeNode* rson;//指向右儿子的地址\r\n};\r\n//AVL树类的属性和方法声明\r\ntemplate&lt;class T&gt;\r\nclass AVLTree\r\n{\r\n    private:\r\n        TreeNode&lt;T&gt;* root;//根节点\r\n        void insertpri(TreeNode&lt;T&gt;* &amp;node,T x);//插入\r\n        TreeNode&lt;T&gt;* findpri(TreeNode&lt;T&gt;* node,T x);//查找\r\n        void insubtree(TreeNode&lt;T&gt;* node);//中序遍历\r\n        void Deletepri(TreeNode&lt;T&gt;* &amp;node,T x);//删除\r\n        int height(TreeNode&lt;T&gt;* node);//求树的高度\r\n        void SingRotateLeft(TreeNode&lt;T&gt;* &amp;k2);//左左情况下的旋转\r\n        void SingRotateRight(TreeNode&lt;T&gt;* &amp;k2);//右右情况下的旋转\r\n        void DoubleRotateLR(TreeNode&lt;T&gt;* &amp;k3);//左右情况下的旋转\r\n        void DoubleRotateRL(TreeNode&lt;T&gt;* &amp;k3);//右左情况下的旋转\r\n        int Max(int cmpa,int cmpb);//求最大值\r\n\r\n    public:\r\n        AVLTree():root(NULL){}\r\n        void insert(T x);//插入接口\r\n        TreeNode&lt;T&gt;* find(T x);//查找接口\r\n        void Delete(T x);//删除接口\r\n        void traversal();//遍历接口\r\n\r\n};\r\n//计算节点的高度\r\ntemplate&lt;class T&gt;\r\nint AVLTree&lt;T&gt;::height(TreeNode&lt;T&gt;* node)\r\n{\r\n    if(node!=NULL)\r\n        return node-&gt;hgt;\r\n    return -1;\r\n}\r\n//求最大值\r\ntemplate&lt;class T&gt;\r\nint AVLTree&lt;T&gt;::Max(int cmpa,int cmpb)\r\n{\r\n    return cmpa&gt;cmpb?cmpa:cmpb;\r\n}\r\n//左左情况下的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::SingRotateLeft(TreeNode&lt;T&gt;* &amp;k2)\r\n{\r\n    TreeNode&lt;T&gt;* k1;\r\n    k1=k2-&gt;lson;\r\n    k2-&gt;lson=k1-&gt;rson;\r\n    k1-&gt;rson=k2;\r\n\r\n    k2-&gt;hgt=Max(height(k2-&gt;lson),height(k2-&gt;rson))+1;\r\n    k1-&gt;hgt=Max(height(k1-&gt;lson),k2-&gt;hgt)+1;\r\n}\r\n//右右情况下的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::SingRotateRight(TreeNode&lt;T&gt;* &amp;k2)\r\n{\r\n    TreeNode&lt;T&gt;* k1;\r\n    k1=k2-&gt;rson;\r\n    k2-&gt;rson=k1-&gt;lson;\r\n    k1-&gt;lson=k2;\r\n\r\n    k2-&gt;hgt=Max(height(k2-&gt;lson),height(k2-&gt;rson))+1;\r\n    k1-&gt;hgt=Max(height(k1-&gt;rson),k2-&gt;hgt)+1;\r\n}\r\n//左右情况的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::DoubleRotateLR(TreeNode&lt;T&gt;* &amp;k3)\r\n{\r\n    SingRotateRight(k3-&gt;lson);\r\n    SingRotateLeft(k3);\r\n}\r\n//右左情况的旋转\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::DoubleRotateRL(TreeNode&lt;T&gt;* &amp;k3)\r\n{\r\n    SingRotateLeft(k3-&gt;rson);\r\n    SingRotateRight(k3);\r\n}\r\n//插入\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insertpri(TreeNode&lt;T&gt;* &amp;node,T x)\r\n{\r\n    if(node==NULL)//如果节点为空,就在此节点处加入x信息\r\n    {\r\n        node=new TreeNode&lt;T&gt;();\r\n        node-&gt;data=x;\r\n        return;\r\n    }\r\n    if(node-&gt;data&gt;x)//如果x小于节点的值,就继续在节点的左子树中插入x\r\n    {\r\n        insertpri(node-&gt;lson,x);\r\n        if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            if(x&lt;node-&gt;lson-&gt;data)\r\n                SingRotateLeft(node);\r\n            else\r\n                DoubleRotateLR(node);\r\n    }\r\n    else if(node-&gt;data&lt;x)//如果x大于节点的值,就继续在节点的右子树中插入x\r\n    {\r\n        insertpri(node-&gt;rson,x);\r\n        if(2==height(node-&gt;rson)-height(node-&gt;lson))//如果高度之差为2的话就失去了平衡,需要旋转\r\n            if(x&gt;node-&gt;rson-&gt;data)\r\n                SingRotateRight(node);\r\n            else\r\n                DoubleRotateRL(node);\r\n    }\r\n    else ++(node-&gt;freq);//如果相等,就把频率加1\r\n    node-&gt;hgt=Max(height(node-&gt;lson),height(node-&gt;rson));\r\n}\r\n//插入接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insert(T x)\r\n{\r\n    insertpri(root,x);\r\n}\r\n//查找\r\ntemplate&lt;class T&gt;\r\nTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::findpri(TreeNode&lt;T&gt;* node,T x)\r\n{\r\n    if(node==NULL)//如果节点为空说明没找到,返回NULL\r\n    {\r\n        return NULL;\r\n    }\r\n    if(node-&gt;data&gt;x)//如果x小于节点的值,就继续在节点的左子树中查找x\r\n    {\r\n        return findpri(node-&gt;lson,x);\r\n    }\r\n    else if(node-&gt;data&lt;x)//如果x大于节点的值,就继续在节点的左子树中查找x\r\n    {\r\n        return findpri(node-&gt;rson,x);\r\n    }\r\n    else return node;//如果相等,就找到了此节点\r\n}\r\n//查找接口\r\ntemplate&lt;class T&gt;\r\nTreeNode&lt;T&gt;* AVLTree&lt;T&gt;::find(T x)\r\n{\r\n    return findpri(root,x);\r\n}\r\n//删除\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::Deletepri(TreeNode&lt;T&gt;* &amp;node,T x)\r\n{\r\n    if(node==NULL) return ;//没有找到值是x的节点\r\n    if(x &lt; node-&gt;data)\r\n    {\r\n         Deletepri(node-&gt;lson,x);//如果x小于节点的值,就继续在节点的左子树中删除x\r\n         if(2==height(node-&gt;rson)-height(node-&gt;lson))\r\n            if(node-&gt;rson-&gt;lson!=NULL&amp;&amp;(height(node-&gt;rson-&gt;lson)&gt;height(node-&gt;rson-&gt;rson)) )\r\n                DoubleRotateRL(node);\r\n            else\r\n                SingRotateRight(node);\r\n    }\r\n\r\n    else if(x &gt; node-&gt;data)\r\n    {\r\n         Deletepri(node-&gt;rson,x);//如果x大于节点的值,就继续在节点的右子树中删除x\r\n         if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            if(node-&gt;lson-&gt;rson!=NULL&amp;&amp; (height(node-&gt;lson-&gt;rson)&gt;height(node-&gt;lson-&gt;lson) ))\r\n                DoubleRotateLR(node);\r\n            else\r\n                SingRotateLeft(node);\r\n    }\r\n\r\n    else//如果相等,此节点就是要删除的节点\r\n    {\r\n        if(node-&gt;lson&amp;&amp;node-&gt;rson)//此节点有两个儿子\r\n        {\r\n            TreeNode&lt;T&gt;* temp=node-&gt;rson;//temp指向节点的右儿子\r\n            while(temp-&gt;lson!=NULL) temp=temp-&gt;lson;//找到右子树中值最小的节点\r\n            //把右子树中最小节点的值赋值给本节点\r\n            node-&gt;data=temp-&gt;data;\r\n            node-&gt;freq=temp-&gt;freq;\r\n            Deletepri(node-&gt;rson,temp-&gt;data);//删除右子树中最小值的节点\r\n            if(2==height(node-&gt;lson)-height(node-&gt;rson))\r\n            {\r\n                if(node-&gt;lson-&gt;rson!=NULL&amp;&amp; (height(node-&gt;lson-&gt;rson)&gt;height(node-&gt;lson-&gt;lson) ))\r\n                    DoubleRotateLR(node);\r\n                else\r\n                    SingRotateLeft(node);\r\n            }\r\n        }\r\n        else//此节点有1个或0个儿子\r\n        {\r\n            TreeNode&lt;T&gt;* temp=node;\r\n            if(node-&gt;lson==NULL)//有右儿子或者没有儿子\r\n            node=node-&gt;rson;\r\n            else if(node-&gt;rson==NULL)//有左儿子\r\n            node=node-&gt;lson;\r\n            delete(temp);\r\n            temp=NULL;\r\n        }\r\n    }\r\n    if(node==NULL) return;\r\n    node-&gt;hgt=Max(height(node-&gt;lson),height(node-&gt;rson))+1;\r\n    return;\r\n}\r\n//删除接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::Delete(T x)\r\n{\r\n    Deletepri(root,x);\r\n}\r\n//中序遍历函数\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::insubtree(TreeNode&lt;T&gt;* node)\r\n{\r\n    if(node==NULL) return;\r\n    insubtree(node-&gt;lson);//先遍历左子树\r\n    cout&lt;&lt;node-&gt;data&lt;&lt;\" \";//输出根节点\r\n    insubtree(node-&gt;rson);//再遍历右子树\r\n}\r\n//中序遍历接口\r\ntemplate&lt;class T&gt;\r\nvoid AVLTree&lt;T&gt;::traversal()\r\n{\r\n    insubtree(root);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-211\">211</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-212\">212</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-213\">213</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-214\">214</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-215\">215</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-216\">216</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-217\">217</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-218\">218</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-219\">219</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-220\">220</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-221\">221</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-222\">222</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-223\">223</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-224\">224</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-225\">225</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-226\">226</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-227\">227</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4752517806589-228\">228</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4752517806589-229\">229</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-1\"><span class=\"crayon-c\">//AVL树节点信息</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-2\"><span class=\"crayon-e\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-3\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TreeNode</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TreeNode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">lson</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">rson</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">freq</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">hgt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//值</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//高度</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//频率</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">TreeNode*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//指向左儿子的地址</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">TreeNode*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//指向右儿子的地址</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-12\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-13\"><span class=\"crayon-c\">//AVL树类的属性和方法声明</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-14\"><span class=\"crayon-e\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-15\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AVLTree</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-16\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//根节点</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//插入</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//查找</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//中序遍历</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//求树的高度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//左左情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//右右情况下的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//左右情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//右左情况下的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//求最大值</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-29\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">AVLTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">root</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//插入接口</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//查找接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-34\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除接口</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">traversal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//遍历接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-36\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-37\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-38\"><span class=\"crayon-c\">//计算节点的高度</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-39\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-40\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-41\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-42\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-45\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-46\"><span class=\"crayon-c\">//求最大值</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-47\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-48\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-49\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-50\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">?</span><span class=\"crayon-v\">cmpa</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">cmpb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-51\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-52\"><span class=\"crayon-c\">//左左情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-53\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-54\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-55\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-56\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-57\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-58\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-59\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-60\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-61\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-62\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-63\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-64\"><span class=\"crayon-c\">//右右情况下的旋转</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-65\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-66\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-67\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-68\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-69\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-71\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">k2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-72\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-73\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-74\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k1</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">k2</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-75\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-76\"><span class=\"crayon-c\">//左右情况的旋转</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-77\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-78\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-79\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-80\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-81\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-82\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-83\"><span class=\"crayon-c\">//右左情况的旋转</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-84\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-85\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-86\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-87\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-88\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-89\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-90\"><span class=\"crayon-c\">//插入</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-91\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-92\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-93\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-94\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果节点为空,就在此节点处加入x信息</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-95\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-96\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-97\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-98\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-99\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-100\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中插入x</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-101\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-102\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-103\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-104\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-105\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-106\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-107\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-108\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-109\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的右子树中插入x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-110\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-111\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-112\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果高度之差为2的话就失去了平衡,需要旋转</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-113\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-114\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-115\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-116\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-117\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-118\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果相等,就把频率加1</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-119\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-120\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-121\"><span class=\"crayon-c\">//插入接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-122\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-123\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-124\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-125\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insertpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-126\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-127\"><span class=\"crayon-c\">//查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-128\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-129\"><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-130\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-131\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果节点为空说明没找到,返回NULL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-132\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-133\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-134\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-135\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中查找x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-136\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-137\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-138\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-139\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的左子树中查找x</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-140\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-141\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-142\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-143\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果相等,就找到了此节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-144\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-145\"><span class=\"crayon-c\">//查找接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-146\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-147\"><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-148\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-149\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">findpri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-150\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-151\"><span class=\"crayon-c\">//删除</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-152\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-153\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-154\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-155\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//没有找到值是x的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-156\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-157\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-158\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果x小于节点的值,就继续在节点的左子树中删除x</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-159\"><span class=\"crayon-h\">         </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-161\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateRL</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-162\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-163\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateRight</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-164\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-165\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-166\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-167\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-168\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//如果x大于节点的值,就继续在节点的右子树中删除x</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-169\"><span class=\"crayon-h\">         </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-170\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-171\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-172\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-173\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-174\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-175\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-176\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">else</span><span class=\"crayon-c\">//如果相等,此节点就是要删除的节点</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-177\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-178\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//此节点有两个儿子</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-179\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-180\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//temp指向节点的右儿子</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-181\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//找到右子树中值最小的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-182\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">//把右子树中最小节点的值赋值给本节点</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-183\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-184\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">freq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-185\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//删除右子树中最小值的节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-186\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">==</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-187\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-188\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">!=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-189\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">DoubleRotateLR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-190\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-191\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">SingRotateLeft</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-192\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-193\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-194\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-c\">//此节点有1个或0个儿子</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-195\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-196\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-197\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//有右儿子或者没有儿子</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-198\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-199\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//有左儿子</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-200\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-201\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-202\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-203\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-204\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-205\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-206\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hgt</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">Max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">height</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-207\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-208\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-209\"><span class=\"crayon-c\">//删除接口</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-210\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-211\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">Delete</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-212\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-213\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Deletepri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-214\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-215\"><span class=\"crayon-c\">//中序遍历函数</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-216\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-217\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TreeNode</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-218\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-219\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">==</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-220\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//先遍历左子树</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-221\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">cout</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-s\">\" \"</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//输出根节点</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-222\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rson</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//再遍历右子树</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-223\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-224\"><span class=\"crayon-c\">//中序遍历接口</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-225\"><span class=\"crayon-v\">template</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-226\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AVLTree</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">T</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">traversal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-227\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4752517806589-228\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">insubtree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4752517806589-229\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0336 seconds] -->\r\n<p></p>\n<h2 class=\"First\">3.2 平衡二叉树之红黑树</h2>\n<p><strong>红黑树的定义：</strong>红黑树是一种自平衡二叉查找树，是在计算机科学中用到的一种数据结构，典型的用途是实现关联数组。它是在1972年由鲁道夫·贝尔发明的，称之为”对称二叉B树”，它现代的名字是在 Leo J. Guibas 和 Robert Sedgewick 于1978年写的一篇论文中获得的。<strong>它是复杂的，但它的操作有着良好的最坏情况运行时间，并且在实践中是高效的: 它可以在O(logn)时间内做查找，插入和删除，这里的n是树中元素的数目。</strong></p>\n<p>红黑树和AVL树一样都对插入时间、删除时间和查找时间提供了最好可能的最坏情况担保。这不只是使它们在时间敏感的应用如实时应用（real time application）中有价值，而且使它们有在提供最坏情况担保的其他数据结构中作为建造板块的价值；例如，在计算几何中使用的很多数据结构都可以基于红黑树。此外，红黑树还是2-3-4树的一种等同，它们的思想是一样的，只不过红黑树是2-3-4树用二叉树的形式表示的。</p>\n<p><strong>红黑树的性质：</strong></p>\n<p>红黑树是每个节点都带有颜色属性的二叉查找树，颜色为红色或黑色。在二叉查找树强制的一般要求以外，对于任何有效的红黑树我们增加了如下的额外要求:</p>\n<p>性质1. 节点是红色或黑色。</p>\n<p>性质2. 根是黑色。</p>\n<p>性质3. 所有叶子都是黑色（叶子是NIL节点）。</p>\n<p>性质4. 每个红色节点必须有两个黑色的子节点。(从每个叶子到根的所有路径上不能有两个连续的红色节点。)</p>\n<p>性质5. 从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。</p>\n<p>下面是一个具体的红黑树的图例：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9fd5e683147961431e0ecfcffbe5805b.png\"><img class=\"aligncenter wp-image-111691 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9fd5e683147961431e0ecfcffbe5805b.png\" alt=\"450px-Red-black_tree_example.svg\" width=\"450\" height=\"217\"></a></p>\n<p>这些约束确保了红黑树的关键特性: 从根到叶子的最长的可能路径不多于最短的可能路径的两倍长。结果是这个树大致上是平衡的。因为操作比如插入、删除和查找某个值的最坏情况时间都要求与树的高度成比例，这个在高度上的理论上限允许红黑树在最坏情况下都是高效的，而不同于普通的二叉查找树。</p>\n<p>要知道为什么这些性质确保了这个结果，注意到性质4导致了路径不能有两个毗连的红色节点就足够了。最短的可能路径都是黑色节点，最长的可能路径有交替的红色和黑色节点。因为根据性质5所有最长的路径都有相同数目的黑色节点，这就表明了没有路径能多于任何其他路径的两倍长。</p>\n<p>以下内容整理自<a href=\"https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91\" target=\"_blank\">wiki百科之红黑树</a>。</p>\n<p><strong>红黑树的自平衡操作：</strong></p>\n<p>因为每一个红黑树也是一个特化的二叉查找树，因此红黑树上的只读操作与普通二叉查找树上的只读操作相同。然而，在红黑树上进行插入操作和删除操作会导致不再符合红黑树的性质。恢复红黑树的性质需要少量(O(logn))的颜色变更(实际是非常快速的)和不超过三次树旋转(对于插入操作是两次)。虽然插入和删除很复杂，但操作时间仍可以保持为O(logn) 次。</p>\n<p><strong>我们首先以二叉查找树的方法增加节点并标记它为红色。如果设为黑色，就会导致根到叶子的路径上有一条路上，多一个额外的黑节点，这个是很难调整的（违背性质5）。</strong>但是设为红色节点后，可能会导致出现两个连续红色节点的冲突，那么可以通过颜色调换（color flips）和树旋转来调整。下面要进行什么操作取决于其他临近节点的颜色。同人类的家族树中一样，我们将使用术语叔父节点来指一个节点的父节点的兄弟节点。注意:</p>\n<ul>\n<li>性质1和性质3总是保持着。</li>\n<li>性质4只在增加红色节点、重绘黑色节点为红色，或做旋转时受到威胁。</li>\n<li>性质5只在增加黑色节点、重绘红色节点为黑色，或做旋转时受到威胁。</li>\n</ul>\n<p><strong>插入操作：</strong></p>\n<p>假设，将要插入的节点标为<strong>N</strong>，N的父节点标为<strong>P</strong>，N的祖父节点标为<strong>G</strong>，N的叔父节点标为<strong>U</strong>。在图中展示的任何颜色要么是由它所处情形这些所作的假定，要么是假定所暗含的。</p>\n<p><strong>情形1: </strong>该树为空树，直接插入根结点的位置，违反性质1，把节点颜色有红改为黑即可。</p>\n<p><strong>情形2:</strong> 插入节点N的父节点P为黑色，不违反任何性质，无需做任何修改。在这种情形下，树仍是有效的。性质5也未受到威胁，尽管新节点N有两个黑色叶子子节点；但由于新节点N是红色，通过它的每个子节点的路径就都有同通过它所取代的黑色的叶子的路径同样数目的黑色节点，所以依然满足这个性质。</p>\n<p>注： 情形1很简单，情形2中P为黑色，一切安然无事，但P为红就不一样了，下边是P为红的各种情况，也是真正难懂的地方。</p>\n<p><strong>情形3: </strong>如果父节点P和叔父节点U二者都是红色，(此时新插入节点N做为P的左子节点或右子节点都属于情形3,这里右图仅显示N做为P左子的情形)则我们可以将它们两个重绘为黑色并重绘祖父节点G为红色(用来保持性质4)。现在我们的新节点N有了一个黑色的父节点P。因为通过父节点P或叔父节点U的任何路径都必定通过祖父节点G，在这些路径上的黑节点数目没有改变。但是，红色的祖父节点G的父节点也有可能是红色的，这就违反了性质4。为了解决这个问题，我们在祖父节点G上递归地进行上述情形的整个过程（把G当成是新加入的节点进行各种情形的检查）。比如，G为根节点，那我们就直接将G变为黑色（情形1）；如果G不是根节点，而它的父节点为黑色，那符合所有的性质，直接插入即可（情形2）；如果G不是根节点，而它的父节点为红色，则递归上述过程（情形3）。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/dc3747336812e9055f958c56ade89eb8.png\"><img class=\"aligncenter wp-image-111692 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/dc3747336812e9055f958c56ade89eb8.png\" alt=\"2011120116425251\" width=\"300\" height=\"139\"></a></p>\n<p><strong>情形4:</strong> 父节点P是红色而叔父节点U是黑色或缺少，新节点N是其父节点的左子节点，而父节点P又是其父节点G的左子节点。在这种情形下，我们进行针对祖父节点G的一次右旋转; 在旋转产生的树中，以前的父节点P现在是新节点N和以前的祖父节点G的父节点。我们知道以前的祖父节点G是黑色，否则父节点P就不可能是红色(如果P和G都是红色就违反了性质4，所以G必须是黑色)。我们切换以前的父节点P和祖父节点G的颜色，结果的树满足性质4。性质5也仍然保持满足，因为通过这三个节点中任何一个的所有路径以前都通过祖父节点G，现在它们都通过以前的父节点P。在各自的情形下，这都是三个节点中唯一的黑色节点。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/4986c959603100e41cba2669d9e3ce0c.png\"><img class=\"aligncenter wp-image-111693 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4986c959603100e41cba2669d9e3ce0c.png\" alt=\"Red-black_tree_insert_case_5\" width=\"310\" height=\"138\"></a></p>\n<p><strong>情形5:</strong> 父节点P是红色而叔父节点U是黑色或缺少，并且新节点N是其父节点P的右子节点而父节点P又是其父节点的左子节点。在这种情形下，我们进行一次左旋转调换新节点和其父节点的角色; 接着，我们按<strong>情形4</strong>处理以前的父节点P以解决仍然失效的性质4。注意这个改变会导致某些路径通过它们以前不通过的新节点N（比如图中1号叶子节点）或不通过节点P（比如图中3号叶子节点），但由于这两个节点都是红色的，所以性质5仍有效。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9cfbf62dfdefe5891347de95a976758f.png\"><img class=\"aligncenter wp-image-111694 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9cfbf62dfdefe5891347de95a976758f.png\" alt=\"Red-black_tree_insert_case_5\" width=\"283\" height=\"138\"></a></p>\n<p><strong>注: 插入实际上是原地算法，因为上述所有调用都使用了尾部递归。</strong></p>\n<p><strong>删除操作：</strong></p>\n<p><strong>如果需要删除的节点有两个儿子，那么问题可以被转化成删除另一个只有一个儿子的节点的问题</strong>。对于二叉查找树，在删除带有两个非叶子儿子的节点的时候，我们找到要么在它的左子树中的最大元素、要么在它的右子树中的最小元素，并把它的值转移到要删除的节点中。我们接着删除我们从中复制出值的那个节点，它必定有少于两个非叶子的儿子。因为只是复制了一个值，不违反任何性质，这就把问题简化为如何删除最多有一个儿子的节点的问题。它不关心这个节点是最初要删除的节点还是我们从中复制出值的那个节点。</p>\n<p><strong>我们只需要讨论删除只有一个儿子的节点</strong>(如果它两个儿子都为空，即均为叶子，我们任意将其中一个看作它的儿子)。如果我们删除一个红色节点（此时该节点的儿子将都为叶子节点），它的父亲和儿子一定是黑色的。所以我们可以简单的用它的黑色儿子替换它，并不会破坏性质3和性质4。通过被删除节点的所有路径只是少了一个红色节点，这样可以继续保证性质5。另一种简单情况是在被删除节点是黑色而它的儿子是红色的时候。如果只是去除这个黑色节点，用它的红色儿子顶替上来的话，会破坏性质5，但是如果我们重绘它的儿子为黑色，则曾经通过它的所有路径将通过它的黑色儿子，这样可以继续保持性质5。</p>\n<p><strong>需要进一步讨论的是在要删除的节点和它的儿子二者都是黑色的时候</strong>，这是一种复杂的情况。我们首先把要删除的节点替换为它的儿子。出于方便，称呼这个儿子为<strong>N</strong>(在新的位置上)，称呼它的兄弟(它父亲的另一个儿子)为<strong>S</strong>。在下面的示意图中，我们还是使用<strong>P</strong>称呼N的父亲，<strong>S<sub>L</sub></strong>称呼S的左儿子，<strong>S<sub>R</sub></strong>称呼S的右儿子。</p>\n<p>如果N和它初始的父亲是黑色，则删除它的父亲导致通过N的路径都比不通过它的路径少了一个黑色节点。因为这违反了性质5，树需要被重新平衡。有几种情形需要考虑:</p>\n<p><strong>情形1:</strong> N是新的根。在这种情形下，我们就做完了。我们从所有路径去除了一个黑色节点，而新根是黑色的，所以性质都保持着。</p>\n<p><strong>注意</strong>: 在情形2、5和6下，我们假定N是它父亲的左儿子。如果它是右儿子，则在这些情形下的左和右应当对调。</p>\n<p><strong>情形2:</strong> S是红色。在这种情形下我们在N的父亲上做左旋转，把红色兄弟转换成N的祖父，我们接着对调N的父亲和祖父的颜色。完成这两个操作后，尽管所有路径上黑色节点的数目没有改变，但现在N有了一个黑色的兄弟和一个红色的父亲（它的新兄弟是黑色因为它是红色S的一个儿子），所以我们可以接下去按<strong>情形4</strong>、<strong>情形5</strong>或<strong>情形6</strong>来处理。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/ce86b0e24e64c35067f5d087dc4c90ae.png\"><img class=\"aligncenter wp-image-111695 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ce86b0e24e64c35067f5d087dc4c90ae.png\" alt=\"Red-black_tree_insert_case_5\" width=\"298\" height=\"136\"></a></p>\n<p><strong>情形3:</strong> N的父亲、S和S的儿子都是黑色的。在这种情形下，我们简单的重绘S为红色。结果是通过S的所有路径，它们就是以前<em>不</em>通过N的那些路径，都少了一个黑色节点。因为删除N的初始的父亲使通过N的所有路径少了一个黑色节点，这使事情都平衡了起来。但是，通过P的所有路径现在比不通过P的路径少了一个黑色节点，所以仍然违反性质5。要修正这个问题，我们要从<strong>情形1</strong>开始，在P上做重新平衡处理。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/30759b4136b3cd56ba31eb8d06a434d2.png\"><img class=\"aligncenter wp-image-111696 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/30759b4136b3cd56ba31eb8d06a434d2.png\" alt=\"Red-black_tree_insert_case_5\" width=\"313\" height=\"132\"></a></p>\n<p><strong>情形4:</strong> S和S的儿子都是黑色，但是N的父亲是红色。在这种情形下，我们简单的交换N的兄弟和父亲的颜色。这不影响不通过N的路径的黑色节点的数目，但是它在通过N的路径上对黑色节点数目增加了一，添补了在这些路径上删除的黑色节点。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/61bda9c9a89a3f9ea5f01ed990070a39.png\"><img class=\"aligncenter wp-image-111697 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/61bda9c9a89a3f9ea5f01ed990070a39.png\" alt=\"Red-black_tree_insert_case_5\" width=\"313\" height=\"132\"></a></p>\n<p><strong>情形5:</strong> S是黑色，S的左儿子是红色，S的右儿子是黑色，而N是它父亲的左儿子。在这种情形下我们在S上做右旋转，这样S的左儿子成为S的父亲和N的新兄弟。我们接着交换S和它的新父亲的颜色。所有路径仍有同样数目的黑色节点，但是现在N有了一个黑色兄弟，他的右儿子是红色的，所以我们进入了<strong>情形6</strong>。N和它的父亲都不受这个变换的影响。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/9f411d70951995007ad2a59fb747d160.png\"><img class=\"aligncenter wp-image-111698 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9f411d70951995007ad2a59fb747d160.png\" alt=\"Red-black_tree_insert_case_5\" width=\"247\" height=\"133\"></a></p>\n<p> </p>\n<p><strong>情形6:</strong> S是黑色，S的右儿子是红色，而N是它父亲的左儿子。在这种情形下我们在N的父亲上做左旋转，这样S成为N的父亲（P）和S的右儿子的父亲。我们接着交换N的父亲和S的颜色，并使S的右儿子为黑色。子树在它的根上的仍是同样的颜色，所以性质3没有被违反。但是，N现在增加了一个黑色祖先: 要么N的父亲变成黑色，要么它是黑色而S被增加为一个黑色祖父。所以，通过N的路径都增加了一个黑色节点。</p>\n<p>此时，如果一个路径不通过N，则有两种可能性:</p>\n<ul>\n<li>它通过N的新兄弟。那么它以前和现在都必定通过S和N的父亲，而它们只是交换了颜色。所以路径保持了同样数目的黑色节点。</li>\n<li>它通过N的新叔父，S的右儿子。那么它以前通过S、S的父亲和S的右儿子，但是现在只通过S，它被假定为它以前的父亲的颜色，和S的右儿子，它被从红色改变为黑色。合成效果是这个路径通过了同样数目的黑色节点。</li>\n</ul>\n<p>在任何情况下，在这些路径上的黑色节点数目都没有改变。所以我们恢复了性质4。在示意图中的白色节点可以是红色或黑色，但是在变换前后都必须指定相同的颜色。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c0ea423eef5e175e0ba92e43ad17270d.png\"><img class=\"aligncenter wp-image-111699 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c0ea423eef5e175e0ba92e43ad17270d.png\" alt=\"Red-black_tree_insert_case_5\" width=\"299\" height=\"143\"></a></p>\n<p><strong>红黑树实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6bac4764458689956\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define BLACK 1\r\n#define RED 0\r\n\r\nusing namespace std;\r\n\r\nclass bst {\r\nprivate:\r\n\r\n    struct Node {\r\n        int value;\r\n        bool color;\r\n        Node *leftTree, *rightTree, *parent;\r\n\r\n        Node() {\r\n            color = RED;\r\n            leftTree = NULL;\r\n            rightTree = NULL;\r\n            parent = NULL;\r\n            value = 0;\r\n        }\r\n\r\n        Node* grandparent() {\r\n            if (parent == NULL) {\r\n                return NULL;\r\n            }\r\n            return parent-&gt;parent;\r\n        }\r\n\r\n        Node* uncle() {\r\n            if (grandparent() == NULL) {\r\n                return NULL;\r\n            }\r\n            if (parent == grandparent()-&gt;rightTree)\r\n                return grandparent()-&gt;leftTree;\r\n            else\r\n                return grandparent()-&gt;rightTree;\r\n        }\r\n\r\n        Node* sibling() {\r\n            if (parent-&gt;leftTree == this)\r\n                return parent-&gt;rightTree;\r\n            else\r\n                return parent-&gt;leftTree;\r\n        }\r\n    };\r\n\r\n    void rotate_right(Node *p) {\r\n        Node *gp = p-&gt;grandparent();\r\n        Node *fa = p-&gt;parent;\r\n        Node *y = p-&gt;rightTree;\r\n\r\n        fa-&gt;leftTree = y;\r\n\r\n        if (y != NIL)\r\n            y-&gt;parent = fa;\r\n        p-&gt;rightTree = fa;\r\n        fa-&gt;parent = p;\r\n\r\n        if (root == fa)\r\n            root = p;\r\n        p-&gt;parent = gp;\r\n\r\n        if (gp != NULL) {\r\n            if (gp-&gt;leftTree == fa)\r\n                gp-&gt;leftTree = p;\r\n            else\r\n                gp-&gt;rightTree = p;\r\n        }\r\n\r\n    }\r\n\r\n    void rotate_left(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            root = p;\r\n            return;\r\n        }\r\n        Node *gp = p-&gt;grandparent();\r\n        Node *fa = p-&gt;parent;\r\n        Node *y = p-&gt;leftTree;\r\n\r\n        fa-&gt;rightTree = y;\r\n\r\n        if (y != NIL)\r\n            y-&gt;parent = fa;\r\n        p-&gt;leftTree = fa;\r\n        fa-&gt;parent = p;\r\n\r\n        if (root == fa)\r\n            root = p;\r\n        p-&gt;parent = gp;\r\n\r\n        if (gp != NULL) {\r\n            if (gp-&gt;leftTree == fa)\r\n                gp-&gt;leftTree = p;\r\n            else\r\n                gp-&gt;rightTree = p;\r\n        }\r\n    }\r\n\r\n    void inorder(Node *p) {\r\n        if (p == NIL)\r\n            return;\r\n\r\n        if (p-&gt;leftTree)\r\n            inorder(p-&gt;leftTree);\r\n\r\n        cout &lt;&lt; p-&gt;value &lt;&lt; \" \";\r\n                \r\n        if (p-&gt;rightTree)\r\n            inorder(p-&gt;rightTree);\r\n    }\r\n\r\n    string outputColor(bool color) {\r\n        return color ? \"BLACK\" : \"RED\";\r\n    }\r\n\r\n    Node* getSmallestChild(Node *p) {\r\n        if (p-&gt;leftTree == NIL)\r\n            return p;\r\n        return getSmallestChild(p-&gt;leftTree);\r\n    }\r\n\r\n    bool delete_child(Node *p, int data) {\r\n        if (p-&gt;value &gt; data) {\r\n            if (p-&gt;leftTree == NIL) {\r\n                return false;\r\n            }\r\n            return delete_child(p-&gt;leftTree, data);\r\n        } else if (p-&gt;value &lt; data) {\r\n            if (p-&gt;rightTree == NIL) {\r\n                return false;\r\n            }\r\n            return delete_child(p-&gt;rightTree, data);\r\n        } else if (p-&gt;value == data) {\r\n            if (p-&gt;rightTree == NIL) {\r\n                delete_one_child(p);\r\n                return true;\r\n            }\r\n            Node *smallest = getSmallestChild(p-&gt;rightTree);\r\n            swap(p-&gt;value, smallest-&gt;value);\r\n            delete_one_child(smallest);\r\n\r\n            return true;\r\n        }\r\n    }\r\n\r\n    void delete_one_child(Node *p) {\r\n        Node *child = p-&gt;leftTree == NIL ? p-&gt;rightTree : p-&gt;leftTree;\r\n        if (p-&gt;parent == NULL &amp;&amp; p-&gt;leftTree == NIL &amp;&amp; p-&gt;rightTree == NIL) {\r\n            p = NULL;\r\n            root = p;\r\n            return;\r\n        }\r\n        \r\n        if (p-&gt;parent == NULL) {\r\n            delete  p;\r\n            child-&gt;parent = NULL;\r\n            root = child;\r\n            root-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        \r\n        if (p-&gt;parent-&gt;leftTree == p) {\r\n            p-&gt;parent-&gt;leftTree = child;\r\n        } else {\r\n            p-&gt;parent-&gt;rightTree = child;\r\n        }\r\n        child-&gt;parent = p-&gt;parent;\r\n\r\n        if (p-&gt;color == BLACK) {\r\n            if (child-&gt;color == RED) {\r\n                child-&gt;color = BLACK;\r\n            } else\r\n                delete_case(child);\r\n        }\r\n\r\n        delete p;\r\n    }\r\n\r\n    void delete_case(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            p-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        if (p-&gt;sibling()-&gt;color == RED) {\r\n            p-&gt;parent-&gt;color = RED;\r\n            p-&gt;sibling()-&gt;color = BLACK;\r\n            if (p == p-&gt;parent-&gt;leftTree)\r\n                rotate_left(p-&gt;sibling());\r\n            else\r\n                rotate_right(p-&gt;sibling());\r\n        }\r\n        if (p-&gt;parent-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;color == BLACK\r\n                &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n            p-&gt;sibling()-&gt;color = RED;\r\n            delete_case(p-&gt;parent);\r\n        } else if (p-&gt;parent-&gt;color == RED &amp;&amp; p-&gt;sibling()-&gt;color == BLACK\r\n                &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n            p-&gt;sibling()-&gt;color = RED;\r\n            p-&gt;parent-&gt;color = BLACK;\r\n        } else {\r\n            if (p-&gt;sibling()-&gt;color == BLACK) {\r\n                if (p == p-&gt;parent-&gt;leftTree &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == RED\r\n                        &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == BLACK) {\r\n                    p-&gt;sibling()-&gt;color = RED;\r\n                    p-&gt;sibling()-&gt;leftTree-&gt;color = BLACK;\r\n                    rotate_right(p-&gt;sibling()-&gt;leftTree);\r\n                } else if (p == p-&gt;parent-&gt;rightTree &amp;&amp; p-&gt;sibling()-&gt;leftTree-&gt;color == BLACK\r\n                        &amp;&amp; p-&gt;sibling()-&gt;rightTree-&gt;color == RED) {\r\n                    p-&gt;sibling()-&gt;color = RED;\r\n                    p-&gt;sibling()-&gt;rightTree-&gt;color = BLACK;\r\n                    rotate_left(p-&gt;sibling()-&gt;rightTree);\r\n                }\r\n            }\r\n            p-&gt;sibling()-&gt;color = p-&gt;parent-&gt;color;\r\n            p-&gt;parent-&gt;color = BLACK;\r\n            if (p == p-&gt;parent-&gt;leftTree) {\r\n                p-&gt;sibling()-&gt;rightTree-&gt;color = BLACK;\r\n                rotate_left(p-&gt;sibling());\r\n            } else {\r\n                p-&gt;sibling()-&gt;leftTree-&gt;color = BLACK;\r\n                rotate_right(p-&gt;sibling());\r\n            }\r\n        }\r\n    }\r\n\r\n    void insert(Node *p, int data) {\r\n        if (p-&gt;value &gt;= data) {\r\n            if (p-&gt;leftTree != NIL)\r\n                insert(p-&gt;leftTree, data);\r\n            else {\r\n                Node *tmp = new Node();\r\n                tmp-&gt;value = data;\r\n                tmp-&gt;leftTree = tmp-&gt;rightTree = NIL;\r\n                tmp-&gt;parent = p;\r\n                p-&gt;leftTree = tmp;\r\n                insert_case(tmp);\r\n            }\r\n        } else {\r\n            if (p-&gt;rightTree != NIL)\r\n                insert(p-&gt;rightTree, data);\r\n            else {\r\n                Node *tmp = new Node();\r\n                tmp-&gt;value = data;\r\n                tmp-&gt;leftTree = tmp-&gt;rightTree = NIL;\r\n                tmp-&gt;parent = p;\r\n                p-&gt;rightTree = tmp;\r\n                insert_case(tmp);\r\n            }\r\n        }\r\n    }\r\n\r\n    void insert_case(Node *p) {\r\n        if (p-&gt;parent == NULL) {\r\n            root = p;\r\n            p-&gt;color = BLACK;\r\n            return;\r\n        }\r\n        if (p-&gt;parent-&gt;color == RED) {\r\n            if (p-&gt;uncle()-&gt;color == RED) {\r\n                p-&gt;parent-&gt;color = p-&gt;uncle()-&gt;color = BLACK;\r\n                p-&gt;grandparent()-&gt;color = RED;\r\n                insert_case(p-&gt;grandparent());\r\n            } else {\r\n                if (p-&gt;parent-&gt;rightTree == p &amp;&amp; p-&gt;grandparent()-&gt;leftTree == p-&gt;parent) {\r\n                    rotate_left(p);\r\n                    rotate_right(p);\r\n                    p-&gt;color = BLACK;\r\n                    p-&gt;leftTree-&gt;color = p-&gt;rightTree-&gt;color = RED;\r\n                } else if (p-&gt;parent-&gt;leftTree == p &amp;&amp; p-&gt;grandparent()-&gt;rightTree == p-&gt;parent) {\r\n                    rotate_right(p);\r\n                    rotate_left(p);\r\n                    p-&gt;color = BLACK;\r\n                    p-&gt;leftTree-&gt;color = p-&gt;rightTree-&gt;color = RED;\r\n                } else if (p-&gt;parent-&gt;leftTree == p &amp;&amp; p-&gt;grandparent()-&gt;leftTree == p-&gt;parent) {\r\n                    p-&gt;parent-&gt;color = BLACK;\r\n                    p-&gt;grandparent()-&gt;color = RED;\r\n                    rotate_right(p-&gt;parent);\r\n                } else if (p-&gt;parent-&gt;rightTree == p &amp;&amp; p-&gt;grandparent()-&gt;rightTree == p-&gt;parent) {\r\n                    p-&gt;parent-&gt;color = BLACK;\r\n                    p-&gt;grandparent()-&gt;color = RED;\r\n                    rotate_left(p-&gt;parent);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    void DeleteTree(Node *p) {\r\n        if (!p || p == NIL) {\r\n            return;\r\n        }\r\n        DeleteTree(p-&gt;leftTree);\r\n        DeleteTree(p-&gt;rightTree);\r\n        delete p;\r\n    }\r\npublic:\r\n\r\n    bst() {\r\n        NIL = new Node();\r\n        NIL-&gt;color = BLACK;\r\n        root = NULL;\r\n    }\r\n\r\n    ~bst() {\r\n        if (root)\r\n            DeleteTree(root);\r\n        delete NIL;\r\n    }\r\n\r\n    void inorder() {\r\n        if (root == NULL)\r\n            return;\r\n        inorder(root);\r\n        cout &lt;&lt; endl;\r\n    }\r\n\r\n    void insert(int x) {\r\n        if (root == NULL) {\r\n            root = new Node();\r\n            root-&gt;color = BLACK;\r\n            root-&gt;leftTree = root-&gt;rightTree = NIL;\r\n            root-&gt;value = x;\r\n        } else {\r\n            insert(root, x);\r\n        }\r\n    }\r\n\r\n    bool delete_value(int data) {\r\n        return delete_child(root, data);\r\n    }\r\nprivate:\r\n    Node *root, *NIL;\r\n};</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-211\">211</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-212\">212</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-213\">213</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-214\">214</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-215\">215</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-216\">216</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-217\">217</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-218\">218</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-219\">219</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-220\">220</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-221\">221</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-222\">222</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-223\">223</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-224\">224</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-225\">225</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-226\">226</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-227\">227</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-228\">228</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-229\">229</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-230\">230</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-231\">231</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-232\">232</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-233\">233</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-234\">234</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-235\">235</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-236\">236</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-237\">237</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-238\">238</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-239\">239</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-240\">240</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-241\">241</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-242\">242</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-243\">243</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-244\">244</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-245\">245</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-246\">246</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-247\">247</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-248\">248</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-249\">249</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-250\">250</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-251\">251</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-252\">252</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-253\">253</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-254\">254</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-255\">255</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-256\">256</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-257\">257</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-258\">258</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-259\">259</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-260\">260</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-261\">261</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-262\">262</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-263\">263</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-264\">264</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-265\">265</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-266\">266</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-267\">267</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-268\">268</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-269\">269</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-270\">270</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-271\">271</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-272\">272</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-273\">273</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-274\">274</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-275\">275</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-276\">276</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-277\">277</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-278\">278</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-279\">279</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-280\">280</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-281\">281</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-282\">282</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-283\">283</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-284\">284</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-285\">285</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-286\">286</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-287\">287</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-288\">288</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-289\">289</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-290\">290</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-291\">291</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-292\">292</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-293\">293</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-294\">294</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-295\">295</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-296\">296</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-297\">297</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-298\">298</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-299\">299</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-300\">300</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-301\">301</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-302\">302</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-303\">303</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-304\">304</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-305\">305</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-306\">306</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-307\">307</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-308\">308</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-309\">309</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-310\">310</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-311\">311</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-312\">312</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-313\">313</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-314\">314</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-315\">315</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-316\">316</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-317\">317</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-318\">318</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-319\">319</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-320\">320</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-321\">321</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-322\">322</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-323\">323</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-324\">324</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-325\">325</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-326\">326</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-327\">327</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-328\">328</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-329\">329</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-330\">330</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-331\">331</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6bac4764458689956-332\">332</div><div class=\"crayon-num\" data-line=\"crayon-595ff6bac4764458689956-333\">333</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-1\"><span class=\"crayon-p\">#define BLACK 1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-2\"><span class=\"crayon-p\">#define RED 0</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-6\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bst</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-7\"><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-8\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-17\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-23\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-24\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-26\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-28\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-32\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-34\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-35\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-36\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-38\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-41\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-43\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-46\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-49\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-51\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">y</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-53\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-54\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-55\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-58\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-59\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-60\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-62\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-64\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-65\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-66\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-67\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-69\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-71\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-72\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-74\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-75\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-76\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-77\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-78\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-79\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-80\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-81\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">y</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-82\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-83\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-84\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-85\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-86\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">fa</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-87\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-88\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-89\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-90\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-91\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-92\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-93\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fa</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-94\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-95\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-96\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">gp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-97\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-98\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-99\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-100\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-101\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-102\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-103\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-104\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-105\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-106\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-107\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\" \"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-108\"><span class=\"crayon-h\">                </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-109\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-110\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-111\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-112\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-113\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">outputColor</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-114\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"BLACK\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"RED\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-115\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-116\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-117\"><span class=\"crayon-h\">    </span><span class=\"crayon-e \">Node*</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-118\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-119\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-120\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-121\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-122\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-123\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-124\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-125\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-126\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-127\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-128\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-129\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-130\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-131\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-132\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-133\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-134\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-135\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-136\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-137\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-138\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-139\"><span class=\"crayon-h\">            </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">smallest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getSmallestChild</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-140\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">swap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smallest</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-141\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">smallest</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-142\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-143\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-144\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-145\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-146\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-147\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_one_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-148\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-r\">child</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-149\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-150\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-151\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-152\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-153\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-154\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-155\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-156\"><span class=\"crayon-h\">            </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-157\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-158\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-159\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-161\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-162\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-163\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-164\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-165\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-166\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-167\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-168\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-169\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-170\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-171\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-172\"><span class=\"crayon-h\">                </span><span class=\"crayon-r\">child</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-173\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-174\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">child</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-175\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-176\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-177\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-178\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-179\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-180\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-181\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-182\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-183\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-184\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-185\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-186\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-187\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-188\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-189\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-190\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-191\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-192\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-193\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-194\"><span class=\"crayon-h\">                </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-195\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-196\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">delete_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-197\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-198\"><span class=\"crayon-h\">                </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-199\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-200\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-201\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-202\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-203\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-204\"><span class=\"crayon-h\">                        </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-205\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-206\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-207\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-208\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-209\"><span class=\"crayon-h\">                        </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-210\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-211\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-212\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-213\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-214\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-215\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-216\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-217\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-218\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-219\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-220\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-221\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-222\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">sibling</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-223\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-224\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-225\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-226\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-227\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-228\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-229\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-230\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-231\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-232\"><span class=\"crayon-h\">                </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-233\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-234\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-235\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-236\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-237\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-238\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-239\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-240\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-241\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-242\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-243\"><span class=\"crayon-h\">                </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-244\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-245\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-246\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-247\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-248\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-249\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-250\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-251\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-252\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-253\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-254\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-255\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-256\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-257\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-258\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-259\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-260\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-261\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">uncle</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-262\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-263\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">insert_case</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-264\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-265\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-266\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-267\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-268\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-269\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-270\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-271\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-272\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-273\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-274\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-275\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-276\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-277\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-278\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_right</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-279\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-280\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-281\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">grandparent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-282\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">rotate_left</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-r\">parent</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-283\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-284\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-285\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-286\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-287\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-288\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-289\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-290\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-291\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-292\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-293\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-294\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-295\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-296\"><span class=\"crayon-m\">public</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-297\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-298\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">bst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-299\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-300\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-301\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-302\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-303\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-304\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">~</span><span class=\"crayon-e\">bst</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-305\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-306\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">DeleteTree</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-307\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">delete </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-308\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-309\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-310\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-311\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-312\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-313\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">inorder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-314\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">endl</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-315\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-316\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-317\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-318\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-319\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Node</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-320\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">color</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BLACK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-321\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">leftTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">rightTree</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-322\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-323\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-324\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">x</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-325\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-326\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-327\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-328\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_value</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-329\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">delete_child</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-330\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-331\"><span class=\"crayon-m\">private</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6bac4764458689956-332\"><span class=\"crayon-h\">    </span><span class=\"crayon-e \">Node *</span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">NIL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6bac4764458689956-333\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0528 seconds] -->\r\n<p></p>\n<h1 class=\"First\">4. B树</h1>\n<p>B树也是一种用于查找的平衡树，但是它不是二叉树。</p>\n<p><strong>B树的定义：</strong>B树（<span class=\"LangWithName\"><span lang=\"en\" xml:lang=\"en\">B-tree）是一种树状数据结构，能够用来存储排序后的数据。这种数据结构能够让查找数据、循序存取、插入数据及删除的动作，都在对数时间内完成。B树，概括来说是一个一般化的二叉查找树，可以拥有多于2个子节点。与自平衡二叉查找树不同，B-树为系统最优化大块数据的读和写操作。B-tree算法减少定位记录时所经历的中间过程，从而加快存取速度。这种数据结构常被应用在数据库和文件系统的实作上。</span></span></p>\n<p>在B树中查找给定关键字的方法是，首先把根结点取来，在根结点所包含的关键字K1,…,Kn查找给定的关键字（可用顺序查找或二分查找法），若找到等于给定值的关键字，则查找成功；否则，一定可以确定要查找的关键字在Ki与Ki+1之间，Pi为指向子树根节点的指针，此时取指针Pi所指的结点继续查找，直至找到，或指针Pi为空时查找失败。</p>\n<p>B树作为一种多路搜索树（并不是二叉的）：</p>\n<p>1) 定义任意非叶子结点最多只有M个儿子；且M&gt;2；</p>\n<p>2) 根结点的儿子数为[2, M]；</p>\n<p>3) 除根结点以外的非叶子结点的儿子数为[M/2, M]；</p>\n<p>4) 每个结点存放至少M/2-1（取上整）和至多M-1个关键字；（至少2个关键字）</p>\n<p>5) 非叶子结点的关键字个数=指向儿子的指针个数-1；</p>\n<p>6) 非叶子结点的关键字：K[1], K[2], …, K[M-1]；且K[i] &lt; K[i+1]；</p>\n<p>7) 非叶子结点的指针：P[1], P[2], …, P[M]；其中P[1]指向关键字小于K[1]的子树，P[M]指向关键字大于K[M-1]的子树，其它P[i]指向关键字属于(K[i-1], K[i])的子树；</p>\n<p>8) 所有叶子结点位于同一层；</p>\n<p>如下图为一个M=3的B树示例：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0178191b698ab75a98fa1d0bb03cc51f.jpg\"><img class=\"aligncenter wp-image-111700 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0178191b698ab75a98fa1d0bb03cc51f.jpg\" alt=\"4\" width=\"624\" height=\"268\"></a></p>\n<p>B树创建的示意图：</p>\n<p><img class=\"aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh5p12mz57g20qm06d4qq.gif\" width=\"958\" height=\"229\"></p>\n<h1 class=\"First\">5. B+树</h1>\n<p>B+树是B树的变体，也是一种多路搜索树：</p>\n<p>1) 其定义基本与B-树相同，除了：</p>\n<p>2) 非叶子结点的子树指针与关键字个数相同；</p>\n<p>3) 非叶子结点的子树指针P[i]，指向关键字值属于[K[i], K[i+1])的子树（B-树是开区间）；</p>\n<p>4) 为所有叶子结点增加一个链指针；</p>\n<p>5) 所有关键字都在叶子结点出现；</p>\n<p>下图为M=3的B+树的示意图：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0972ef809f286cc29cd2d94687b2ef2d.jpg\"><img class=\"aligncenter wp-image-111701 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0972ef809f286cc29cd2d94687b2ef2d.jpg\" alt=\"4\" width=\"569\" height=\"345\"></a></p>\n<p>B+树的搜索与B树也基本相同，区别是B+树只有达到叶子结点才命中（B树可以在非叶子结点命中），其性能也等价于在关键字全集做一次二分查找；</p>\n<p><strong>B+的性质：</strong></p>\n<p>1.所有关键字都出现在叶子结点的链表中（稠密索引），且链表中的关键字恰好是有序的；</p>\n<p>2.不可能在非叶子结点命中；</p>\n<p>3.非叶子结点相当于是叶子结点的索引（稀疏索引），叶子结点相当于是存储（关键字）数据的数据层；</p>\n<p>4.更适合文件索引系统。</p>\n<p>下面为一个B+树创建的示意图：</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/large/7cc829d3gy1fh5p2ef94jg20rz05i7wi.gif\" width=\"1007\" height=\"198\"></p>\n<h1 class=\"First\">6. B*树</h1>\n<p>B*树是B+树的变体，在B+树的非根和非叶子结点再增加指向兄弟的指针，将结点的最低利用率从1/2提高到2/3。</p>\n<p>B*树如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/eb5835f421e029240105ccb8e80279ee.jpg\"><img class=\"aligncenter wp-image-111702 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/eb5835f421e029240105ccb8e80279ee.jpg\" alt=\"4\" width=\"569\" height=\"345\"></a></p>\n<p>B*树定义了非叶子结点关键字个数至少为(2/3)*M，即块的最低使用率为2/3（代替B+树的1/2）；</p>\n<p>B+树的分裂：当一个结点满时，分配一个新的结点，并将原结点中1/2的数据复制到新结点，最后在父结点中增加新结点的指针；B+树的分裂只影响原结点和父结点，而不会影响兄弟结点，所以它不需要指向兄弟的指针；</p>\n<p>B*树的分裂：当一个结点满时，如果它的下一个兄弟结点未满，那么将一部分数据移到兄弟结点中，再在原结点插入关键字，最后修改父结点中兄弟结点的关键字（因为兄弟结点的关键字范围改变了）；如果兄弟也满了，则在原结点与兄弟结点之间增加新结点，并各复制1/3的数据到新结点，最后在父结点增加新结点的指针；</p>\n<p>所以，B*树分配新结点的概率比B+树要低，空间使用率更高。</p>\n<h1 class=\"First\">7. Trie树</h1>\n<p>Tire树称为字典树，又称单词查找树，Trie树，是一种树形结构，是一种哈希树的变种。典型应用是用于统计，排序和保存大量的字符串（但不仅限于字符串），所以经常被搜索引擎系统用于文本词频统计。<strong>它的优点是：利用字符串的公共前缀来减少查询时间，最大限度地减少无谓的字符串比较，查询效率比哈希树高。</strong></p>\n<div class=\"para\"><strong>Tire树的三个基本性质：</strong></div>\n<div class=\"para\">1) 根节点不包含字符，除根节点外每一个节点都只包含一个字符；</div>\n<div class=\"para\">2) 从根节点到某一节点，路径上经过的字符连接起来，为该节点对应的字符串；</div>\n<div class=\"para\">3) 每个节点的所有子节点包含的字符都不相同。</div>\n<p><strong>Tire树的应用：</strong></p>\n<p>1) <span class=\"headline-content\">串的快速检索</span></p>\n<p class=\"para\">给出N个单词组成的熟词表，以及一篇全用小写英文书写的文章，请你按最早出现的顺序写出所有不在熟词表中的生词。在这道题中，我们可以用数组枚举，用哈希，用字典树，先把熟词建一棵树，然后读入文章进行比较，这种方法效率是比较高的。</p>\n<p class=\"para\"><span class=\"headline-content\">2) “串”排序</span></p>\n<p class=\"para\">给定N个互不相同的仅由一个单词构成的英文名，让你将他们按字典序从小到大输出。用字典树进行排序，采用数组的方式创建字典树，这棵树的每个结点的所有儿子很显然地按照其字母大小排序。对这棵树进行先序遍历即可。</p>\n<p class=\"para\"><span class=\"headline-content\">3) 最长公共前缀</span></p>\n<p class=\"para\">对所有串建立字典树，对于两个串的最长公共前缀的长度即他们所在的结点的公共祖先个数，于是，问题就转化为求公共祖先的问题。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111680\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111680votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111680\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/bc42d6b7087d92bf57edac612206395f.jpg', 'full/6032d7dc1233f95d17343e58eeaff17e6a49cb23.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('Linux 系统下 init 进程的前世今生', '2017-07-07', 'http://blog.jobbole.com/111610/', '095c32b8a09e11a07b4519d90d27a594', 1, 1, 'IT技术, Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-23769728-id-3129443.html\">MagicBoy2010</a>   </div><p>Linux系统中的init进程(pid=1)是除了idle进程(pid=0，也就是init_task)之外另一个比较特殊的进程，它是Linux内核开始建立起进程概念时第一个通过kernel_thread产生的进程，其开始在内核态执行，然后通过一个系统调用，开始执行用户空间的/sbin/init程序，期间Linux内核也经历了从内核态到用户态的特权级转变，/sbin/init极有可能产生出了shell，然后所有的用户进程都有该进程派生出来(目前尚未阅读过/sbin/init的源码)…</p>\n<p>目前我们至少知道在内核空间执行用户空间的一段应用程序有两种方法：<br>\n1. call_usermodehelper<br>\n2. kernel_execve</p>\n<p>它们最终都通过int $0x80在内核空间发起一个系统调用来完成，这个过程我在《深入Linux设备驱动程序内核机制》第9章有过详细的描述，对它的讨论最终结束在 sys_execve函数那里，后者被用来执行一个新的程序。现在一个有趣的问题是，在内核空间发起的系统调用，最终通过sys_execve来执行用户 空间的一个程序，比如/sbin/myhotplug，那么该应用程序执行时是在内核态呢还是用户态呢？直觉上肯定是用户态，不过因为cpu在执行 sys_execve时cs寄存器还是__KERNEL_CS，如果前面我们的猜测是真的话，必然会有个cs寄存器的值从__KERNEL_CS到 __USER_CS的转变过程，这个过程是如何发生的呢？下面我以kernel_execve为例，来具体讨论一下其间所发生的一些有趣的事情。</p>\n<p>start_kernel在其最后一个函数rest_init的调用中，会通过kernel_thread来生成一个内核进程，后者则会在新进程环境下调 用kernel_init函数，kernel_init一个让人感兴趣的地方在于它会调用run_init_process来执行根文件系统下的 /sbin/init等程序：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7938314846174\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic noinline int init_post(void)\r\n{\r\n        ...\r\n        run_init_process(\"/sbin/init\");\r\n        run_init_process(\"/etc/init\");\r\n        run_init_process(\"/bin/init\");\r\n        run_init_process(\"/bin/sh\");\r\n        panic(\"No init found. Try passing init= option to kernel. \"\r\n              \"See Linux Documentation/init.txt for guidance.\");\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7938314846174-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7938314846174-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7938314846174-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7938314846174-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7938314846174-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7938314846174-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7938314846174-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7938314846174-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7938314846174-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7938314846174-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7938314846174-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">noinline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">init_post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7938314846174-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7938314846174-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7938314846174-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/sbin/init\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7938314846174-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/etc/init\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7938314846174-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/bin/init\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7938314846174-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/bin/sh\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7938314846174-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">panic</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"No init found. Try passing init= option to kernel. \"</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7938314846174-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-s\">\"See Linux Documentation/init.txt for guidance.\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7938314846174-10\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>run_init_process的核心调用就是kernel_execve，后者的实现代码是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7942260278116\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint kernel_execve(const char *filename,\r\n                  const char *const argv[],\r\n                  const char *const envp[])\r\n{\r\n        long __res;\r\n        asm volatile (\"int $0x80\"\r\n        : \"=a\" (__res)\r\n        : \"0\" (__NR_execve), \"b\" (filename), \"c\" (argv), \"d\" (envp) : \"memory\");\r\n        return __res;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7942260278116-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7942260278116-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7942260278116-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7942260278116-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7942260278116-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7942260278116-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7942260278116-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7942260278116-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7942260278116-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7942260278116-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7942260278116-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">kernel_execve</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7942260278116-2\"><span class=\"crayon-h\">                  </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7942260278116-3\"><span class=\"crayon-h\">                  </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">envp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7942260278116-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7942260278116-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__res</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7942260278116-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">asm </span><span class=\"crayon-e\">volatile</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"int $0x80\"</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7942260278116-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"=a\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">__res</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7942260278116-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"0\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">__NR_execve</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"b\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"c\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"d\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">envp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"memory\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7942260278116-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__res</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7942260278116-10\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>里面是段内嵌的汇编代码，代码相对比较简单，核心代码是int $0x80，执行系统调用，系统调用号__NR_execve放在AX里，当然系统调用的返回值也是在AX中，要执行的用户空间应用程序路径名称保存在 BX中。int $0x80的执行导致代码向__KERNEL_CS:system_call转移(具体过程可参考<a href=\"http://blog.chinaunix.net/uid-23769728-id-3077701.html\" target=\"_blank\">x86处理器中的特权级检查及Linux系统调用的实现</a>一帖). 此处用bx,cx以及dx来保存filename, argv以及envp参数是有讲究的，它对应着struct pt_regs中寄存器在栈中的布局，因为接下来就会涉及从汇编到调用C函数过程，所以汇编程序在调用C之前，应该把要传递给C的参数在栈中准备好。</p>\n<p>system_call是一段纯汇编代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7947354742146\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n&lt;arch/x86/kernel/entry_32.s&gt;\r\nENTRY(system_call)\r\n        RING0_INT_FRAME # can\'t unwind into user space anyway\r\n        pushl_cfi %eax # save orig_eax\r\n        SAVE_ALL\r\n        GET_THREAD_INFO(%ebp)\r\n                                        # system call tracing in operation / emulation\r\n        testl $_TIF_WORK_SYSCALL_ENTRY,TI_flags(%ebp)\r\n        jnz syscall_trace_entry\r\n        cmpl $(nr_syscalls), %eax\r\n        jae syscall_badsys\r\nsyscall_call:\r\n        call *sys_call_table(,%eax,4)\r\n        movl %eax,PT_EAX(%esp) # store the return value\r\n\r\nsyscall_exit:\r\n        ...\r\nrestore_nocheck:\r\n        RESTORE_REGS 4 # skip orig_eax/error_code\r\nirq_return:\r\n        INTERRUPT_RETURN #iret instruction for x86_32</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7947354742146-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7947354742146-21\">21</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">arch</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">x86</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">kernel</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">entry_32</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-2\"><span class=\"crayon-e\">ENTRY</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">system_call</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">RING0_INT_FRAME</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># can\'t unwind into user space anyway</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">pushl_cfi</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">eax</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># save orig_eax</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">SAVE_ALL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-6\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">GET_THREAD_INFO</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">ebp</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-7\"><span class=\"crayon-h\">                                        </span><span class=\"crayon-p\"># system call tracing in operation / emulation</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">testl</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_TIF_WORK_SYSCALL_ENTRY</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">TI_flags</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">ebp</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">jnz </span><span class=\"crayon-e\">syscall_trace_entry</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-10\"><span class=\"crayon-e\">        </span><span class=\"crayon-i\">cmpl</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">nr_syscalls</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-e\">eax</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-11\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">jae </span><span class=\"crayon-e\">syscall_badsys</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-12\"><span class=\"crayon-v\">syscall_call</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-e \">call *</span><span class=\"crayon-e\">sys_call_table</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">,</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">eax</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">movl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">eax</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">PT_EAX</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">esp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># store the return value</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-16\"><span class=\"crayon-v\">syscall_exit</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-18\"><span class=\"crayon-v\">restore_nocheck</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">RESTORE</span><span class=\"crayon-sy\">_</span>REGS<span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># skip orig_eax/error_code</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7947354742146-20\"><span class=\"crayon-v\">irq_return</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7947354742146-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">INTERRUPT_RETURN</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#iret instruction for x86_32</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>system_call首先会为后续的C函数的调用在当前堆栈中建立参数传递的环境(x86_64的实现要相对复杂一点，它会将系统调用切换到内核栈 movq PER_CPU_VAR(kernel_stack),%rsp)，尤其是接下来对C函数sys_execve调用中的struct pt_regs *regs参数，我在上面代码中同时列出了系统调用之后的后续操作syscall_exit，从代码中可以看到系统调用int $0x80最终通过iret指令返回，而后者会从当前栈中弹出cs与ip，然后跳转到cs:ip处执行代码。正常情况下，x86架构上的int n指 令会将其下条指令的cs:ip压入堆栈，所以当通过iret指令返回时，原来的代码将从int n的下条指令继续执行，不过如果我们能在后续的C代码中改变regs-&gt;cs与regs-&gt;ip(也就是int n执行时压入栈中的cs与ip)，那么就可以控制下一步代码执行的走向，而 sys_execve函数的调用链正好利用了这一点，接下来我们很快就会看到。SAVE_ALL宏的最后为将ds, es, fs都设置为__USER_DS，但是此时cs还是__KERNEL_CS.</p>\n<p>核心的调用发生在call *sys_call_table(,%eax,4)这条指令上，sys_call_table是个系统调用表，本质上就是一个函数指针数组，我们这里的系 统调用号是__NR_execve=11, 所以在sys_call_table中对应的函数为：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b794c804500380\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nENTRY(sys_call_table)\r\n        .long sys_restart_syscall /* 0 - old \"setup()\" system call, used for restarting */\r\n        .long sys_exit\r\n        .long ptregs_fork\r\n        .long sys_read\r\n        .long sys_write\r\n        .long sys_open /* 5 */\r\n        .long sys_close\r\n        ...\r\n        .long sys_unlink /* 10 */\r\n        .long ptregs_execve //__NR_execve\r\n        ...</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b794c804500380-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b794c804500380-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b794c804500380-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b794c804500380-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b794c804500380-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b794c804500380-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b794c804500380-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b794c804500380-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b794c804500380-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b794c804500380-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b794c804500380-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b794c804500380-12\">12</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b794c804500380-1\"><span class=\"crayon-e\">ENTRY</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sys_call_table</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b794c804500380-2\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys_restart_syscall</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/* 0 - old \"setup()\" system call, used for restarting */</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b794c804500380-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys</span><span class=\"crayon-sy\">_</span>exit</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b794c804500380-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ptregs</span><span class=\"crayon-sy\">_</span>fork</div><div class=\"crayon-line\" id=\"crayon-596017c9b794c804500380-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys</span><span class=\"crayon-sy\">_</span>read</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b794c804500380-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys</span><span class=\"crayon-sy\">_</span>write</div><div class=\"crayon-line\" id=\"crayon-596017c9b794c804500380-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys_open</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/* 5 */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b794c804500380-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys</span><span class=\"crayon-sy\">_</span>close</div><div class=\"crayon-line\" id=\"crayon-596017c9b794c804500380-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b794c804500380-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sys_unlink</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/* 10 */</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b794c804500380-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ptregs_execve</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//__NR_execve</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b794c804500380-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>ptregs_execve其实就是sys_execve函数：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7950348632939\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define ptregs_execve sys_execve</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7950348632939-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7950348632939-1\"><span class=\"crayon-p\">#define ptregs_execve sys_execve</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>而sys_execve函数的代码实现则是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7953065844536\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*\r\n * sys_execve() executes a new program.\r\n */\r\nlong sys_execve(const char __user *name,\r\n                const char __user *const __user *argv,\r\n                const char __user *const __user *envp, struct pt_regs *regs)\r\n{\r\n        long error;\r\n        char *filename;\r\n\r\n        filename = getname(name);\r\n        error = PTR_ERR(filename);\r\n        if (IS_ERR(filename))\r\n                return error;\r\n        error = do_execve(filename, argv, envp, regs);\r\n\r\n#ifdef CONFIG_X86_32\r\n        if (error == 0) {\r\n                /* Make sure we don\'t return using sysenter.. */\r\n                set_thread_flag(TIF_IRET);\r\n        }\r\n#endif\r\n\r\n        putname(filename);\r\n        return error;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7953065844536-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7953065844536-26\">26</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-1\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-2\"><span class=\"crayon-c\"> * sys_execve() executes a new program.</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-3\"><span class=\"crayon-c\"> */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-4\"><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sys_execve</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-5\"><span class=\"crayon-h\">                </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-6\"><span class=\"crayon-h\">                </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-v\">envp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pt_regs *</span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-10\"> </div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">filename</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getname</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">PTR_ERR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IS_ERR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-14\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">do_execve</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">envp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-16\"> </div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-17\"><span class=\"crayon-p\">#ifdef CONFIG_X86_32</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-19\"><span class=\"crayon-h\">                </span><span class=\"crayon-c\">/* Make sure we don\'t return using sysenter.. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-20\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">set_thread_flag</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TIF_IRET</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-22\"><span class=\"crayon-p\">#endif</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">putname</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7953065844536-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7953065844536-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0031 seconds] -->\r\n<p>注意这里的参数传递机制！其中的核心调用是do_execve,后者调用do_execve_common来干执行一个新程序的活，在我们这个例子中要执 行的新程序来自/sbin/init，如果用file命令看一下会发现它其实是个ELF格式的动态链接库，而不是那种普通的可执行文件，所以 do_execve_common会负责打开、解析这个文件并找到其可执行入口点，这个过程相当繁琐，我们不妨直接看那些跟我们问题密切相关的代 码，do_execve_common会调用search_binary_handler去查找所谓的binary formats handler，ELF显然是最常见的一种格式：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7957745021244\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint search_binary_handler(struct linux_binprm *bprm,struct pt_regs *regs)\r\n{\r\n       ...\r\n       for (try=0; try&lt;2; try++) {\r\n                read_lock(&amp;binfmt_lock);\r\n                list_for_each_entry(fmt, &amp;formats, lh) {\r\n                        int (*fn)(struct linux_binprm *, struct pt_regs *) = fmt-&gt;load_binary;\r\n                        ...\r\n                        retval = fn(bprm, regs);\r\n                        ...\r\n               }\r\n               ...\r\n       }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7957745021244-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7957745021244-14\">14</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">search_binary_handler</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">linux_binprm *</span><span class=\"crayon-v\">bprm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pt_regs *</span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-3\"><span class=\"crayon-h\">       </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-4\"><span class=\"crayon-h\">       </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-st\">try</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">try</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">try</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-5\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">read_lock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">binfmt_lock</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-6\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">list_for_each_entry</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fmt</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">formats</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">lh</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-7\"><span class=\"crayon-h\">                        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">fn</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">linux_binprm *</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pt_regs *</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fmt</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">load_binary</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-8\"><span class=\"crayon-h\">                        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-9\"><span class=\"crayon-h\">                        </span><span class=\"crayon-v\">retval</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">bprm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-10\"><span class=\"crayon-h\">                        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-11\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-12\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7957745021244-13\"><span class=\"crayon-h\">       </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7957745021244-14\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>代码中针对ELF格式的 fmt-&gt;load_binary即为load_elf_binary, 所以fn=load_elf_binary, 后续对fn的调用即是调用load_elf_binary，这是个非常长的函数，直到其最后，我们才找到所需要的答案：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b795b627619091\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int load_elf_binary(struct linux_binprm *bprm, struct pt_regs *regs)\r\n{\r\n        ...\r\n        start_thread(regs, elf_entry, bprm-&gt;p);\r\n        ...\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b795b627619091-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795b627619091-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795b627619091-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795b627619091-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795b627619091-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795b627619091-6\">6</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b795b627619091-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">load_elf_binary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">linux_binprm *</span><span class=\"crayon-v\">bprm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pt_regs *</span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795b627619091-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795b627619091-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795b627619091-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">start_thread</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">elf_entry</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bprm</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795b627619091-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795b627619091-6\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>上述代码中的elf_entry即为/sbin/init中的执行入口点， bprm-&gt;p为应用程序新栈(应该已经在用户空间了)，start_thread的实现为：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b795e336884345\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvoid\r\nstart_thread(struct pt_regs *regs, unsigned long new_ip, unsigned long new_sp)\r\n{\r\n        set_user_gs(regs, 0);\r\n        regs-&gt;fs = 0;\r\n        regs-&gt;ds = __USER_DS;\r\n        regs-&gt;es = __USER_DS;\r\n        regs-&gt;ss = __USER_DS;\r\n        regs-&gt;cs = __USER_CS;\r\n        regs-&gt;ip = new_ip;\r\n        regs-&gt;sp = new_sp;\r\n        /*\r\n         * Free the old FP and other extended state\r\n         */\r\n        free_thread_xstate(current);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b795e336884345-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b795e336884345-16\">16</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-1\"><span class=\"crayon-t\">void</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-2\"><span class=\"crayon-e\">start_thread</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pt_regs *</span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_ip</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_sp</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">set_user_gs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">regs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">fs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ds</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__USER_DS</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">es</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__USER_DS</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ss</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__USER_DS</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">cs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__USER_CS</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_ip</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">regs</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_sp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-13\"><span class=\"crayon-c\">         * Free the old FP and other extended state</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-14\"><span class=\"crayon-c\">         */</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b795e336884345-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free_thread_xstate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">current</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b795e336884345-16\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>在这里，我们看到了__USER_CS的身影，在x86 64位系统架构下，该值为0x33. start_thread函数最关键的地方在于修改了regs-&gt;cs= __USER_CS, regs-&gt;ip= new_ip，其实就是人为地改变了系统调用int $0x80指令压入堆栈的下条指令的地址，这样当系统调用结束通过iret指令返回时，代码将从这里的__USER_CS:elf_entry处开始执 行，也就是/sbin/init中的入口点。start_thread的代码与kernel_thread非常神似，不过它不需要象 kernel_thread那样在最后调用do_fork来产生一个task_struct实例出来了，因为目前只需要在当前进程上下文中执行代码，而不是创建一个新进程。关于kernel_thread，我在本版曾有一篇帖子分析过，当时基于的是ARM架构。</p>\n<p>所以我们看到，start_kernel在最后调用rest_init，而后者通过对kernel_thread的调用产生一个新进程(pid=1)，新进程在其kernel_init()–&gt;init_post()调用链中将通过run_init_process来执行用户空间的/sbin /init，run_init_process的核心是个系统调用，当系统调用返回时代码将从/sbin/init的入口点处开始执行，所以虽然我们知道 post_init中有如下几个run_init_process的调用：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7962561774345\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nrun_init_process(\"/sbin/init\");\r\nrun_init_process(\"/etc/init\");\r\nrun_init_process(\"/bin/init\");\r\nrun_init_process(\"/bin/sh\");</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7962561774345-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7962561774345-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7962561774345-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7962561774345-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7962561774345-1\"><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/sbin/init\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7962561774345-2\"><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/etc/init\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7962561774345-3\"><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/bin/init\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7962561774345-4\"><span class=\"crayon-e\">run_init_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/bin/sh\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>但是只要比如/sbin/init被成功调用，run_init_process中的kernel_execve函数将无法返回，因为它执行int $0x80时压入堆栈中回家的路径被后续的C函数调用链给改写了，这样4个run_init_process只会有一个有机会被成功执行，如果这4个函数都失败 了，那么内核将会panic. 所以内核设计时必须确保用来改写int $0x80压入栈中的cs和ip的start_thread函数之后不会再有其他额外的代码导致整个调用链的失败，否则代码将执行非预期的指令，内核进入不稳定状态。</p>\n<p>最后，我们来验证一下，所谓眼见为实，耳听为虚。再者，如果验证达到预期，也是很鼓舞人好奇心的极佳方法。验证的方法我打算采用“<a href=\"http://blog.chinaunix.net/uid-23769728-id-3087574.html\" target=\"_blank\">Linux设备驱动模型中的热插拔机制及实验</a>” 中的路线，通过call_usermodehelper来做，因为它和kernel_execve本质上都是一样的。我们自己写个应用程序，在这个应用程序里读取cs寄存器的值，程序很简单：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017c9b7966476666743\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;unistd.h&gt;\r\n#include &lt;syslog.h&gt;\r\n\r\nint main()\r\n{\r\n    unsigned short ucs;\r\n    asm(\r\n        \"movw %%cs, %0\\n\"\r\n        :\"=r\"(ucs)\r\n        ::\"memory\");\r\n    syslog(LOG_INFO, \"ucs = 0x%x\\n\", ucs);\r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017c9b7966476666743-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596017c9b7966476666743-15\">15</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-4\"><span class=\"crayon-p\">#include &lt;syslog.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-6\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-7\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">short</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ucs</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">asm</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"movw %%cs, %0\\n\"</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-o\">:</span><span class=\"crayon-s\">\"=r\"</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ucs</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-o\">::</span><span class=\"crayon-s\">\"memory\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">syslog</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">LOG_INFO</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"ucs = 0x%x\\n\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ucs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017c9b7966476666743-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017c9b7966476666743-15\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>然后把这个程序打到/sys/kernel/uevent_help上面(参照<a href=\"http://blog.chinaunix.net/uid-23769728-id-3087574.html\" target=\"_blank\">Linux设备驱动模型中的热插拔机制及实验</a>一文），之后我们往电脑里插个U盘，然后到/var/log/syslog文件里看输出(在某些distribution上，syslog的输出可能会到/var/log/messages中)：</p>\n<p>Mar 10 14:20:23 build-server main: <strong><span style=\"color: red\">ucs = 0x33</span></strong></p>\n<p>0x33正好就是x86 64位系统(我实验用的环境)下的__USER_CS.</p>\n<p>所以第一个内核进程(pid=1)通过执行用户空间程序，期间通过cs的转变(从__KERNEL_CS到__USER_CS)来达到特权级的更替。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111610\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111610votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111610\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png', 'full/d3d1a5ad957de059084690efae6fdfaa3527e1c3.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('通过机器学习来自动调优 DBMS，让任何人都可以部署数据库管理系统', '2017-07-07', 'http://blog.jobbole.com/111486/', '0f1644704be43e7b1d23c82609dce19c', 0, 1, 'IT技术, OtterTune, 数据库, 机器学习', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/upanblack\">Panblack</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://aws.amazon.com/cn/blogs/ai/tuning-your-dbms-automatically-with-machine-learning/\">AWS</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p><em>本文是卡耐基梅隆大学的 Dana Van Aken、Andy Pavlo 和 Geoff Gordon 所写。这个项目展示了学术研究人员如何利用 AWS Cloud Credits for Research Program 来助力他们的科技突破的。</em></p>\n<p>数据库管理系统（DBMS）是任何数据密集应用的关键部分。它们可以处理大量数据和复杂的工作负载，但同时也难以管理，因为有成百上千个“旋钮”（即配置变量）控制着各种要素，比如要使用多少内存做缓存和写入磁盘的频率。组织机构经常要雇佣专家来做调优，而专家对很多组织来说太过昂贵了。<a href=\"http://db.cs.cmu.edu/projects/autotune/\">卡耐基梅隆大学数据库研究组</a>的学生和研究人员在开发一个新的工具，名为 OtterTune，可以自动为 DBMS 的“旋钮”找到合适的设置。工具的目的是让任何人都可以部署 DBMS，即使没有任何数据库管理专长。</p>\n<p>OtterTune 跟其他 DBMS 设置工具不同，因为它是利用对以前的 DBMS 调优知识来调优新的 DBMS，这显著降低了所耗时间和资源。OtterTune 通过维护一个之前调优积累的知识库来实现这一点，这些积累的数据用来构建机器学习（ML）模型，去捕获 DBMS 对不同的设置的反应。OtterTune 利用这些模型指导新的应用程序实验，对提升最终目标（比如降低延迟和增加吞吐量）给出建议的配置。</p>\n<p>本文中，我们将讨论 OtterTune 的每一个机器学习流水线组件，以及它们是如何互动以便调优 DBMS 的设置。然后，我们评估 OtterTune 在 MySQL 和 Postgres 上的调优表现，将它的最优配置与 DBA 和其他自动调优工具进行对比。</p>\n<p>OtterTune 是卡耐基梅隆大学数据库研究组的学生和研究人员开发的开源工具，所有的代码都托管在 <a href=\"https://github.com/cmu-db/ottertune\">Github</a> 上，以 Apache License 2.0 许可证发布。</p>\n<h2>OtterTune工作原理</h2>\n<p>下图是 OtterTune 组件和工作流程</p>\n<p><img class=\"size-full wp-image-835 alignnone\" src=\"https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2017/05/31/ottertune_1.gif\" alt=\"\" width=\"800\" height=\"319\"></p>\n<p>调优过程开始，用户告知 OtterTune 要调优的最终目标（比如，延迟或吞吐量），客户端控制器程序连接目标 DBMS，收集 Amazon EC2 实例类型和当前配置。</p>\n<p>然后，控制器启动首次观察期，来观察并记录最终目标。观察结束后，控制器收集 DBMS 的内部指标，比如 MySQL 磁盘页读取和写入的计数。控制器将这些数据返回给调优管理器程序。</p>\n<p>OtterTune 的调优管理器将接收到的指标数据保存到知识库。OtterTune 用这些结果计算出目标 DBMS 的下一个配置，连同预估的性能提升，返回给控制器。用户可以决定是否继续或终止调优过程。</p>\n<p> </p>\n<h3>注意</h3>\n<p>OtterTune 对每个支持的 DBMS 版本维护了一份“旋钮”黑名单，包括了对调优无关紧要的部分（比如保存数据文件的路径），或者那些会产生严重或隐性后果（比如丢数据）的部分。调优过程开始时，OtterTune 会向用户提供这份黑名单，用户可以添加他们希望 OtterTune 避开的其它“旋钮”。</p>\n<p>OtterTune 有一些预定假设，对某些用户可能会造成一定的限制。比如，它假设用户拥有管理员权限，以便控制器来修改 DBMS 配置。否则，用户必须在其他硬件上部署一份数据库拷贝给 OtterTune 做调优实验。这要求用户或者重现工作负载，或者转发生产 DBMS 的查询。完整的预设和限制请看我们的<a href=\"http://db.cs.cmu.edu/papers/2017/tuning-sigmod2017.pdf\">论文</a> 。</p>\n<h1>机器学习流水线</h1>\n<p>下图是 OtterTune ML流水线处理数据的过程，所有的观察结果都保存在知识库中。</p>\n<p>OtterTune 先将观察数据输送到“工作流特征化组件”（Workload Characterization component），这个组件可以识别一小部分 DBMS 指标，这些指标能最有效地捕捉到性能变化和不同工作负载的显著特征。</p>\n<p>下一步，“旋钮识别组件”（Knob Identification component）生成一个旋钮排序表，包含哪些对 DBMS 性能影响最大的旋钮。OtterTune 接着把所有这些信息“喂”给自动调优器（Automatic Tuner），后者将目标 DBMS 的工作负载与知识库里最接近的负载进行映射，重新使用这份负载数据来生成更佳的配置。</p>\n<p><img class=\"size-full wp-image-836 alignnone\" src=\"https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2017/05/31/ottertune_2.gif\" alt=\"\" width=\"613\" height=\"193\"></p>\n<p>我们来深入挖掘以下机器学习流水线的每个组件。</p>\n<p><strong>工作负载特征化</strong>： OtterTune 利用 DBMS 的内部运行时指标来特征化某个工作负载的行为，这些指标精确地代表了工作负载，因为它们捕获了负载的多个方面行为。然而，很多指标是冗余的：有些是用不同的单位表示相同的度量值，其他的表示 DBMS 的一些独立组件，但它们的值高度相关。梳理冗余度量值非常重要，可以降低机器学习模型的复杂度。因此，我们基于相关性将 DBMS 的度量值集中起来，然后选出其中最具代表性的一个，具体说就是最接近中间值的。机器学习的后续组件将使用这些度量值。</p>\n<p><strong>旋钮识别</strong>： DBMS 可以有几百个旋钮，但只有一部分影响性能。OtterTune 使用一种流行的“特性-选择”技术，叫做 Lasso，来判断哪些旋钮对系统的整体性能影响最大。用这个技术处理知识库中的数据，OtterTune 得以确定 DBMS 旋钮的重要性顺序。</p>\n<p>接着，OtterTune 必须决定在做出配置建议时使用多少个旋钮，旋钮用的太多会明显增加 OtterTune 的调优时间，而旋钮用的太少则难以找到最好的配置。OtterTune 用了一个增量方法来自动化这个过程，在一次调优过程中，逐步增加使用的旋钮。这个方法让 OtterTune 可以先用少量最重要的旋钮来探索并调优配置，然后再扩大范围考虑其他旋钮。</p>\n<p><strong>自动调优器</strong>： 自动调优器组件在每次观察阶段后，通过两步分析法来决定推荐哪个配置。</p>\n<p>首先，系统使用工作负载特征化组件找到的性能数据来确认与当前的目标 DBMS 工作负载最接近的历史调优过程，比较两者的度量值以确认哪些值对不同的旋钮设置有相似的反应。</p>\n<p>然后，OtterTune 尝试另一个旋钮配置，将一个统计模型应用到收集的数据，以及知识库中最贴近的工作负载数据。这个模型让 OtterTune 预测 DBMS 在每个可能的配置下的表现。OtterTune 调优下一个配置，在探索（收集用来改进模型的信息）和利用（贪婪地接近目标度量值）之间交替进行。</p>\n<h2>实现</h2>\n<p>OtterTune 用 Python 编写。</p>\n<p>对于工作负载特征化和旋钮识别组件，运行时性能不是着重考虑的，所以我们用 <a href=\"http://scikit-learn.org/\">scikit-learn</a> 实现对应的机器学习算法。这些算法运行在后台进程中，把新生成的数据吸收到知识库里。</p>\n<p>对于自动调优组件，机器学习算法就非常关键了。每次观察阶段完成后就需要运行，吸收新数据以便 OtterTune 挑选下一个旋钮来进行测试。由于需要考虑性能，我们用 <a href=\"https://www.tensorflow.org/\" target=\"_blank\" rel=\"noopener noreferrer\">TensorFlow</a> 来实现。</p>\n<p>为了收集 DBMS 的硬件、旋钮配置和运行时性能指标，我们把 <a href=\"https://github.com/oltpbenchmark/oltpbench\" target=\"_blank\" rel=\"noopener noreferrer\">OLTP-Bench</a> 基准测试框架集成到 OtterTune 的控制器内。</p>\n<h2>实验设计</h2>\n<p>我们比较了 OtterTune 对 MySQL 和 Postgres 做出的最佳配置与如下配置方案进行了比较，以便评估：</p>\n<ul>\n<li>默认： DBMS 初始配置</li>\n<li>调优脚本： 一个开源调优建议工具做出的配置</li>\n<li>DBA： 人类 DBA 选择的配置</li>\n<li>RDS： 将亚马逊开发人员管理的 DBMS 的定制配置应用到相同的 EC2 实例类型。</li>\n</ul>\n<p>我们在<a href=\"https://aws.amazon.com/cn/ec2/spot/\">亚马逊 EC2 竞价实例</a>上执行了所有的实验。每个实验运行在两个实例上，分别是m4.large 和 m3.xlarge 类型：一个用于 OtterTune 控制器，一个用于目标 DBMS 部署。OtterTune 调优管理器和知识库部署在本地一台 20 核 128G 内存的服务器上。</p>\n<p>工作负载用的是 <a href=\"http://www.tpc.org/tpcc/\" target=\"_blank\" rel=\"noopener noreferrer\">TPC-C</a>，这是评估联机交易系统性能的工业标准。</p>\n<h2>评估</h2>\n<p>我们给每个实验中的数据库 —— MySQL 和 Postgres —— 测量了延迟和吞吐量，下面的图表显示了结果。第一个图表显示了“第99百分位延迟”的数量，代表“最差情况下”完成一个事务的时长。第二个图表显示了吞吐量结果，以平均每秒执行的事务数来衡量。</p>\n<h2>MySQL 实验结果</h2>\n<p><img class=\"alignnone size-full wp-image-837\" src=\"https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2017/05/31/ottertune_3.gif\" alt=\"\" width=\"641\" height=\"281\"></p>\n<p>OtterTune 生成的最佳配置与调优脚本和 RDS 的配置相比，OtterTune 让 MySQL 的延迟下降了大约 60%，吞吐量提升了 22% 到 35%。OtterTune 还生成了一份几乎跟 DBA 一样好的配置。</p>\n<p>在 TPC-C 负载下，只有几个 MySQL 的旋钮显著影响性能。OtterTune 和 DBA 的配置给这几个旋钮设置了很好的值。RDS 表现略逊一筹，因为给一个旋钮配置了欠佳的值。调优脚本表现最差，因为只修改一个旋钮。</p>\n<h2>Postgres 实验结果</h2>\n<p><img class=\"alignnone size-full wp-image-838\" src=\"https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2017/05/31/ottertune_4.gif\" alt=\"\" width=\"630\" height=\"254\"></p>\n<p>在延迟方面，相比 Postgres 默认配置，OtterTune、调优工具、DBA 和 RDS 的配置获得了近似的提升。我们大概可以把这归于 OLTP-Bench 客户端和 DBMS 之间的网络开销。吞吐量方面，Postgres 在 OtterTune 的配置下比 DBA 和调优脚本要高 12%，比 RDS 要高 32%。</p>\n<h2>结束语</h2>\n<p>OtterTune 将寻找 DBMS 配置旋钮的最优值这一过程自动化了。它通过重用之前的调优过程收集的训练数据，来调优新部署的 DBMS。因为 OtterTune 不需要生成初始化数据集来训练它的机器学习模型，调优时间得以大大减少。</p>\n<p>下一步会怎么样？ 为了顺应的越来越流行的 DBaaS （远程登录 DBMS 主机是不可能的），OtterTune 会很快能够自动探查目标 DBMS 的硬件能力，而不需要远程登录。</p>\n<p>想了解 OtterTune 的详细资料，请查看我们的<a href=\"http://db.cs.cmu.edu/papers/2017/tuning-sigmod2017.pdf\">论文</a>和 <a href=\"https://github.com/cmu-db/ottertune\">GitHub 上的代码</a>。关注这个<a href=\"http://ottertune.cs.cmu.edu/\">网站</a>，我们将很快让 OtterTune 成为一个在线调优服务。</p>\n<hr>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/bb6b0431912b5b441aac6477e67bd0d22.png\">\n            \n                            <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/381b4bd995d3cff3c32be73b9d0571b82.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111486\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111486votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111486\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack\">Panblack</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack\">\r\n			<img src=\"http://tp4.sinaimg.cn/1611865122/180/0/1\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            挺老的Linux新手        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/upanblack\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/upanblack/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 37</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://www.cnblogs.com/panblack\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/panblack\"><i class=\"fa fa-weibo\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"http://github.com/panblack\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'https://d2908q01vomqb2.cloudfront.net/f1f836cb4ea6efb2a0b1b99f41ad8b103eff4b59/2017/05/31/ottertune_1.gif', 'full/6b71dd8cb7b56ba90079b35343c571c0236eb5fb.jpg'),
('谈一下我们是如何开展code review的', '2017-07-07', 'http://blog.jobbole.com/111600/', '0f956401464bc9648fc64fd226ff5ecf', 2, 2, 'IT技术, Code Review, 代码审查', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/harlanc/p/6772394.html\">HarlanC</a>   </div><div id=\"cnblogs_post_body\">\n<p>众所周知，代码审查是软件开发过程中十分重要的环节，楼主结合自己的实际工作经验，和大家分享一下在实际工作中代码审查是如何开展的。</p>\n<p>笔者水平有限，若有错误和纰漏，还请大家指正。</p>\n<h2>代码审查的阻力</h2>\n<p>我想不通公司不同部门对代码审查这项工作的重视程度还是不一样的，对于代码审查的阻力总结了以下几点：</p>\n<ul>\n<li>国内的整体环境，国内的公司，尤其是互联网公司，讲究速度致上，软件开发的迭代周期周期短，速度快，因为竞争太大，开发的产品要求快速上线，对代码审查不是很重视，先上线，出了问题再解决。</li>\n<li>公司的规模，大公司重视流程，把代码审查作为软件开发中的重要一环，甚至计入考核，不管什么一旦成为制度，开展起来就相对容易了。小公司则不然，尤其是刚起步的，可能觉的代码审查没有必要。</li>\n<li>和你的领导有关系，就和上面说的，代码审查如果没有形成制度，如果你的领导是技术出身，明白代码审查的重要性，那么会要求你去做。如果是来自别的领域，可能认识不到它的重要性，觉的代码审查是浪费时间（就和代码重构一个道理）。</li>\n<li>个人原因，尤其是刚刚进入公司的员工，大学的软件工程课里面好像是没有介绍代码审查的，就是有，没有实际经验，也体会不到它的重要性，笔者刚入职时就是这么认为的。</li>\n</ul>\n<h2>代码审查的重要性</h2>\n<p>说了代码审查工作的开展遇到的阻力，下面说一下为什么代码审查是重要的。</p>\n<ul>\n<li>代码审查是保证代码质量的重要手段。软件缺陷可能隐藏在各个地方，测试是发现缺陷的重要方法，但专业的测试人员更多的可能是黑盒测试，他们不去关注代码内部的逻辑，只去关注代码实现的功能，有人说测试代码中的逻辑需要开发人员进行单元测试，一方面，单元测试覆盖率基本上不可能达到100%，另一方面，毕竟是单元测试，测试场景简单，有些复杂的场景有可能会测不到。各种测试完成后，如果还有缺陷，那只能让客户充当我们的“终极测试”了。抱怨会接踵而来，客户满意度会越来越低。所以，我们要想出一切可以使用的方法来进一步提高代码质量的方法，还有代码审查么，测试发现不了的问题，通过代码审查也许你能够发现。</li>\n<li>代码审查是熟悉软件架构，了解软件业务逻辑的好方法。学习代码是需要切入点的，一个上百万行代码的系统，从哪里开始着手，只能一个模块一个模块，一个组件一个组件的来熟悉，掌握。实现一个比较大的功能，你应该不会是唯一的开发人员，从系统架构师输出的系统设计，然后到各个团队中技术Lead输出的component级别的设计，到开始实现时，应该会把功能分为不同的模块有不同的开发人员协同实现。这是个学习的机会，不要只局限于自己这部分，为了了解这个大的功能，甚至和这个功能相关的其他已经实现的功能，你同样需要关注其他人的工作。有目的的看代码和漫无目的的浏览效果是不一样的，你已经对新功能有所了解，审查代码之前，你认为代码会怎么写，别人哪里和你想的不一样，旧功能和新功能是如何相互影响的等等，心里怀着问题，你的学习速度会更快，记得更加深刻。</li>\n<li>代码审查是你提高自己的好方法。前提是team中有经验丰富的开发人员的存在。也就是大牛，不要错过让他看你代码的机会，不要害怕他会为你写的代码挑出一大堆问题，有人说你自己写的代码就像自己的孩子，见不得别人说半点不字，不要固执，要内心平静的，客观的去看待你所写的代码，发现并解决问题才能提高你自己。也不要错过去review大牛代码的机会，看看大牛写出来的代码是怎样的，你可以取其精华。</li>\n<li>代码审查是需要功力的。网上有帖子说程序员的资深与否和工作年限没有必然联系，你是5年工作经验还是一个经验用了5年，这需要你去刻意练习，刚开始reveiew代码的时候你可能不习惯，也可能很痛苦，面对的一屏幕的代码不知如何下眼。但有一句话，如果你觉的内心很舒服，你就是在原地踏步。觉的痛苦说明你是在爬坡，刻意的去联系自己的大脑吧，今天你看一页代码可能用了一个小时，没有发现问题，但是坚持一个月甚至三个月之后，你看一眼就能够发现代码中的缺陷，恭喜你，你的功力加深了。</li>\n</ul>\n<h2>我们是如何开展代码审查的</h2>\n<p>好了。罗嗦了半天。下面开始说一下在楼主参与的项目中是如果开展code review的。</p>\n<p>第一家公司，是一家国内的大公司，就不说名字了，我所在的部门开发的产品众多，换项目很频繁，我参与的有3,4个吧，开发流程不规范，部门老大没有对代码审查有硬性要求。但带我的老师，也是项目经理（但是主要做技术，所以也可以说是技术经理）是一个非常热衷于技术的人，应该说明白代码review的重要性，我们敏捷团队有4个开发，每次写完代码后，都会进行team review。把代码投到大屏幕上，然后老师带我们去review代码。印象深刻的一次是一个同事着急回家过年，草草把代码就提交走人了，被师傅挑出来很多问题。换了项目和项目经理之后，代码review就不了了之了。</p>\n<p>第二家公司，是一个外企，有几十年的历史了，开发流程算是比较规范了，而且分工明确。在这家公司我们的大老板（也就是技术经理的上司）对代码review是有要求的，下面详细说明我们的代码审查是如何一步一步演进的。</p>\n<ul>\n<li>第一阶段   team review + TFVC</li>\n</ul>\n<p>先简单介绍下我们的版本控制工具：微软的TFVC，代码的branch是按如下图创建的，有一个main branch每个scrum team一个branch，出release之前把各个team的branch merge回main,最后出release branch，release branch上修复的bug也要最终回main。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/2ce8213fa488fb70614d3dc5fc9cff64.png\" alt=\"\"></p>\n<p>开始的时候我们是没有peer review的，每两周开一次team review。一个主持人，负责预定会议室，操作visual studio查看最近两周提交的changeset，一个记录员，负责记录发现的问题，相关功能的开发人员负责讲解和解答疑问。最后记录员将review结果记录到wiki中并发送到整个开发部门。</p>\n<ul>\n<li>第二阶段 自律TFVC + peer review + team review</li>\n</ul>\n<p>记不太清是从哪个visual studio版本开始支持code review了，好像是VS2012。在提交之前每个开发人员需要将代码提交给至少一个人进行review，然后生成一个code review的work item。你需要将这个work item链接到你的changeset中才能check in代码，不然我们公司自定义的policy会发出警告。这些警告是可以被忽略的，然后也能强制提交。前面说过部分老大对code review是很重视的，如何才能检查peer review的结果呢？对，将这些code review的work item数据进行查询，将没有链接work item的changeset过滤出来，然后将结果显示。技术经理和老大一眼就能看到谁没有遵守这个流程。尽管这么做了，开始执行的时候还是有不少的人出现在查询结果中。</p>\n<p>说一下自律的问题，公司添加这个查询review结果的措施是手段，只是在某种程度上保证了流程，但目的是什么？目的是需要收到review请求的成员认认真真的review代码，而不是随便的走一下流程就OK。如果你认识到review的重要性，你可能会用心一点吧。</p>\n<p>我们的team review 会议依然在进行，和peer review的区别就是peer review只给一个人或者少数的人进行review，而team review 是在整个scrum team间进行。</p>\n<ul>\n<li>第三阶段 GIT + peer review + team review</li>\n</ul>\n<p>我们的公司虽然历史悠久，但对一些流程的工具和技术还是极力推崇的。大家都知道GIT是非常流行的版本控制工具，visual studio 2012也开始支持GIT，我们也一步一步的 将source code移到了TFS-GIT中。</p>\n<p>和TFVC相比，GIT的branch是非常轻量级的，你可以很容易并且快速的创建一个branch。所以我们现在可以将branch进行细分了。TFVC和GIT的代码提交也不一样，TFVC是集中式的，最全的代码放在server上，你需要一个branch的code时要将其check out到本地。每次提交都是把代码从local一次性merge到server，如果出现conflicts,你需要在本地处理然后check in。GIT是分布式的，每个人clone的时候都会把所有分支download到本地，代码提交是通过pull request来进行的，也就是通过branch之间的merge来进行，这一点刚从TFVC转到GIT的时候很难理解。这样就得为每个人创建一个临时branch，注意这个branch在本地和server端同时存在，我们用这个branch开发自己的代码并用这个branch进行merge code。这里的pull request就相当于TFVC中的code review，TFVC你还可以偷懒忽略code review的work item，在这里就是强制性的了，没有pull request，别人不会approve你的代码，你根本就没有方法将你的代码merge到feature branch中。</p>\n<p>还有team review会议也是照常进行的。</p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111600\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111600votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111600\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2016/04/8d67b7db1e9704c55aad01b886ec4c46.jpg', 'full/dfa8fff3b99c7011381e1666d2c2ba0015a7c34f.jpg'),
('我眼中的项目经理', '2017-07-07', 'http://blog.jobbole.com/111535/', '2139dbe97ca8c52f95ad3657fd02203b', 3, 1, '职场, , 程序员, 职场, 项目经理', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/ljhdo/p/5068072.html\">Vic Liu</a>   </div><div>\n<h3>把想法变成项目，服务于业务</h3>\n<p>在项目组待的时间久了，渐渐地跟微软的项目经理Michael熟悉起来了，跟他有过很多次深入的聊天，向他请教过很多关于人生，理想，技术上的问题，不得不说，项目经理是我神往的角色。虽然我没有亲身经历过，但是我认为做项目经理很有意思，把一个想法变成项目，服务于业务，这是我期望的工作。 佛者说：“一花一世界，一叶一菩提”，不得不说，修行是一个技术活，面对同一个世界，眼界的不同，能够看到的事物也是不同的；同样一句话，阅历不同，理解也会不同。那我就说说我眼中的项目经理，与常人不同的是，他们总是更进一步，想的更多，做的更多。</p>\n<p>在每天的Daily Scrum会议上，Michael照例追踪分配给每个人的Task的完成情况，并分配新的Task。这种一成不变的例行汇报，听的多了，就有点习以为常了，左耳朵进，右耳朵出，当然，起码得“留一点痕迹”，至少得知道自己新的Task。在项目不是很复杂的时候，即使做不同样的事情，也大概知道彼此做事的内容。可是有一次，在同事小林汇报工作时，即使我集中十二分的注意力，也听不懂小林说话的内容，但是，Michael却能瞬间找到关键点，那一刻，我才知道什么叫“默契”，我能感受到小林的开心，因为有人很懂她。</p>\n<p>我请教过这个问题，Michael说：“这是由于‘信息不对称’导致的，因为我负责整个项目的进度和业务，跟所有的开发工程师（Developer）都有交集，交流比较多，知道他们在做什么，能听懂他们说的话，这很正常，不用诧异。”我觉得信息不对称，固然是一个重要的原因，但是，不是最主要的。我曾经在汇报工作时，对于数据库中出现的一个问题，提出了一个解决方案，由于这个想法是临时想出来的，我在描述解决方案时，没有组织好语言，说的磕磕绊绊，我认为我没有说清除，但是，Michael却出乎我意料之外的理解了，并把我的不成熟的想法完善了，当时，我意识到，有人懂我，是多么的开心，也理解了同事小林当时喜悦的心情。这是信息不对称，善于沟通所不能解释的，我认为，熟悉业务，善于思考，对项目经理来说，才是最重要的特质。</p>\n<h3>换位思考</h3>\n<p>还有一件事，由于同事小陈离职了，我开始接手PowerBI报表，在跟业务分析小组的同事共事时，我发现他们身上有一个显著的个性，就是：<strong>站在老板的立场上思考问题，组织语言和汇报工作。</strong>在我第一次无意识地向老板直接汇报工作时，我犯了很多技术出身的开发人员经常忽视的错误，那就是不自觉地在报告中掺杂了太多的开发术语，没有意识到，我面对的客户是一位不懂技术，但深谙业务的老板。沈姐是业务分析小组实际上的Leader，她跟我说：“你不能那样向老板回邮件，老板不懂技术，只懂业务，你要翻译成他们能够理解的内容，他们才知道，你已经把问题解决了，不然，他们又会发邮件问你。”</p>\n<p>有了沈姐的开导，我开始意识到，在工作上，必须具有换位思考的意识：站在老板的角度上来看待问题，但意识到，不代表你就能做到，这是一个技术活。当老板再次发送邮件，提出新的业务需求时，我又犯错了，这次的错误，是由于信息不对称导致的，也跟我缺少历练有关。老板在邮件中，说到：“请提供报表数据，用于分析组织者（Organizer）每个月在活动中的贡献（Contribution）。”由于在业务逻辑中，组织者（Organizer）是管理者角色的一种，除了Organizer，还有Co-Organizer，Event-Organizer，Assistant-Organizer等管理者角色，我提供的报表数据仅仅是Organizer角色每个月的贡献。Michael在Review代码时，认真对我说：“Vic，老板不知道我们具体的角色分类，老板想知道的，其实是所有组织者在每个月的贡献，要站在老板的角度上，处理问题。给老板的报表，每一个数据上的细节都必须做到有理有据，即使数据对不上，不align，也必须要有合理的解释。”这次教训非常深刻，我意识到，老板是特殊的存在，必须理解老板的意思，同时，也必须把自己的意思传达给老板，这中间需要由一个词汇的转换，怎样做到？站在老板的角度上，思考问题，处理问题，刚开始做的不好，不要紧，必须要有这个意识（Sense）和觉悟。</p>\n<h3>项目经理是整个项目组的大脑</h3>\n<p>这样说一点也不为过，至少在我们项目组是这样的，其他成员具备的是执行力，也就是按时完成任务的能力。这里抛出一个问题：给你一个团队，你要如何带？在两年多的时间里，Michael带领我们团队做过很多新的项目，而每个新的项目都不是凭空想出来的。之所以这么说，是因为，我也曾经有过相同的想法，但是，我没有意识到这个想法的价值，在脑海中思考过之后，没有把想法“变现”的意识，导致轻易把想法抛弃；一旦Michael提出类似的新项目之后，我发觉：“我曾经也有过这个想法，只不过，我没有继续深入下去，没有更进一步去丰富这个想法 ……”</p>\n<p>反省不能解决问题，或许，这才是项目经理应该具备的优秀性格：不是想不到，而是善于发现想法的价值。Michael把抽象的想法，变成文档上的设想，经过丰富之后，变成有价值的具体项目，这就是创建价值，简化业务的过程。Michael说：“我想实现的新项目，实际上就是为了优化业务流程，做到化繁为简，而为了实现这个目的，必须化简为繁。比如，为了便于发现更多有影响力的人物（Influencer），必须整合所有的数据资源，从各个数据源中分析数据，这是我们的主要业务需求，为了简化这个流程，可以把这套业务流程扩大化，自动化，做一个更为复杂的引擎来替代手工，一旦这个繁的引擎做出来，业务流程就会变的非常简单。”抓住主要业务搞优化，实现项目的增值和技术的迭代，这其实也是他的一种管理思想，极简工作：先解决主要矛盾，再解决次要矛盾，根据业务需求，调整优先级。</p>\n<h3>项目经理很忙的</h3>\n<p>实际上，我观察到Michael的工作，1/3是在开会。不仅跟开发者开会，而且跟老板开会。我们的老板是外国人，Michael的英语相当不错，上海人，软实力杠杠滴，从小到大接受的教育，是我们这些屌丝所不能想象的。跟老板开会的内容，大致是谈论业务需求，演示新的项目，Michael说：“老板是非常聪明的，非常熟悉业务，对于新的项目，老板只要看到demo，自然会想到如何使用，不需要过多的文字说明”，好吧，高级别的老板，我也没有接触过，能坐到那个位置上，肯定有过人之处。跟开发者开会，Michael主要是演示项目，把控项目的进度和分配任务。</p>\n<p>Michael在任务的管控上，没有绝对的收和放，而是：前期放任，定时检查，最后是测试和验收。不过，他的管理风格还是比较自由的，他说：“我分配一个任务交给你们来做，你们想怎么做，就怎么做，只要实现业务需求就行。我的任务不是告诉你们如何去做，而是，告诉你们怎么做最简单，哪些是当前的业务上能够满足的，哪些是当前不需要做的。”</p>\n<h3>项目经理很忙的</h3>\n<p>但是，Michael能够记住很多非常细节的业务逻辑，不得不佩服他得记忆力，是不是项目经理的记忆力都很好？Michael说：“首先，这些关键的业务逻辑是我设置的，我当然记得比较牢，其次，我能记住的，实际上是关键的业务逻辑，经常遇到，那些特殊的设置，我也是需要阅读代码才知道。”我觉得，跟普通的开发工程师不同，项目经理更擅长处理业务上的问题。身价一万和身价十万的差距，没有想象中那么大，通过努力，日积月累，我也能做项目经理。阿Q一下，梦想还是要有的，万一实现了。</p>\n<h3>关于加薪</h3>\n<p>这是一个非常具有挑战性的问题，除非你在项目组中是不可替代的，否则，你就只能拿着offer，或者跳槽来提升身价，但是，那些项目经理是如何从普通的开发工程师，一步步被提拔上去的呢？运营经理范老板给出一份答案：创造额外的价值，注意，是额外的价值，而不仅仅是本职工作。在公司的动员大会上，有一句很流行的话：要想成为项目经理，必须先干项目经理的活。当然这些话都出自高层之口，尽管，事实上，大多数Leader都是空降的，仍然会有人心灵淹死在鸡汤中。很多开发工程师，包括我，天真地认为，只要做好本职工作，提升技术实力，就能获得公司的认可和嘉奖，获得升职和加薪的机会，就像运营经理说的那样，“这是技术人员的一条路线，稳定而平缓，但是，如果想快速提升，走一条陡峭的上升路线，必须创造额外的价值，当你为公司创造额外价值的时候，公司也会给你提供更好的发展空间。”其实，道理都是相通的，打铁还需自身硬，公司不会给你机会试炼，而会给你空间发挥，前提是你必须比身边的人优秀，才有能力抓住机会。</p>\n<p>这一个个小故事，都是真实的，给我很多启发，在人生的道路上，能够聆听到成功者的教诲，是最难能可贵的，谢谢！</p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111535\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111535votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111535\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2016/08/25e260d52cd3cc8e5ae1638dd3ab4271.jpg', 'full/1ded311d6e5e90e971d375817a4f5efb8e7096f1.jpg'),
('让程序员跨界做设计，脑洞开的万万想不到', '2017-07-07', 'http://blog.jobbole.com/111518/', '28c734bfc805d9104aada552c0c94048', 1, 4, '趣文小说, , 趣文', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://www.oschina.net/news/85952/th-worst-volume-control-design-contest\">开源中国社区/王练</a>   </div><p>如果程序员来做设计，世界会变成什么样子？</p>\n<p>著名社交新闻网站 Reddit 最近举办了一个“最糟糕音量键设计大赛”，起因是一个程序员在 Reddit 晒出了自己设计的一款“不同寻常”的音量控制键，并号召大家加入到设计当中来。</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fgqlqodsdlg20d407s40w.gif\" width=\"472\" height=\"280\"></p>\n<p>程序员们分别按照自己的想法，重新设计了电脑的音量大小按键，比如这样的：</p>\n<blockquote><p>我也不知道音量大小是多少，全都是凭运气来调整的，想要改音量的时候就 roll 一下</p></blockquote>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fgqlqoib21g20dy06z76y.gif\" width=\"502\" height=\"251\"></p>\n<blockquote><p>快把音量调到50！等等，等等，我再晃一下，刚刚晃过了…</p></blockquote>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/63918611gy1fgqlqpgt5fg20ir06wqv5.gif\" width=\"675\" height=\"248\"></p>\n<p>愤怒的小鸟？</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fgqlqpwtikg20dw06y41h.gif\" width=\"500\" height=\"250\"></p>\n<p>单身几十年的手速终于排上用场了</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fgqlqqzjgeg20fm0dg7wh.gif\" width=\"562\" height=\"484\"></p>\n<p>学渣的末日</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fgqlqra6u8g20dm02yglm.gif\" width=\"490\" height=\"106\"></p>\n<p>论“鼠标手”是怎么炼成的</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/63918611gy1fgqlqrtsxyg20ie0aemzf.gif\" width=\"662\" height=\"374\"></p>\n<p>给我一天时间，我能画个蒙娜丽莎出来</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fgqlqs8ecsg20go0ctdqu.gif\" width=\"600\" height=\"461\"></p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111518\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111518votetotal\">4</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111518\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 7 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/04/7a91ae8776d0953ac776284a7d92e861.jpg', 'full/e4ef10899dd499cd91f9102bff717ea3d2311bfc.jpg'),
('Linus Torvalds 说 Linux 仍然惊讶和激励着他', '2017-07-07', 'http://blog.jobbole.com/111571/', '2e6de1dd2090382bf77a14e74b18bde3', 1, 1, 'IT技术, Linus Torvalds', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.linux.com/blog/event/lc3-china/20176/6/linus-torvalds-explains-how-linux-still-surprises-and-motivates-him\">Linux 基金会</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-8638-1.html\">Linux中国</a>   </div><p>周一，Linus Torvalds 首次来到中国参加<a class=\"ext\" href=\"https://www.lfasiallc.com/linuxcon-containercon-cloudopen-china\" target=\"_blank\" rel=\"external nofollow\">在北京召开的 LinuxCon + ContainerCon + CloudOpen</a>。在近 2000 名观众面前，Linus Torvalds 和 VMware 开源负责人 Dirk Hohndel 进行了进行了一次“炉边聊天”，谈及是什么在惊讶和激励着他，以及有志的开源开发者们该如何上手。下面是他们谈话中的一些亮点。</p>\n<h3 id=\"toc_1\">Linux 开发中有什么令人惊讶的事情?</h3>\n<blockquote><p>“我觉得有趣的是我认为已经稳定的代码仍然在不断的得到改进，有些东西我们已经很多年没有碰了，然后有人来改进了它们，或者在我以为根本就不会有人用的东西上提交了 Bug 报告。我们有了新的硬件，开发了新的功能，但是 25 年后，我们仍然有老的、非常基础的东西，并且人们依然在关心和改善着它们。”</p></blockquote>\n<h3 id=\"toc_2\">什么在激励着他</h3>\n<blockquote><p>“我真的很喜欢我正在做的事情。我喜欢醒来时有一个在技术上有趣而富有挑战性并且不太紧张的工作，因此我可以长时间的为此工作；或者做一些我感觉我正在做一个真正有影响的事情，做一些不仅仅是对我来说有意义的事情。</p>\n<p>“我偶尔在工作中休息一下，例如我在 Git 上工作两到三周的时候就开始休息了。但是每次休息的时间比较长我都会感到无聊厌倦。当我出去潜水一周，就想着要回来，我从没有感觉我需要一个更长的假期。”</p></blockquote>\n<p>（LCTT 译注：此处“在 Git 上工作” 是指 Linus 在 Git 版本仓库里面开发 Linux 内核，而非开发 Git 软件——事实上，Linus 在早期开发完 Git 的原型之后，主要的 Git 开发已经有别人接手了，虽然他被称之为 Git 之父。而“潜水”是真的指潜水运动，Linus 喜好玩潜水运动。）</p>\n<h3 id=\"toc_3\">Linux 的未来领导力</h3>\n<blockquote><p>“我们的工作进程不会只是 25 年，我们仍然有非常强大的维护团队。我们常常抱怨我们没有足够的维护者 – 这是真的，我们只有数十名顶级维护者做日常合并的工作，这对于一个开源项目来说是一个非常强大的团队。而且随着这些顶级维护者慢慢变老变胖，我们不断有新人进来。一个新人成长为一个顶级维护者需要几年的时间，因此我不觉得我们应该为 Linux 的下一个 20 年担心。”</p></blockquote>\n<h3 id=\"toc_4\">Linux 会被替代吗？</h3>\n<blockquote><p>“或许会有一些新的项目将来会并且表明他们比我们做的更好，但是我不担心这个。有很多非常成功的 Linux 的分支（fork），人们不会把它们看作是分支是因为他们很和谐。如果有人想要改变一切并且让内核变得更好，我的感觉是，干吧，证明你自己。我可能觉得那是一个坏主意，但是你可以证明我是错的。”</p></blockquote>\n<p>（LCTT 译注：此处所说的分支，应该是指类似 Android、AGL 等 Linux 分支并没有分裂 Linux 生态，而是彼此补充。）</p>\n<h3 id=\"toc_5\">对 Git 的想法</h3>\n<blockquote><p>“我对 Git 的广泛传播感到非常的惊讶。显然我非常高兴，它验证了我对分布式开发的看法。然而那时，已经有如此之多的源码版本控制工具，很难再去推出一个新的版本控制系统。我预计它主要限于内核开发 – 因为它是针对我们所做的。”</p>\n<p>“在刚开始的三到四年里，关于 Git 的抱怨是它如此的与众不同，难以使用。大约五年前，事情发生了改变。有足够多的项目和开发者开始使用 Git ，它变得不再与众不同；人们习惯于使用 Git 。他们开始利用这种开发模式，使用 Git 的安全感，意味着任何东西都不会损坏或者丢失。”</p>\n<p>“在某些方面，Git 比 Linux 更为人所知。Linux 常常被隐藏起来，例如安卓手机就运行在 Linux 之上，但是你并不知道。但是使用 Git 时，你确切地知道你在使用 Git 。”</p></blockquote>\n<h3 id=\"toc_6\">分支 Linux</h3>\n<blockquote><p>“当我坐下来开始写 Git ，一个首要的原则就是你应该能 fork 并且在此基础上做你自己的事情。如果你有友好的 fork（能证明我错了，并且能够改进内核），在这种情况下，人们可以回来说我们实际上改进了内核，这没有什么不好的感觉。我会采纳你的改进并且将其合并进来。这就是为什么你应该鼓励 fork 。你也想让良好的回馈变得很简单。”</p></blockquote>\n<h3 id=\"toc_7\">开源开发者应该如何开始</h3>\n<blockquote><p>“于我而言，我总是自我激励，知道自己想要做什么，我从来没有被告知要去做什么。我不确定我的例子是否适合人们效仿。如果你是一个新手程序员，你可以从成千上万的开源项目中找到你所感兴趣的，你可以长期关注这个项目，去了解它的代码，以至于你可以在某个部分的代码上可以成为专家，不需要是整个项目。没有人是整个内核的专家，但是你可以很好地了解其中的一个领域。”</p>\n<p>“如果你能成为社区的一份子，能提交补丁，那将不仅仅是编程，而是有开源社会方面的意义。你作为一个程序员提升了你自己并且和外界联系了起来。你基本上可以向外展示 – 我做了这些改进，我有能力在我的社区或者工作上走得更远。你不得不花费一定的时间来学习一个项目，但是你将有一个巨大的上升空间 – 不仅仅是从职业方面，而且在你的生活中有一个惊人的项目。”</p></blockquote>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111571\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111571votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111571\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png', 'full/d3d1a5ad957de059084690efae6fdfaa3527e1c3.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('理解 Linux 的平均负载和性能监控', '2017-07-07', 'http://blog.jobbole.com/111590/', '34b5869fcba12edc398c702d1a036624', 5, 1, 'IT技术, Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.tecmint.com/understand-linux-load-averages-and-monitor-performance/\">Aaron Kili </a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-8632-1.html\">Linux中国 / kylecao</a>   </div><p>在本文中，我们将解释 Linux 系统中最关键的管理任务之一——关于系统 / CPU 的负载和平均负载的性能监控。</p>\n<p>首先来看所有的类 UNIX 系统中两个重要的表述:</p>\n<ul>\n<li>系统负载 / CPU 负载 – 衡量 Linux 系统的 CPU 过载或利用率低的指标，即处于运算状态或等待状态的 CPU 核心数。</li>\n<li>平均负载 – 通过固定的时间周期如 1、5、15 分钟计算出的平均的系统负载。</li>\n</ul>\n<p>Linux 中，平均负载一般指在内核运行队列中被标记为运行或不可打断状态的进程的平均数。</p>\n<p>注意：</p>\n<ul>\n<li>几乎没有 Linux 或类 Unix 系统不为用户展示平均负载的值。</li>\n<li>完全空闲的 Linux 系统平均负载为 0，不包括空闲进程。</li>\n<li>绝大多数类 Unix 系统只统计运行和等待状态的进程。但是在 Linux 中，平均负载也包括处于不可打断的睡眠状态的进程——它们是在等待其它系统资源如磁盘 I/O 等的进程。</li>\n</ul>\n<h3 id=\"toc_1\">如何监测 Linux 系统平均负载</h3>\n<p>有诸多方式监测系统平均负载，如 <code>uptime</code>，它会展示系统运行时间、用户数量及平均负载：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f3933461999888\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ uptime\r\n07:13:53 up 8 days, 19 min,  1 user,  load average: 1.98, 2.15, 2.21</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f3933461999888-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3933461999888-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f3933461999888-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">uptime</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3933461999888-2\"><span class=\"crayon-cn\">07</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">13</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">53</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">up</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">8</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">days</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">19</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">load </span><span class=\"crayon-v\">average</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.98</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2.15</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2.21</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>平均负载的数字从左到右的含义依次为:</p>\n<ul>\n<li>最近 1 分钟的平均负载为 1.98</li>\n<li>最近 5 分钟的平均负载为 2.15</li>\n<li>最近 15 分钟的平均负载为 2.21</li>\n</ul>\n<p>高平均负载意味着系统是过载的：许多进程在等待 CPU 时间。</p>\n<p>下一节将介绍平均负载和 CPU 核数的关系。此外，常用的工具 <a href=\"https://www.tecmint.com/12-top-command-examples-in-linux/\">top</a> 和 <a href=\"https://linux.cn/article-6882-1.html\">glances</a> 可以实时显示 Linux 系统的运行状态：</p>\n<h4 id=\"toc_2\">Top命令</h4>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f393e044492303\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ top</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f393e044492303-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f393e044492303-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">top</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>显示运行中的Linux进程：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f3942862901424\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-mixed-highlight\" title=\"含多种语言\"></span><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntop - 12:51:42 up  2:11,  1 user,  load average: 1.22, 1.12, 1.26\r\nTasks: 243 total,   1 running, 242 sleeping,   0 stopped,   0 zombie\r\n%Cpu(s): 17.4 us,  2.9 sy,  0.3 ni, 74.8 id,  4.6 wa,  0.0 hi,  0.0 si,  0.0 st\r\nKiB Mem :  8069036 total,   388060 free,  4381184 used,  3299792 buff/cache\r\nKiB Swap:  3906556 total,  3901876 free,     4680 used.  2807464 avail Mem \r\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                        \r\n6265 tecmint   20   0 1244348 170680  83616 S  13.3  2.1   6:47.72 Headset                                                                                                                                        \r\n2301 tecmint    9 -11  640332  13344   9932 S   6.7  0.2   2:18.96 pulseaudio                                                                                                                                     \r\n2459 tecmint   20   0 1707692 315628  62992 S   6.7  3.9   6:55.45 cinnamon                                                                                                                                       \r\n2957 tecmint   20   0 2644644 1.035g 137968 S   6.7 13.5  50:11.13 firefox                                                                                                                                        \r\n3208 tecmint   20   0  507060  52136  33152 S   6.7  0.6   0:04.34 gnome-terminal-                                                                                                                                \r\n3272 tecmint   20   0 1521380 391324 178348 S   6.7  4.8   6:21.01 chrome                                                                                                                                         \r\n6220 tecmint   20   0 1595392 106964  76836 S   6.7  1.3   3:31.94 Headset                                                                                                                                        \r\n1 root      20   0  120056   6204   3964 S   0.0  0.1   0:01.83 systemd                                                                                                                                        \r\n2 root      20   0       0      0      0 S   0.0  0.0   0:00.00 kthreadd                                                                                                                                       \r\n3 root      20   0       0      0      0 S   0.0  0.0   0:00.10 ksoftirqd/0                                                                                                                                    \r\n5 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H   \r\n....</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3942862901424-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3942862901424-19\">19</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-1\"><span class=\"crayon-v\">top</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">51</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">42</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">up</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">11</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">load </span><span class=\"crayon-v\">average</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.22</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.12</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.26</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-2\"><span class=\"crayon-v\">Tasks</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">243</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">running</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">242</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sleeping</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">stopped</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">zombie</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-3\"><span class=\"crayon-ta\">%</span><span class=\"crayon-e\">Cpu</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">17.4</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">us</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2.9</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sy</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ni</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">74.8</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">4.6</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hi</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">si</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">st</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-4\"> </div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-5\"><span class=\"crayon-e\">KiB </span><span class=\"crayon-v\">Mem</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">8069036</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">388060</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">free</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">4381184</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">used</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">3299792</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buff</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">cache</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-6\"><span class=\"crayon-e\">KiB </span><span class=\"crayon-v\">Swap</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">3906556</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">3901876</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">free</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">4680</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">used</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2807464</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">avail </span><span class=\"crayon-e\">Mem </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-7\"><span class=\"crayon-e\">PID </span><span class=\"crayon-e\">USER      </span><span class=\"crayon-e\">PR  </span><span class=\"crayon-e\">NI    </span><span class=\"crayon-e\">VIRT    </span><span class=\"crayon-e\">RES    </span><span class=\"crayon-i\">SHR</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">CPU</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-e\">MEM     </span><span class=\"crayon-v\">TIME</span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">COMMAND</span><span class=\"crayon-h\">                                                                                                                                        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-8\"><span class=\"crayon-cn\">6265</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1244348</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">170680</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">83616</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">13.3</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2.1</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">47.72</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Headset</span><span class=\"crayon-h\">                                                                                                                                        </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-9\"><span class=\"crayon-cn\">2301</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">9</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">11</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">640332</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">13344</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">9932</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6.7</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.2</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">18.96</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">pulseaudio</span><span class=\"crayon-h\">                                                                                                                                     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-10\"><span class=\"crayon-cn\">2459</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1707692</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">315628</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">62992</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6.7</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">3.9</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">55.45</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cinnamon</span><span class=\"crayon-h\">                                                                                                                                       </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-11\"><span class=\"crayon-cn\">2957</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2644644</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.035g</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">137968</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6.7</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">13.5</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">50</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">11.13</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">firefox</span><span class=\"crayon-h\">                                                                                                                                        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-12\"><span class=\"crayon-cn\">3208</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">507060</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">52136</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">33152</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6.7</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.6</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">04.34</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gnome</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">terminal</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">                                                                                                                                </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-13\"><span class=\"crayon-cn\">3272</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1521380</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">391324</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">178348</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6.7</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">4.8</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">21.01</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">chrome</span><span class=\"crayon-h\">                                                                                                                                         </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-14\"><span class=\"crayon-cn\">6220</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1595392</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">106964</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">76836</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6.7</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">1.3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">3</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">31.94</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Headset</span><span class=\"crayon-h\">                                                                                                                                        </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-15\"><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">root</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">120056</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">6204</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">3964</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.1</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">01.83</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">systemd</span><span class=\"crayon-h\">                                                                                                                                        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-16\"><span class=\"crayon-cn\">2</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">root</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">00.00</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">kthreadd</span><span class=\"crayon-h\">                                                                                                                                       </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-17\"><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">root</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">00.10</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ksoftirqd</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">                                                                                                                                    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3942862901424-18\"><span class=\"crayon-cn\">5</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">root</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">00.00</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kworker</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">0H</span><span class=\"crayon-h\">   </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3942862901424-19\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0134 seconds] -->\r\n<p></p>\n<h4 id=\"toc_3\">Glances 工具</h4>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f3947832288099\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ glances</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f3947832288099-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f3947832288099-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">glances</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>Glances – Linux系统监测工具：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f394b231802040\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nTecMint (LinuxMint 18 64bit / Linux 4.4.0-21-generic)                                                                                                                                               Uptime: 2:16:06\r\nCPU      16.4%  nice:     0.1%                                        LOAD    4-core                                        MEM     60.5%  active:    4.90G                                        SWAP      0.1%\r\nuser:    10.2%  irq:      0.0%                                        1 min:    1.20                                        total:  7.70G  inactive:  2.07G                                        total:   3.73G\r\nsystem:   3.4%  iowait:   2.7%                                        5 min:    1.16                                        used:   4.66G  buffers:    242M                                        used:    4.57M\r\nidle:    83.6%  steal:    0.0%                                        15 min:   1.24                                        free:   3.04G  cached:    2.58G                                        free:    3.72G\r\nNETWORK     Rx/s   Tx/s   TASKS 253 (883 thr), 1 run, 252 slp, 0 oth sorted automatically by cpu_percent, flat view\r\nenp1s0     525Kb   31Kb\r\nlo           2Kb    2Kb     CPU%  MEM%  VIRT   RES   PID USER        NI S    TIME+ IOR/s IOW/s Command \r\nwlp2s0        0b     0b     14.6  13.3 2.53G 1.03G  2957 tecmint      0 S 51:49.10     0   40K /usr/lib/firefox/firefox \r\n7.4   2.2 1.16G  176M  6265 tecmint      0 S  7:08.18     0     0 /usr/lib/Headset/Headset --type=renderer --no-sandbox --primordial-pipe-token=879B36514C6BEDB183D3E4142774D1DF --lan\r\nDISK I/O     R/s    W/s      4.9   3.9 1.63G  310M  2459 tecmint      0 R  7:12.18     0     0 cinnamon --replace\r\nram0           0      0      4.2   0.2  625M 13.0M  2301 tecmint    -11 S  2:29.72     0     0 /usr/bin/pulseaudio --start --log-target=syslog\r\nram1           0      0      4.2   1.3 1.52G  105M  6220 tecmint      0 S  3:42.64     0     0 /usr/lib/Headset/Headset \r\nram10          0      0      2.9   0.8  409M 66.7M  6240 tecmint      0 S  2:40.44     0     0 /usr/lib/Headset/Headset --type=gpu-process --no-sandbox --supports-dual-gpus=false --gpu-driver-bug-workarounds=7,2\r\nram11          0      0      2.9   1.8  531M  142M  1690 root         0 S  6:03.79     0     0 /usr/lib/xorg/Xorg :0 -audit 0 -auth /var/lib/mdm/:0.Xauth -nolisten tcp vt8\r\nram12          0      0      2.6   0.3 79.3M 23.8M  9651 tecmint      0 R  0:00.71     0     0 /usr/bin/python3 /usr/bin/glances\r\nram13          0      0      1.6   4.8 1.45G  382M  3272 tecmint      0 S  6:25.30     0    4K /opt/google/chrome/chrome \r\n...</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f394b231802040-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f394b231802040-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-1\"><span class=\"crayon-e\">TecMint</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">LinuxMint</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">18</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">64bit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4.4.0</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">21</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">generic</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">                                                                                                                                               </span><span class=\"crayon-v\">Uptime</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">16</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">06</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-2\"><span class=\"crayon-i\">CPU</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">16.4</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">nice</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0.1</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-i\">LOAD</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">4</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">core                                        </span><span class=\"crayon-i\">MEM</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">60.5</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">active</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">4.90G</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-i\">SWAP</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0.1</span><span class=\"crayon-o\">%</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-3\"><span class=\"crayon-v\">user</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">10.2</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">irq</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">1.20</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-v\">total</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">7.70G</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">inactive</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2.07G</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-v\">total</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">3.73G</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-4\"><span class=\"crayon-v\">system</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">3.4</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">iowait</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">2.7</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-cn\">5</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">1.16</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-v\">used</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">4.66G</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">buffers</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">242M</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-v\">used</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">4.57M</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-5\"><span class=\"crayon-v\">idle</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">83.6</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">steal</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-cn\">15</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">1.24</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-v\">free</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">3.04G</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">cached</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">2.58G</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-v\">free</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">3.72G</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-6\"><span class=\"crayon-e\">NETWORK     </span><span class=\"crayon-v\">Rx</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\">   </span><span class=\"crayon-v\">Tx</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">TASKS</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">253</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">883</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">thr</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">run</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">252</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">slp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">oth </span><span class=\"crayon-e\">sorted </span><span class=\"crayon-e\">automatically </span><span class=\"crayon-e\">by </span><span class=\"crayon-v\">cpu_percent</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">flat </span><span class=\"crayon-e\">view</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-7\"><span class=\"crayon-i\">enp1s0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">525Kb</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">31Kb</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-8\"><span class=\"crayon-i\">lo</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">2Kb</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">2Kb</span><span class=\"crayon-h\">     </span><span class=\"crayon-v\">CPU</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">MEM</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">VIRT   </span><span class=\"crayon-e\">RES   </span><span class=\"crayon-e\">PID </span><span class=\"crayon-e\">USER        </span><span class=\"crayon-i\">NI</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">    </span><span class=\"crayon-v\">TIME</span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">IOR</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">IOW</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Command </span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-9\"><span class=\"crayon-i\">wlp2s0</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">0b</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0b</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">14.6</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">13.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2.53G</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.03G</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2957</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">51</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">49.10</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">40K</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">firefox</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">firefox</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-10\"><span class=\"crayon-cn\">7.4</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">2.2</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.16G</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">176M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">6265</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">7</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">08.18</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Headset</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Headset</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">renderer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">no</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sandbox</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">primordial</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">pipe</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">token</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">879B36514C6BEDB183D3E4142774D1DF</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">lan</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-11\"><span class=\"crayon-i\">DISK</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">I</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">O</span><span class=\"crayon-h\">     </span><span class=\"crayon-v\">R</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\">    </span><span class=\"crayon-v\">W</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">4.9</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">3.9</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.63G</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">310M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2459</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">7</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">12.18</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cinnamon</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">replace</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-12\"><span class=\"crayon-i\">ram0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">4.2</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.2</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">625M</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">13.0M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2301</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-h\">    </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">11</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">29.72</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">pulseaudio</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">start</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">log</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">target</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">syslog</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-13\"><span class=\"crayon-i\">ram1</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">4.2</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">1.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.52G</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">105M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">6220</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">3</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">42.64</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Headset</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">Headset </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-14\"><span class=\"crayon-i\">ram10</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">2.9</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.8</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">409M</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">66.7M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">6240</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">40.44</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Headset</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Headset</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">gpu</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">process</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">no</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sandbox</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">supports</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">dual</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">gpus</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">false</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">gpu</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">driver</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">bug</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">workarounds</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">7</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">2</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-15\"><span class=\"crayon-i\">ram11</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">2.9</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">1.8</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">531M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">142M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">1690</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">root</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">6</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">03.79</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">xorg</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Xorg</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">audit</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">auth</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mdm</span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">0.Xauth</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">nolisten </span><span class=\"crayon-e\">tcp </span><span class=\"crayon-e\">vt8</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-16\"><span class=\"crayon-i\">ram12</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">2.6</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">79.3M</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23.8M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">9651</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">00.71</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">python3</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">glances</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f394b231802040-17\"><span class=\"crayon-i\">ram13</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">1.6</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">4.8</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.45G</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">382M</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">3272</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">tecmint</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">6</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">25.30</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">4K</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">opt</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">google</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">chrome</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">chrome</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f394b231802040-18\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0132 seconds] -->\r\n<p>这些工具中的平均负载是从 <code>/proc/loadavg</code> 文件中读取的，也可以直接使用 <a href=\"https://www.tecmint.com/13-basic-cat-command-examples-in-linux/\">cat 命令</a>查看：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f3950282588473\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ cat /proc/loadavg\r\n2.48 1.69 1.42 5/889 10570</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f3950282588473-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3950282588473-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f3950282588473-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">proc</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">loadavg</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3950282588473-2\"><span class=\"crayon-cn\">2.48</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.69</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.42</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">889</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10570</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>在桌面计算机中，可以使用图形用户接口工具查看系统平均负载。</p>\n<h3 id=\"toc_4\">理解系统平均负载和 CPU 核心数的关系</h3>\n<p>考虑了 CPU 核心数的影响，才能解释系统负载。</p>\n<h4 id=\"toc_5\">多处理器 Vs 多核处理器</h4>\n<ul>\n<li>多处理器 – 一个计算机系统中集成两个或多个物理 CPU</li>\n<li>多核处理器 – 单个物理 CPU 有两个或多个单独的核并行工作（也叫处理单元）。双核意味着有两个处理单元，4 核有 4 个处理单元，以此类推。</li>\n</ul>\n<p>此外，Intel 引入了超线程技术用来提高并行计算能力。</p>\n<p>通过超线程技术，在操作系统中，单个物理 CPU 表现的和两个逻辑 CPU 一样。（实际在硬件上只有一个 CPU）。</p>\n<p>注意，单个 CPU 核同一时间只能执行一个任务，于是产生了多 CPU/处理器、多核 CPU，以及多线程技术。</p>\n<p>多 CPU 时，多个程序可以同时执行。如今的 Intel CPU 使用了多核心和超线程技术。</p>\n<p>可以使用 <a href=\"https://www.tecmint.com/check-linux-cpu-information/\">nproc 或 lscpu 命令</a>查看系统中的处理器单元数量。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f3954481287340\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ nproc\r\n4\r\n# 或者\r\nlscpu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f3954481287340-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3954481287340-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a81f3954481287340-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3954481287340-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f3954481287340-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">nproc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3954481287340-2\"><span class=\"crayon-cn\">4</span></div><div class=\"crayon-line\" id=\"crayon-59602a81f3954481287340-3\"><span class=\"crayon-p\"># 或者</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3954481287340-4\"><span class=\"crayon-v\">lscpu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>也可以使用 <a href=\"https://www.tecmint.com/12-practical-examples-of-linux-grep-command/\">grep 命令</a>：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f3958047636492\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ grep \'model name\' /proc/cpuinfo | wc -l\r\n4</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f3958047636492-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81f3958047636492-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f3958047636492-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\'model name\'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">proc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">cpuinfo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">l</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81f3958047636492-2\"><span class=\"crayon-cn\">4</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>为了进一步理解系统负载，需要做一些假设。假设系统负载如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81f395b771413197\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n23:16:49 up  10:49,  5 user,  load average: 1.00, 0.40, 3.35</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81f395b771413197-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81f395b771413197-1\"><span class=\"crayon-cn\">23</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">16</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">49</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">up</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">10</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">49</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">5</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">load </span><span class=\"crayon-v\">average</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1.00</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.40</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3.35</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p><strong>在单核系统中意味着：</strong></p>\n<ul>\n<li>CPU 被充分利用（100%）；最近的 1 分钟有 1 个进程在运行。</li>\n<li>CPU 有 60% 处于空闲状态；在最近的 5 分钟没有进程等待 CPU 时间。</li>\n<li>CPU 平均过载了 235%；最近的 15 分钟平均有 2.35 个进程在等待 CPU 时间。</li>\n</ul>\n<p><strong>在双核系统中意味着：</strong></p>\n<ul>\n<li>有一个 CPU 处于完全空闲状态，另一个 CPU 被使用；最近的 1 分钟没有进程等待 CPU 时间。</li>\n<li>CPU 平均 160% 处于空闲状态；最近的 5 分钟没有进程等待 CPU 时间。</li>\n<li>CPU 平均过载了 135%；最近的 15 分钟有 1.35 个进程等待 CPU 时间。</li>\n</ul>\n<p>总而言之，如果你是系统管理员，你应该关注高的平均负载。平均负载高于 CPU 核心数意味着需要增加 CPU，反之则意味着 CPU 未被充分利用。</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111590\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111590votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111590\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 5 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2015/10/478116e0d2ac0c766a25a7c5d7252167.jpg', 'full/1f020353984ba3d88d0e0349f7b5decd4ed6dd8a.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('数据可视化产生生产力', '2017-07-07', 'http://blog.jobbole.com/111529/', '34b73297603f02703efe586131a737a7', 1, 1, 'IT技术, 可视化, 数据', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/thoughtworkschina\">ThoughtWorks</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><div>\n<p>数据可视化就是借助于图形化手段，清晰有效地进行信息传达与沟通。许多人会着眼于“可视化”，认为数据可视化就是将一系列看上去很炫、很复杂的图表展示在页面上。其实不然，虽然可视化脱离不了各种图表类型，但并不意味着要以增加用户理解难度为代价去实现复杂的功能；或者为了看上去绚丽多彩而失去其最根本的意义：<strong>传达与沟通</strong>。</p>\n<h3>数据可视化产生生产力</h3>\n<p>数据可视化之所以会大受欢迎，其原因不仅在于能带给用户良好的的视觉效果，更因为它能够产生生产力，形成数据驱动闭环，主要包含以下几个阶段：</p>\n<ul>\n<li>技术人员运用技术手段将需求分析、基础数据整合、数据计算等操作结合到一起进行数据可视化，实时监控数据的变化情况。</li>\n<li>用户能够使用这些可视化图表，进行分析、对比等操作，定位业务问题。之后再结合业务变动提出新的需求。</li>\n<li>技术人员将用户访问数据与新的业务需求结合，重新进行数据整合、分析、计算，循环往复下去。</li>\n</ul>\n<p>如下图所示：</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/1-data-visualization.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/1-data-visualization.png\" alt=\"\" width=\"940\" height=\"712\"></a></p>\n<p>图1. 数据驱动闭环</p>\n<p>实现用数据可视化的方式不断驱动业务的提升，产生生产力、创造收益。</p>\n<h3>如何使数据可视化产生生产力？</h3>\n<p>满足这一目的的前提在于－－“创造出都能读懂、易于操作、能够提前预警的图表”，关键因素有以下几点：</p>\n<h4>1、选择合适的图表类型</h4>\n<p>选择图表的时候，许多人认为基本图表太过简单，不够高端大气，因而更倾向选择复杂的图表类型。实际上越简单的图表越容易理解，对用户的友好程度越高。只要能够高效清楚地传达业务含义，就应该优先选择。</p>\n<p>例如，饼图比较适合反映某个部分占整体的比重，而折线图能更好的反应数据变化的趋势；分组柱状图和堆叠柱状图都能够显示数据集的分组情况，但是彼此间的差异却让它们在特定情况下显得更加强大。在比较同一分类不同组的数据或者同组不同分类的数据时，分组柱状图更能体现优势；然而在比较每个分组之间的总量时，堆叠柱状图显然更加合适。下面分别使用这两种图表在展示不同地区、不同年龄段人口数量分布时显示的效果：</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/2-Grouped-Bar-Chart.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/2-Grouped-Bar-Chart.png\" alt=\"\" width=\"940\" height=\"483\"></a></p>\n<p>图2. 分组柱状图（Grouped Bar Chart)</p>\n<p>图片来自：<a href=\"https://bl.ocks.org/mbostock/3887051\">https://bl.ocks.org/mbostock/3887051</a></p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/3-Stacked-Bar-Chart.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/3-Stacked-Bar-Chart.png\" alt=\"\" width=\"940\" height=\"485\"></a></p>\n<p>图3. 堆叠柱状图（Stacked Bar Chart)</p>\n<p>图片来自：<a href=\"https://bl.ocks.org/mbostock/3886208\">https://bl.ocks.org/mbostock/3886208</a></p>\n<p>要想让受众读懂图表所表达的业务含义，就要选择合适的图表类型。在选择时，首先需要清楚的知道不同图表的优劣以及它们适合的应用场景；除此之外尽量选择一些简单的、易于理解的图表类型。但这不意味着不能选择复杂的图表类型，有的图表虽然看起来比较复杂，但是却能很好的反映一些业务场景，再辅助一些文字说明等其他手段，降低用户的使用难度，也未尝不可。</p>\n<p>选择图表时，以业务为基础。只要能够清晰地表达业务数据背后含义，不让用户产生歧义，都值得考虑。</p>\n<h4>2、易用的、多维度的交互分析</h4>\n<p>随着数据类型的多样化，数据间的关联关系也越来越复杂。仅仅展示单维度的数据，是无法让用户轻易发现数据之间的联系、挖掘出更多业务价值的。同样，若是交互方式过于复杂，也只会增加用户的使用难度而已，不利于业务长期发展。因此易操作的、多维度的交互分析对于数据可视化来说必不可少。多维度的分析方式有很多种，以下是常见的几种：</p>\n<ul>\n<li>钻取： 将汇总数据拆分到更细节的数据；在维的不同层次间的变化，从上层降到下一层。</li>\n<li>上卷： 钻取的逆操作，即从细粒度数据向高层的聚合。</li>\n<li>切片： 选择维中特定的值进行分析。</li>\n<li>切块：选择维中特定区间的数据或者某批特定值进行分析。</li>\n<li>筛选： 通过不同的维度或者类别过滤出用户想要的数据。</li>\n<li>联动：若干个相关联的图表，一个图表发生变化，其他的也会跟着发生变化。</li>\n</ul>\n<p>下面是一些图表的样例：</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/4-tree-graph.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/4-tree-graph.png\" alt=\"\" width=\"940\" height=\"435\"></a></p>\n<p>图4. 树图（不同数据层次，可以进行数据的钻取、上卷的等等操作)</p>\n<p>（图片来自：<a href=\"https://bl.ocks.org/mbostock/1093025\">https://bl.ocks.org/mbostock/1093025</a>）</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/5-Linkage.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/5-Linkage.png\" alt=\"\" width=\"940\" height=\"756\"></a></p>\n<p>图5. 同步联动图（图中显示的是在某一到达距离时的速度、高度以及心率）</p>\n<p>（图片来自：<a href=\"https://www.highcharts.com/demo/synchronized-charts\">http://t.cn/RoUdHCX</a>）<code></code></p>\n<p>有选择的将不同交互方式进行结合，能够发挥出更强大的作用。再辅助高效灵活的追加合并、拖曳式操作进行数据的挖掘分析，就可以帮助用户快速定位问题，释放劳动力，提升效率，不再需要程序员花费大量精力在日志文件中寻找问题的原因。同时通过各类数据的横向、纵向对比，业务人员能够从中挖掘出更多的业务需求，创造更大的商业价值。</p>\n<h4>3、预警功能</h4>\n<p>数据可视化除了能够帮助定位已有的问题，另外一个更大的价值是能够及时预警。</p>\n<p>一旦数据出现异常或者是提前预定义的一些条件被满足时，警报就会被触发，提前预警。通过设置报警方式、报警策略、报警等级等等，根据紧急程度用不同的方式通知特定的人群。这样在问题发生之前，就能预先做好防护措施；或者在问题发生的时候，能够及时通知负责人，尽快解决问题。这样不仅能缩短反馈周期（发现问题－找到责任人－定位问题－解决问题），也能降低对用户的影响，提升用户对产品的信任度，很好的降低业务损失。</p>\n<h3>总结</h3>\n<p>除了上述提到的一些关键因素，好的数据可视化平台、产品也有许多其他的共性： 友好的用户体验设计，页面的交互逻辑要符合真实的用户路径； 可以多终端使用 ，尤其要能契合移动端体验的可视化设计实现，使得人与数据零距离，随时随地可用；强大的数据整合、计算、渲染能力，就算图表表达的业务含义再精确，性能的缺失也是致命的。 支持多种数据源整合、多数据类型的扩展等等。 对产品用户使用情况进行监控、分析。了解真实用户人群、用户路径、用户的核心关注点，帮助产品进行改善</p>\n<p>总之，好的数据可视化，就是要以用户为中心。根据目标用户的需求提炼业务需求，以用户的良好体验为目标，绘制出人人都能读懂的图表；以人人都会的交互方式，帮助用户挖掘业务价值，提升工作效率，促进业务持续发展，让数据可视化产生生产力。</p>\n<div></div>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111529\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111529votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111529\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/thoughtworkschina\">ThoughtWorks</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/thoughtworkschina\">\r\n			<img src=\"http://tp3.sinaimg.cn/1774908135/180/0/1\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            ThoughtWorks是一家全球IT咨询公司，追求卓越软件质量，致力于科技驱动商业变革。擅长构建定制化软件产品，帮助客户快速将概念转化为价值。同时为客户提供用户体验设计、技术战略咨询、组织转型等咨询服务。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/thoughtworkschina\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/thoughtworkschina/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/thoughtworkschina/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 60</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://insights.thoughtworkers.org/\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/thoughtworkschina\"><i class=\"fa fa-weibo\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://insights.thoughtworkers.org/wp-content/uploads/2017/06/1-data-visualization.png', 'full/5fd060bc6a901fb82af8477afb63c706d0e06446.jpg'),
('为何不用担心大公司偷你的绝世创业点子', '2017-07-07', 'http://blog.jobbole.com/111721/', '38cc12ee297c4f23c14ac3da6f7a65ce', 1, 1, '创业, 创业', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/TJQ\">佟大冬</a> 翻译，<a href=\"http://www.jobbole.com/members/young605867996\">Lada</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://timhampson.quora.com/Startups-Why-Google-Facebook-Apple-SalesForce-probably-wont-steal-your-lunch-money\">Tim Hampson</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【导读】：并非所有人都认为你的创业idea是值得做的。且大公司并非拥有无限人力财力，再加上内部各山头的政治斗争，中层干部只求升职加薪安安稳稳，底层年轻员工空有理想但说话没分量。</p>\n<p style=\"text-align: center;\"><strong>为何不用担心 GG/FB/苹果等大公司偷你的绝世创业点子</strong></p>\n<p><img class=\"aligncenter\" src=\"https://qph.ec.quoracdn.net/main-qimg-a7a763468243016c2a80b3817b8a4cd6.webp\"></p>\n<p>创业公司经常被问到这样一个问题——为什么大公司不实现你的创业 idea，从而把你踢除这个市场？</p>\n<p>因为相比于典型创业公司的资源，大公司拥有数十亿美元的资金和成千上万个工程师，所以这个问题听起来似乎非常合理。</p>\n<p>其实比起创业公司，大公司的优势实际比你想象的要少。为什么？这个问题的原因值得列出来。</p>\n<h3>1.创新是件全凭运气的事儿</h3>\n<p>只有当你的点子（idea）开始盈利了，别人才会发现你的 idea 到底有多好，在此之前没人真的了解。然而到那个时候，你也将顺利地成为下一代执牛耳者。风投不会投资公司，他们投资市场和人（尤其是 CEO）。因为他们明白，在一个热门市场，他们尝试投资一位出类拔萃的人，他有望成为市场领导者，而且很有可能（50% ~ 80% 的可能性）带来回报，这些回报足以让有限的合伙人安心。如果这个市场足够热门，即使失败了，你也不会失去一切。失败被遗忘，历史被重写，只有其中 1-2 个带来回报的大项目被人们记住，以强调投资人有远见。而 20-30 个失败投资就这样被遗忘了（在大多数人看来，这些失败投资中，有些可能还是很成功的）。</p>\n<p>创业是一项投资组合业务，而且在这项业务中，大部分风投公司的投资规模在 1~5 亿美元之间。你不能在 2004 年左右，只是简单地将 1000 万美元投资给 Facebook，虽然这也不那么容易。你应该采取广泛的组合投资，而这需要大量的资金。因此，即使市场领导人试着实施他们自己的创新项目时也犹豫不决。</p>\n<p>这种投资组合模式也需要优胜劣汰机制，这一点风投们可以轻松做到，因为他们所要做的只是在资金用完时停止续投。对一个大公司而言，要解散一个表现不佳的研发团队无论从心理上还是实际行动上都困难得多。Google 因为终止项目非常果决，所以经常被做为反例。但实际上 Google 在 Google+ 上展示了它比任何风投都多的耐心。大公司对待新项目就像哺乳动物对待自己的孩子，风投则像鱼，虽然冷血（无双关），但它更有效。</p>\n<p>大公司无意和一个 500 万美元的创业公司竞争，他们竞争的是一个数十亿美元的生态系统，这就是为什么创业公司总能克敌制胜。大公司不能像风投那样对项目进行组合投资。</p>\n<h3>2. 每个人都不愿亏损</h3>\n<p>没人想影响正常稳定的收入。创业公司没有什么收入，所以他们不用担心收入受影响。从稳定的、可预测的（即使是下降的）收入形势中走出来不容易。相比之下，一款最新的小工具能不能在市场投放，大公司不关心，他们更倾向于投资升级成熟的主线产品……</p>\n<p> </p>\n<h3>3. 大公司是受过程约束的</h3>\n<p>每个人都可以说不，没有人可以拍板。或者往好了说，整个公司都需要“买进”，“整个”可以是公司遍布全球的各个部门。中层管理者更关注于管理自己的养老金，这是他们固有的惰性。上层管理者往往对现实市场鞭长莫及，不能辨别后起之秀。而对于公司底层人员，别人说什么他们就做什么，要不然就离开公司自己去创业……</p>\n<h3>4. 大公司需要大项目</h3>\n<p>所有的大公司基本都成为了集团。如果你已经是市场的引领者了，那么唯一的发展方向就是进入另一个市场。如果你想每季度收入几十亿美元，那么只有大项目能够做到。当然，创业公司 100 % 的增长看起来很漂亮，而额外的 100 万美元收入，大公司收入四舍五入带来的错误就有这么多。</p>\n<p>大公司注重创新之处都是大量资本密集投注的地方（比如 Google 街景），这是创业公司难以匹敌的事情。</p>\n<p>这还会影响大公司的发展战略。从 90 年代初期开始，Oracle 公司就不再满足于做一家数据库公司，现在已转型为 IT 供应商，为企业提供全套服务，包括硬件、软件和服务。SalesForce 是 CRM 市场的占尽先机者，所以人们经常还会以为 SalesForce 仍然是一家 CRM 公司。事实上，SalesForce 如今已发展为一个 PaaS 公司，希望通过大数据等来扩展其业务。在云服务方面，SalesForce 像 Oracle 看齐。SalesForce 85% 的 IT 支出是用于企业客户的，Marc Benioff （SalesForce 创始人）根本不在乎小客户，更别说想赶上类似 SalesForce 的 CRM 创业公司。这就像 Oracle 根本不在乎 MongoDB 一样。</p>\n<h3>5. 非本公司原创（即不愿意用别人发明的东西）</h3>\n<p>在 1999 年，Google 主动提出仅以 1 百万美元出售给 Excite，但是被 Excite 嗤之以鼻，因为 Excite 仅靠自己可以很容易实现搜索引擎。有趣的是，虽说他们是正确的，但他们从未找到足够的时间去做。正如他们所说，遗留的是历史。</p>\n<p>作为一个手下数百名开发人员的大公司的产品经理，很难接受这个事实：他们可能已经错过了，几个极客在资源紧缺的条件下，成功完成的某个项目。所以他们通常不会（使用创业公司的 idea）。</p>\n<h3>6. 大公司并不大</h3>\n<p>大公司有很多部门，其中有些可能并不大。“<strong>但他们还是有大量资源</strong>”，没错，但是他们都有事情在做。而对于所需的实际技能，他们并没有。</p>\n<p>90 年代，我离开 IBM（当时已有 30 万名员工），加入了 Sybase（当时有 1500 名员工）。令我惊讶的是，后起之秀 Sybase（只做数据库）专注于数据库开发的员工数量是 IBM 的两倍，那时 IBM 还有除数据库之外的各种业务，甚至包括管理军用直升机的交付项目。之后，当我加入创业公司 Illustra（不到 80 名员工）时，我并不惊讶，而至今我们所拥有的 web 数据库专业知识，比 Informix、Oracle 和 Sybase 加起来都多。最后 Informix 付给了 Illustra 4 亿美元。</p>\n<h3>7. 时间就是金钱</h3>\n<p>究竟为什么 Facebook 不简单地复制 Instagram 的 24 人月的工作量，而是支付令人瞠目的 10 亿美元来收购呢？</p>\n<p>这不是对 13 名员工的人才收购。由于 Instragram 的 3000 万用户也都是 Facebook 的用户（那时有 8.45 亿用户），所以和市场份额也没关系。当然这更不是获得多少收入，因为 Instagram 没有钱，完全没有！</p>\n<p>原因是 Facebook 确信这是图片分享的未来，并且会使自家业务面临风险（因为简单来说，Facebook 实际上是和照片相关的应用）。对于以上列出的所有原因，他们明白至少需要 12 个月才能复制出来，到那时，占尽先机的大公司和初创企业之间的财富可能会有很大的逆转。购买而非构造意味着额外的收入，但是相当于并购公司现有的销售和营销渠道的水平，而不是创业公司的。这可以很容易地证明愚蠢的营收倍数，因为重点不是 Instagram 现在在做什么，而是 Facebook 会错过什么，你说是不是？当 Facebook 在 14 年第三季度几乎投了 30 亿美元时，却只为 Instagram 投了一个月的收入。鉴于现在 Instagram 对于 Facebook 价值主张的重要性，这看起来似乎赚到了。</p>\n<h2>专注于客户，而不是竞争</h2>\n<p>你不能指望一颗橡子就能长成一颗橡树。你首先需要准备一盘完整的幼苗，然后筛选剔除一些，最后专心培育其余的幼苗，期待至少有一颗苗子最后能长成橡树。这实际上正是 VC 模式的整个前提，这也是为什么大公司通常不会压制创业公司的原因，因为他们不知道哪个最终会超过他们，并且也不可能把那么多初创公司都扼杀。</p>\n<p>如同商业中所有的普遍规律一样，也有例外存在。总想着成为市场领导者一向不会有什么好结果，但应该明白以上这些规律。虽然总体规则很明确。几乎没有哪家初创公司会因为试图取代占尽先机者而面临风险，更大的风险是：<strong>你的产品在市场上是否有容身之处</strong>。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111721\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111721votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111721\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/TJQ\">佟大冬</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/TJQ\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2017/05/5f8b3a74725397a8f5033c9ac0afeefb.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            live and learn.        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/TJQ\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/tjq/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/TJQ/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 11</a> · <a title=\"QQ：601591123\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'https://qph.ec.quoracdn.net/main-qimg-a7a763468243016c2a80b3817b8a4cd6.webp', 'full/dd39ad223c55fb33c263f1ee6ac7409fcf730227.jpg'),
('迪斯尼的华丽海洋动效算法，是如何实现的？', '2017-07-07', 'http://blog.jobbole.com/111596/', '3986d7468c90d34fb100d57e8460b2ac', 1, 2, 'IT技术, 算法', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/upanblack\">Panblack</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://www.theatlantic.com/technology/archive/2017/05/the-algorithms-behind-moanas-gorgeously-animated-pacific-ocean/528645/?single_page=true\">Adrienne LaFrance</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【伯乐在线导读】：《海洋奇缘》讲述了作为航海世家后代的波里尼西亚公主莫阿娜，为了找寻传说中的神秘之岛，独自踏上了航海之旅的故事。本文并没有详细介绍具体的动画技术，而是迪斯尼如何用心拍摄了一部感人至深的作品。</p>\n<p><img id=\"pic\" class=\"M_cur_zoom_in aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh2ctg0y8vj21hc0u017k.jpg\" width=\"621\" height=\"349\"></p>\n<hr>\n<p>早期，当电影还是个新鲜事物的时候，拍摄海洋是个疯狂的想法。</p>\n<p>海面的波浪当然没问题，但是，捕捉摇曳多姿的海底物种群、游泳的鱼和海底大理石般烁烁生辉的阳光？人们的普遍观点是：做不到。</p>\n<p>事实上，这可以做到。一个世纪前，船长 Williamson 的两个儿子 John Ernest 和 George 愿意证明这一点。Williamson 兄弟俩求助于他们的父亲给潜水员设计的一项用于水下维修和救援用的技术。这个装置是一串柔韧的同心管（美国国会图书馆是<a href=\"http://www.loc.gov/loc/lcib/9615/sea.html\">这么描述</a>的：“….联锁在一起的一串铁环，伸展开了就像一个手风琴” ），悬垂在一艘特制的船上，潜水员可以通过它下到一个密封舱内。管道的一头是水面上的船，另一头是潜水屋。</p>\n<p>John Ernest 和 George 被父亲的这个机器迷住了。透过管道上的大玻璃窗，他们可以观察到红鲷鱼、鰤鱼、胖胖的鲶鱼，还有其他亮晶晶的海底生物在巴哈马群岛珊瑚礁中穿行。他们决定下次来要带上相机。之后，他们发表的报纸上的照片——包括一条模糊的鲨鱼和朦胧的海草——产生了轰动。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/32c4f4684e33f3227627440eef7a0799.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/32c4f4684e33f3227627440eef7a0799.png\" alt=\"b215ee4e7\" width=\"622\" height=\"483\"></a></p>\n<blockquote><p>顺时针方向左起：Williamson 兄弟海底拍摄的鲨鱼、潜水挖金币的男孩、巴哈马群岛“海洋伊甸园”、兄弟俩中的一个坐在装置的球层内。这些照片1914年7月发表在《巴尔的摩太阳报》（Baltimore Sun）上。</p></blockquote>\n<p>最终，Williamson 兄弟的管状装置——配备了新的特制球形观察舱，还有一个巨大的漏斗形的窗——1916年被用来拍摄电影《海底两万里》的水下场景。“我管它叫魔法窗，” 电影在展现一片灰暗如乌云的海底画面前，幕间旁白这样写道：“我们注视到的场面，你也许会觉得上帝从未打算让我们看到。”</p>\n<p>在那时，这些镜头是非同寻常的，电影空前成功。</p>\n<p><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/05/gif_20000leages/37dadcf8c.gif\" width=\"450\" height=\"338\"></p>\n<blockquote>\n<p style=\"text-align: center\">《海底两万里》（1916）中的海洋镜头</p>\n</blockquote>\n<p>从那以后，电影制作者们使用科技手段不断推近描绘海洋的极限，不仅仅限于真人电影。最近，迪斯尼卡通片《海洋奇缘》（Moana）让观众为之倾倒。这部片子讲述了太平洋岛屿上的一个少女沿着祖先的足迹踏上探险之旅的故事。</p>\n<p>《海洋奇缘》的导演，Ron Clements 和 John Musker，几十年来一直迷恋与海洋有关的故事。他们在1989年拍摄了《小美人鱼》（The Little Mermaid）。Clements 是受 1940 年的电影《木偶奇遇记》（Pinocchio）——其中有著名的巨鲸扑浪镜头 —— 的激励，开始追求在动画事业上有所作为。不过，那些电影中的海洋画面与观众在《海洋奇缘》中看到的无法同日而语，《海洋奇缘》就像是 1916年的《海底两万里》一样具有开创性。</p>\n<p>“制作水的特效总是很难。” 《海洋奇缘》的联合动效主管 Marlon West 说，“通常一部动画片会有十几个水的镜头，非常难做。” 但《海洋奇缘》的大部分情节与水有关，而且海洋并不仅仅是个场景，所有情节就发生在水上，这增加了另一层复杂度。除此之外，《海洋奇缘》的太平洋有时候是拟人化的，就像是詹姆斯卡梅隆的《深渊》里那个海水的远房表亲。</p>\n<p>迪斯尼的软件团队搞出了一个工具软件，叫 Splash（类似制作《冰雪奇缘》的软件 Matterhorn），来自动化处理水在不同镜头下的行为。Splash 是第三方 3D 动画软件 Houdini 的“流体解算器”插件。用这款解算器，视效专业人员可以定义需要模拟的区域，比如动画小船周围的水域。然后用一个设定值来决定从什么样的海水条件开始。在这个基础上，他们在预定义的海面运行模拟器，来确定那片水面如何跟小船互动。模拟的输出，即“几百万的粒子”，实际上就是几百万的新动画数据点，被平滑处理到影片最后的渲染中。</p>\n<p><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/041817_Bforever/a2379f3f8.gif\" width=\"629\" height=\"354\"></p>\n<blockquote>\n<p style=\"text-align: center\">《海洋奇缘》的技术团队花了差不多一年来给片中的船开发自动航迹系统</p>\n</blockquote>\n<p>Splash 还引进了一系列模拟水花、漩涡和航迹的算法。软件的浮力算法让片中巨大的领航帆船在波浪中上下拍打的动作非常逼真。（好多镜头中，许多帆船一齐出现在水中，互相挨得很近，带来了更多动画制作的挑战。）</p>\n<p>“作为特效艺术家，在制作流体时，你不会总能预料到你的模拟会出来什么效果。” 本片的视效主管 Erin Ramos 说，“对水来说最难的是，如果不对劲，你一眼就能看出来，哪怕是作为背景。”</p>\n<p style=\"text-align: center\"><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/052517forever/d84211b74.gif\" width=\"630\" height=\"264\"></p>\n<blockquote>\n<p style=\"text-align: center\">“莫阿娜与海洋的亲密接触” Eric Goldberg 的铅笔动画稿</p>\n</blockquote>\n<p>迪斯尼的特效专业人员告诉我，他们可以在约80%的时间成功地自动化处理关键的海洋活动细节——就是说，可以找一个助理简单地运行一个脚本就生成了船只的航迹。“运行脚本来生成动画，艺术家们可以有更多精力去专注镜头的艺术性，” Ramos对我说，“所以他们才有时间创造这些叹为观止的镜头，而且得以让海洋表现得像一个角色。”</p>\n<p>《海洋奇缘》里的大海是个拟人化的力量，在莫阿娜的旅途中经常起到推动作用，只不过这个角色既没有脸，也不会说话。（“在这个意义上说，它有些像迪斯尼《阿拉丁》里那个动画魔毯。”《海洋奇缘》制作人 Osnat Shurer 对我说。）因此，迪斯尼的视效专业人员和动画师们始终在矛盾中权衡：一方面让水看起来、动起来像真正的水，同时又要展现出魔力。</p>\n<p>“这是个很大的挑战。” West 说，“他们要把海洋做得像一个袜子玩偶，我们要把它举起来，往里面灌满了泡泡和液体，或者做一个模拟计算给它充满了水，好让它看上去更加水汪汪的。”</p>\n<p>对于如何把海洋从平常状态转换为角色，动画师和视效专业人员同制片方之间照旧有很多争论。“是什么让海洋角色在一个人看来像普通的水，在另一个人看来却过于躁动和咄咄逼人？” West 说，“我们的海洋角色突现在蹒跚学步的莫阿娜或莫阿娜的奶奶面前时，你绝不能让人担忧她们的安危，你要让人感到不可思议。”</p>\n<p><img class=\"aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/040417forever/4695c56ff.gif\" width=\"629\" height=\"354\"></p>\n<blockquote><p>为了达到这样的感觉，动画师们先是创建了海洋的动作，视效专业人员运行模拟器，添加上水的真实特性，然后照明专业人员补上附加的细节。（沃特迪斯尼动画工作室）</p></blockquote>\n<p>最后，平衡这两种预期——真实的海洋，同时像个角色一样传达暖意和鼓舞——意味着当水作为一个角色时，让它表现出部分超自然的光滑和圆润。还有些时候忽略物理定律，以便于观众更加关注角色。“因为我们要讲故事，” West 对我说，“这是个非写实的世界。我们力求创造出存在于你的心中和脑海中的水的形象。”</p>\n<p>接着面临的问题时如何展现可信的海洋——不是物理上写实，而是文化上真实。迪斯尼为此成立了“大洋洲故事基金会”，由来自太平洋岛屿上的一群文化业者组成，作为影片的顾问。基金会成员参与到影片的方方面面，从哈卡战舞到纹身的设计到半神毛依的头发。（毛依的初稿是光头，基金会成员说不应该，于是迪斯尼给了他华丽的头发。）</p>\n<p>影片制作者第一次考察之旅去了斐济，见到了“天使”Jiujiua Bera，一个熟练的探路人。“他带着强烈的个人感情谈论大海，” 《海洋奇缘》制片人Osnat Shurer 对我说。“他真的会非常轻柔地拍打海水，还告诉我们对海洋讲话也要轻柔。他说：‘海洋什么都知道。’ 清晨他会问候海洋，就像问候自己的家人。这让我们印象深刻。”</p>\n<p>让 Shurer 和同事大为触动的是，他们见到的太平洋岛民之间更加广泛的纽带联系，而且很多海岛文化认为海洋和陆地是浑然一体的。（比如在古代夏威夷，这个理念形成了 <a href=\"http://baike.sogou.com/v192899.htm\">ahupuaʻa</a>  的概念，即从山顶连绵到海里的陆地区块单位。）还有一些文化认为海洋本身就是一个纽带。“在太平洋上，我们不认为水是一种阻隔。”人类学家、大洋洲故事基金会成员 Dionne Fonoti 在《海洋奇缘》特别收录版中接受迪斯尼采访时说道。“把我们连接在一起的并不仅仅是海岛文化和居民，还有海洋。”</p>\n<p>然而，当制片项目开始的时候，迪斯尼团队还不知道该如何描绘这么复杂事物——即使是从技术角度。更不用说另一个相关的挑战：制作人性化的火山岛。</p>\n<p style=\"text-align: center\"><img class=\"alignnone aligncenter\" src=\"https://cdn.theatlantic.com/assets/media/img/posts/2017/06/050217forever/e172aa646.gif\" width=\"630\" height=\"264\"></p>\n<blockquote>\n<p style=\"text-align: center\">制作《海洋奇缘》的 Te Kā 所需的多个动效层：烟、或、岩浆、闪电和水</p>\n</blockquote>\n<p>“我对我们的工作成果充满期待，” West 对我说。“当我看到最终的电影，我觉得没有什么能让我畏缩不前，从来没有。”</p>\n<p>这个项目也改变了动画师和视效专业人员们看待真实海洋的角度。视效主管 Ramos 说她用了一年半以上的时间制作逼真的海岸线动画。即使现在，她只要去了海滩就会留意那些参与《海洋奇缘》之前从未考虑过的细节。</p>\n<p>“要知道，去海滩对我来说是件艰难的事情，” 她说。“只要去了那儿，我就会观察泡沫是如何消散的，海水如何渐渐退回大海，海浪短暂停顿的韵律和节奏。我会观察沙滩如何成型为礁岩浪型，光线如何影响水的外观、清澈度、颜色。脑子里要过的东西太多了。”</p>\n<p>“我不觉得这是坏事，” 她补充道。“我觉得这美妙无比。”</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/bb6b0431912b5b441aac6477e67bd0d22.png\">\n            \n                            <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/381b4bd995d3cff3c32be73b9d0571b82.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111596\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111596votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111596\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack\">Panblack</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack\">\r\n			<img src=\"http://tp4.sinaimg.cn/1611865122/180/0/1\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            挺老的Linux新手        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/upanblack\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/upanblack/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/upanblack/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 37</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://www.cnblogs.com/panblack\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/panblack\"><i class=\"fa fa-weibo\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"http://github.com/panblack\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://wx3.sinaimg.cn/large/7cc829d3gy1fh2ctg0y8vj21hc0u017k.jpg', 'full/1920e6dd8243dc236fa1e8abd1a1fa16a072ff2d.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('Linux TCP GSO 和 TSO 实现', '2017-07-07', 'http://blog.jobbole.com/111668/', '3c4107179d9db7fa5cdd457d1cd8fd80', 0, 1, 'IT技术, Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-28541347-id-5763844.html\">lvyilong316</a>   </div><div>（注：kernel版本：linux 2.6.32）\n<h2>概念</h2>\n<p>TSO(TCP Segmentation Offload): 是一种利用网卡来对大数据包进行自动分段，降低CPU负载的技术。 其主要是延迟分段。</p>\n<p>GSO(Generic Segmentation Offload): GSO是协议栈是否推迟分段，在发送到网卡之前判断网卡是否支持TSO，如果网卡支持TSO则让网卡分段，否则协议栈分完段再交给驱动。 <b>如果TSO</b><b>开启，GSO</b><b>会自动开启。</b></p>\n<p>以下是TSO和GSO的组合关系：</p>\n<ul>\n<li>GSO开启， TSO开启: 协议栈推迟分段，并直接传递大数据包到网卡，让网卡自动分段</li>\n<li>GSO开启， TSO关闭: 协议栈推迟分段，在最后发送到网卡前才执行分段</li>\n<li>GSO关闭， TSO开启: 同GSO开启， TSO开启</li>\n<li>GSO关闭， TSO关闭: 不推迟分段，在tcp_sendmsg中直接发送MSS大小的数据包</li>\n</ul>\n<h2>开启GSO/TSO</h2>\n<p>驱动程序在注册网卡设备的时候默认开启GSO: NETIF_F_GSO</p>\n<p>驱动程序会根据网卡硬件是否支持来设置TSO: NETIF_F_TSO</p>\n<p>可以通过ethtool -K来开关GSO/TSO</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78c5652781148\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define NETIF_F_SOFT_FEATURES (NETIF_F_GSO | NETIF_F_GRO)\r\nint register_netdevice(struct net_device *dev)\r\n{\r\n              ...\r\n              /* Transfer changeable features to wanted_features and enable\r\n               * software offloads (GSO and GRO).\r\n               */\r\n              dev-&gt;hw_features |= NETIF_F_SOFT_FEATURES;\r\n              dev-&gt;features |= NETIF_F_SOFT_FEATURES; //默认开启GRO/GSO\r\n              dev-&gt;wanted_features = dev-&gt;features &amp; dev-&gt;hw_features;\r\n              ...\r\n}\r\nstatic int ixgbe_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\n              ...\r\n              netdev-&gt;features = NETIF_F_SG |\r\n                                              NETIF_F_TSO |\r\n                                              NETIF_F_TSO6 |\r\n                                              NETIF_F_RXHASH |\r\n                                              NETIF_F_RXCSUM |\r\n                                              NETIF_F_HW_CSUM;\r\n              register_netdev(netdev);\r\n              ...\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78c5652781148-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78c5652781148-24\">24</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-1\"><span class=\"crayon-p\">#define NETIF_F_SOFT_FEATURES (NETIF_F_GSO | NETIF_F_GRO)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">register_netdevice</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">net_device *</span><span class=\"crayon-v\">dev</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-c\">/* Transfer changeable features to wanted_features and enable</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-6\"><span class=\"crayon-c\">               * software offloads (GSO and GRO).</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-7\"><span class=\"crayon-c\">               */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hw_features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SOFT_FEATURES</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SOFT_FEATURES</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//默认开启GRO/GSO</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-10\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">wanted_features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">hw_features</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-11\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-13\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ixgbe_probe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pci_dev *</span><span class=\"crayon-v\">pdev</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">pci_device_id *</span><span class=\"crayon-v\">ent</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-14\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-15\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-16\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">netdev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-17\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_TSO</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-18\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_TSO6</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-19\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_RXHASH</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-20\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_RXCSUM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-21\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">NETIF_F_HW_CSUM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-22\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">register_netdev</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">netdev</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78c5652781148-23\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78c5652781148-24\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0029 seconds] -->\r\n<p></p>\n<h2>是否推迟分段</h2>\n<p>从上面我们知道GSO/TSO是否开启是保存在dev-&gt;features中，而设备和路由关联，当我们查询到路由后就可以把配置保存在sock中。</p>\n<p>比如在tcp_v4_connect和tcp_v4_syn_recv_sock都会调用sk_setup_caps来设置GSO/TSO配置。</p>\n<p>需要注意的是，只要开启了GSO，即使硬件不支持TSO，也会设置NETIF_F_TSO，使得sk_can_gso(sk)在GSO开启或者TSO开启的时候都返回true</p>\n<p>l  <b>sk_setup_caps</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78d1805728484\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#define NETIF_F_GSO_SOFTWARE (NETIF_F_TSO | NETIF_F_TSO_ECN | NETIF_F_TSO6)\r\n#define NETIF_F_TSO (SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT)\r\n\r\nvoid sk_setup_caps(struct sock *sk, struct dst_entry *dst)\r\n{\r\n              __sk_dst_set(sk, dst);\r\n              sk-&gt;sk_route_caps = dst-&gt;dev-&gt;features;\r\n              if (sk-&gt;sk_route_caps &amp; NETIF_F_GSO) /*GSO默认都会开启*/\r\n                             sk-&gt;sk_route_caps |= NETIF_F_GSO_SOFTWARE; /*打开TSO*/\r\n              if (sk_can_gso(sk)) { /*对于tcp这里会成立*/\r\n                             if (dst-&gt;header_len) {\r\n                                           sk-&gt;sk_route_caps &amp;= ~NETIF_F_GSO_MASK;\r\n                             } else {\r\n                                           sk-&gt;sk_route_caps |= NETIF_F_SG | NETIF_F_HW_CSUM;\r\n                                           sk-&gt;sk_gso_max_size = dst-&gt;dev-&gt;gso_max_size; /*GSO_MAX_SIZE=65536*/\r\n                             }\r\n              }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d1805728484-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d1805728484-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-1\"><span class=\"crayon-p\">#define NETIF_F_GSO_SOFTWARE (NETIF_F_TSO | NETIF_F_TSO_ECN | NETIF_F_TSO6)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-2\"><span class=\"crayon-p\">#define NETIF_F_TSO (SKB_GSO_TCPV4 &lt;&lt; NETIF_F_GSO_SHIFT)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-4\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_setup_caps</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">dst_entry *</span><span class=\"crayon-v\">dst</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-5\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-6\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">__sk_dst_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-7\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*GSO默认都会开启*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-9\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO_SOFTWARE</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*打开TSO*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-10\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*对于tcp这里会成立*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-11\"><span class=\"crayon-h\">                             </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">header_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-12\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">NETIF_F_GSO_MASK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-13\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-14\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_HW_CSUM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-15\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_max_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dst</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_max_size</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*GSO_MAX_SIZE=65536*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-16\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d1805728484-17\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d1805728484-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>从上面可以看出，如果设备开启了GSO，sock都会将TSO标志打开，但是注意这和硬件是否开启TSO无关，硬件的TSO取决于硬件自身特性的支持。下面看下sk_can_gso的逻辑。</p>\n<p>l  <b>sk_can_gso</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78d5304457226\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic inline int sk_can_gso(const struct sock *sk)\r\n{\r\n    /*对于tcp，在tcp_v4_connect中被设置：sk-&gt;sk_gso_type = SKB_GSO_TCPV4*/\r\n              return net_gso_ok(sk-&gt;sk_route_caps, sk-&gt;sk_gso_type);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78d5304457226-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d5304457226-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d5304457226-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d5304457226-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d5304457226-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78d5304457226-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d5304457226-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d5304457226-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*对于tcp，在tcp_v4_connect中被设置：sk-&gt;sk_gso_type = SKB_GSO_TCPV4*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d5304457226-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">net_gso_ok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d5304457226-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>l  <b>net_gso_ok</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78d9972186182\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic inline int net_gso_ok(int features, int gso_type)\r\n{\r\n              int feature = gso_type &lt;&lt; NETIF_F_GSO_SHIFT;\r\n              return (features &amp; feature) == feature;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78d9972186182-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d9972186182-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d9972186182-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78d9972186182-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78d9972186182-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78d9972186182-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inline </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">net_gso_ok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d9972186182-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d9972186182-3\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_GSO_SHIFT</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78d9972186182-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78d9972186182-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>由于对于tcp 在sk_setup_caps中sk-&gt;sk_route_caps也被设置有SKB_GSO_TCPV4，所以整个sk_can_gso成立。</p>\n<h2>GSO的数据包长度</h2>\n<p>对紧急数据包或GSO/TSO都不开启的情况，才不会推迟发送， 默认使用当前MSS。开启GSO后，tcp_send_mss返回mss和单个skb的GSO大小，为mss的整数倍。</p>\n<p>l  <b>tcp_send_mss</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78dc857827901\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_send_mss(struct sock *sk, int *size_goal, int flags)\r\n{\r\n              int mss_now;\r\n \r\n              mss_now = tcp_current_mss(sk);/*通过ip option，SACKs及pmtu确定当前的mss*/\r\n              *size_goal = tcp_xmit_size_goal(sk, mss_now, !(flags &amp; MSG_OOB));\r\n \r\n              return mss_now;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78dc857827901-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78dc857827901-9\">9</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-3\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-4\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_current_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*通过ip option，SACKs及pmtu确定当前的mss*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-6\"><span class=\"crayon-h\">              </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_xmit_size_goal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_OOB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-7\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78dc857827901-8\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78dc857827901-9\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>l  <b>tcp_xmit_size_goal</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78e0903404434\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic unsigned int tcp_xmit_size_goal(struct sock *sk, u32 mss_now,\r\n                                                                int large_allowed)\r\n{\r\n              struct tcp_sock *tp = tcp_sk(sk);\r\n              u32 xmit_size_goal, old_size_goal;\r\n \r\n              xmit_size_goal = mss_now;\r\n    /*这里large_allowed表示是否是紧急数据*/\r\n              if (large_allowed &amp;&amp; sk_can_gso(sk)) { /*如果不是紧急数据且支持GSO*/\r\n                             xmit_size_goal = ((sk-&gt;sk_gso_max_size - 1) -\r\n                                                           inet_csk(sk)-&gt;icsk_af_ops-&gt;net_header_len -\r\n                                                           inet_csk(sk)-&gt;icsk_ext_hdr_len -\r\n                                                           tp-&gt;tcp_header_len);/*xmit_size_goal为gso最大分段大小减去tcp和ip头部长度*/\r\n \r\n                             xmit_size_goal = tcp_bound_to_half_wnd(tp, xmit_size_goal);/*最多达到收到的最大rwnd窗口通告的一半*/\r\n \r\n                             /* We try hard to avoid divides here */\r\n                             old_size_goal = tp-&gt;xmit_size_goal_segs * mss_now;\r\n \r\n                             if (likely(old_size_goal &lt;= xmit_size_goal &amp;&amp;\r\n                                              old_size_goal + mss_now &gt; xmit_size_goal)) {\r\n                                           xmit_size_goal = old_size_goal; /*使用老的xmit_size*/\r\n                             } else {\r\n                                           tp-&gt;xmit_size_goal_segs = xmit_size_goal / mss_now;\r\n                                           xmit_size_goal = tp-&gt;xmit_size_goal_segs * mss_now; /*使用新的xmit_size*/\r\n                             }\r\n              }\r\n \r\n              return max(xmit_size_goal, mss_now);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e0903404434-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e0903404434-30\">30</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_xmit_size_goal</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">u32 </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-2\"><span class=\"crayon-h\">                                                                </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">large_allowed</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-4\"><span class=\"crayon-h\">              </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-5\"><span class=\"crayon-h\">              </span><span class=\"crayon-e\">u32 </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-6\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-7\"><span class=\"crayon-h\">              </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*这里large_allowed表示是否是紧急数据*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-9\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">large_allowed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果不是紧急数据且支持GSO*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-10\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_max_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-11\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-e\">inet_csk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">icsk_af_ops</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">net_header_len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-12\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-e\">inet_csk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">icsk_ext_hdr_len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-13\"><span class=\"crayon-h\">                                                           </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">tcp_header_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*xmit_size_goal为gso最大分段大小减去tcp和ip头部长度*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-14\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-15\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_bound_to_half_wnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*最多达到收到的最大rwnd窗口通告的一半*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-16\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-17\"><span class=\"crayon-h\">                             </span><span class=\"crayon-c\">/* We try hard to avoid divides here */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-18\"><span class=\"crayon-h\">                             </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e \">xmit_size_goal_segs *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-19\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-20\"><span class=\"crayon-h\">                             </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">likely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-21\"><span class=\"crayon-h\">                                              </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-22\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">old_size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*使用老的xmit_size*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-23\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-24\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">xmit_size_goal_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-25\"><span class=\"crayon-h\">                                           </span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e \">xmit_size_goal_segs *</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*使用新的xmit_size*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-26\"><span class=\"crayon-h\">                             </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-27\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-28\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e0903404434-29\"><span class=\"crayon-h\">              </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">xmit_size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e0903404434-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0050 seconds] -->\r\n<p>l  <b>tcp_sendmsg</b></p>\n<p>应用程序send()数据后，会在tcp_sendmsg中尝试在同一个skb，保存size_goal大小的数据，然后再通过tcp_push把这些包通过tcp_write_xmit发出去</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78e4935095387\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint tcp_sendmsg(struct kiocb *iocb, struct socket *sock, struct msghdr *msg,\r\n                             size_t size)\r\n{\r\n    struct sock *sk = sock-&gt;sk;\r\n    struct iovec *iov;\r\n    struct tcp_sock *tp = tcp_sk(sk);\r\n    struct sk_buff *skb;\r\n    int iovlen, flags;\r\n    int mss_now, size_goal;\r\n    int err, copied;\r\n    long timeo;\r\n \r\n    lock_sock(sk);\r\n    TCP_CHECK_TIMER(sk);\r\n \r\n    flags = msg-&gt;msg_flags;\r\n    timeo = sock_sndtimeo(sk, flags &amp; MSG_DONTWAIT);\r\n \r\n    /* Wait for a connection to finish. */\r\n    if ((1 &lt;&lt; sk-&gt;sk_state) &amp; ~(TCPF_ESTABLISHED | TCPF_CLOSE_WAIT))\r\n        if ((err = sk_stream_wait_connect(sk, &amp;timeo)) != 0)\r\n             goto out_err;\r\n \r\n    /* This should be in poll */\r\n    clear_bit(SOCK_ASYNC_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);\r\n    /* size_goal表示GSO支持的大小，为mss的整数倍，不支持GSO时则和mss相等 */\r\n    mss_now = tcp_send_mss(sk, &amp;size_goal, flags);/*返回值mss_now为真实mss*/\r\n \r\n    /* Ok commence sending. */\r\n    iovlen = msg-&gt;msg_iovlen;\r\n    iov = msg-&gt;msg_iov;\r\n    copied = 0;\r\n \r\n    err = -EPIPE;\r\n    if (sk-&gt;sk_err || (sk-&gt;sk_shutdown &amp; SEND_SHUTDOWN))\r\n        goto out_err;\r\n \r\n    while (--iovlen &gt;= 0) {\r\n        size_t seglen = iov-&gt;iov_len;\r\n        unsigned char __user *from = iov-&gt;iov_base;\r\n \r\n        iov++;\r\n \r\n        while (seglen &gt; 0) {\r\n            int copy = 0;\r\n            int max = size_goal; /*每个skb中填充的数据长度初始化为size_goal*/\r\n            /* 从sk-&gt;sk_write_queue中取出队尾的skb，因为这个skb可能还没有被填满 */\r\n            skb = tcp_write_queue_tail(sk);\r\n            if (tcp_send_head(sk)) { /*如果之前还有未发送的数据*/\r\n                if (skb-&gt;ip_summed == CHECKSUM_NONE) /*比如路由变更，之前的不支持TSO,现在的支持了*/\r\n                    max = mss_now; /*上一个不支持GSO的skb，继续不支持*/\r\n                copy = max - skb-&gt;len; /*copy为每次想skb中拷贝的数据长度*/\r\n            }\r\n           /*copy&lt;=0表示不能合并到之前skb做GSO*/\r\n           if (copy &lt;= 0) {\r\nnew_segment:\r\n               /* Allocate new segment. If the interface is SG,\r\n                * allocate skb fitting to single page.\r\n                */\r\n               /* 内存不足，需要等待 */\r\n               if (!sk_stream_memory_free(sk))\r\n                   goto wait_for_sndbuf;\r\n               /* 分配新的skb */\r\n               skb = sk_stream_alloc_skb(sk, select_size(sk), sk-&gt;sk_allocation);\r\n               if (!skb)\r\n                   goto wait_for_memory;\r\n \r\n               /*\r\n                * Check whether we can use HW checksum.\r\n                */\r\n               /*如果硬件支持checksum，则将skb-&gt;ip_summed设置为CHECKSUM_PARTIAL，表示由硬件计算校验和*/\r\n               if (sk-&gt;sk_route_caps &amp; NETIF_F_ALL_CSUM)\r\n                   skb-&gt;ip_summed = CHECKSUM_PARTIAL;\r\n               /*将skb加入sk-&gt;sk_write_queue队尾, 同时去掉skb的TCP_NAGLE_PUSH标记*/\r\n               skb_entail(sk, skb);\r\n               copy = size_goal; /*这里将每次copy的大小设置为size_goal，即GSO支持的大小*/\r\n               max = size_goal;\r\n           }\r\n \r\n           /* Try to append data to the end of skb. */\r\n           if (copy &gt; seglen)\r\n               copy = seglen;\r\n \r\n           /* Where to copy to? */\r\n           if (skb_tailroom(skb) &gt; 0) { /*如果skb的线性区还有空间，则先填充skb的线性区*/\r\n               /* We have some space in skb head. */\r\n               if (copy &gt; skb_tailroom(skb))\r\n                   copy = skb_tailroom(skb);\r\n               if ((err = skb_add_data(skb, from, copy)) != 0) /*copy用户态数据到skb线性区*/\r\n                   goto do_fault;\r\n           } else { /*否则尝试向SG的frags中拷贝*/\r\n               int merge = 0;\r\n               int i = skb_shinfo(skb)-&gt;nr_frags;\r\n               struct page *page = TCP_PAGE(sk);\r\n               int off = TCP_OFF(sk);\r\n \r\n               if (skb_can_coalesce(skb, i, page, off) &amp;&amp; off != PAGE_SIZE) {/*pfrag-&gt;page和frags[i-1]是否使用相同页，并且page_offset相同*/\r\n                   /* We can extend the last page\r\n                   * fragment. */\r\n                   merge = 1; /*说明和之前frags中是同一个page，需要merge*/\r\n               } else if (i == MAX_SKB_FRAGS || (!i &amp;&amp; !(sk-&gt;sk_route_caps &amp; NETIF_F_SG))) {\r\n                   /* Need to add new fragment and cannot\r\n                    * do this because interface is non-SG,\r\n                    * or because all the page slots are\r\n                    * busy. */\r\n                   /*如果设备不支持SG，或者非线性区frags已经达到最大，则创建新的skb分段*/\r\n                   tcp_mark_push(tp, skb); /*标记push flag*/\r\n                       goto new_segment;\r\n               } else if (page) {\r\n                   if (off == PAGE_SIZE) {\r\n                       put_page(page); /*增加page引用计数*/\r\n                       TCP_PAGE(sk) = page = NULL;\r\n                       off = 0;\r\n                   }\r\n              } else\r\n                  off = 0;\r\n                  if (copy &gt; PAGE_SIZE - off)\r\n                  copy = PAGE_SIZE - off;\r\n                  if (!sk_wmem_schedule(sk, copy))\r\n                      goto wait_for_memory;\r\n \r\n                 if (!page) {\r\n                     /* Allocate new cache page. */\r\n                     if (!(page = sk_stream_alloc_page(sk)))\r\n                     goto wait_for_memory;\r\n                 }\r\n \r\n                 err = skb_copy_to_page(sk, from, skb, page, off, copy); /*拷贝数据到page中*/\r\n                 if (err) {\r\n                     /* If this page was new, give it to the\r\n                      * socket so it does not get leaked.\r\n                      */\r\n                     if (!TCP_PAGE(sk)) {\r\n                         TCP_PAGE(sk) = page;\r\n                         TCP_OFF(sk) = 0;\r\n                     }\r\n                     goto do_error;\r\n                }\r\n \r\n                /* Update the skb. */\r\n                if (merge) { /*pfrag和frags[i - 1]是相同的*/\r\n                     skb_shinfo(skb)-&gt;frags[i - 1].size += copy;\r\n                } else {\r\n                    skb_fill_page_desc(skb, i, page, off, copy);\r\n                    if (TCP_PAGE(sk)) {\r\n                        get_page(page);\r\n                    } else if (off + copy &lt; PAGE_SIZE) {\r\n                        get_page(page);\r\n                        TCP_PAGE(sk) = page;\r\n                    }\r\n                }\r\n                TCP_OFF(sk) = off + copy;\r\n            }\r\n            if (!copied)\r\n                TCP_SKB_CB(skb)-&gt;flags &amp;= ~TCPCB_FLAG_PSH;\r\n \r\n            tp-&gt;write_seq += copy;\r\n            TCP_SKB_CB(skb)-&gt;end_seq += copy;\r\n            skb_shinfo(skb)-&gt;gso_segs = 0; /*清零tso分段数，让tcp_write_xmit去计算*/\r\n            from += copy;\r\n            copied += copy;\r\n            if ((seglen -= copy) == 0 &amp;&amp; iovlen == 0)\r\n                goto out;\r\n            /* 还有数据没copy，并且没有达到最大可拷贝的大小(注意这里max之前被赋值为size_goal，即GSO支持的大小)， 尝试往该skb继续添加数据*/\r\n            if (skb-&gt;len &lt; max || (flags &amp; MSG_OOB))\r\n                continue;\r\n            /*下面的逻辑就是：还有数据没copy，但是当前skb已经满了，所以可以发送了(但不是一定要发送)*/\r\n            if (forced_push(tp)) { /*超过最大窗口的一半没有设置push了*/\r\n                tcp_mark_push(tp, skb); /*设置push标记，更新pushed_seq*/\r\n                __tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH); /*调用tcp_write_xmit马上发送*/\r\n            } else if (skb == tcp_send_head(sk)) /*第一个包，直接发送*/\r\n                tcp_push_one(sk, mss_now);\r\n                continue; /*说明发送队列前面还有skb等待发送，且距离之前push的包还不是非常久*/\r\nwait_for_sndbuf:\r\n                set_bit(SOCK_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);\r\nwait_for_memory:\r\n                if (copied)/*先把copied的发出去再等内存*/\r\n                    tcp_push(sk, flags &amp; ~MSG_MORE, mss_now, TCP_NAGLE_PUSH);\r\n               /*阻塞等待内存*/\r\n               if ((err = sk_stream_wait_memory(sk, &amp;timeo)) != 0)\r\n                   goto do_error;\r\n               mss_now = tcp_send_mss(sk, &amp;size_goal, flags);\r\n          }\r\n      }\r\n \r\nout:\r\n      if (copied) /*所有数据都放到发送队列中了，调用tcp_push发送*/\r\n          tcp_push(sk, flags, mss_now, tp-&gt;nonagle);\r\n      TCP_CHECK_TIMER(sk);\r\n      release_sock(sk);\r\n      return copied;\r\n \r\ndo_fault:\r\n      if (!skb-&gt;len) {\r\n          tcp_unlink_write_queue(skb, sk);\r\n          /* It is the one place in all of TCP, except connection\r\n           * reset, where we can be unlinking the send_head.\r\n           */\r\n          tcp_check_send_head(sk, skb);\r\n          sk_wmem_free_skb(sk, skb);\r\n      }\r\n \r\ndo_error:\r\n      if (copied)\r\n          goto out;\r\nout_err:\r\n      err = sk_stream_error(sk, flags, err);\r\n      TCP_CHECK_TIMER(sk);\r\n      release_sock(sk);\r\n      return err;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-77\">77</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-78\">78</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-79\">79</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-80\">80</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-81\">81</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-82\">82</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-83\">83</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-84\">84</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-85\">85</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-86\">86</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-87\">87</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-88\">88</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-89\">89</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-90\">90</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-91\">91</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-92\">92</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-93\">93</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-94\">94</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-95\">95</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-96\">96</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-97\">97</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-98\">98</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-99\">99</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-100\">100</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-101\">101</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-102\">102</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-103\">103</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-104\">104</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-105\">105</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-106\">106</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-107\">107</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-108\">108</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-109\">109</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-110\">110</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-111\">111</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-112\">112</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-113\">113</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-114\">114</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-115\">115</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-116\">116</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-117\">117</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-118\">118</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-119\">119</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-120\">120</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-121\">121</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-122\">122</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-123\">123</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-124\">124</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-125\">125</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-126\">126</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-127\">127</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-128\">128</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-129\">129</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-130\">130</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-131\">131</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-132\">132</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-133\">133</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-134\">134</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-135\">135</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-136\">136</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-137\">137</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-138\">138</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-139\">139</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-140\">140</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-141\">141</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-142\">142</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-143\">143</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-144\">144</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-145\">145</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-146\">146</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-147\">147</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-148\">148</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-149\">149</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-150\">150</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-151\">151</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-152\">152</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-153\">153</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-154\">154</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-155\">155</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-156\">156</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-157\">157</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-158\">158</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-159\">159</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-160\">160</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-161\">161</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-162\">162</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-163\">163</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-164\">164</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-165\">165</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-166\">166</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-167\">167</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-168\">168</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-169\">169</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-170\">170</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-171\">171</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-172\">172</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-173\">173</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-174\">174</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-175\">175</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-176\">176</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-177\">177</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-178\">178</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-179\">179</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-180\">180</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-181\">181</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-182\">182</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-183\">183</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-184\">184</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-185\">185</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-186\">186</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-187\">187</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-188\">188</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-189\">189</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-190\">190</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-191\">191</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-192\">192</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-193\">193</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-194\">194</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-195\">195</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-196\">196</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-197\">197</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-198\">198</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-199\">199</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-200\">200</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-201\">201</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-202\">202</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-203\">203</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-204\">204</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-205\">205</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-206\">206</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-207\">207</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-208\">208</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-209\">209</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78e4935095387-210\">210</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78e4935095387-211\">211</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sendmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">kiocb *</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">socket *</span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">msghdr *</span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-2\"><span class=\"crayon-h\">                             </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">iovec *</span><span class=\"crayon-v\">iov</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-12\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">lock_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-15\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_flags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sock_sndtimeo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_DONTWAIT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-18\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Wait for a connection to finish. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_state</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TCPF_ESTABLISHED</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCPF_CLOSE_WAIT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_wait_connect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-22\"><span class=\"crayon-h\">             </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out_err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-23\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* This should be in poll */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">clear_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_ASYNC_NOSPACE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* size_goal表示GSO支持的大小，为mss的整数倍，不支持GSO时则和mss相等 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*返回值mss_now为真实mss*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-28\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Ok commence sending. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_iovlen</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">iov</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">msg_iov</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-33\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EPIPE</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_shutdown</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SEND_SHUTDOWN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out_err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-37\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">iov_len</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">__user *</span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">iov_base</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-41\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">iov</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-43\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-46\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*每个skb中填充的数据长度初始化为size_goal*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 从sk-&gt;sk_write_queue中取出队尾的skb，因为这个skb可能还没有被填满 */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-48\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_write_queue_tail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-49\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果之前还有未发送的数据*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-50\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_NONE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*比如路由变更，之前的不支持TSO,现在的支持了*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-51\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*上一个不支持GSO的skb，继续不支持*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-52\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*copy为每次想skb中拷贝的数据长度*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-54\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/*copy&lt;=0表示不能合并到之前skb做GSO*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-55\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-56\"><span class=\"crayon-v\">new_segment</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-57\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* Allocate new segment. If the interface is SG,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-58\"><span class=\"crayon-c\">                * allocate skb fitting to single page.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-59\"><span class=\"crayon-c\">                */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-60\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* 内存不足，需要等待 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-61\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_stream_memory_free</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-62\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_sndbuf</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-63\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* 分配新的skb */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-64\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_alloc_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">select_size</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_allocation</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-65\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-66\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-67\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-68\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-69\"><span class=\"crayon-c\">                * Check whether we can use HW checksum.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-70\"><span class=\"crayon-c\">                */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-71\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*如果硬件支持checksum，则将skb-&gt;ip_summed设置为CHECKSUM_PARTIAL，表示由硬件计算校验和*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-72\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_ALL_CSUM</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-73\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_PARTIAL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-74\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*将skb加入sk-&gt;sk_write_queue队尾, 同时去掉skb的TCP_NAGLE_PUSH标记*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-75\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">skb_entail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-76\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*这里将每次copy的大小设置为size_goal，即GSO支持的大小*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-77\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-78\"><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-79\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-80\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/* Try to append data to the end of skb. */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-81\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-82\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">seglen</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-83\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-84\"><span class=\"crayon-h\">           </span><span class=\"crayon-c\">/* Where to copy to? */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-85\"><span class=\"crayon-h\">           </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*如果skb的线性区还有空间，则先填充skb的线性区*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-86\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/* We have some space in skb head. */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-87\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-88\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_tailroom</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-89\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_add_data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*copy用户态数据到skb线性区*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-90\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_fault</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-91\"><span class=\"crayon-h\">           </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*否则尝试向SG的frags中拷贝*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-92\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">merge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-93\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nr_frags</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-94\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">page *</span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-95\"><span class=\"crayon-h\">               </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-96\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-97\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_can_coalesce</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*pfrag-&gt;page和frags[i-1]是否使用相同页，并且page_offset相同*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-98\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/* We can extend the last page</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-99\"><span class=\"crayon-c\">                   * fragment. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-100\"><span class=\"crayon-h\">                   </span><span class=\"crayon-v\">merge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*说明和之前frags中是同一个page，需要merge*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-101\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAX_SKB_FRAGS</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_route_caps</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NETIF_F_SG</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-102\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/* Need to add new fragment and cannot</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-103\"><span class=\"crayon-c\">                    * do this because interface is non-SG,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-104\"><span class=\"crayon-c\">                    * or because all the page slots are</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-105\"><span class=\"crayon-c\">                    * busy. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-106\"><span class=\"crayon-h\">                   </span><span class=\"crayon-c\">/*如果设备不支持SG，或者非线性区frags已经达到最大，则创建新的skb分段*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-107\"><span class=\"crayon-h\">                   </span><span class=\"crayon-e\">tcp_mark_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*标记push flag*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-108\"><span class=\"crayon-h\">                       </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">new_segment</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-109\"><span class=\"crayon-h\">               </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-110\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-111\"><span class=\"crayon-h\">                       </span><span class=\"crayon-e\">put_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*增加page引用计数*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-112\"><span class=\"crayon-h\">                       </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-113\"><span class=\"crayon-h\">                       </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-114\"><span class=\"crayon-h\">                   </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-115\"><span class=\"crayon-h\">              </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-116\"><span class=\"crayon-h\">                  </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-117\"><span class=\"crayon-h\">                  </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-118\"><span class=\"crayon-h\">                  </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-119\"><span class=\"crayon-h\">                  </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_wmem_schedule</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-120\"><span class=\"crayon-h\">                      </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-121\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-122\"><span class=\"crayon-h\">                 </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-123\"><span class=\"crayon-h\">                     </span><span class=\"crayon-c\">/* Allocate new cache page. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-124\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_alloc_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-125\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-126\"><span class=\"crayon-h\">                 </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-127\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-128\"><span class=\"crayon-h\">                 </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">skb_copy_to_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*拷贝数据到page中*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-129\"><span class=\"crayon-h\">                 </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-130\"><span class=\"crayon-h\">                     </span><span class=\"crayon-c\">/* If this page was new, give it to the</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-131\"><span class=\"crayon-c\">                      * socket so it does not get leaked.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-132\"><span class=\"crayon-c\">                      */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-133\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-134\"><span class=\"crayon-h\">                         </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-135\"><span class=\"crayon-h\">                         </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-136\"><span class=\"crayon-h\">                     </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-137\"><span class=\"crayon-h\">                     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-138\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-139\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-140\"><span class=\"crayon-h\">                </span><span class=\"crayon-c\">/* Update the skb. */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-141\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">merge</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*pfrag和frags[i - 1]是相同的*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-142\"><span class=\"crayon-h\">                     </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">frags</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-143\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-144\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">skb_fill_page_desc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-145\"><span class=\"crayon-h\">                    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-146\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">get_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-147\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PAGE_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-148\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">get_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-149\"><span class=\"crayon-h\">                        </span><span class=\"crayon-e\">TCP_PAGE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-150\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-151\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-152\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">TCP_OFF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">off</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-153\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-154\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-155\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">TCPCB_FLAG_PSH</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-156\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-157\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">write_seq</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-158\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">end_seq</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-159\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*清零tso分段数，让tcp_write_xmit去计算*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-160\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-161\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-162\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">seglen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iovlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-163\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-164\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 还有数据没copy，并且没有达到最大可拷贝的大小(注意这里max之前被赋值为size_goal，即GSO支持的大小)， 尝试往该skb继续添加数据*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-165\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_OOB</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-166\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">continue</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-167\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/*下面的逻辑就是：还有数据没copy，但是当前skb已经满了，所以可以发送了(但不是一定要发送)*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-168\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">forced_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*超过最大窗口的一半没有设置push了*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-169\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">tcp_mark_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*设置push标记，更新pushed_seq*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-170\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">__tcp_push_pending_frames</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*调用tcp_write_xmit马上发送*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-171\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*第一个包，直接发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-172\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">tcp_push_one</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-173\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">continue</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*说明发送队列前面还有skb等待发送，且距离之前push的包还不是非常久*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-174\"><span class=\"crayon-v\">wait_for_sndbuf</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-175\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">set_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_NOSPACE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-176\"><span class=\"crayon-v\">wait_for_memory</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-177\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">/*先把copied的发出去再等内存*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-178\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">tcp_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">MSG_MORE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-179\"><span class=\"crayon-h\">               </span><span class=\"crayon-c\">/*阻塞等待内存*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-180\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_wait_memory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-181\"><span class=\"crayon-h\">                   </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">do_error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-182\"><span class=\"crayon-h\">               </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">size_goal</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-183\"><span class=\"crayon-h\">          </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-184\"><span class=\"crayon-h\">      </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-185\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-186\"><span class=\"crayon-v\">out</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-187\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*所有数据都放到发送队列中了，调用tcp_push发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-188\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_push</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-189\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-190\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-191\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-192\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-193\"><span class=\"crayon-v\">do_fault</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-194\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-195\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_unlink_write_queue</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-196\"><span class=\"crayon-h\">          </span><span class=\"crayon-c\">/* It is the one place in all of TCP, except connection</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-197\"><span class=\"crayon-c\">           * reset, where we can be unlinking the send_head.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-198\"><span class=\"crayon-c\">           */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-199\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">tcp_check_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-200\"><span class=\"crayon-h\">          </span><span class=\"crayon-e\">sk_wmem_free_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-201\"><span class=\"crayon-h\">      </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-202\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-203\"><span class=\"crayon-v\">do_error</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-204\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-205\"><span class=\"crayon-h\">          </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-206\"><span class=\"crayon-v\">out_err</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-207\"><span class=\"crayon-h\">      </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_stream_error</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-208\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">TCP_CHECK_TIMER</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-209\"><span class=\"crayon-h\">      </span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78e4935095387-210\"><span class=\"crayon-h\">      </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78e4935095387-211\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0316 seconds] -->\r\n<p>最终会调用tcp_push发送skb，而tcp_push又会调用tcp_write_xmit。tcp_sendmsg已经把数据按照GSO最大的size，放到一个个的skb中， 最终调用tcp_write_xmit发送这些GSO包。tcp_write_xmit会检查当前的拥塞窗口，还有nagle测试，tsq检查来决定是否能发送整个或者部分的skb， 如果只能发送一部分，则需要调用tso_fragment做切分。最后通过tcp_transmit_skb发送， 如果发送窗口没有达到限制，skb中存放的数据将达到GSO最大值。</p>\n<p>l  <b>tcp_write_xmit</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78ed301179950\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_write_xmit(struct sock *sk, unsigned int mss_now, int nonagle,\r\n                                             int push_one, gfp_t gfp)\r\n{\r\n    struct tcp_sock *tp = tcp_sk(sk);\r\n    struct sk_buff *skb;\r\n    unsigned int tso_segs, sent_pkts;\r\n    int cwnd_quota;\r\n    int result;\r\n \r\n    sent_pkts = 0;\r\n \r\n    if (!push_one) {\r\n        /* Do MTU probing. */\r\n        result = tcp_mtu_probe(sk);\r\n        if (!result) {\r\n            return 0;\r\n        } else if (result &gt; 0) {\r\n            sent_pkts = 1;\r\n        }\r\n    }\r\n    /*遍历发送队列*/\r\n    while ((skb = tcp_send_head(sk))) {\r\n        unsigned int limit;\r\n \r\n        tso_segs = tcp_init_tso_segs(sk, skb, mss_now); /*skb-&gt;len/mss，重新设置tcp_gso_segs，因为在tcp_sendmsg中被清零了*/\r\n        BUG_ON(!tso_segs);\r\n \r\n        cwnd_quota = tcp_cwnd_test(tp, skb);\r\n        if (!cwnd_quota)\r\n            break;\r\n \r\n        if (unlikely(!tcp_snd_wnd_test(tp, skb, mss_now)))\r\n            break;\r\n \r\n        if (tso_segs == 1) { /*tso_segs=1表示无需tso分段*/\r\n            /* 根据nagle算法，计算是否需要推迟发送数据 */\r\n            if (unlikely(!tcp_nagle_test(tp, skb, mss_now, (tcp_skb_is_last(sk, skb) ? /*last skb就直接发送*/\r\n                           nonagle : TCP_NAGLE_PUSH))))\r\n                break;\r\n        } else {/*有多个tso分段*/\r\n            if (!push_one /*push所有skb*/\r\n                 &amp;&amp; tcp_tso_should_defer(sk, skb))/*/如果发送窗口剩余不多，并且预计下一个ack将很快到来(意味着可用窗口会增加)，则推迟发送*/\r\n               break;\r\n        }\r\n        /*下面的逻辑是：不用推迟发送，马上发送的情况*/\r\n        limit = mss_now;\r\n        /*由于tso_segs被设置为skb-&gt;len/mss_now，所以开启gso时一定大于1*/\r\n        if (tso_segs &gt; 1 &amp;&amp; !tcp_urg_mode(tp)) /*tso分段大于1且非urg模式*/\r\n            limit = tcp_mss_split_point(sk, skb, mss_now, cwnd_quota);/*返回当前skb中可以发送的数据大小，通过mss和cwnd*/\r\n        /* 当skb的长度大于限制时，需要调用tso_fragment分片,如果分段失败则暂不发送 */\r\n        if (skb-&gt;len &gt; limit &amp;&amp;\r\n             unlikely(tso_fragment(sk, skb, limit, mss_now))) /*/按limit切割成多个skb*/\r\n            break;\r\n \r\n        TCP_SKB_CB(skb)-&gt;when = tcp_time_stamp;\r\n        /*发送，如果包被qdisc丢了，则退出循环，不继续发送了*/\r\n        if (unlikely(tcp_transmit_skb(sk, skb, 1, gfp)))\r\n            break;\r\n \r\n        /* Advance the send_head. This one is sent out.\r\n         * This call will increment packets_out.\r\n         */\r\n        /*更新sk_send_head和packets_out*/\r\n        tcp_event_new_data_sent(sk, skb);\r\n        tcp_minshall_update(tp, mss_now, skb);\r\n        sent_pkts++;\r\n \r\n        if (push_one)\r\n            break;\r\n    }\r\n \r\n    if (likely(sent_pkts)) {\r\n        tcp_cwnd_validate(sk);\r\n        return 0;\r\n    }\r\n    return !tp-&gt;packets_out &amp;&amp; tcp_send_head(sk);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78ed301179950-76\">76</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78ed301179950-77\">77</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_write_xmit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-2\"><span class=\"crayon-h\">                                             </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">gfp_t </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">tcp_sock *</span><span class=\"crayon-v\">tp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_sk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-9\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-11\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* Do MTU probing. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_mtu_probe</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*遍历发送队列*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-24\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_init_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*skb-&gt;len/mss，重新设置tcp_gso_segs，因为在tcp_sendmsg中被清零了*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">BUG_ON</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-27\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_cwnd_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-31\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_snd_wnd_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-34\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*tso_segs=1表示无需tso分段*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-36\"><span class=\"crayon-h\">            </span><span class=\"crayon-c\">/* 根据nagle算法，计算是否需要推迟发送数据 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_nagle_test</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_skb_is_last</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*last skb就直接发送*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-38\"><span class=\"crayon-h\">                           </span><span class=\"crayon-v\">nonagle</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_NAGLE_PUSH</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-39\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*有多个tso分段*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-41\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*push所有skb*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-42\"><span class=\"crayon-h\">                 </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_tso_should_defer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">/*/如果发送窗口剩余不多，并且预计下一个ack将很快到来(意味着可用窗口会增加)，则推迟发送*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-43\"><span class=\"crayon-h\">               </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-45\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*下面的逻辑是：不用推迟发送，马上发送的情况*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-46\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*由于tso_segs被设置为skb-&gt;len/mss_now，所以开启gso时一定大于1*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">tcp_urg_mode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*tso分段大于1且非urg模式*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-49\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_mss_split_point</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cwnd_quota</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">/*返回当前skb中可以发送的数据大小，通过mss和cwnd*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-50\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* 当skb的长度大于限制时，需要调用tso_fragment分片,如果分段失败则暂不发送 */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-51\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-52\"><span class=\"crayon-h\">             </span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tso_fragment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">limit</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*/按limit切割成多个skb*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-53\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-54\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TCP_SKB_CB</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">when</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_time_stamp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*发送，如果包被qdisc丢了，则退出循环，不继续发送了*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">unlikely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">tcp_transmit_skb</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-58\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-59\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-60\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/* Advance the send_head. This one is sent out.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-61\"><span class=\"crayon-c\">         * This call will increment packets_out.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-62\"><span class=\"crayon-c\">         */</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-63\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">/*更新sk_send_head和packets_out*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-64\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_event_new_data_sent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-65\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_minshall_update</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-66\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-67\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-68\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">push_one</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-69\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-70\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-71\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-72\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">likely</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sent_pkts</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-73\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_cwnd_validate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-74\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-75\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78ed301179950-76\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">packets_out</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_send_head</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78ed301179950-77\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0108 seconds] -->\r\n<p>其中tcp_init_tso_segs会设置skb的gso信息后文分析。我们看到tcp_write_xmit 会调用tso_fragment进行“tcp分段”。而分段的条件是skb-&gt;len &gt; limit。这里的关键就是limit的值，我们看到在tso_segs &gt; 1时，也就是开启gso的时候，limit的值是由tcp_mss_split_point得到的，也就是min(skb-&gt;len, window)，即发送窗口允许的最大值。在没有开启gso时limit就是当前的mss。</p>\n<p>l  <b>tcp_init_tso_segs</b></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78f3288382102\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int tcp_init_tso_segs(struct sock *sk, struct sk_buff *skb, unsigned int mss_now)\r\n{\r\n    int tso_segs = tcp_skb_pcount(skb); /*skb_shinfo(skb)-&gt;gso_seg之前被初始化为0*/\r\n \r\n    if (!tso_segs || (tso_segs &gt; 1 &amp;&amp; tcp_skb_mss(skb) != mss_now)) {\r\n        tcp_set_skb_tso_segs(sk, skb, mss_now);\r\n        tso_segs = tcp_skb_pcount(skb);\r\n    }\r\n    return tso_segs;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f3288382102-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f3288382102-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_init_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_pcount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*skb_shinfo(skb)-&gt;gso_seg之前被初始化为0*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-4\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_mss</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">tcp_set_skb_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_skb_pcount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f3288382102-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tso_segs</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f3288382102-10\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596006fad78f6115659724\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic void tcp_set_skb_tso_segs(struct sock *sk, struct sk_buff *skb, unsigned int mss_now)\r\n{\r\n    /* Make sure we own this skb before messing gso_size/gso_segs */\r\n    WARN_ON_ONCE(skb_cloned(skb));\r\n    if (skb-&gt;len &lt;= mss_now || !sk_can_gso(sk) ||\r\n        skb-&gt;ip_summed == CHECKSUM_NONE) {/*不支持gso的情况*/\r\n       /* Avoid the costly divide in the normal\r\n        * non-TSO case.\r\n        */\r\n       skb_shinfo(skb)-&gt;gso_segs = 1;\r\n       skb_shinfo(skb)-&gt;gso_size = 0;\r\n       skb_shinfo(skb)-&gt;gso_type = 0;\r\n    } else {\r\n        skb_shinfo(skb)-&gt;gso_segs = DIV_ROUND_UP(skb-&gt;len, mss_now); /*被设置为skb-&gt;len/mss_now*/\r\n        skb_shinfo(skb)-&gt;gso_size = mss_now; /*注意mss_now为真实的mss，这里保存以供gso分段使用*/\r\n        skb_shinfo(skb)-&gt;gso_type = sk-&gt;sk_gso_type;\r\n    }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596006fad78f6115659724-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596006fad78f6115659724-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_set_skb_tso_segs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sock *</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">sk_buff *</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* Make sure we own this skb before messing gso_size/gso_segs */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">WARN_ON_ONCE</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">skb_cloned</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">sk_can_gso</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ip_summed</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CHECKSUM_NONE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">/*不支持gso的情况*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-7\"><span class=\"crayon-h\">       </span><span class=\"crayon-c\">/* Avoid the costly divide in the normal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-8\"><span class=\"crayon-c\">        * non-TSO case.</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-9\"><span class=\"crayon-c\">        */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-10\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-11\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-12\"><span class=\"crayon-h\">       </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_segs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DIV_ROUND_UP</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*被设置为skb-&gt;len/mss_now*/</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_size</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mss_now</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">/*注意mss_now为真实的mss，这里保存以供gso分段使用*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">skb_shinfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">skb</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">gso_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_gso_type</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596006fad78f6115659724-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596006fad78f6115659724-18\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>tcp_write_xmit最后会调用ip_queue_xmit发送skb，进入ip层。</p>\n<h2>ip分片，tcp分段，GSO，TSO</h2>\n<p>之后的逻辑就是之前另一篇文章中分析的GSO逻辑了。下面我们看下整个协议栈中ip分片，tcp分段，GSO，TSO的关系。我将这个流程由下图表示。</p>\n<p><img class=\"aligncenter\" src=\"http://blog.chinaunix.net/attachment/201705/6/28541347_1494074632KCCh.png\" alt=\"\" width=\"598\" height=\"856\"></p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111668\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111668votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111668\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2015/10/23426c26d6b88a782a1d894de8e89bca.jpg', 'full/a6e095311cee5dbfc6a3b7e5127f63181f1ad769.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('使用 Nmon 监控 Linux 的系统性能', '2017-07-07', 'http://blog.jobbole.com/111587/', '41936b748d950cc69823a09265f9e1a0', 2, 1, 'IT技术, Linux, Nmon', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.maketecheasier.com/monitor-linux-system-performance/\">Hitesh Jethva</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-6886-1.html\">Linux 中国</a>   </div><p>Nmon（得名于 Nigel 的监控器）是IBM的员工 Nigel Griffiths 为 AIX 和 Linux 系统开发的一款计算机性能系统监控工具。Nmon 可以把操作系统的统计数据展示在屏幕上或者存储到一份数据文件里，来帮助了解计算机资源的使用情况、调整方向和系统瓶颈。这个系统基准测试工具只需要使用一条命令就能得到大量重要的性能数据。使用 Nmon 可以很轻松的监控系统的 CPU、内存、网络、硬盘、文件系统、NFS、高耗进程、资源和 IBM Power 系统的微分区的信息。</p>\n<h3 id=\"toc_1\">Nmon 安装</h3>\n<p>Nmon 默认是存在于 Ubuntu 的仓库中的。你可以通过下面的命令安装 Nmon：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81df05c146002732\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo apt-get install nmon</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81df05c146002732-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81df05c146002732-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">apt</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">get </span><span class=\"crayon-e\">install </span><span class=\"crayon-v\">nmon</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h3 id=\"toc_2\">怎么使用Nmon来监控Linux的性能</h3>\n<p>安装完成后，通过在终端输入<code>nmon</code> 命令来启动 Nmon</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81df065532316184\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nnmon</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81df065532316184-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81df065532316184-1\"><span class=\"crayon-v\">nmon</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0002 seconds] -->\r\n<p>你会看到下面的输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063604jy0wkkuvz8jnzss8.png\" alt=\"nmon-output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>nmon-output</em></p>\n<p>从上面的截图可以看到 nmon 命令行工具完全是交互式运行的，你可以使用快捷键来轻松查看对应的统计数据。你可以使用下面的 nmon 快捷键来显示不同的系统统计数据：</p>\n<ul>\n<li><code>q</code> : 停止并退出 Nmon</li>\n<li><code>h</code> : 查看帮助</li>\n<li><code>c</code> : 查看 CPU 统计数据</li>\n<li><code>m</code> : 查看内存统计数据</li>\n<li><code>d</code> : 查看硬盘统计数据</li>\n<li><code>k</code> : 查看内核统计数据</li>\n<li><code>n</code> : 查看网络统计数据</li>\n<li><code>N</code> : 查看 NFS 统计数据</li>\n<li><code>j</code> : 查看文件系统统计数据</li>\n<li><code>t</code> : 查看高耗进程</li>\n<li><code>V</code> : 查看虚拟内存统计数据</li>\n<li><code>v</code> : 详细模式</li>\n</ul>\n<h3 id=\"toc_3\">核查 CPU 处理器</h3>\n<p>如果你想收集关于 CPU 性能相关的统计数据，你应该按下键盘上的<code>c</code>键，之后你将会看到下面的输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063605ko14d13jrd58ttow.png\" alt=\"nmon_cpu_output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>nmon_cpu_output</em></p>\n<h3 id=\"toc_4\">核查高耗进程统计数据</h3>\n<p>如果想收集系统正在运行的高耗进程的统计数据，按键盘上的<code>t</code>键，之后你将会看到下面的输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063609idvjcvmdmm6v4zjz.jpg\" alt=\"nmon_process_output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>nmon_process_output</em></p>\n<h3 id=\"toc_5\">核查网络统计数据</h3>\n<p>如果想收集 Linux 系统的网络统计数据，按下<code>n</code>键，你将会看到下面输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063610wib3m6qwjcnq3mmn.png\" alt=\"n_network_output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>n_network_output</em></p>\n<h3 id=\"toc_6\">硬盘 I/O 图表</h3>\n<p>使用<code>d</code> 键获取硬盘相关的信息，你会看到下面输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063611o2ztlpsp8fj4ljn8.png\" alt=\"nmon_disk_output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>nmon_disk_output</em></p>\n<h3 id=\"toc_7\">核查内核信息</h3>\n<p>Nmon 一个非常重要的快捷键是<code>k</code>键，用来显示系统内核相关的概要信息。按下<code>k</code>键之后，会看到下面输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063612l5s8m5cm1onslhzx.png\" alt=\"nmon_kernel_output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>nmon_kernel_output</em></p>\n<h3 id=\"toc_8\">获取系统信息</h3>\n<p>对每个系统管理员来说一个非常有用的快捷键是<code>r</code>键，可以用来显示计算机的系统结构、操作系统版本号和 CPU 等不同资源的信息。按下<code>r</code>键之后会看到下面输出：</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063614r71jjf5funtn7unv.png\" alt=\"nmon_system_output\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center\"><em>nmon_system_output</em></p>\n<h3 id=\"toc_9\">总结</h3>\n<p>还有许多其他的工具做的和 Nmon 同样的工作，不过 Nmon 对一个 Linux 新手来说还是很友好的。如果你有什么问题，尽管评论。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111587\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111587votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111587\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'https://dn-linuxcn.qbox.me/data/attachment/album/201601/14/063604jy0wkkuvz8jnzss8.png', 'full/9d7d43ff6c607ddfd743f689be22c76d0a21bd71.jpg'),
('一步步实现 Redis 搜索引擎', '2017-07-07', 'http://blog.jobbole.com/111480/', '42369d324412b391499279a170e4ca36', 4, 1, 'IT技术, , Redis', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md\">jasonGeng88</a>   </div><div>\n<h2>场景</h2>\n</div>\n<p>大家如果是做后端开发的，想必都实现过列表查询的接口，当然有的查询条件很简单，一条 SQL 就搞定了，但有的查询条件极其复杂，再加上库表中设计的各种不合理，导致查询接口特别难写，然后加班什么的就不用说了（<em>不知各位有没有这种感受呢~</em>）。</p>\n<p>下面以一个例子开始，这是某购物网站的搜索条件，如果让你实现这样的一个搜索接口，你会如何实现？（<em>当然你说借助搜索引擎，像 Elasticsearch 之类的，你完全可以实现。但我这里想说的是，如果要你自己实现呢？</em>）</p>\n<p><a href=\"https://github.com/jasonGeng88/blog/blob/master/201706/assets/redis_search_01.png\" target=\"_blank\"><img src=\"https://github.com/jasonGeng88/blog/raw/master/201706/assets/redis_search_01.png\" alt=\"\"></a></p>\n<p>从上图中可以看出，搜索总共分为6大类，每大类中又分了各个子类。这中间，各大类条件之间是取的交集，各子类中有单选、多选、以及自定义的情况，最终输出符合条件的结果集。</p>\n<p>好了，既然需求很明确了，我们就开始来实现。</p>\n<h2><a id=\"user-content-实现1\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E5%AE%9E%E7%8E%B01\"></a>实现1</h2>\n<p>率先登场是小A同学，他是写 SQL 方面的“专家”。小A信心满满的说：“不就是一个查询接口吗？看着条件很多，但凭着我丰富的 SQL 经验，这点还是难不倒我的。”</p>\n<p>于是乎就写出了下面这段代码（这里以 MYSQL 为例）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017a8a4603233531950\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nselect ... from table_1\r\nleft join table_2\r\nleft join table_3\r\nleft join (select ... from table_x where ...) tmp_1\r\n...\r\nwhere ...\r\norder by ...\r\nlimit m,n</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017a8a4603233531950-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a4603233531950-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017a8a4603233531950-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a4603233531950-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017a8a4603233531950-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a4603233531950-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596017a8a4603233531950-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a4603233531950-8\">8</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017a8a4603233531950-1\"><span class=\"crayon-i\">select</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">from </span><span class=\"crayon-e\">table_1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a4603233531950-2\"><span class=\"crayon-e\">left </span><span class=\"crayon-e\">join </span><span class=\"crayon-e\">table_2</span></div><div class=\"crayon-line\" id=\"crayon-596017a8a4603233531950-3\"><span class=\"crayon-e\">left </span><span class=\"crayon-e\">join </span><span class=\"crayon-e\">table_3</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a4603233531950-4\"><span class=\"crayon-e\">left </span><span class=\"crayon-e\">join</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">select</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">from </span><span class=\"crayon-e\">table_x </span><span class=\"crayon-i\">where</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tmp</span><span class=\"crayon-sy\">_</span>1</div><div class=\"crayon-line\" id=\"crayon-596017a8a4603233531950-5\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a4603233531950-6\"><span class=\"crayon-i\">where</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596017a8a4603233531950-7\"><span class=\"crayon-e\">order </span><span class=\"crayon-i\">by</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a4603233531950-8\"><span class=\"crayon-i\">limit</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">m</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">n</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>代码在测试环境跑了一把，结果好像都匹配上了，于是准备上预发。这一上预发，问题就开始暴露出来。预发为了尽可能的逼真线上环境，所以数据量自然而然要比测试大的多。所以这么一个复杂的 SQL，它的执行效率可想而知。测试同学果断把小A的代码给打了回来。</p>\n<h2><a id=\"user-content-实现2\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E5%AE%9E%E7%8E%B02\"></a>实现2</h2>\n<p>总结了小A失败的教训，小B开始对SQL进行了优化，先是通过了<code>explain</code>关键字进行SQL性能分析，对该加索引的地方都加上了索引。同时将一条复杂SQL拆分成了多条SQL，计算结果在程序内存中进行计算。</p>\n<p>伪代码如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596017a8a460d785131593\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$result_1 = query(\'select ... from table_1 where ...\');\r\n$result_2 = query(\'select ... from table_2 where ...\');\r\n$result_3 = query(\'select ... from table_3 where ...\');\r\n...\r\n\r\n$result = array_intersect($result_1, $result_2, $result_3, ...);</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596017a8a460d785131593-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a460d785131593-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596017a8a460d785131593-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a460d785131593-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596017a8a460d785131593-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596017a8a460d785131593-6\">6</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596017a8a460d785131593-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result_1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">query</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\'select ... from table_1 where ...\'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a460d785131593-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result_2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">query</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\'select ... from table_2 where ...\'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596017a8a460d785131593-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result_3</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">query</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\'select ... from table_3 where ...\'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a460d785131593-4\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-596017a8a460d785131593-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596017a8a460d785131593-6\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">array_intersect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result_1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result_2</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result_3</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>这种方案从性能上明显比第一种要好很多，可是在功能验收的时候，产品经理还是觉得查询速度不够快。小B自己也知道，每次查询都会向数据库查询多次，而且有些历史原因，部分条件是做不到单表查询的，所以查询等待的时间是避免不了的。</p>\n<h2><a id=\"user-content-实现3\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E5%AE%9E%E7%8E%B03\"></a>实现3</h2>\n<p>小C从上面的方案中看到了优化的空间。他发现小B在思路上是没问题的，将复杂条件拆分，计算各个子维度的结果集，最后将所有的子结果集进行一个汇总合并，得到最终想要的结果。</p>\n<p>于是他突发奇想，能否事先将各个子维度的结果集给缓存起来，这要查询的时候直接去取想要的子集，而不用每次去查库计算。</p>\n<p>这里小C采用 <a href=\"https://redis.io/\">Redis</a> 来存储缓存数据，用它的主要原因是，它提供了多种数据结构，并且在 Redis 中进行集合的交并集操作是一件很容易的事情。</p>\n<p>具体方案，如图所示：</p>\n<p><a href=\"https://github.com/jasonGeng88/blog/blob/master/201706/assets/redis_search_02.png\" target=\"_blank\"><img src=\"https://github.com/jasonGeng88/blog/raw/master/201706/assets/redis_search_02.png\" alt=\"\"></a></p>\n<p>这里每个条件都事先将计算好的结果集ID存入对应的key中，选用的数据结构是集合（Set）。查询操作包括：</p>\n<ul>\n<li>子类单选：直接根据条件 key，获取对应结果集；</li>\n<li>子类多选：根据多个条件 Key，进行并集操作，获取对应结果集；</li>\n<li>最终结果：将获取的所有子类结果集进行交集操作，得到最终结果；</li>\n</ul>\n<p><em><strong>这其实就是所谓的<a href=\"https://zh.wikipedia.org/wiki/%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95\">反向索引</a>。</strong></em></p>\n<p>这里会发现，漏了一个价格的条件。从需求中可知，价格条件是个区间，并且是无穷举的。所以上述的这种穷举条件的 Key-Value 方式是做不到的。这里我们采用 Redis 的另一种数据结构进行实现，有序集合（Sorted Set）：</p>\n<p><a href=\"https://github.com/jasonGeng88/blog/blob/master/201706/assets/redis_search_03.png\" target=\"_blank\"><img src=\"https://github.com/jasonGeng88/blog/raw/master/201706/assets/redis_search_03.png\" alt=\"\"></a></p>\n<p>将所有商品加入 Key 为价格的有序集合中，值为商品ID，每个值对应的分数为商品价格的数值。这样在 Redis 的有序集合中就可以通过<code>ZRANGEBYSCORE</code>命令，根据分数（价格）区间，获取相应结果集。</p>\n<p>至此，方案三的优化已全部结束，将数据的查询与计算通过缓存的手段，进行了分离。在每次查找时，只需要简单的查找 Redis 几次就能得出结果。查询速度上符合了验收的要求。</p>\n<h2><a id=\"user-content-扩展\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E6%89%A9%E5%B1%95\"></a>扩展</h2>\n<h3><a id=\"user-content-分页\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E5%88%86%E9%A1%B5\"></a>分页</h3>\n<p>这里你或许发现了一个严重的功能缺陷，列表查询怎么能没有分页。是的，我们马上来看 Redis 是如何实现分页的。</p>\n<p>分页主要涉及排序，这里简单起见，就以创建时间为例。</p>\n<p>如图所示：</p>\n<p><a href=\"https://github.com/jasonGeng88/blog/blob/master/201706/assets/redis_search_04.png\" target=\"_blank\"><img src=\"https://github.com/jasonGeng88/blog/raw/master/201706/assets/redis_search_04.png\" alt=\"\"></a></p>\n<p>图中蓝色部分是以创建时间为分值的商品有序集合，蓝色下方的结果集即为条件计算而得的结果，通过<code>ZINTERSTORE</code>命令，赋结果集权重为0，商品时间结果为1，取交集而得的结果集赋予创建时间分值的新有序集合。对新结果集的操作即能得到分页所需的各个数据：</p>\n<ul>\n<li>页面总数为：<code>ZCOUNT</code>命令</li>\n<li>当前页内容：<code>ZRANGE</code>命令</li>\n<li>若以倒序排列：<code>ZREVRANGE</code>命令</li>\n</ul>\n<h3><a id=\"user-content-数据更新\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0\"></a>数据更新</h3>\n<p>关于索引数据更新的问题，有两种方式来进行。一种是通过商品数据的修改，来即时触发更新操作，一种是通过定时脚本来进行批量更新。这里要注意的是，关于索引内容的更新，如果暴力的删除 Key，再重新设置 Key。因为 Redis 中两个操作不会是原子性进行的，所以中间可能存在空白间隙，建议采用仅移除集合中失效元素，添加新元素的方式进行。</p>\n<h3><a id=\"user-content-性能优化\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96\"></a>性能优化</h3>\n<p>Redis 是内存级操作，所以单次的查询会很快。但是如果我们的实现中会进行多次的 Redis 操作，Redis 的多次连接时间可能是不必要时间消耗。通过使用<code>MULTI</code>命令，开启一个事务，将 Redis 的多次操作放在一个事务中，最后通过<code>EXEC</code>来进行原子性执行（<em><strong>注意：这里所谓的事务，只是将多个操作在一次连接中执行，如果执行过程中遇到失败，是不会回滚的</strong></em>）。</p>\n<h2><a id=\"user-content-总结\" class=\"anchor\" href=\"https://github.com/jasonGeng88/blog/blob/master/201706/redis-search.md?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io#%E6%80%BB%E7%BB%93\"></a>总结</h2>\n<p>这里只是一个采用 Redis 优化查询搜索的一个简单 Demo，和现有的开源搜索引擎相比，它更轻量，学习成本也相应低些。其次，它的一些思想与开源搜索引擎是类似的，如果再加上词语解析，也可以实现类似全文检索的功能。</p>\n<p>最后，未完，待续。。。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111480\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111480votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111480\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2013/08/redis-logo.png', 'full/0a03ec3e1ce1b668b8db0234731fac4915b1064d.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('开发团队到底好不好，这 12 个问题能检验出来吗？', '2017-07-07', 'http://blog.jobbole.com/111551/', '52f70501a29c2a68a1a8aced393190d5', 6, 1, '开发, 团队', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/alvendarthy\">alvendarthy</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://myers.io/2017/04/04/the-joel-test-for-2017/\">Dale Myers</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【伯乐在线导读】：「Joel 测试」是 Joel Spolsky 在 2000 年提出的 12 个问题，用来检验一个团队是否是好的开发团队。17 年过去了，Dale Myers 重新审视了这12个问题，并与时俱进地提出了修改建议。</p>\n<hr>\n<p>就在 2013 年，我参加了一个课程：“软件的架构、执行和管理”。其中主题之一，就是如何评价一个开发团队？这不是一个简单的问题，如果要得到一个完整的答案，最后一定需要一些必要的研究，一篇冗长的报告。还好，Joel Spolsky 提出了12 个非常简单的测试问题，相对无痛地解决这个问题，这些问题被称为“Joel 测试”。该测试不是非常严谨，也无意于此。但是它可以为你提供坚实基础，进一步了解其他细节。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a8155485196284618\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n1. 是否使用源码控制？\r\n2. 能实现一键编译吗?\r\n3. 是否进行每日编译？\r\n4. 有无 bug 数据库？\r\n5. 在编码前是否解决bug？\r\n6. 是否有实时更新的计划表？\r\n7. 是否有文档？\r\n8. 开发人员有安静的开发环境吗?\r\n9. 是否使用市面上最好的工具？\r\n10. 是否有测试人员？\r\n11. 新员工面试时写代码吗？\r\n12. 是否进行走廊可用性测试？</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a8155485196284618-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155485196284618-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155485196284618-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155485196284618-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155485196284618-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155485196284618-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155485196284618-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155485196284618-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155485196284618-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155485196284618-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155485196284618-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155485196284618-12\">12</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a8155485196284618-1\"><span class=\"crayon-cn\">1.</span><span class=\"crayon-h\"> </span>是否使用源码控制？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155485196284618-2\"><span class=\"crayon-cn\">2.</span><span class=\"crayon-h\"> </span>能实现一键编译吗<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line\" id=\"crayon-59602a8155485196284618-3\"><span class=\"crayon-cn\">3.</span><span class=\"crayon-h\"> </span>是否进行每日编译？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155485196284618-4\"><span class=\"crayon-cn\">4.</span><span class=\"crayon-h\"> </span>有无<span class=\"crayon-h\"> </span><span class=\"crayon-i\">bug</span><span class=\"crayon-h\"> </span>数据库？</div><div class=\"crayon-line\" id=\"crayon-59602a8155485196284618-5\"><span class=\"crayon-cn\">5.</span><span class=\"crayon-h\"> </span>在编码前是否解决<span class=\"crayon-i\">bug</span>？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155485196284618-6\"><span class=\"crayon-cn\">6.</span><span class=\"crayon-h\"> </span>是否有实时更新的计划表？</div><div class=\"crayon-line\" id=\"crayon-59602a8155485196284618-7\"><span class=\"crayon-cn\">7.</span><span class=\"crayon-h\"> </span>是否有文档？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155485196284618-8\"><span class=\"crayon-cn\">8.</span><span class=\"crayon-h\"> </span>开发人员有安静的开发环境吗<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line\" id=\"crayon-59602a8155485196284618-9\"><span class=\"crayon-cn\">9.</span><span class=\"crayon-h\"> </span>是否使用市面上最好的工具？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155485196284618-10\"><span class=\"crayon-cn\">10.</span><span class=\"crayon-h\"> </span>是否有测试人员？</div><div class=\"crayon-line\" id=\"crayon-59602a8155485196284618-11\"><span class=\"crayon-cn\">11.</span><span class=\"crayon-h\"> </span>新员工面试时写代码吗？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155485196284618-12\"><span class=\"crayon-cn\">12.</span><span class=\"crayon-h\"> </span>是否进行走廊可用性测试？</div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p><strong>Joel 测试的优点在于：仅仅通过很小一组是非题，就可以得到需要的答案</strong>。你无需关注任何例外，或任何附加条件，只需要单纯的关注每个问题的答案是 yes 还是 no，就可以得到需要的结果： 12 分为优，11 分为良， 10 分及以下为差。这个优点并没有被我和我的几个同学忽视。我立刻将这个方法用到评估那些我面试实习的公司，以及后来毕业后第一份工作的公司。大多数雇主从来没有听说过这个测试，这倒不意外。真正令人意外的是，有多少公司没有通过该测试，而我曾认为这些公司非常棒！</p>\n<p><strong>我提问的不准确吗？他们真的理解我的意思吗？再或者我统计 12 个问题的时候算错了？</strong></p>\n<p>在面试时遇到 ”你还有什么想要问我们的吗？“ 这种问题时，Joel 测试是回答这个问题的大杀器，但是基本都没有及格的。当然，有可能刚好我面试的公司都很差劲，但是，尽管我是软件行业的新人，但是我有个感觉，事实绝非如此。我将该测试带入我的一些应用，发现我竟没有在任何地方考虑到这些问题。</p>\n<p><strong>那么我在 Joel 测试中出了什么问题呢？</strong></p>\n<p>每个开发人员都是不同的，他们对好坏都有着自己的标准，而且这个标准还会随着时间变化。Joel 测试试图规避这种偏差，用客观题替代了主观题。相信没有任何开发人员会反对，跟踪 bug 是个好想法，但是其他的问题呢？</p>\n<p>从 2000 年发布开始，Joel 测试已经有 17 个年头了。它比 OS X 的历史还要久。在同一时期，Windows 2000 还是当时技术最高水平，PlayStation 2 刚刚发布， 奔腾 III 处理器还在 1GHz 下嗡嗡地工作。 在计算机世界里，这确实是很久以前的事了。随着处理器计算能力（还有硬件的整体性能）每18个月翻番，我们的开发进程也一同提升了。Joel 测试的问题反映了当时软件开发的时代缩影。时至 2017 年，它们就未必非常恰当了。</p>\n<p>以第一个问题为例：</p>\n<blockquote><p>是否有源码控制？</p></blockquote>\n<p>如今最流行的版本控制系统——Git，在当时还没有出现。好吧，众所周知，Git 直到 2005 年才出现。也不要忘记，前任的版本控制系统之王——Subversion 也是到 2000 年才出现，比 Joel 测试首次发布晚了 2 个月。那时源码控制出现了，但是却不像今天这样普遍。这是不是意味着，今天还讨论源码控制这个问题显得多此一举呢？可能吧！我们应该修改这个问题与时俱进吗？也许吧！</p>\n<p>让我们一起来看看这些问题，然后看看如何与时俱进吧。</p>\n<h3 id=\"do-you-use-source-control\">1. 是否使用源码控制？</h3>\n<p>除了上面提到的，时至今日，这个问题似乎依然有意义。任何团队都需要源码控制，这是毋庸置疑的。如今的争议主要在是否使用集中式版本控制系统。一般的项目使用 Git 或者 Mercurial （举例来说）都可以。大型公司拥有超大型代码仓库，一般采用集中式版本控制系统。这个问题没有绝对答案。真正重要的是，有版本控制！既然这个问题已经是常识，我认为它就没必要继续存在了。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议： 删除</strong></span></p>\n<h3>2. 能实现一键编译吗?</h3>\n<p>Joel 的解释如下：</p>\n<blockquote><p>从最新的代码快照编译出交付版本，一共需要多少步？</p></blockquote>\n<p>其背后的原因，今天依然成立。好了，我认为这是我们对老问题的第一个挑战。我一直认为，编译交付版本，应当 0 步骤完成。持续集成已经广泛存在。使用它是非常明智的。创建一个交付版本的步骤应当这样：程序员们提交代码，当管理人员，或者其他负责人准备 release 时，他只需要点击 ”release“ 按钮即可，然后就成功了。所有开发人员只需要确保他们提交的代码无误，持续集成服务自动会完成其他工作。</p>\n<p>持续集成系统将软件开发产业向前推进了一大步。如果我们能更广泛的使用，充分发挥它的潜力，我们将受益良多。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：所有版本，都由持续集成服务器自动编译吗？</strong></span></p>\n<h3 id=\"do-you-make-daily-builds\">3. 是否进行每日编译？</h3>\n<p>这个问题紧随第 2 个。如果对团队有用的话，每日编译是可行的。我一直认为每日应当是最低限度了。在我眼里更好的实践是，确保主开发分支的每一次提交，都可以正常的完成编译。这算是一种“预览”版本，同时也意味着你能更快、更有效地发现自己的问题，因为一旦发生任何故障，非常容易确认其版本。</p>\n<p>该编译过程应当由持续集成系统自动完成。还有，你不止应当进行每日编译，而且应该使用它们。当然，如果你开发那些与你日常工作无关的软件时（定制或者专业软件），很难做到这一点。比如你在开发一款会计软件，或者火箭控制程序，显然你不可能使用这些产品。然而，我的建议是，每天至少花20分钟看看你的软件，试用一下，确保一切正常。假如你开发的软件每天都能用得到，那就更好了。它的作用与前面提到的 20 分钟试用一样，但在实际操作中，你可以进行远超 20 分钟的测试，使项目暴露在更加真实的场景下。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：是否执行每日编译，并使用这些版本？</strong></span></p>\n<h3>4. 有无 bug 数据库？</h3>\n<p>当然啦，你应该使用某种 bug 数据库。你听说过任何人认为没这个必要吗？如今发生变化的是，bug 跟踪有了更加丰富的特性。它们已经不再单单是一个数据库表的接口，而是拥有丰富功能的规划、管理程序，通常在任务和 bug 之间有显著区别（参考第 5 条）。</p>\n<p>如今，当你提交一个bug时，它有标题、描述、复现步骤、影响平台等等信息，一般都是如此。如今不同的是，管理将贯穿你的 bug 处理，bug 会被分派到若干迭代中，你需要利用看板规划任务，你的敏捷开发组长会就那些有困难的任务与你进行谈话。</p>\n<p>问题跟踪器也不仅仅是记录需要做的事。它包含谁执行了操作，对团队的影响，对产品的影响，以及其他上百个属性。那么，我认为你应该有某种软件来做这些事情，这都不重要，它就是你的某种问题跟踪器。因为各个团队的情况有所差异，这个问题也没有确切的答案。我所做的一点调整，只是为了用文字的一点不同，来反映我们现有的能力。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：你是否使用问题追踪器（issue tracker）？</strong></span></p>\n<h3 id=\"do-you-fix-bugs-before-writing-new-code\">5. 在编码前是否解决bug？</h3>\n<p>Joel 对这一点的重要性给出了非常好的论述，17 年后的今天，它依然成立。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：无</strong></span></p>\n<h3 id=\"do-you-have-an-up-to-date-schedule\">6. 是否有实时更新的计划表？</h3>\n<p>作为开发人员，你可能没那么关心计划表。如果你的团队没有在按时完成任务会怎样？不是你的问题吗？把这个问题留给管理人员吧！</p>\n<p>留个管理人员，也许有用，也许没用。如今，我们有各种敏捷开发理论，从开发人员，或者其他任何估时比较靠谱的人那里，得到的项目预估，是进行项目规划的关键要素。这帮助我们安排团队工作、谁来做这些工作，以及何时做这些工作。你可以掩耳盗铃，假装事事与你无关，但是最终，每一个人都需要对整个团队有一份责任。</p>\n<p>这一条今天还有效吗？必须的！当然了，我们已经不用瀑布流了。确保准时达到测试阶段，对我们已经没有太多意义了，但在敏捷开发（很多人深信，跟“现编现造”一个意思），特别是敏捷开发，计划表是最重要的，而且需要时刻保持更新。如今不同的是，计划表会根据新信息，保持更新。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：无</strong></span></p>\n<h3 id=\"do-you-have-a-spec\">7. 是否有文档？</h3>\n<p>计划表那一条完整的被保留下来，文档却未必同样走运。在瀑布流流行的时候，文档是你了解开发目标的关键。如果你无法有效调配资源，那么你的项目，注定会失败。</p>\n<p>回到 2001 年，当你创建一个程序时，无论是一台咖啡机，一台火箭，或者只是一个简单的 CRUD（Create、Retrieve、Update、Delete等） 界面，你都很清楚需要做什么，以及大约需要多少开销，逐步实现它。开发人员、测试人员、项目管理人员各司其职，大家全程根据文档展开工作，测试，交付，然后进入下一个项目。而今，在很多方面已经不是这样了。当然了，如果你还在开发上面提到的东西，情况就基本没什么变化。但是，如果你在开发 Twitter 客户端呢？或者文本编辑器呢？再或者邮件客户端？以前的老方法还依然有效吗？通常不是。</p>\n<p>只有当你可以从一开始就获得所有信息，并用来完成规划，文档才是有效的。当你的软件需要持续开发时，文档只在 MVP（Minimum Viable Product，最小可行产品）阶段比较重要，在此之后，它的用处就很小了。要让文档在今天依然保持重要性，就必须实时更新信息，并相应地适应当前进度和产品情况。</p>\n<p>这里所谓的信息，可以通过很多形式获得。可能只是简单的模拟用户如何使用APP，或者应该更进一步，如果可能的话，应当对新特性和设计进行 A/B 测试。</p>\n<p><strong><span style=\"color: #ff0000;\">更新建议：是否有关于产品功能和使用相关的最新信息？</span></strong></p>\n<h3 id=\"do-programmers-have-quiet-working-conditions\">8. 程序员有安静的开发环境吗?</h3>\n<p>当回想八九十年代的软件开发环境，一片小隔间的海洋就会进入脑海。如今，情形基本没变，唯独发生变化的是，隔断变得更小了，或者隔断在所谓的“开放式”办公室里，直接消失了。</p>\n<p>我个人而言，我并不喜欢开放式办公室。我喜欢自己的办公室，我就可以拥有单独的开发时间，完全看我的喜好，我可以打开音乐，让我步入状态。然而并不是所有人都同意我的观点。我知道很多人喜欢开放式办公，这样更加有效率，促进团队成员之间直接沟通，通常可以获得更快、更好的问题解决方案。</p>\n<p>这条规则对工作环境的要求，并不是什么特例。开放式办公室，通常比你自己的办公室更加嘈杂。每当有人问起关于开放式办公室的噪音问题时，我通常的解决方案就是带上耳机。通过消音技术，基本能解决绝大多数问题。这是我平常在开放办公室的办法。</p>\n<p>总之，安静的工作环境，无非就是独立办公室和开放办公室之间的取舍，这两个也没有孰优孰劣。</p>\n<p><img id=\"pic\" class=\"M_cur_zoom_out aligncenter\" src=\"http://ww4.sinaimg.cn/large/7cc829d3gw1f5o84olqc5j20zk0qodjo.jpg\"></p>\n<p style=\"text-align: center;\">（ 《<a href=\"http://blog.jobbole.com/101501/\" target=\"_blank\">国内程序员的办公桌是什么样的？</a>》文中黄钊的晒图 ）</p>\n<p><strong><span style=\"color: #ff0000;\">更新建议：删除</span></strong></p>\n<h3 id=\"do-you-use-the-best-tools-money-can-buy\">9. 是否使用市面上最好的工具？</h3>\n<p>这一条是最难取舍的，事实上我是写完本文其他部分以后，才回头写这一部分。</p>\n<p>我通常遇到的情况是这样的，公司无法负担市面最好的工具。也就是今天无法负担而已，不代表以后不行。我认为这一条规则的精神依然是成立的。公司应当有义务，尽可能保证开发人员的工作惬意、开心。愉快、宽松的程序员会生产更好的代码。</p>\n<p>有一点一定要切记，这并不意味着必须要用重金砸向这些问题，如果优秀的工具是免费的，那肯定还是要用免费的。</p>\n<p> </p>\n<p><img id=\"pic\" class=\"M_cur_zoom_in aligncenter\" src=\"http://ww1.sinaimg.cn/large/7cc829d3gw1f5mkf3ee8wj20zk0qon0z.jpg\" width=\"734\" height=\"551\"></p>\n<p style=\"text-align: center;\">（《<span data-rel=\"title\"><a class=\"archive-title\" title=\"国外程序员的办公桌是什么样的？\" href=\"http://blog.jobbole.com/103205/\" target=\"_blank\">国外程序员的办公桌是什么样的？</a>》，</span>网友「土豆」晒图）</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：无</strong></span></p>\n<h3 id=\"do-you-have-testers\">10. 是否有测试人员？</h3>\n<p>不同公司在测试方面是有区别的。几年前，就在我还是个实习生，到成为全职之间那段时间，微软复用工程师作为测试人员。我曾撰文说明，<a href=\"https://www.quora.com/Why-is-Microsoft-merging-its-SDE-and-SDET-positions-into-the-software-engineer-title\" target=\"_blank\">为什么我认为微软复用开发和测试人员</a>，很好的说明我作为实习生浪费了多少资源，还消除了曾鼓励我编写更好代码的安全网。现在这都在微软得到印证，我们还是看看 Joel 对此是怎么说的：</p>\n<blockquote><p>如果你的团队没有专业的测试人员，至少每 2~3 个开发人员一个测试人员，你要么会交付缺陷产品，要么你让时薪 $100 的开发人员，去做时薪 $30 测试人员的工作。</p></blockquote>\n<p>我和 Joel 观点的主要不同是，对于微软而言，开发人员和测试人员是一样的，开发人员的薪酬并不是测试人员的 3 倍。测试人员花费时间，遍历代码变更，确保提交的修改可用，而且没有引入新的问题，这些都与开发人员的时间一样有价值。当然，这也算安全网。</p>\n<p>拥有测试人员是很好的选择，但是 Joel 提出了更好的观点，那就是，你千万不要浪费测试人员的价值。</p>\n<p>开发人员需要对自己的代码负责。如果你不是特别确信自己的代码无 bug，就不应当提交。这意味着你需要进行人工测试、单元测试、集成测试等等。既然在未进行代码 review 之前，代码是不可提交的，那没有进行测试，又怎么可以提交呢？</p>\n<p>测试人员不需要遍历每一个变更，但是他们需要确保，产品作为一个整体依然是稳定的。他们应该能将他们的时间投入测试模型，这远比开发人员更加有价值。有测试人员并不是最关键的，有完整有效的测试计划才是。</p>\n<p><strong><span style=\"color: #ff0000;\">更新建议：是否有完整的测试计划。</span></strong></p>\n<h3 id=\"do-new-candidates-write-code-during-their-interview\">11. 新员工面试时写代码吗？</h3>\n<p>当你在很多类似 Hacker News，或者一些  Reddit 之类开发网站搜索关键字“面试”时，结果中的文章有多少对现在的面试流程是正面评价呢？非常少！每个人都很清楚，现在的面试系统很烂，我们需要更好的选择。在某人想出更好的之前，就当现在只有这么一个办法，虽然看起来不像什么好点子，我们就将就一下吧。</p>\n<p>目前有如下一些不同的面试方法：</p>\n<ol>\n<li>白板面试。</li>\n<li>做一个家庭作业式的小项目。</li>\n<li>到公司来，与我们一起工作 6 个月，作为试用期。</li>\n</ol>\n<p>有件事我们都有共识，开发人员应该编码。既然这是他们的工作，那你就应该在这方面测试他们。就不要用查找特定的语法错误这种问题来为难他们，也不要让他们选择你的团队的工作语言了，只要确保他们可以编码即可。</p>\n<p>就像我们前面看到的，这一条也是非常常识的问题，我觉得就没必要继续保留了。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：删除。</strong></span></p>\n<h3 id=\"do-you-do-hallway-usability-testing\">12. 是否进行走廊可用性测试？</h3>\n<p>这是一条鲜为人知的规则，我们看看 Joel 的定义：</p>\n<blockquote><p>走廊可用性测试是这样的，你在走廊里，随手请一位路人，帮忙测试你刚刚编写的代码。如果如此请了 5 个人帮忙，你就可以找到代码中 95% 影响可用性的问题。</p></blockquote>\n<p>现在，如果我说走廊可用性测试是个好东西，应该不会有太多人反对吧，但是对于灰色桌面背景上的灰色工具栏，上面还有灰色按钮的情况，这就未必了。电脑用户（如今这个定义非常宽泛）通常不是特别了解其工作原理。对于专业工具，你可能需要按钮提示信息、拖拽支持、键盘快捷方式等，这样就非常棒了。然而对于 Facebook，得让你的爷爷奶奶也能用才行。这需要清晰的设计：元素之间采用高对比度，在合理的位置进行交互，还要有适合的大小。</p>\n<p>在各种情况下，需要创建用户界面和用户体验，我所说的不仅仅是常规的 UI，而是类似“以合理的方式，控制文件保存操作”这样的事，这已经不是一个开发人员能做到的了，应该由专业人员来做。现在这是专业的 UI 和 UX 设计师应该掌握的一种专业技能。</p>\n<p><span style=\"color: #ff0000;\"><strong>更新建议：是否有专业的 UI 和 UX 设计师?</strong></span></p>\n<h2>现在我们看看「Joel 测试」变成什么样了：</h2>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a8155499158132673\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n1. 所有版本都是由一个持续集成服务自动完成的吗? \r\n2. 是否生成并使用每日版本? \r\n3. 是否有问题跟踪器?\r\n4. 写代码之前修正所有 bug 吗?\r\n5. 是否有实时更新的计划表?\r\n6. 是否实时更新产品功能和使用方法的文档?\r\n7. 是否使用市面上最好的工具？\r\n8. 是否有完整的测试计划？\r\n9. 是否有专业的 UI 和 UX 设计师？</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a8155499158132673-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155499158132673-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155499158132673-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155499158132673-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155499158132673-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155499158132673-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155499158132673-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a8155499158132673-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a8155499158132673-9\">9</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a8155499158132673-1\"><span class=\"crayon-cn\">1.</span><span class=\"crayon-h\"> </span>所有版本都是由一个持续集成服务自动完成的吗<span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155499158132673-2\"><span class=\"crayon-cn\">2.</span><span class=\"crayon-h\"> </span>是否生成并使用每日版本<span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-59602a8155499158132673-3\"><span class=\"crayon-cn\">3.</span><span class=\"crayon-h\"> </span>是否有问题跟踪器<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155499158132673-4\"><span class=\"crayon-cn\">4.</span><span class=\"crayon-h\"> </span>写代码之前修正所有<span class=\"crayon-h\"> </span><span class=\"crayon-i\">bug</span><span class=\"crayon-h\"> </span>吗<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line\" id=\"crayon-59602a8155499158132673-5\"><span class=\"crayon-cn\">5.</span><span class=\"crayon-h\"> </span>是否有实时更新的计划表<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155499158132673-6\"><span class=\"crayon-cn\">6.</span><span class=\"crayon-h\"> </span>是否实时更新产品功能和使用方法的文档<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line\" id=\"crayon-59602a8155499158132673-7\"><span class=\"crayon-cn\">7.</span><span class=\"crayon-h\"> </span>是否使用市面上最好的工具？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a8155499158132673-8\"><span class=\"crayon-cn\">8.</span><span class=\"crayon-h\"> </span>是否有完整的测试计划？</div><div class=\"crayon-line\" id=\"crayon-59602a8155499158132673-9\"><span class=\"crayon-cn\">9.</span><span class=\"crayon-h\"> </span>是否有专业的<span class=\"crayon-h\"> </span><span class=\"crayon-i\">UI</span><span class=\"crayon-h\"> </span>和<span class=\"crayon-h\"> </span><span class=\"crayon-i\">UX</span><span class=\"crayon-h\"> </span>设计师？</div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>我们砍掉了部分规则，修正了其他的。但是这还没完。这只是我们如何修改已有规则，使之与时俱进，但是我们还需要新增一些如今非常重要的规则。</p>\n<h2 id=\"new-rules\">新增的 3 个规则</h2>\n<h3 id=\"does-all-code-go-through-code-review\">所有代码都经过 review 了吗？</h3>\n<p>每个人都会犯错，无论你是刚刚毕业的新人，还是身经百战的编程老司机，你都会犯错。我们总是过于依赖编译器帮我们发现错误，这并不是编译器的正确使用方法。这就是我们需要“测试”的原因。但是测试也可能失效，我们不能 100% 依赖它。对你的代码擦亮眼睛，能让你发现平时未发现的东西。除此之外，这还能让你的代码与团队代码风格保持一致，编译器通常不具备这样的能力（代码检查这个主题，我们换个机会再谈）。一致性良好的代码，可以方便团队成员阅读、使用你的代码。</p>\n<h3 id=\"do-you-have-coding-standards\">是否有编码标准？</h3>\n<p>这条规则与上面一条相互依存。编写代码非常重要，但是最终你需要能重读你的代码。很遗憾，现实并不是这样。所以，我们应该尽可能让代码易于阅读。首要任务就是，保证代码库的一致性。通过制定一系列规范，在团队内贯彻，令代码易于阅读和理解。在代码库中搜索最常用的模块、类型等等，清晰定义期望的代码风格，帮助新进开发人员逐步跟上进度，这比在开发过程中一点点明确风格要好的多。也可以在持续集成系统中，增加自动代码检查工具，推进这些代码规范。</p>\n<h3 id=\"are-new-employees-given-training\">新员工是否有培训？</h3>\n<p>这看起来显而易见，但事实上却并不常见。很多新进开发人员，加入一家公司，就立刻被投入深水区。这个过程对开发人员和公司，都是浪费。有一些会试着游起来，但是绝大多数会沉没。当你加入一家公司后，你应当获得工作所需的一些必要信息。我并不是说你应该在一间会议室里待一周，学习 HR 课程、聆听 VP 的宣讲，这确非我的本意。实际上你应该获得你所工作系统的文档，并且，有一位团队成员，给你当一段时间导师，以帮助你尽快跟上进度。没错，这意味着这个开发人员可能在培训阶段的输出会有所减少，但是在此之后，你就获得了两个开发人员，任何会算数的人，都会看出来，这事一笔值当的投资。</p>\n<h2 id=\"conclusion\">结语</h2>\n<p>那么，我们看看我们 2017 版 “Joel 测试”是怎样的：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a81554a0605903568\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n1. 所有版本都是由一个持续集成服务器自动完成的吗? \r\n2. 是否生成并使用每日版本? \r\n3. 是否有问题跟踪器?\r\n4. 写代码之前修正所有 bug 吗?\r\n5. 是否有实时更新的计划表?\r\n6. 是否实时更新产品功能和使用方法的文档?\r\n7. 是否使用市面上最好的工具？\r\n8. 是否有完整的测试计划？\r\n9. 是否有专业的 UI 和 UX 设计师？\r\n10. 所有代码都进行 review 吗？\r\n11. 是否有代码规范？\r\n12. 新员工有培训吗？</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a81554a0605903568-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81554a0605903568-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a81554a0605903568-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81554a0605903568-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a81554a0605903568-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81554a0605903568-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a81554a0605903568-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81554a0605903568-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a81554a0605903568-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81554a0605903568-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59602a81554a0605903568-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a81554a0605903568-12\">12</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a81554a0605903568-1\"><span class=\"crayon-cn\">1.</span><span class=\"crayon-h\"> </span>所有版本都是由一个持续集成服务器自动完成的吗<span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81554a0605903568-2\"><span class=\"crayon-cn\">2.</span><span class=\"crayon-h\"> </span>是否生成并使用每日版本<span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-59602a81554a0605903568-3\"><span class=\"crayon-cn\">3.</span><span class=\"crayon-h\"> </span>是否有问题跟踪器<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81554a0605903568-4\"><span class=\"crayon-cn\">4.</span><span class=\"crayon-h\"> </span>写代码之前修正所有<span class=\"crayon-h\"> </span><span class=\"crayon-i\">bug</span><span class=\"crayon-h\"> </span>吗<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line\" id=\"crayon-59602a81554a0605903568-5\"><span class=\"crayon-cn\">5.</span><span class=\"crayon-h\"> </span>是否有实时更新的计划表<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81554a0605903568-6\"><span class=\"crayon-cn\">6.</span><span class=\"crayon-h\"> </span>是否实时更新产品功能和使用方法的文档<span class=\"crayon-sy\">?</span></div><div class=\"crayon-line\" id=\"crayon-59602a81554a0605903568-7\"><span class=\"crayon-cn\">7.</span><span class=\"crayon-h\"> </span>是否使用市面上最好的工具？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81554a0605903568-8\"><span class=\"crayon-cn\">8.</span><span class=\"crayon-h\"> </span>是否有完整的测试计划？</div><div class=\"crayon-line\" id=\"crayon-59602a81554a0605903568-9\"><span class=\"crayon-cn\">9.</span><span class=\"crayon-h\"> </span>是否有专业的<span class=\"crayon-h\"> </span><span class=\"crayon-i\">UI</span><span class=\"crayon-h\"> </span>和<span class=\"crayon-h\"> </span><span class=\"crayon-i\">UX</span><span class=\"crayon-h\"> </span>设计师？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81554a0605903568-10\"><span class=\"crayon-cn\">10.</span><span class=\"crayon-h\"> </span>所有代码都进行<span class=\"crayon-h\"> </span><span class=\"crayon-i\">review</span><span class=\"crayon-h\"> </span>吗？</div><div class=\"crayon-line\" id=\"crayon-59602a81554a0605903568-11\"><span class=\"crayon-cn\">11.</span><span class=\"crayon-h\"> </span>是否有代码规范？</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a81554a0605903568-12\"><span class=\"crayon-cn\">12.</span><span class=\"crayon-h\"> </span>新员工有培训吗？</div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0024 seconds] -->\r\n<p>好棒耶！让我们喜大普奔地照办起来吧。</p>\n<p>还是不要了！该测试不是万金油，只是个指导意见。它是一个指导系统，而非一套完整的评估系统。一个得到满分的企业，依然可能是一家不宜工作的地方。当然，如果一家公司连 10 分都拿不到，那这是家不靠谱的公司基本没跑。只要确保你的雇主能获得 11~12 这样的高分，然后根据自己的判断来。千万不要迷信！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111551\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111551votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111551\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 6 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/alvendarthy\">alvendarthy</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/alvendarthy\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2015/04/8fbdaaa5ea6d3b49c8c1c825aafeb5d9.png\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            一个热爱生活的家伙！        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/alvendarthy\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/alvendarthy/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/alvendarthy/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 14</a>        </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://ww4.sinaimg.cn/large/7cc829d3gw1f5o84olqc5j20zk0qodjo.jpg', 'full/8ac214b4204afd642c5f87970a0d16ad87660f96.jpg'),
('基于密码学的数据治理Crypto-based Data Governance', '2017-07-07', 'http://blog.jobbole.com/111599/', '54d988fe70aea29f72b1e63e22933529', 1, 1, 'IT技术, 密码学, 数据治理', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/thoughtworkschina\">ThoughtWorks</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><div>\n<p>最近得益于区块链在金融领域的火爆效应，Crypto-based currency&amp;transaction 改变了金融圈原本“数字货币=数字游戏”的印象，密码学货币不再只是数字货币，它还被赋予了“防篡改、去中心”的特性，但是本质上这些事务都是数据治理问题，只不过从原本的“服务级别”的访问权限校验转入了“数据级别”的完整性校验。其实密码学不只可以在金融业务方面做出贡献，在其他一系列数据治理难题中，我们也可以借鉴其中的一些思路。</p>\n<p>下面让我们来回顾一些常见的数据治理问题，以及我们如何使用密码学来解决这些问题。</p>\n<h3>数据私密性</h3>\n<p>私密性（Confidentiality），数据作为企业的重要财产已经得到足够的重视，同时作为业务必须的原料又不得不分发到终端。我们既要做好必要的安全防护工作，同时也希望尽可能地灵活管理访问权限，在需要的时候能及时地送达业务场景中消化。</p>\n<p>这个防护工作的目的也就是保护数据的私密性。通常有两种方式保障，授权与加密，随着数据量级的增长，私密性变得越来越细粒度。如何划分授权与加密这两种有着明确区分的方案往往被大家混淆，甚至不少开发人员认为授权是加密的一种。</p>\n<p>常见的授权（Authorization），包含了验证（Authentication）与访问控制（Access Control）两个部分，验证是指用户或者业务模块通过一个私密的凭证来确保身份，它可以是一个密码，可以是一类数字签名（包括证书），也可以使用相对复杂的双向动态授权协议。</p>\n<p>验证后的访问控制则是将数据权限更细粒度地拆分，提供一次性或者短暂性的访问权限，Token作为一个权证只能用来访问其对应权限下的数据，可以防止私密数据过量泄露。而目前一些新的方法中，权证分发本身被改善成了一个数字签名的过程，通过完全的非对称密码系统，让数据提供方原本需要保存的Token，转变为只需要验证访问请求所携带的数字签名就可以获知权限的Certificate/Signature，例如Hyperledger区块链平台就采用这种方式，分别签发Enrollment Certificate和Transaction Certificate为不同的业务场景提供不同的数据访问权限。</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/1-authorization.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/1-authorization.png\" alt=\"\" width=\"845\" height=\"684\"></a></p>\n<p>授权方案的发展历经了几个阶段（如上图），虽然和出现时间并没有太大关系，TLS早就定义了第三种形式作为分发证书链的模式，我们可以看到在第二种方案中，通过采用token的授权，使得细粒度的授权分发可以和验证分离开来。而第三种方案则更进一步，让双方不需要再传输存储授权凭证，而且整个授权过程可以是一次性的，而不会影响到数据访问。</p>\n<p>随着高阶密码学原语的引入，我们甚至可以在验证授权的过程中为用户的访问提供隐私保护，例如通过Dual Receiver Encryption配合Ring Signature可以实现匿名组策略等效果。</p>\n<p>加密（Encryption），往往是较为耗时和受限制的数据治理手段，尤其是非对称加密算法，只能针对少量的数据集执行，而对称加密又存在交换秘钥、存储管理秘钥时的隐患。因此作为保护数据私密性的最后手段，我们应该尽量避免滥用误用，常见的误用场景包括试图通过在客户端加密Token来防止用户篡改数据访问权限、试图用加密应用代码的方式保护数据、试图仅依靠对称加密分发数据等等。</p>\n<p>常见的加密确保私密性，常常是基于“数据被盗”或者“数据集必须存放在用户端”的假设，“数据被盗”决定了每个数据池都有必要对基础设施进行预防，例如对硬盘加密、选择安全的通信信道和协议、避免秘钥泄露、避免系统人为操作、避免内网服务对外开放、减少私有网络的威胁等等。而“数据集必须存放在用户端”则需要考虑到恶意软件、逆向工程、暴力破解可能造成的数据损失。</p>\n<h3>数据完整性</h3>\n<p>完整性（Integrity），说到区块链的一大卖点就是不可篡改，通过确定交易双方身份的Signature、交易顺序的Merkel Hash tree、Block前向完整性（Forward integrity）Hash，三者（如图）组成了一套完整的分布式账本链条，其中每一条、每一页的交易记录之间、页与页之间都由密码学原语保护。这样的一种数据结构设计，为区块链带来了更灵活的去中心结算方案。</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/2-Blockchain.png\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/2-Blockchain-1024x311.png\" alt=\"\" width=\"700\" height=\"213\"></a></p>\n<p>将区块链解构之后，我们也可以灵活地将这些密码学原语用于保障常规数据的完整性，尤其可以应对B2B场景下，企业联盟之间的数据共享信任问题，通过完整性校验，可以实现竞争关系下的同业数据融合；通过数字签名，可以为如票据交易、款项去处之类的数据审计提供证据。</p>\n<p>大数据分析提高了对数据真实性的要求，密码学提供的完整性校验方案，可以为外来数据治理提供额外的保障。同时由于密码学原语位于设施的底层，因而这一系列的验证审计操作都可以自动化执行，而不需要额外的人力来管理校对。</p>\n<h3>数据可用性</h3>\n<p>可用性（Availablity），在数据治理中是一个非常困难的话题，我们可以将数据副本分发到业务微服务中缓存，也可以采用分布式的存储方式，这些都是为了解决单点故障、减少大量数据同步的时间开销，其中Hash Table作为最常见的检索方式，可以同时保障数据的完整性和可用性，数据池可以使用分块的方式将数据分散存储，同时使用Hash来计算出摘要以供后续的检索，通过额外的加密手段，甚至可以实现对等节点的全量和增量数据同步，而不必担心数据的私密泄露。</p>\n<p>DynamoDB采用了这种Hash一致性算法，“均匀”地管理数据分片(如图)。Bittorrent网络采用Hashtable来寻找目标文件。Spark-mllib也使用了Hash来进行词频统计，达到数据分治的效果，避免了维护全局term-to-index map的麻烦。</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/3-dynamo-bigtable-comparison.jpg\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/3-dynamo-bigtable-comparison.jpg\" alt=\"\" width=\"638\" height=\"479\"></a></p>\n<p>此外，加密后的数据由于可读性问题，很难再做重用，而常见的保护用户敏感信息，并且同时保护数据分析可读性的方法，在微软和苹果等公司都有所尝试，称为Differential privacy（如图），数据分析师在提取数据时，Privacy Guard评估Query Privacy impact，为反馈的数据加上噪音，例如可以使用Hash替换掉真实信息，只保留数据“特征”，减少用户隐私泄露的风险，同时又能保留数据的分析价值。</p>\n<p><a href=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/4-uting-Differential-Privacy.jpg\"><img src=\"http://insights.thoughtworkers.org/wp-content/uploads/2017/06/4-uting-Differential-Privacy.jpg\" alt=\"\" width=\"560\" height=\"267\"></a></p>\n<h3>重返焦点</h3>\n<p>如果说数据湖是每个企业的金库，那么数据治理的安全措施就是用于搭起金库壁垒的一砖一瓦，每个安全措施之间的紧密粘合都依托于完善和牢固的密码学设计，随着“安全无小事，商场入战场”的警钟不断敲响，从基础设施建设上对数据治理的不断规范化和标准化呼声越来越高，密码学重回技术焦点的日子应该不会太远。</p>\n<div></div>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111599\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111599votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111599\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/thoughtworkschina\">ThoughtWorks</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/thoughtworkschina\">\r\n			<img src=\"http://tp3.sinaimg.cn/1774908135/180/0/1\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            ThoughtWorks是一家全球IT咨询公司，追求卓越软件质量，致力于科技驱动商业变革。擅长构建定制化软件产品，帮助客户快速将概念转化为价值。同时为客户提供用户体验设计、技术战略咨询、组织转型等咨询服务。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/thoughtworkschina\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/thoughtworkschina/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/thoughtworkschina/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 60</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://insights.thoughtworkers.org/\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/thoughtworkschina\"><i class=\"fa fa-weibo\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://insights.thoughtworkers.org/wp-content/uploads/2017/06/1-authorization.png', 'full/e56b761fb7600a480f0de3228665bdb07b09a589.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('带着问题学习分布式系统之数据分片', '2017-07-07', 'http://blog.jobbole.com/111716/', '7005be04c2edd13df9a087263d719892', 3, 1, 'IT技术, 分布式系统', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/xybaby/p/7076731.html\">xybaby</a>   </div><p>听过很多道理，却依然过不好这一生。</p>\n<p>看过很多关于学习的技巧、方法，却没应用到自己的学习中。</p>\n<p>随着年纪变大，记忆力越来越差，整块的时间也越来越少，于是，越来越希望能够更高效的学习。学习是一种习惯也是一种能力，这种能力在上学期间养成是最好的，毕竟那个时候绝大部分时间都在学习。但很遗憾，我没有养成适合自己的、好的学习习惯。工作之后，除了在日常工作中用到的知识技术，很难通过自学掌握新的知识（偏向于专业知识，即技术）。而互联网行业的分支、知识点又是如此之多，于是会出现这样的情况，遇到一个新的知识，觉得很厉害很感兴趣，看两天，但很快就忘记了。另外，对于一些比较庞杂的技术，又无从下手，也很难坚持下去。</p>\n<p>根本的问题在于学习不系统，没有把一个个的知识点连接起来，本来这些新的知识就很少在工作中实践，如果又是一个个的信息孤岛，很快就会被遗忘。另一个问题，没有良好的规划，今天看看这里，明天看看哪里，纠结于细枝末节，忘了从整体上把握。</p>\n<p>幸好，差不多半年前开始意识到了这个问题，开始看书，看别人的博客，开始思考如何充分利用好有限的时间。自己也实践了一些想法，比如写博客，坚持写博客。也有很多没做好，比如如何学习掌握一门新技术。关于这一点，其实看了许多文章，也有很多印象深刻，觉得很有道理；也有一些好书，比如《study more，learn less》。纸上得来终觉浅，绝知此事要躬行，别人的办法再好也需要亲身实践才知道是否对自己适用。</p>\n<p>需要学习的技术很多，要自学新知识也不是一件容易的事，选择一个自己比较感兴趣的会是一个比较好的开端，于是，打算学一学分布式系统。</p>\n<p><strong>带着问题，有目的的学习，先了解整体架构，在深入感兴趣的细节</strong>，这是我的计划。</p>\n<div>首先得有问题，如果每日重复相同的工作，也不主动去学习，很难发现新的问题。不怕自己无知，就怕不知道自己无知，只有不断的学习，才会发现更多未知的知识领域！</div>\n<h3>带着问题出发</h3>\n<p>分布式要解决什么问题呢？解决持久化数据太大，单个节点的硬盘无法存储的问题；解决运算量太大，单个节点的内存、CPU无法处理的问题。解决这些问题，有两种思路：scale up，scale out。前者就是提升单个节点的能力，更大的磁盘，更快的CPU，定制的软硬件，然而这意味着更高的价格，而且再怎么scaleup 也是有上限的。后者就是把存储、计算任务分担到普通的机器上，通过动态增加节点来应对数据量的增长，但缺点是多个节点的管理、任务的调度比较麻烦，这也是分布式系统研究和解决的问题。只有当数据量达到单机无法存储、处理的情况下才考虑分布式，不然都是自找麻烦。</p>\n<div>\n<div>状态的维护比计算要难很多，所谓状态就是需要持久化的数据。因此主要考虑分布式存储，况且即使是分布式计算，为了节省带宽需要尽量保证data locality，也是需要分布式存储。</div>\n<div></div>\n<div>现在有一堆数据，可能是结构化或者半结构化，需要将数据分片（segment、fragment、shard），形成一个个的数据子集，存储到一组物理节点上，物理节点之间通过网络通信。那么需要考虑两个问题：</div>\n<div></div>\n<blockquote>\n<div>第一：数据如何划分;</div>\n<div>第二：数据的可靠性、可用性问题</div>\n</blockquote>\n<h3>数据分片</h3>\n<p>数据分片是指将数据子集尽可能均衡的划分到各个物理节点上。那么会有哪些挑战呢？</p>\n<div>\n<p>（1）如果某个物理节点宕机，如何将该物理节点负责的数据尽快的转移到其他物理节点；</p>\n</div>\n<div>\n<p>（2）如果新增了物理节点，怎么从其他节点迁移数据到新节点；</p>\n</div>\n<p>（3）对于可修改的数据（即不是只能追加的数据），比如数据库数据，如果某节点数据量变大，怎么将部分数据迁移到其他负载较小的节点，及达到动态均衡的效果。</p>\n<div>（4）元数据的管理问题：当数据分布在各个节点，那么当用户使用的时候需要知道具体的数据在哪一个节点上。因此，系统需要维护<strong>数据的元数据：即每一个数据所在的位置、状态等信息</strong>。当用户需要具体的数据时，先查询元数据，然后再去具体的节点上查询。当数据在节点之间迁移的时候，也需要更新元数据。元数据的管理节点这里称之为meta server。元数据的管理也带来了新的挑战：</div>\n<div>（4.1）如何抽取数据的特征（特征是分片的依据，也是用户查询数据时的key），或者支持用户自定义数据特征；</div>\n<p>（4.2）如何保证meta server的高性能和高可用，是单点还是复制集</p>\n<div>（5）分片的粒度，即数据子集的大小，也是数据迁移的基本单位。粒度过粗，不利于数据均衡；粒度过细，管理、迁移成本又会比较大。</div>\n<h3>数据冗余</h3>\n<div>\n<p>前面提到，分布式系统中的节点都是普通的节点，因此有一定的概率会出现物理故障，比如断电、网络不可用，这些故障导致数据的暂时不可用；另外一些故障更严重，会导致数据的丢失，比如磁盘损坏。即使单个节点的故障是小概率，当集群中的节点数目很多是，故障就成为了一个大概率事件。因此，保证数据的高可用和可靠性是分布式系统必须解决的问题。</p>\n<p>为了避免单点故障，可行的办法就是数据冗余（复制集），即将同一份数据放在不同的物理节点，甚至是不同的数据中心。如果数据是一次写，多次读那很好办，随便从哪个副本读取都行。但对于很多分布式存储系统，比如数据库，数据是持续变化的，有读有写。那么复制集会带来什么样的挑战呢，需要如何权衡呢，假设有三个副本：</p>\n<p>（1）三个副本的地位，大家都是平等的还是有主（primary、master）有次（secondary、slave），如果是平等的，那么每个节点都可以接收写操作；如果不平等，可以一个节点负责所有的写操作，所有节点都提供读操作，</p>\n<p>（2）在平等的情况下，怎么保证写入操作不冲突，保证各个节点的数据是一致的，怎么保证能读取到最新的数据</p>\n<div>　　（3）不平等的情况下</div>\n<div>　　　　（3.1）写节点怎么将变更的数据同步到其他节点，同步还是异步；</div>\n<div>　　　　（3.2）非写节点能否提供读数据，如果能够允许，会不会读取到过时的数据。</div>\n<div>　　　　（3.3）主节点是怎么产生的，当主节点宕机的时候，怎么选择出新的主节点。是有统一的复制集管理中心（记录谁主谁次，各自的状态），还是复制集自己选举出一个主节点？</div>\n<p>（4）不管复制集内部的节点是平等的，还是有集中式节点的，只要有多个数据副本，就需要考虑数据的一致性可用性问题。按照CAP理论，只能同时满足一致性 可用性 分区容错性之间的二者，不同的分布式系统需要权衡。</p>\n</div>\n</div>\n<hr>\n<p>在前文中，提出了分布式系统（尤其是分布式存储系统）需要解决的两个最主要的问题，即数据分片和数据冗余，下面这个图片（<a href=\"http://book.mixu.net/distsys/intro.html\" target=\"_blank\">来源</a>）形象生动的解释了其概念和区别：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9c3ebd88533763a9cc48fc406d741a1a.png\" alt=\"\"></p>\n<p>其中数据即A、B属于数据分片，原始数据被拆分成两个正交子集分布在两个节点上。而数据集C属于数据冗余，同一份完整的数据在两个节点都有存储。当然，在实际的分布式系统中，数据分片和数据冗余一般都是共存的。</p>\n<p>本文主要讨论数据分片的三个问题：</p>\n<p>（1）如何做数据分片，即如何将数据映射到节点</p>\n<p>（2）数据分片的特征值，即按照数据中的哪一个属性（字段）来分片</p>\n<p>（3）数据分片的元数据的管理，如何保证元数据服务器的高性能、高可用，如果是一组服务器，如何保证强一致性</p>\n<p>所谓分布式系统，就是利用多个独立的计算机来解决单个节点（计算机）无法处理的存储、计算问题，这是非常典型的分而治之的思想。每个节点只负责原问题（即整个系统需要完成的任务）的一个子集，那么原问题如何拆分到多个节点？在分布式存储系统中，任务的拆分即数据分片。</p>\n<p>何为数据分片（segment，fragment， shard， partition），就是按照一定的规则，将数据集划分成相互独立、正交的数据子集，然后将数据子集分布到不同的节点上。注意，这里提到，数据分片需要按照一定的规则，不同的分布式应用有不同的规则，但都遵循同样的原则：按照最主要、最频繁使用的访问方式来分片。</p>\n<h1>三种数据分片方式</h1>\n<div>　　首先介绍三种分片方式：hash方式，一致性hash（consistent hash），按照数据范围（range based）。对于任何方式，都需要思考以下几个问题：</div>\n<div>\n<ol>\n<li>具体如何划分原始数据集？</li>\n<li>当原问题的规模变大的时候，能否通过增加节点来动态适应？</li>\n<li>当某个节点故障的时候，能否将该节点上的任务均衡的分摊到其他节点？</li>\n<li>对于可修改的数据（比如数据库数据），如果某节点数据量变大，能否以及如何将部分数据迁移到其他负载较小的节点，及达到动态均衡的效果？</li>\n<li>元数据的管理（即数据与物理节点的对应关系）规模？元数据更新的频率以及复杂度？</li>\n</ol>\n<p>为了后面分析不同的数据分片方式，假设有三个物理节点，编号为N0， N1， N2；有以下几条记录：</p>\n<p>R0: {id: 95, name: ‘aa’, tag:’older’}<br>\nR1: {id: 302, name: ‘bb’,}<br>\nR2: {id: 759, name: ‘aa’,}<br>\nR3: {id: 607, name: ‘dd’, age: 18}<br>\nR4: {id: 904, name: ‘ff’,}<br>\nR5: {id: 246, name: ‘gg’,}<br>\nR6: {id: 148, name: ‘ff’,}<br>\nR7: {id: 533, name: ‘kk’,}</p>\n</div>\n<h2>hash方式：</h2>\n<p>哈希表（散列表）是最为常见的数据结构，根据记录（或者对象）的关键值将记录映射到表中的一个槽（slot），便于快速访问。绝大多数编程语言都有对hash表的支持，如python中的dict， C++中的map，Java中的Hashtable， Lua中的table等等。在哈希表中，最为简单的散列函数是 mod N（N为表的大小）。即首先将关键值计算出hash值（这里是一个整型），通过对N取余，余数即在表中的位置。</p>\n<p>数据分片的hash方式也是这个思想，即按照数据的某一特征（key）来计算哈希值，并将哈希值与系统中的节点建立映射关系,从而将哈希值不同的数据分布到不同的节点上。</p>\n<p>我们选择id作为数据分片的key，那么各个节点负责的数据如下：</p>\n<div>　　<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/60b1cd0b902642fcd732d92d826bf1d7.png\" alt=\"\" width=\"735\" height=\"173\"></div>\n<p>由此可以看到，按照hash方式做数据分片，映射关系非常简单；需要管理的元数据也非常之少，只需要记录节点的数目以及hash方式就行了。</p>\n<div>　　但hash方式的缺点也非常明显：当加入或者删除一个节点的时候，大量的数据需要移动。比如在这里增加一个节点N3，因此hash方式变为了mod 4，数据的迁移如下：</div>\n<div>　　<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a070c20a578c8728f269a7c5f88a9bc1.png\" alt=\"\"></div>\n<p>在这种方式下，是不满足单调性（Monotonicity）的：如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应能够保证原有已分配的内容可以被映射到原有的或者新的缓冲中去，而不会被映射到旧的缓冲集合中的其他缓冲区。</p>\n<p>在工程中，为了减少迁移的数据量，节点的数目可以成倍增长，这样概率上来讲至多有50%的数据迁移。</p>\n<div>hash方式还有一个缺点，即很难解决数据不均衡的问题。有两种情况：原始数据的特征值分布不均匀，导致大量的数据集中到一个物理节点上；第二，对于可修改的记录数据，单条记录的数据变大。在这两种情况下，都会导致节点之间的负载不均衡，而且在hash方式下很难解决。</div>\n<h2>一致性hash</h2>\n<div><a href=\"https://en.wikipedia.org/wiki/Consistent_hashing\" target=\"_blank\">一致性hash</a>是将数据按照特征值映射到一个首尾相接的hash环上，同时也将节点（按照IP地址或者机器名hash）映射到这个环上。对于数据，从数据在环上的位置开始，顺时针找到的第一个节点即为数据的存储节点。这里仍然以上述的数据为例，假设id的范围为［0， 1000］，N0， N1， N2在环上的位置分别是100， 400， 800，那么hash环示意图与数据的分布如下：</div>\n<div style=\"text-align: center;\"> 　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/265e3dc723d195313a689e01bc6c542e.png\" alt=\"\">　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bba07578f38434571328a37d984025c0.png\" alt=\"\"></div>\n<p>可以看到相比于上述的hash方式，一致性hash方式需要维护的元数据额外包含了节点在环上的位置，但这个数据量也是非常小的。</p>\n<p>一致性hash在增加或者删除节点的时候，受到影响的数据是比较有限的，比如这里增加一个节点N3，其在环上的位置为600，因此，原来N2负责的范围段（400， 800］现在由N2（400， 600] N3(600, 800]负责，因此只需要将记录R2(id:759), R3(id: 607) 从N2,迁移到N3:</p>\n<div>　　不难发现一致性hash方式在增删的时候只会影响到hash环上响应的节点，不会发生大规模的数据迁移。</div>\n<p>但是，一致性hash方式在增加节点的时候，只能分摊一个已存在节点的压力；同样，在其中一个节点挂掉的时候，该节点的压力也会被全部转移到下一个节点。我们希望的是“一方有难，八方支援”，因此需要在增删节点的时候，已存在的所有节点都能参与响应，达到新的均衡状态。</p>\n<p>因此，在实际工程中，一般会引入虚拟节点（virtual node）的概念。即不是将物理节点映射在hash换上，而是将虚拟节点映射到hash环上。虚拟节点的数目远大于物理节点，因此一个物理节点需要负责多个虚拟节点的真实存储。操作数据的时候，先通过hash环找到对应的虚拟节点，再通过虚拟节点与物理节点的映射关系找到对应的物理节点。</p>\n<p>引入虚拟节点后的一致性hash需要维护的元数据也会增加：第一，虚拟节点在hash环上的问题，且虚拟节点的数目又比较多；第二，虚拟节点与物理节点的映射关系。但带来的好处是明显的，当一个物理节点失效是，hash环上多个虚拟节点失效，对应的压力也就会发散到多个其余的虚拟节点，事实上也就是多个其余的物理节点。在增加物理节点的时候同样如此。</p>\n<p>工程中，<a href=\"http://cloudgroup.neu.edu.cn/papers/cloud%20data%20storage/dynamo-sosp-2007.pdf\" target=\"_blank\">Dynamo</a>、<a href=\"https://cassandra.apache.org/%20%20%20%20\" target=\"_blank\">Cassandra</a>都使用了一致性hash算法，且在比较高的版本中都使用了虚拟节点的概念。在这些系统中，需要考虑综合考虑数据分布方式和数据副本，当引入数据副本之后，一致性hash方式也需要做相应的调整， 可以参加cassandra的相关文档。</p>\n<h2>range based</h2>\n<p>简单来说，就是按照关键值划分成不同的区间，每个物理节点负责一个或者多个区间。其实这种方式跟一致性hash有点像，可以理解为物理节点在hash环上的位置是动态变化的。</p>\n<p>还是以上面的数据举例，三个节点的数据区间分别是N0(0, 200]， N1(200, 500]， N2(500, 1000]。那么数据分布如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/97744e5665ed8d8444a5642e0e887714.png\" alt=\"\"></p>\n<p>注意，区间的大小不是固定的，每个数据区间的数据量与区间的大小也是没有关系的。比如说，一部分数据非常集中，那么区间大小应该是比较小的，即以数据量的大小为片段标准。在实际工程中，一个节点往往负责多个区间，每个区间成为一个块（chunk、block），每个块有一个阈值，当达到这个阈值之后就会分裂成两个块。这样做的目的在于当有节点加入的时候，可以快速达到均衡的目的。</p>\n<p>不知道读者有没有发现，如果一个节点负责的数据只有一个区间，range based与没有虚拟节点概念的一致性hash很类似；如果一个节点负责多个区间，range based与有虚拟节点概念的一致性hash很类似。</p>\n<p>range based的元数据管理相对复杂一些，需要记录每个节点的数据区间范围，特别单个节点对于多个区间的情况。而且，在数据可修改的情况下，如果块进行分裂，那么元数据中的区间信息也需要同步修改。</p>\n<p>range based这种数据分片方式应用非常广泛，比如MongoDB, PostgreSQL， HDFS</p>\n<h2>小结：</h2>\n<p>在这里对三种分片方式（应该是四种，有没有virtual node的一致性hash算两种）进行简单总结，主要是针对提出的几个问题：</p>\n<table cellspacing=\"0\" cellpadding=\"2\">\n<colgroup></colgroup>\n<tbody>\n<tr>\n<td></td>\n<td>映射难度</td>\n<td>元数据</td>\n<td>节点增删</td>\n<td>数据动态均衡</td>\n</tr>\n<tr>\n<td>hash方式</td>\n<td>简单</td>\n<td>非常简单，几乎不用修改</td>\n<td>需要迁移的数据比较多</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>consistent hash<br>\nwithout virtual node</td>\n<td>简单</td>\n<td>比较简单，取决于节点规模，几乎不用修改</td>\n<td>增删节点的时候只影响hash环上相邻节点，但不能使所有节点都参与数据迁移过程</td>\n<td>不支持</td>\n</tr>\n<tr>\n<td>consistent hash<br>\nwith virtual node</td>\n<td>中等</td>\n<td>稍微复杂一些，主要取决于虚拟节点规模，很少修改</td>\n<td>需要迁移的数据比较少，且所有节点都能贡献部分数据</td>\n<td>若支持（修改虚拟节点与物理节点映射关系）</td>\n</tr>\n<tr>\n<td>range based</td>\n<td>较为复杂</td>\n<td>取决于每个块的大小，一般来说规模较大；且修改频率较高</td>\n<td>需要迁移的数据比较少，且所有节点都能贡献部分数据</td>\n<td>支持，且比较容易</td>\n</tr>\n</tbody>\n</table>\n<p>上面的数据动态均衡，值得是上述问题的第4点，即如果某节点数据量变大，能否以及如何将部分数据迁移到其他负载较小的节点</p>\n<h1>分片特征值的选择</h1>\n<p>上面的三种方式都提到了对数据的分片是基于关键值、特征值的。这个特征值在不同的系统中有不同的叫法，比如MongoDB中的<a href=\"https://docs.mongodb.com/manual/core/sharding-shard-key/\" target=\"_blank\">sharding key</a>， Oracle中的<a href=\"https://docs.oracle.com/cd/B28359_01/server.111/b32024/partition.htm\" target=\"_blank\">Partition Key</a>，不管怎么样，这个特征值的选择都是非常非常重要的。</p>\n<p>那么。怎么选择这个特征值呢？《<a href=\"http://book.mixu.net/distsys/intro.html\" target=\"_blank\">Distributed systems for fun and profi</a>t》给出了言简意赅的标准：</p>\n<blockquote><p>　　 based on what you think the primary access pattern will be</p></blockquote>\n<p>大概翻译为：基于最常用的访问模式。访问时包括对数据的增删改查的。比如上面的列子，我们选择“id”作为分片的依据，那么就是默认对的数据增删改查都是通过“id”字段来进行的。</p>\n<p>如果在应用中，大量的数据操作都是通过这个特征值进行，那么数据分片就能提供两个额外的好处：</p>\n<p>（1）提升性能和并发，操作被分发到不同的分片，相互独立</p>\n<p>（2）提升系统的可用性，即使部分分片不能用，其他分片不会受到影响</p>\n<p>如果大量操作并没有使用到特征值，那么就很麻烦了。比如在本文的例子中，如果用name去查询，而元数据记录的是如何根据按照id映射数据位置，那就尴尬了，需要到多有分片都去查一下，然后再做一个聚合！</p>\n<p>另外一个问题，如果以单个字段为特征值（如id），那么不管按照什么分布方式，在多条数据拥有相同的特征值（如id）的情况下，这些数据一定都会分布到同一个节点上。在这种情况下有两个问题，一是不能达到节点间数据的均衡，二是如果数据超过了单个节点的存储能力怎么办？关键在于，即使按照分布式系统解决问题的常规办法 — 增加节点 –也是于事无补的。</p>\n<p>在这个时候，单个字段做特征值就不行了，可能得再增加一个字段作为“联合特征值”，类似数据库中的联合索引。比如，数据是用户的操作日志，可以使用id和时间戳一起作为hash函数的输入，然后算出特征值；但在这种情况下，如果还想以id为查询关键字来查询，那就得遍历所有节点了。</p>\n<p>所以说没有最优的设计，只有最符合应用需求的设计。</p>\n<p>下面以MongoDB中的sharding key为例，解释特征值选择的重要性以及对数据操作的影响。如果有数据库操作基础，即使没有使用过MongoDB，阅读下面的内容应该也没有问题。</p>\n<h2>以MongoDB sharding key为例</h2>\n<p>关于MongoDB Sharded cluster，之前也写过一篇文章《<a href=\"http://www.cnblogs.com/xybaby/p/6832296.html\" target=\"_blank\">通过一步步创建sharded cluster来认识mongodb</a>》，做了简单介绍。在我的工作场景中，除了联合查询（join）和事务，MongoDB的使用和Mysql还是比较相似的，特别是基本的CRUD操作、数据库索引。MongoDb中，每一个分片成为一个shard，分片的特征值成为sharding key，每个数据称之为一个document。选择适合的字段作为shardingkey非常重要，why？</p>\n<p>前面也提到，如果使用非sharding key去访问数据，那么元数据服务器（或者元数据缓存服务器，后面会讲解这一部分）是没法知道对应的数据在哪一个shard上，那么该访问就得发送到所有的shard，得到所有shard的结果之后再做聚合，在mongoDB中，由mongos（缓存有元数据信息）做数据聚合。对于数据读取（R： read or retrieve），通过同一个字段获取到多个数据，是没有问题的，只是效率比较低而已。对于数据更新，如果只能更新一个数据，那么在哪一个shard上更新呢，似乎都不对，这个时候，MongoDB是拒绝的。对应到MongoDB（MongoDD3.0）的命令包括但不限于：</p>\n<ul>\n<li>　　findandmodify：这个命令只能更新一个document，因此查询部分必须包含sharding key</li>\n</ul>\n<blockquote><p>　　When using <code>findAndModify</code> in a sharded environment, the <code>query</code> must contain the shard key for all operations against the shard cluster for the <em>sharded</em> collections.</p></blockquote>\n<ul>\n<li>　　update：这个命令有一个参数multi，默认是false，即只能更新一个document，此时查询部分必须包含sharding key</li>\n</ul>\n<blockquote>\n<div>All <code>update()</code> operations for a sharded collection that specify the <code>multi: false</code> option must include theshard key <em>or</em> the <code>_id</code> field in the query specification.</div>\n</blockquote>\n<ul>\n<li> 　  remove：有一个参数JustOne，如果为True，只能删除一个document，也必须使用sharidng key</li>\n</ul>\n<p>另外，熟悉sql的同学都知道，在数据中索引中有unique index（唯一索引），即保证这个字段的值在table中是唯一的。mongoDB中，也可以建立unique index，但是在sharded cluster环境下，只能对sharding key创建unique index，道理也很简单，如果unique index不是sharidng key，那么插入的时候就得去所有shard上查看，而且还得加锁。</p>\n<p>接下来，讨论分片到shard上的数据不均的问题，如果一段时间内shardkey过于集中（比如按时间增长），那么数据只往一个shard写入，导致无法平衡集群压力。</p>\n<div>　　MongoDB中提供了”<a href=\"https://docs.mongodb.com/manual/core/ranged-sharding/\" target=\"_blank\">range partition</a>“和”<a href=\"https://docs.mongodb.com/manual/core/hashed-sharding/\" target=\"_blank\">hash partition</a>“，<strong>这个跟上面提到的分片方式 hash方式， ranged based不是一回事儿</strong>，而是指对sharding key处理。MongoDB一定是ranged base分片方式,<a href=\"https://docs.mongodb.com/manual/core/sharding-shard-key/\" target=\"_blank\">docuemnt</a>中如是说：</div>\n<blockquote>\n<div>MongoDB <a href=\"https://docs.mongodb.com/manual/reference/glossary/#term-data-partition\">partitions</a> data in the collection using ranges of shard key values. Each range defines a non-overlapping range of shard key values and is associated with a <a href=\"https://docs.mongodb.com/manual/reference/glossary/#term-chunk\">chunk</a>.</div>\n</blockquote>\n<p>那么什么是”range partition”和”hash partition”，官网的一张图很好说明了二者的区别：</p>\n<p style=\"text-align: center;\">　　<img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4f75dba562d78dd3cf88e6a0420a83b6.png\" alt=\"\" width=\"496\" height=\"248\">            <img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/13aa93953848ef771a508070a6e68ee7.png\" alt=\"\" width=\"504\" height=\"252\"></p>\n<p>　　上图左是range partition，右是hash partition。range partition就是使用字段本身作为分片的边界，比如上图的x；而hash partition会将字段重新hash到一个更大、更离散的值域区间。</p>\n<p>hash partition的最大好处在于保证数据在各个节点上均匀分布（这里的均匀指的是在写入的时候就均匀，而不是通过MongoDB的balancing功能）。比如MongoDB中默认的_id是objectid，objectid是一个12个字节的BSON类型，前4个字节是机器的时间戳，那么如果在同一时间大量创建以ObjectId为_id的数据 会分配到同一个shard上，此时若将_id设置为hash index 和 hash sharding key，就不会有这个问题。</p>\n<p>当然，hash  partition相比range partition也有一个很大的缺点，就是范围查询的时候效率低！因此到底选用hash  partition还是range partition还得根据应用场景来具体讨论。</p>\n<p>最后得知道，sharding key一但选定，就无法修改（Immutable）。如果应用必须要修改sharidng key，那么只能将数据导出，新建数据库并创建新的sharding key，最后导入数据。</p>\n<h1>元数据服务器</h1>\n<p>在上面讨论的三种数据分片分式中，或多或少都会记录一些元数据：数据与节点的映射关系、节点状态等等。我们称记录元数据的服务器为元数据服务器（metaserver），不同的系统叫法不一样，比如master、configserver、namenode等。</p>\n<p>元数据服务器就像人类的大脑，一只手不能用了还没忍受，大脑不工作整个人就瘫痪了。因此，元数据服务器的<strong>高性能、高可用</strong>，要达到这两个目标，元数据服务器就得高<strong>可扩展</strong> — 以此应对元数据的增长。</p>\n<p>元数据的高可用要求元数据服务器不能成为故障单点（single point of failure），因此需要元数据服务器有多个备份，并且能够在故障的时候迅速切换。</p>\n<p>有多个备份，那么问题就来了，怎么保证多个备份的数据一致性？</p>\n<p>多个副本的一致性、可用性是CAP理论讨论的范畴，这里简单介绍两种方案。第一种是主从同步，首先选出主服务器，只有主服务器提供对外服务，主服务器将元数据的变革信息以日志的方式持久化到共享存储（例如nfs），然后从服务器从共享存储读取日志并应用，达到与主服务器一致的状态，如果主服务器被检测到故障（比如通过心跳），那么会重新选出新的主服务器。第二种方式，通过分布式一致性协议来达到多个副本件的一致，比如大名鼎鼎的Paxos协议，以及工程中使用较多的Paxos的特化版本 — Raft协议，协议可以实现所有备份均可以提供对外服务，并且保证强一致性。</p>\n<h2>HDFS元数据</h2>\n<p>HDFS中，元数据服务器被称之为namenode，在hdfs1.0之前，namenode还是单点，一旦namenode挂掉，整个系统就无法工作。在hdfs2.0，解决了namenode的单点问题。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/8221eac439b32bd000638097d281c3bb.png\" alt=\"\"></p>\n<p>上图中NN即NameNode， DN即DataNode（即实际存储数据的节点）。从图中可以看到， 两台 NameNode 形成互备，一台处于 Active 状态，为主 NameNode，另外一台处于 Standby 状态，为备 NameNode，<strong>只有主 NameNode 才能对外提供读写服务</strong>。</p>\n<p>Active NN与standby NN之间的数据同步通过共享存储实现，共享存储系统保证了Namenode的高可用。为了保证元数据的强一致性，在进行准备切换的时候，新的Active NN必须要在确认元数据完全同步之后才能继续对外提供服务。</p>\n<p>另外，Namenode的状态监控以及准备切换都是Zookeeper集群负责，在网络分割（network partition）的情况下，有可能zookeeper认为原来的Active NN挂掉了，选举出新的ActiveNN，但实际上原来的Active NN还在继续提供服务。这就导致了“双主“或者脑裂（brain-split）现象。为了解决这个问题，提出了fencing机制，也就是想办法把旧的 Active NameNode 隔离起来，使它不能正常对外提供服务。具体参见<a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/\" target=\"_blank\">这篇文章</a>。</p>\n<h2>MongoDB元数据</h2>\n<p>MongoDB中，元数据服务器被称为config server。在MongoDB3.2中，已经不再建议使用三个镜像(Mirrored)MongoDB实例作为config server，而是推荐使用复制集（replica set）作为config server，此举的目的是增强config server的一致性，而且config sever中mongod的数目也能从3个达到replica set的上线（50个节点），从而提高了可靠性。</p>\n<p>在MongoDB3.0及之前的版本中，元数据的读写按照下面的方式进行：</p>\n<blockquote><p>　　When writing to the three config servers, a <strong>coordinator</strong> dispatches the same write commands to the three config servers and collects the results. Differing results indicate an inconsistent writes to the config servers and may require manual intervention.</p></blockquote>\n<p>MongoDB的官方文档并没有详细解释这一过程，不过在<a href=\"https://dba.stackexchange.com/questions/91194/why-does-mongodb-require-three-config-servers\" target=\"_blank\">stackexchange</a>上，有人指出这个过程是两阶段提交。</p>\n<p>MongoDB3.2及之后的版本，使用了replica set config server，在《<a href=\"http://www.cnblogs.com/xybaby/p/6871764.html\" target=\"_blank\">CAP理论与MongoDB一致性、可用性的一些思考</a>》文章中，详细介绍了replica set的write concern、read concern和read references，这三个选项会影响到复制集的一致性、可靠性与读取性能。在config server中，使用了WriteConcern：Majority；ReadConcern：Majority；ReadReferences：nearest。</p>\n<h2>元数据的缓存：</h2>\n<p>即使元数据服务器可以由一组物理机器组成，也保证了副本集之间的一致性问题。但是如果每次对数据的请求都经过元数据服务器的话，元数据服务器的压力也是非常大的。很多应用场景，元数据的变化并不是很频繁，因此可以在访问节点上做缓存，这样应用可以直接利用缓存数据进行数据读写，减轻元数据服务器压力。</p>\n<p>在这个环境下，缓存的元数据必须与元数据服务器上的元数据一致，缓存的元数据必须是准确的，未过时的。相反的例子是DNS之类的缓存，即使使用了过期的DNS缓存也不会有太大的问题。</p>\n<p>怎么达到缓存的强一致性呢？比较容易想到的办法是当metadata变化的时候立即通知所有的缓存服务器（mongos），但问题是通信有延时，不可靠。</p>\n<p>解决不一致的问题，一个比较常见的思路是版本号，比如网络通信，通信协议可能会发生变化，通信双方为了达成一致，那么可以使用版本号。在缓存一致性的问题上，也可以使用版本号，基本思路是请求的时候带上缓存的版本号，路由到具体节点之后比较实际数据的版本号，如果版本号不一致，那么表示缓存信息过旧，此时需要从元数据服务器重新拉取元数据并缓存。在MongoDB中，mongos缓存上就是使用的这种办法。</p>\n<p>另外一种解决办法，就是大名鼎鼎的lease机制 — “An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency”，lease机制在分布式系统中使用非常广泛，不仅仅用于分布式缓存，在很多需要达成某种约定的地方都大显身手，在《分布式系统原理介绍》中，对lease机制有较为详细的描述，下面对lease机制进行简单介绍。</p>\n<h2>Lease机制：</h2>\n<p>既然，Lease机制提出的时候是为了解决分布式存储系统中缓存一致性的问题，那么首先来看看Lease机制是怎么保证缓存的强一致性的。<strong>注意</strong>，为了方便后文描述，在本小节中，我们称元数据服务器为服务器，缓存服务器为客户端。</p>\n<p><strong>要点</strong>：</p>\n<ul>\n<li>　　服务器向所有客户端发送缓存数据的同时，颁发一个lease，lease包含一个有限期（即过期时间）</li>\n<li>　　lease的含义是：在这个有效期内，服务器保证元数据不会发生变化</li>\n<li>　　因此客户端在这个有效期内可以放心大胆的使用缓存的元数据，如果超过了有效期，就不能使用数据了，就得去服务器请求。</li>\n<li>　　如果外部请求修改服务器上的元数据（元数据的修改一定在服务器上进行），那么服务器会阻塞修改请求，直到所有已颁发的lease过期，然后修改元数据，并将新的元数据和新的lease发送到客户端</li>\n<li>　　如果元数据没有发生变化，那么服务器也需要在之前已颁发的lease到期之间，重新给客户端颁发新的lease（只有lease，没有数据）</li>\n</ul>\n<p>在Lease论文的标题中，提到了“Fault-Tolerant”，那么lease是怎么做到容错的呢。关键在于，只要服务器一旦发出数据和lease，不关心客户端是否收到数据，只要等待lease过期，就可以修改元数据；另外，lease的有效期通过过期时间（一个时间戳）来标识，因此即使从服务器到客户端的消息延时到达、或者重复发送都是没有关系的。</p>\n<p>不难发现，容错的前提是服务器与客户端的时间要一致。如果服务器的时间比客户端的时间慢，那么客户端收到lease之后很快就过期了，lease机制就发挥不了作用；如果服务器的时间比客户端的时间快，那么就比较危险，因为客户端会在服务器已经开始更新元数据的时候继续使用缓存，工程中，通常将服务器的过期时间设置得比客户端的略大，来解决这个问题。为了保持时间的一致，最好的办法是使用NTP（Network Time Protocol）来保证时钟同步。</p>\n<p>Lease机制的本质是颁发者授予的在某一有效期内的承诺，承诺的范围是非常广泛的：比如上面提到的cache；比如做权限控制，例如当需要做并发控制时，同一时刻只给某一个节点颁发lease，只有持有lease的节点才可以修改数据；比如身份验证，例如在primary-secondary架构中，给节点颁发lease，只有持有lease的节点才具有primary身份；比如节点的状态监测，例如在primary-secondary架构中监测primary是否正常，这个后文再详细介绍。</p>\n<p>工程中，lease机制也有大量的应用：GFS中使用Lease确定Chuck的Primary副本, Lease由Master节点颁发给primary副本，持有Lease的副本成为primary副本。chubby通过paxos协议实现去中心化的选择primary节点，然后Secondary节点向primary节点发送lease，该lease的含义是：“承诺在lease时间内，不选举其他节点成为primary节点”。chubby中，primary节点也会向每个client节点颁发lease。该lease的含义是用来判断client的死活状态，一个client节点只有只有合法的lease，才能与chubby中的primary进行读写操作。</p>\n<h1>总结</h1>\n<p>本文主要介绍分布式系统中的分片相关问题，包括三种分布方式：hash、一致性hash、range based，以及各自的优缺点。分片都是按照一定的特征值来进行，特征值应该从应用的使用场景来选取，并结合MongoDB展示了特征值（mongodb中的sharding key）对数据操作的影响。分片信息（即元数据）需要专门的服务器存储，元数据服务器是分布式存储系统的核心，因此需要提到其可用性和可靠性，为了减轻元数据服务器的压力，分布式系统中，会在其他节点缓存元数据，缓存的元数据由带来了一致性的挑战，由此引入了Lease机制。</p>\n<h1>references</h1>\n<ul>\n<li>刘杰的《分布式系统原理介绍》</li>\n<li><a href=\"http://book.mixu.net/distsys/\" target=\"_blank\">Distributed systems for fun and profit  </a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Consistent_hashing\" target=\"_blank\">Wiki：Consistent_hashing</a></li>\n<li><a href=\"https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/\" target=\"_blank\">Hadoop NameNode 高可用 (High Availability) 实现解析</a></li>\n<li><a href=\"http://www.cnblogs.com/xybaby/p/6871764.html\" target=\"_blank\">CAP理论与MongoDB一致性、可用性的一些思考</a></li>\n<li><a href=\"http://web.eecs.umich.edu/~mosharaf/Readings/Leases.pdf\" target=\"_blank\">Leases: An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency</a></li>\n</ul>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111716\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111716votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111716\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/9c3ebd88533763a9cc48fc406d741a1a.png', 'full/4f98c9ecf55b5d6ac63cc8ecc27f2fa194e86ad0.jpg'),
('大数据搜索选开源还是商业软件？ElasticSearch 对比 Splunk', '2017-07-07', 'http://blog.jobbole.com/111525/', '78d28f7dbe719356ad7e22862dbab59e', 4, 1, 'IT技术, ElasticSearch, Splunk', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://my.oschina.net/taogang/blog/983586\">naughty</a>   </div><p>本文就架构，功能，产品线，概念等方面就ElasticSearch和Splunk做了一下全方位的对比，希望能够大家在制定大数据搜索方案的时候有所帮助。</p>\n<h2 id=\"h2_0\">简介</h2>\n<p><strong>ElasticSearch</strong> （<a href=\"https://www.elastic.co/\" rel=\"nofollow\">1</a>）（<a href=\"https://en.wikipedia.org/wiki/Elasticsearch\" rel=\"nofollow\">2</a>）是一个基于Lucene的开源搜索服务。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于<a href=\"http://baike.baidu.com/item/%E4%BA%91%E8%AE%A1%E7%AE%97\" target=\"_blank\" rel=\"nofollow\">云计算</a>中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>\n<p><strong>ELK</strong>是<a href=\"https://www.elastic.co/jp/products/elasticsearch\" rel=\"nofollow\">ElasticSearch</a>，<a href=\"https://www.elastic.co/jp/products/logstash\" rel=\"nofollow\">Logstash</a>，<a href=\"https://www.elastic.co/jp/products/kibana\" rel=\"nofollow\">Kibana</a>的缩写，分别提供搜索，数据接入和可视化功能，构成了Elastic的应用栈。</p>\n<p><strong>Splunk</strong> 是大数据领域第一家在纳斯达克上市公司，<a href=\"https://www.splunk.com/zh-hans_cn\" rel=\"nofollow\">Splunk</a>提供一个机器数据的引擎。使用 Splunk 可收集、索引和利用所有应用程序、服务器和设备（物理、虚拟和云中）生成的快速移动型计算机数据 。从一个位置搜索并分析所有实时和历史数据。 使用 Splunk 处理计算机数据，可让您在几分钟内（而不是几个小时或几天）解决问题和调查安全事件。监视您的端对端基础结构，避免服务性能降低或中断。以较低成本满足合规性要求。关联并分析跨越多个系统的复杂事件。获取新层次的运营可见性以及 IT 和业务智能。</p>\n<p>根据最新的<a href=\"https://db-engines.com/en/ranking\" rel=\"nofollow\">数据库引擎排名</a>显示，Elastic，Solr和Splunk分别占据了数据库搜索引擎的前三位。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/102156_SGGq_1450051.png\" width=\"942\" height=\"642\"></p>\n<p>从<a href=\"https://db-engines.com/en/ranking_trend\" rel=\"nofollow\">趋势</a>上来看，Elastic和Splunk上升明显，Elastic更是表现出了非常强劲的势头。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/102436_w14n_1450051.png\" width=\"963\" height=\"534\"></p>\n<h2 id=\"h2_1\">基本概念</h2>\n<p><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html\" rel=\"nofollow\"><strong>Elastic</strong></a></p>\n<ul>\n<li>准实时(NRT)<br>\nElasticsearch是一个准实时性的搜索平台，从数据索引到数据可以被搜索存在一定的时延。</li>\n<li>索引（Index）<br>\n索引是有共同特性的文档的集合，索引有自己的名字，可以对索引执行搜索，更新，删除等操作。</li>\n<li>类型（Type）<br>\n每个索引可以包含一个或者多个类型，类型可以看作一个索引数据的逻辑分组，通常我们会把拥有相同字段的文档定义为同一个类型。</li>\n<li>文档（Document）<br>\n文档是索引信息的基本单元。Elastic中文档表现为JSON对象，文档物理存贮在索引中，并需要被制定一个类型。因为表现为JSON， 很自然的，文档是由一个个的字段（Feilds）组成，每个字段是一个名值对（Name Value Pair）</li>\n<li>评分（score）<br>\nElastic是基于<a href=\"https://lucene.apache.org/\" rel=\"nofollow\">Lucene</a>构建的，所以搜索的结果会有一个<a href=\"http://blog.chenlb.com/2009/08/lucene-scoring-architecture.html\" rel=\"nofollow\">打分</a>。来评价搜索结果和查询的相关性。</li>\n</ul>\n<p>下图是一个Elastic的搜索在Kibana中看到的例子，原始的数据是一个简单的日志文件：</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/143016_SOUq_1450051.png\" width=\"465\" height=\"187\"></p>\n<p>我们通过logstash索引到Elasticsearch后，就可以搜索了。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/135259_AEE0_1450051.png\" width=\"1222\" height=\"712\"></p>\n<p><a href=\"https://www.splunk.com/content/dam/splunk2/pdfs/solution-guides/splunk-quick-reference-guide.pdf\" rel=\"nofollow\"><strong>Splunk</strong></a></p>\n<ul>\n<li>实时性<br>\nSplunk同样是准实时的，Splunk的实时搜索（<a href=\"http://docs.splunk.com/Documentation/SplunkCloud/6.6.0/Search/RealtimesearchesandreportsinSplunkWeb\" rel=\"nofollow\">Realtime Search</a>）可以提供不间断的搜索结果的数据流。</li>\n<li>事件（Event）<br>\n对应于Elastic的文档，Splunk的数据索引的基本单元是事件，每一个事件包含了一组值，字段，时间戳。Splunk的事件可以是一段文本，一个配置文件，一段日志或者JSON对象。</li>\n<li>字段（Fields）<br>\n字段是可以被搜索的名值对，不同的事件可能拥有不同的字段。Splunk支持索引时（index time）和搜索时（search time）的字段抽取（fields extraction）</li>\n<li>索引（Indexes）<br>\n类似Elastic的索引，所有的事件物理存储在索引上，可以把索引理解为一个数据库的表。</li>\n<li>知识对象（Knowledge Object）<br>\nSplunk的知识对象提供对数据进一步的解释，分类，增强等功能，包括：字段（fields），字段抽取（fields extraction），事件类型（event type），事务（transaction），查找（lookups），标签（tags），别名（aliases），数据模型（data model）等等。</li>\n</ul>\n<p>下图是一个Splunk的搜索在Splunk客户端看到的和前一个例子同样的日志数据的搜索结果。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/135439_CcWN_1450051.png\" width=\"924\" height=\"809\"></p>\n<p>从基本概念上来看，Elasticsearch和Splunk基本一致。从例子中我们可以看到很多的共性，事件／文档，时间戳，字段，搜索，时间轴图等等。其中有几个主要的差别：</p>\n<ul>\n<li>Elastic不支持搜索时的字段抽取，也就是说Elastic的文档中的所有字段在索引时已经固定了，而Splunk支持在搜索时，动态的抽取新的字段</li>\n<li>Elastic的搜索是基于评分机制的，搜索的结果有一个打分，而Splunk没有对搜索结果评分</li>\n<li>Splunk的知识对象可以提供对数据更高级，更灵活的管理能力。</li>\n</ul>\n<h2 id=\"h2_2\">用户接口</h2>\n<p>ElasticSearch提供REST API来进行</p>\n<ul>\n<li>集群的管理，监控，健康检查</li>\n<li>索引的管理（CURD）</li>\n<li>搜索的执行，包括排序，分页，过滤，脚本，聚合等等高级的搜索功能。</li>\n</ul>\n<p>Elasticsearch 本身并没有提供任何UI的功能，搜索可以用Kibana，但是没有管理UI还是让人不爽的，好在开源的好处就是会有很多的开发者来构建缺失的功能：</p>\n<ul>\n<li><a href=\"http://www.elastichq.org/\" rel=\"nofollow\">ElasticHQ</a></li>\n<li><a href=\"https://github.com/lmenezes/cerebro\" rel=\"nofollow\">cerebro</a> (推荐，界面干净，我喜欢)</li>\n<li><a href=\"https://github.com/appbaseio/dejavu/tree/dev\" rel=\"nofollow\">dejavu</a></li>\n</ul>\n<p>另一选择就是安装X-Pack，这个是要收费的。</p>\n<p>Splunk作为企业软件，管理及访问接口比较丰富，除了REST API 和命令行接口，Splunk的UI非常友好易用，基本上所有的功能都能通过集成的UI来使用。同时提供以下接口</p>\n<ul>\n<li>REST API</li>\n<li>Splunk UI</li>\n<li>CLI</li>\n</ul>\n<h2 id=\"h2_3\">功能</h2>\n<h3 id=\"h3_4\">数据接入和获取</h3>\n<p><strong>Elastic</strong>栈使用Logstash和Beats来进行数据的消化和获取。</p>\n<p><a href=\"https://github.com/elastic/logstash\" rel=\"nofollow\">Logstash</a>用jruby实现，有点像一个数据管道，把输入的数据进行处理，变形，过滤，然后输出到其它地方。Logstash 设计了自己的 DSL，包括有区域，注释，数据类型(布尔值，字符串，数值，数组，哈希)，条件判断，字段引用等。</p>\n<p>Logstash的数据管道包含三个步骤，Input，Filter和Output，每一步都可以通过plugin来扩展。另外Input和Output还支持配置Codecs，完成对输入输出数据的编解码工作。</p>\n<p><img src=\"https://static.oschina.net/uploads/img/201706/19170803_cGoS.png\" alt=\"\"></p>\n<p>Logstash支持的常见的Input包含File，syslog，beats等。Filter中主要完成数据的变形处理，可以增删改字段，加标签，等等。作为一个开源软件，Output不仅仅支持ElasticSearch，还可以和许多其它软件集成和目标，Output可以是文件，graphite，数据库，Nagios，S3，Hadoop等。</p>\n<p><img src=\"https://static.oschina.net/uploads/img/201706/19170811_3g2R.jpg\" alt=\"\"></p>\n<p>在实际运用中，logstash 进程会被分为两个不同的角色。运行在应用服务器上的，尽量减轻运行压力，只做读取和转发，这个角色叫做 shipper；运行在独立服务器上，完成数据解析处理，负责写入 Elasticsearch 的角色，叫 indexer。</p>\n<p>logstash 作为无状态的软件，配合消息队列系统，可以很轻松的做到线性扩展</p>\n<p><a href=\"https://github.com/elastic/beats\" rel=\"nofollow\">Beats</a>是 Elastic 从 packetbeat 发展出来的数据收集器系统。beat 收集器可以直接写入 Elasticsearch，也可以传输给 Logstash。其中抽象出来的 libbeat，提供了统一的数据发送方法，输入配置解析，日志记录框架等功能。</p>\n<p><img src=\"https://static.oschina.net/uploads/img/201706/19170345_gLzF.png\" alt=\"\"></p>\n<p>开源社区已经贡献了<a href=\"https://www.elastic.co/guide/en/beats/libbeat/current/community-beats.html\" rel=\"nofollow\">许多的beats</a>种类。</p>\n<p>因为Beats是使用Golang编写的，效率上很不错。</p>\n<p><strong>Splunk</strong>使用Farwarder和Add-ons来进行数据的消化和获取。</p>\n<p>Splunk内置了对文件，syslog，网络端口等input的处理。当配置某个节点为Forwarder的时候，Splunk Forwarder可以作为一个数据通道把数据发送到配置好的indexer去。这时候，它就类似logstash。这里一个主要的区别就是对数据字段的抽取，Elastic必须在logstash中通过filter配置或者扩展来做，也就是我们所说的Index time抽取，抽取后不能改变。Splunk支持Index time的抽取，但是更多时候，Splunk 在index time并不抽取而是等到搜索是在决定如何抽取字段。</p>\n<p>对于特定领域的数据获取，Splunk是用<a href=\"https://www.splunk.com/en_us/products/apps-and-add-ons.html\" rel=\"nofollow\">Add-on</a>的形式。Splunk 的App市场上有超过600个不同种类的Add-on。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/172840_Kc9n_1450051.png\" alt=\"\" width=\"788\" height=\"624\"></p>\n<p>用户可以通过特定的Add-on或者自己开发Add-on来获取特定的数据。</p>\n<p>对于大数据的数据采集，大家也可以参考我的<a href=\"https://my.oschina.net/taogang/blog/524385\" rel=\"nofollow\">另一篇博客</a>。</p>\n<h3 id=\"h3_5\">数据管理和存储</h3>\n<p>ElasticSearch的数据存贮模型来自于Lucene，基本原理是实用了倒排表。大家可以参考<a href=\"http://www.infoq.com/cn/articles/analysis-of-elasticsearch-cluster-part01\" rel=\"nofollow\">这篇文章</a>。</p>\n<p>Splunk的核心同样是倒排表，推荐大家看这篇去年Splunk Conf上的介绍，<a href=\"https://conf.splunk.com/files/2016/slides/behind-the-magnifying-glass-how-search-works.pdf\" rel=\"nofollow\">Behind the Magnifying Glass: How Search Works</a></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/173140_pJqA_1450051.png\" alt=\"\" width=\"2062\" height=\"890\"></p>\n<p>Splunk的Event存在许多Buckets中，多个Buckets构成逻辑分组的索引分布在Indexer上。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/175300_F8F0_1450051.png\" width=\"2134\" height=\"836\"></p>\n<p>每个Bucket中都是倒排表的结构存储数据，原始数据通过gzip压缩。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/191746_kL6q_1450051.png\" width=\"2066\" height=\"1052\"></p>\n<p>搜索时，利用Bloom filter定位数据所在的bucket。</p>\n<p>在对数据的存储管理上，Elastic 和Splunk都是利用了倒排表。Splunk对数据进行压缩，所以存储空间的占用要少很多，尤其考虑到大部分数据是文本，压缩比很高的，当然这会损失一部分性能用于数据的解压。</p>\n<h3 id=\"h3_6\">数据分析和处理</h3>\n<p>对数据的处理分析，ElasticSearch主要使用 <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search.html\" rel=\"nofollow\">Search API</a>来实现。而Splunk则提供了非常强大的<a href=\"https://www.splunk.com/en_us/resources/search-processing-language.html\" rel=\"nofollow\">SPL</a>，相比起ES的Search API，Splunk的SPL要好用很多，可以说SPL就是非结构化数据的SQL。无论是利用SPL来开发分析应用，还是直接在Splunk UI上用SPL来处理数据，SPL都非常易用。开源社区也在试图为Elastic增加类似SPL的DSL来改善数据处理的易用性。例如：</p>\n<ul>\n<li><a href=\"https://github.com/chenryn/ESPL\" rel=\"nofollow\">https://github.com/chenryn/ESPL</a></li>\n</ul>\n<p>从这篇<a href=\"https://discuss.elastic.co/t/elastic-vs-splunk-query-feature-comparison-join-pipe-table-dedup-eval-chart-rex/23552\" rel=\"nofollow\">反馈</a>可以看出，ES的search还有许多的不足。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/194302_paug_1450051.png\" width=\"2234\" height=\"1066\"></p>\n<p>作为对此的响应，Elastic推出了<a href=\"https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-getting-started.html\" rel=\"nofollow\">painless script</a>，该功能还处于实验阶段。</p>\n<h3 id=\"h3_7\">数据展现和可视化</h3>\n<p>Kibana是一个针对Elasticsearch的开源分析及可视化平台，用来搜索、查看交互存储在Elasticsearch索引中的数据。使用Kibana，可以通过各种图表进行高级数据分析及展示。</p>\n<p><img src=\"https://static.oschina.net/uploads/img/201706/19171453_gqaE.jpg\" alt=\"\"></p>\n<p>Splunk集成了非常方便的数据可视化和仪表盘功能，对于SPL的结果，可以非常方便的通过UI的简单设置进行可视化的分析，导出到仪表盘。</p>\n<p><img src=\"https://static.oschina.net/uploads/img/201706/19171456_fsKK.jpg\" alt=\"\"></p>\n<p>下图的比较来自<a href=\"https://www.itcentralstation.com/products/comparisons/kibana_vs_splunk\" rel=\"nofollow\">https://www.itcentralstation.com/products/comparisons/kibana_vs_splunk</a></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/193547_Wwq6_1450051.png\" width=\"1982\" height=\"750\"></p>\n<p>在数据可视化的领域的<a href=\"https://www.itcentralstation.com/categories/data-visualization#top_rated\" rel=\"nofollow\">排名</a>，Splunk仅仅落后于Tableau而已</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0619/194139_q14k_1450051.png\" width=\"2010\" height=\"1314\"></p>\n<h3 id=\"h3_8\">扩展性</h3>\n<p>从扩展性的角度来看，两个平台都拥有非常好的扩展性。</p>\n<p>Elastic栈作为一个开源栈，很容易通过Plugin的方式扩展。包括：</p>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/plugins/current/index.html\" rel=\"nofollow\">ElasticSearch Plugin </a></li>\n<li><a href=\"https://www.elastic.co/guide/en/kibana/current/kibana-plugins.html\" rel=\"nofollow\">Kibana Plugin</a></li>\n<li><a href=\"https://www.elastic.co/guide/en/logstash/current/working-with-plugins.html\" rel=\"nofollow\">Logstash Plugin</a></li>\n<li><a href=\"https://www.elastic.co/guide/en/beats/libbeat/current/new-beat.html\" rel=\"nofollow\">Beats Platform</a></li>\n</ul>\n<p>Splunk提供一系列的扩展点支持应用和Add-on的开发， 在<a href=\"http://dev.splunk.com/\" rel=\"nofollow\">http://dev.splunk.com/</a>可以找到更多的信息和文档。包括：</p>\n<ul>\n<li><a href=\"http://dev.splunk.com/webframework\" rel=\"nofollow\">Web Framework</a></li>\n<li><a href=\"http://dev.splunk.com/sdks\" rel=\"nofollow\">SDK</a></li>\n<li><a href=\"http://dev.splunk.com/view/python-sdk/SP-CAAAER3\" rel=\"nofollow\">Modular Input</a></li>\n<li>… …</li>\n</ul>\n<p>比起Elastic的Plugin，Splunk的扩展概念上比较复杂，开发一个App或者Add-on的门槛都要相对高一些。做为一个数据平台，Splunk应该在扩展性上有所改进，使得扩展变的更为容易和简单。</p>\n<h2 id=\"h2_9\">架构</h2>\n<p><strong>Elastic Stack</strong></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/104019_J5fb_1450051.png\" width=\"1152\" height=\"431\"></p>\n<p>如上图所示，ELK是一套栈，Logstash提供数据的消化和获取，Elasticsearch对数据进行存储，索引和搜索，而Kibana提供数据可视化和报表的功能。</p>\n<p><strong>Splunk</strong></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/103709_fR14_1450051.png\" width=\"699\" height=\"700\"></p>\n<p>Splunk的架构主要有三个角色：</p>\n<ul>\n<li>Indexer<br>\nIndexer提供数据的存储，索引，类似Elasticsearch的作用</li>\n<li>Search Head<br>\nSearch Head负责搜素，客户接入，从功能上看，一部分是Kibana，因为Splunk的UI是运行在Search Head上的，提供所有的客户端和可视化的功能，还有一部分，是提供分布式的搜索功能，包含对搜索的分发到Indexer和搜索结果的合并，这一部分功能对应在Elasticsearch上。</li>\n<li>Forwarder<br>\nSplunk的Forwarder负责数据接入，类似Logstash</li>\n</ul>\n<p>除了以上的三个主要的角色，Splunk的架构中还有：Deployment Server，License Server，Master Cluster Node，Deployer等。</p>\n<p>Splunk和ELK的基本架构非常类似，但是ELK的架构更为简单和清楚，Logstash负责数据接入，Kibana负责数据展现，所有的复杂性在Elasticsearch中。Splunk的架构更为复杂一些，角色的类型也更多一些。</p>\n<p>如果装单机版本，Splunk更容易，因为所有的功能一次性就装好了，而ELK则必须分别安装E/L/K，从这一点上来看，Splunk有一定的优势。</p>\n<h2 id=\"h2_10\">分布集群和扩展性</h2>\n<p><strong>ElasticSearch</strong></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/105032_zDW9_1450051.png\" width=\"607\" height=\"254\"></p>\n<p>ElasticSearch是为分布式设计的，有很好的扩展性，在一个典型的分布式配置中，每一个节点（node）可以配制成不同的角色，如上图所示：</p>\n<ul>\n<li>Client Node，负责API和数据的访问的节点，不存储／处理数据</li>\n<li>Data Node，负责数据的存储和索引</li>\n<li>Master Node， 管理节点，负责Cluster中的节点的协调，不存储数据。</li>\n</ul>\n<p>每一种角色可以通过ElasticSearch的配置文件或者环境变量来配置。每一种角色都可以很方便的Scale，因为Elastic采用了对等性的设计，也就是所有的角色是平等的，（Master Node会进行Leader Election，其中有一个是领导者）这样的设计使得在集群环境的伸缩性非常好，尤其是在容器环境，例如Docker Swarm或者Kubernetes中使用。</p>\n<p>参考：</p>\n<ul>\n<li><a href=\"https://elk-docker.readthedocs.io/#elasticsearch-cluster\" rel=\"nofollow\">https://elk-docker.readthedocs.io/#elasticsearch-cluster</a></li>\n<li><a href=\"https://github.com/pires/kubernetes-elasticsearch-cluster\" rel=\"nofollow\">https://github.com/pires/kubernetes-elasticsearch-cluster</a></li>\n</ul>\n<p><strong>Splunk</strong></p>\n<p>Splunk作为企业级的分布式机器数据的平台，拥有强大的分布式配置，包括跨数据中心的集群配置。Splunk提供两种集群，Indexer集群和Search Head集群。</p>\n<p>Splunk <a href=\"http://docs.splunk.com/Documentation/Splunk/6.6.1/Indexer/Basicclusterarchitecture\" rel=\"nofollow\">Indexer集群</a></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/104459_RNyl_1450051.png\" width=\"590\" height=\"525\"></p>\n<p>如上图所示，Splunk的indexer集群主要由三种角色：</p>\n<ul>\n<li>Master Node，Master Node负责管理和协调整个的集群，类似ES的Master。但是只有一个节点，不支持多Master（最新版本6.6）。Master Node负责\n<ul>\n<li>协调Peer Node之间的数据复制</li>\n<li>告诉Search Head数据在哪里</li>\n<li>Peer Node的配置管理</li>\n<li>Peer Node故障时的故障恢复</li>\n</ul>\n</li>\n<li>Peer Nodes，负责数据索引，类似ES的Data Node，Peer Node负责\n<ul>\n<li>存储索引数据</li>\n<li>发送／接收复制数据到其他Peer节点</li>\n<li>响应搜索请求</li>\n</ul>\n</li>\n<li>Search Head，负责数据的搜索和客户端API访问，类似ES的Client Node，但不完全相同。Search Head负责发送搜索请求到Peer Nodes，并对搜索的结果进行合并。</li>\n</ul>\n<p>有人会问，那Master是不是集群中的单点故障？What if Master node goes down？Splunk的回答是否。即使Master 节点出现故障，Peer Nodes仍然可以正常工作，除非，同时有Peer Node出现故障。</p>\n<ul>\n<li><a href=\"http://docs.splunk.com/Documentation/Splunk/6.6.1/Indexer/Whathappenswhenamasternodegoesdown\" rel=\"nofollow\">http://docs.splunk.com/Documentation/Splunk/6.6.1/Indexer/Whathappenswhenamasternodegoesdown</a></li>\n<li><a href=\"https://answers.splunk.com/answers/129446/why-does-master-node-continue-to-be-single-point-of-failure-in-clustering.html\" rel=\"nofollow\">https://answers.splunk.com/answers/129446/why-does-master-node-continue-to-be-single-point-of-failure-in-clustering.html</a></li>\n</ul>\n<p>Splunk <a href=\"http://docs.splunk.com/Documentation/Splunk/6.6.1/DistSearch/SHCarchitecture%C2%A0\" rel=\"nofollow\">Search Header 集群</a></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/121621_KPDw_1450051.png\" width=\"646\" height=\"408\"></p>\n<p>Search Head集群是由一组Search Head组成，它们共享配置，搜索任务等状态。该Cluster主要有以下角色：</p>\n<ul>\n<li>Deployer， 负责分发状态和应用到peers</li>\n<li>Cluster Member，其中有一个是Captain，负责协调。Cluster Memeber之间会互相通信，来保证状态一致。Load Balancer是个可选项，可以负责Search的接入。</li>\n<li>Search Peers，负责数据索引的 Indexer Nodes</li>\n</ul>\n<p>另外Splunk还曾经提供过一个功能叫做<a href=\"http://docs.splunk.com/Documentation/Splunk/6.6.1/DistSearch/Configuresearchheadpooling\" rel=\"nofollow\">Search Head Pooling</a>，不过现在已经Depecated了。</p>\n<p>Indexer集群可以和Search Head集群一起配置，构成一个分布式的Splunk配置。</p>\n<p>相比较ES的相对比较简单的集群配置，Splunk的集群配置比较复杂，ES中所有每一个节点可以灵活的配置角色，并且可以相对比较容易的扩展，利用例如Kubernetes的Pod的复制可以很容易的扩展每一个角色。扩展Splunk相对比较困难，要做到动态的伸缩，需要比较复杂的配置。大家可以参考<a href=\"https://github.com/outcoldman/docker-splunk-cluster\" rel=\"nofollow\">这里</a>，在容器环境里配置一个Splunk的集群需要比较多的布置，例如在这个<a href=\"https://github.com/outcoldman/docker-splunk-cluster/blob/master/examples/docker/cluster-master.env_file\" rel=\"nofollow\">Master的配置</a>中，用户需要考虑：</p>\n<ul>\n<li>如何配置License</li>\n<li>修改缺省的用户名口令</li>\n<li>为每一个Search Head配置Search Head Cluster</li>\n<li>等待Splunk进程成功启动</li>\n<li>配置业务发现</li>\n<li>安装应用</li>\n<li>… …</li>\n</ul>\n<p>并且集群的扩展很难直接利用容器编排平台提供的扩展接口，这一点Splunk还有很多提高的空间。</p>\n<h2 id=\"h2_11\">产品线</h2>\n<p><strong>Elastic</strong></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/103316_ysvG_1450051.png\" width=\"859\" height=\"436\"></p>\n<p>Elastic的产品线除了大家熟悉的ELK（ElasticSearch，Logstash，Kikana），主要包含</p>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/beats/libbeat/current/index.html\" rel=\"nofollow\">Beats</a> Beats是一个开源组件，提供一个代理，把本地抓到的数据传送到ElasticSearch</li>\n<li><a href=\"https://www.elastic.co/guide/en/cloud/current/index.html\" rel=\"nofollow\">Elastic Cloud</a>， Elasti提供的云服务</li>\n<li><a href=\"https://www.elastic.co/guide/en/x-pack/current/index.html\" rel=\"nofollow\">X-Pack</a>， Elastic的扩展组件，提供安全，告警，监控，机器学习和图处理能力。主要功能需要付费使用。</li>\n</ul>\n<p><strong>Splunk</strong></p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/103236_KuNa_1450051.png\" width=\"1742\" height=\"756\"></p>\n<p>Splunk的产品线包括</p>\n<ul>\n<li>Splunk Enterprise</li>\n<li>Splunk Cloud， Splunk运营的云服务，跑在AWS上</li>\n<li>Splunk Light，Splunk Light版本，功能有所精简，面向中小企业</li>\n<li>Hunk， Splunk on Hadoop</li>\n<li>Apps ／ Add-ons,  Splunk提供大量的应用和数据获取的扩展，可以参考 <a href=\"http://apps.splunk.com/\" rel=\"nofollow\">http://apps.splunk.com/</a></li>\n<li>Splunk ITSI （IT Service Intelligence）， Splunk为IT运维专门开发的产品</li>\n<li>Splunk ES （Enterprise Security）， Splunk为企业安全开发的产品，这个是Splunk 公司的拳头产品，连续被<a href=\"http://www.gartner.com/it-glossary/security-information-and-event-management-siem/\" rel=\"nofollow\">Gartner</a>评为<a href=\"https://en.wikipedia.org/wiki/Security_information_and_event_management\" rel=\"nofollow\">SIEM</a>领域的领导者，挑战了该行业的传统巨鳄IBM，HP</li>\n<li>Splunk UBA （User Behavior Analytic）， UBA是Splunk在15年<a href=\"https://www.splunk.com/en_us/investor-relations/acquisitions/caspida.html\" rel=\"nofollow\">收购的Caspidia</a>带来的基于机器学习的安全产品。</li>\n</ul>\n<p>从产品线的角度来看，Splunk除了提供基本平台，在IT运维和安全领域都有自己的拳头产品。Elastic缺乏某个领域的应用。</p>\n<h2 id=\"h2_12\">价格</h2>\n<p>价格是大家非常关心的一个因素</p>\n<p>Elastic的基本组件都是开源的，参看<a href=\"https://www.elastic.co/cloud/as-a-service/subscriptions\" rel=\"nofollow\">下表</a>，X-pack中的一些高级功能需要付费使用。包含安全，多集群，报表，监控等等。</p>\n<p><a href=\"https://www.elastic.co/subscriptions#request-info\" rel=\"nofollow\"><img src=\"https://static.oschina.net/uploads/space/2017/0614/112815_X1nv_1450051.png\" width=\"879\" height=\"656\"></a></p>\n<p>云服务的<a href=\"https://www.elastic.co/cloud/as-a-service/pricing\" rel=\"nofollow\">价格</a>参考下图，ES的云是按照所使用的资源来收费，从这里选取的区域可以看出，ES的云也是运行在AWS上的。下图中的配置每月需要花费200美元左右。（不同区域的收费不同）</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/122208_0lhg_1450051.png\" width=\"1235\" height=\"838\"></p>\n<p>同时，除了Elastic自己，还有许多其他公司也提供Elastic Search的云服务，例如Bonsai，Qbox.io等。</p>\n<p><a href=\"https://www.slant.co/topics/170/~best-hosted-elasticsearch-services\" rel=\"nofollow\"><img src=\"https://static.oschina.net/uploads/space/2017/0614/122320_NH3b_1450051.png\" width=\"599\" height=\"715\"></a></p>\n<p><strong>Splunk</strong></p>\n<p>Splunk Enterprise是按照数据每日的流量按年或者无限制事件付费，每天1GB的话，每年是2700美元，每个月也是差不多200块。如果每天的数据量少于500M，可以使用Splunk提供的免费License，只是不能用安全，分布式等高级功能，500M可以做很多事情了。</p>\n<p><a href=\"https://www.splunk.com/en_us/products/pricing.html\" rel=\"nofollow\"><img src=\"https://static.oschina.net/uploads/space/2017/0614/112050_q0Dx_1450051.png\" width=\"1169\" height=\"568\"></a></p>\n<p>云服务的价格就要便宜多了，每天5GB，每年只要2430元，每个月不到200块。当然因为计费的方式不同，和Elastic的云就不好比较了。另外因为是在AWS上，中国的用户，呵呵了。</p>\n<p><img src=\"https://static.oschina.net/uploads/space/2017/0614/121744_0ol0_1450051.png\" width=\"1168\" height=\"541\"></p>\n<h2 id=\"h2_13\">总结</h2>\n<p>大数据的搜索平台已经成为了众多企业的标配，Elastic栈和Splunk是其中最为优秀和流行的选择。两者都有各自的优点和值得改进的地方。希望本文能够在你的大数据平台的选型上，有所帮助。也希望大家来和我交流，共同成长。</p>\n<h2 id=\"h2_14\">参考文档</h2>\n<p>ELK</p>\n<ul>\n<li>ElasticSearch 参考文档<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html\" rel=\"nofollow\">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a></li>\n<li>Github上收集的ElasticSearch相关开源软件列表 <a href=\"https://github.com/dzharii/awesome-elasticsearch\" rel=\"nofollow\">https://github.com/dzharii/awesome-elasticsearch</a></li>\n<li>知乎ElaticSearch专题 <a href=\"https://www.zhihu.com/topic/19899427/hot\" rel=\"nofollow\">https://www.zhihu.com/topic/19899427/hot</a></li>\n<li>中文书 <a href=\"https://github.com/chenryn/ELKstack-guide-cn\" rel=\"nofollow\">https://github.com/chenryn/ELKstack-guide-cn</a></li>\n<li>中文书 <a href=\"https://www.gitbook.com/book/wizardforcel/mastering-elasticsearch/details\" rel=\"nofollow\">https://www.gitbook.com/book/wizardforcel/mastering-elasticsearch/details</a></li>\n</ul>\n<p>Splunk</p>\n<ul>\n<li>Splunk 文档 <a href=\"https://docs.splunk.com/Documentation\" rel=\"nofollow\">https://docs.splunk.com/Documentation</a></li>\n<li>Splunk电子书 <a href=\"https://www.splunk.com/web_assets/v5/book/Exploring_Splunk.pdf\" rel=\"nofollow\">https://www.splunk.com/web_assets/v5/book/Exploring_Splunk.pdf</a></li>\n<li>Splunk 开发文档 <a href=\"http://dev.splunk.com/getstarted\" rel=\"nofollow\">http://dev.splunk.com/getstarted</a></li>\n<li>Splunk 应用市场 <a href=\"http://apps.splunk.com/\" rel=\"nofollow\">http://apps.splunk.com/</a></li>\n<li>Splunk 快速参考 <a href=\"https://www.splunk.com/content/dam/splunk2/pdfs/solution-guides/splunk-quick-reference-guide.pdf\" rel=\"nofollow\">https://www.splunk.com/content/dam/splunk2/pdfs/solution-guides/splunk-quick-reference-guide.pdf</a></li>\n</ul>\n<p>其它</p>\n<ul>\n<li><a href=\"https://www.upguard.com/articles/splunk-vs-elk\" rel=\"nofollow\">https://www.upguard.com/articles/splunk-vs-elk</a></li>\n<li><a href=\"https://db-engines.com/en/system/Elasticsearch%3BSplunk\" rel=\"nofollow\">https://db-engines.com/en/system/Elasticsearch%3BSplunk</a></li>\n<li><a href=\"https://www.searchtechnologies.com/blog/log-analytics-tools-open-source-vs-commercial\" rel=\"nofollow\">https://www.searchtechnologies.com/blog/log-analytics-tools-open-source-vs-commercial</a></li>\n<li><a href=\"http://www.learnsplunk.com/splunk-vs-elk-stack.html\" rel=\"nofollow\">http://www.learnsplunk.com/splunk-vs-elk-stack.html</a></li>\n</ul>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111525\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111525votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111525\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'https://static.oschina.net/uploads/space/2017/0614/102156_SGGq_1450051.png', 'full/e81f66bb819f021a1b7b51d3573617097a9d860d.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('实现前后端分离的心得', '2017-07-07', 'http://blog.jobbole.com/111624/', '83036acfe38763334b3abfe88bc409c1', 5, 1, 'IT技术, 前端, 后端', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/chenjg/p/6992062.htm\">陈陈jg</a>   </div><div id=\"cnblogs_post_body\">\n<h1 id=\"实现前后端分离的心得\">实现前后端分离的心得</h1>\n<p>对目前的web来说，前后端分离已经变得越来越流行了，越来越多的企业/网站都开始往这个方向靠拢。那么，为什么要选择前后端分离呢？前后端分离对实际开发有什么好处呢?</p>\n<h2 id=\"为什么选择前后端分离\"><strong>为什么选择前后端分离</strong></h2>\n<ul>\n<li><strong>在以前传统的网站开发中，前端一般扮演的只是切图的工作，只是简单地将UI设计师提供的原型图实现成静态的HTML页面，而具体的页面交互逻辑，比如与后台的数据交互工作等，可能都是由后台的开发人员来实现的，或者是前端是紧紧的耦合后台。比如，以前淘宝的Web基本上都是基于MVC框架webx，架构决定了前端只能依赖后端。所以他们的开发模式依然是，前端写好静态demo，后端翻译成VM模版，这种模式的问题就不说了，被吐槽了很久。</strong></li>\n<li><strong>而且更有可能后台人员直接兼顾前端的工作，一边实现API接口，一边开发页面，两者互相切换着做，而且根据不同的url动态拼接页面，这也导致后台的开发压力大大增加。前后端工作分配不均。不仅仅开发效率慢，而且代码难以维护。而前后端分离的话，则可以很好的解决前后端分工不均的问题，将更多的交互逻辑分配给前端来处理，而后端则可以专注于其本职工作，比如提供API接口，进行权限控制以及进行运算工作。而前端开发人员则可以利用nodejs来搭建自己的本地服务器，直接在本地开发，然后通过一些插件来将api请求转发到后台，这样就可以完全模拟线上的场景，并且与后台解耦。前端可以独立完成与用户交互的整一个过程，两者都可以同时开工，不互相依赖，开发效率更快，而且分工比较均衡。</strong></li>\n</ul>\n<h2 id=\"如何做到前后端分离\"><strong>如何做到前后端分离</strong></h2>\n<p>(以下的内容都是基于我们的电影购票网站来讨论的)<br>\n前端的技术框架是: vue全家桶+nodejs+express(实现的是单页面(SPA)应用)<br>\n首先，先分清楚前后端的工作</p>\n<ul>\n<li>前端的工作：实现整一个前端页面以及交互逻辑，以及利用ajax与nodejs服务器（中间层)交互</li>\n<li>后端的工作：提供API接口，利用redis来管理session,与数据库交互</li>\n</ul>\n<p>我们项目的整一个架构如下:</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/67e8579ee2214313c2b2984471596e35.png\" alt=\"这里写图片描述\"></p>\n<p><strong>接下来进入正题，如何实现前后端分离</strong></p>\n<ol>\n<li>一般来说，要实现前后端分离，前端就需要开启一个本地的服务器来运行自己的前端代码，以此来模拟真实的线上环境，并且，也是为了更好的开发。因为你在实际开发中，你不可能要求每一个前端都去搭建一个java(php)环境，并且在java环境下开发，这对于前端来说，学习成本太高了。但如果本地没有开启服务器的话，不仅无法模拟线上的环境，而且还面临到了跨域的问题，因为你如果写静态的html页面，直接在文件目录下打开的话，你是无法发出ajax请求的(浏览器跨域的限制),因此，你需要在本地运行一个服务器，可是又不想搭建陌生而庞大的java环境，怎么办法呢？nodejs正好解决了这个问题。在我们项目中，我们利用nodejs的express框架来开启一个本地的服务器，然后利用nodejs的一个http-proxy-middleware插件将客户端发往nodejs的请求转发给真正的服务器，让nodejs作为一个中间层。这样，前端就可以无忧无虑的开发了</li>\n<li>由于前后端分离后，前端和后台同时开发时，就可能遇到前端已经开发好一个页面了，可是却等待后台API接口的情况。比如说A是负责前端，B是负责后台，A可能用了一周做好了基本的结构，并且需要API接口联调后，才能继续开发，而此时B却还没有实现好所需要的接口，这种情况，怎么办呢？在我们这个项目里，我们是通过了mock来提供一些假数据，我们先规定好了API接口，设计出了一套API文档，然后我们就可以通过API文档，利用mock(<a>http://mockjs.com)来返回一些假数据，这样就可以模拟发送API到接受响应的整一个过程，因此前端也不需要依赖于后端开发了，可以独立开发，等到后台的API全部设计完之后，就可以比较快速的联调</a>。</li>\n</ol>\n<h2 id=\"为什么要引入nodejs作为中间层\"><strong>为什么要引入nodejs作为中间层</strong></h2>\n<p>前面的我发的项目结构图中，已经表明，在这个项目里，我们将nodejs作为中间层，那么，为什么我们要特地引入nodejs呢？直接用java做不就行了吗？</p>\n<ul>\n<li>我觉得引入nodejs主要是为了分层开发，职责划分，nodejs作为前端服务器，由前端开发人员负责，前端开发人员不需要知道java后台是如何实现的，也不需要知道API接口是如何实现的，我们只需要关心我们前端的开发工作，并且管理好nodejs前端服务器，而后台开发人员也不需要考虑如何前端是如何部署的，他只需要做好自己擅长的部分，提供好API接口就可以；</li>\n<li>nodejs本身有着独特的异步、非阻塞I/O的特点，这也就意味着他特别适合I/O密集型操作，在处理并发量比较大的请求上能力比较强，因此，利用它来充当前端服务器，向客户端提供静态文件以及响应客户端的请求，我觉得这是一个很不错的选择。</li>\n</ul>\n<h2 id=\"前端服务器如何部署\"><strong>前端服务器如何部署</strong></h2>\n<p><strong>nodejs前端服务器的职责</strong></p>\n<ol>\n<li>作为静态文件服务器，当用户访问网站的时候，将index.html以及其引入的js、css、fonts以及图片返回给用户</li>\n<li>负责将客户端发来的ajax请求转发给后台服务器</li>\n</ol>\n<p><strong>其实前端服务器的部署工作是算比较简单的，具体有以下两个点:</strong></p>\n<ol>\n<li>将开发完的前端代码，利用webpack打包成静态压缩文件</li>\n<li>在服务器上，利用pm2负载均衡器来执行以下的代码来开启服务器:</li>\n</ol>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e6da864d4af726f47beb4100fbf5bbff.png\"></p>\n<p>评论区有人提到有一个不错的文章，我看了下觉得写得确实很详细，大家也可能看一下:<a href=\"https://segmentfault.com/a/1190000009329474?_ea=2038402\">https://segmentfault.com/a/1190000009329474?_ea=2038402</a> (感觉这就是业务与专业的区别哈哈)<br>\n(PS:其实也有一个做法，就是用nginx来做反向代理，负责转发请求，根据客户端访问的url把这个请求转发到不同的服务，比如访问/api/*的请求，就转发到后台服务，访问其它的请求，就转发到nodejs服务)<br>\n以上，就是我对于前后端分离的一些看法，以及一些实践，如果大家有什么好的想法，欢迎交流。</p>\n<p>本次项目代码的地址为:<a href=\"https://github.com/chenjigeng/filmshopping\">https://github.com/chenjigeng/filmshopping</a></p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111624\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111624votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111624\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 5 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/67e8579ee2214313c2b2984471596e35.png', 'full/cb6856e79b5025e46c895464e60a86e2f6c4e811.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('能当主力，能入虚拟机，还能随时打包带走，Linux 就是这么强大', '2017-07-07', 'http://blog.jobbole.com/111672/', '851c8144fffb89af1d9613091b149fa9', 1, 1, 'IT技术, Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/\">zasdfgbnm</a>   </div><p>这里介绍一下自己管理自己的Linux桌面的一点经验吧，我觉得还是有不少可取之处的。先来说一下大多数人管理Linux桌面的方法有哪些不方便的地方吧：</p>\n<ul>\n<li>买新电脑了，又得在新电脑上安装Linux，安装各种软件，各种库，各种开发环境，配置各种服务，真麻烦。</li>\n<li>最近一直在用电脑A，干了好多事情安装了好多软件，也配置了不少开发环境跟各种服务，然而处于某种原因，我又要开始使用好久没用过的电脑B了，难道我要把在A上的做的各种配置在B上再重新做一遍？</li>\n<li>在Windows下做着PPT呢，发现需要调出自己之前的程序，然后根据若干组输入跑几个结果画张图好插到PPT里，然而这个程序是在Linux下写的，编译等的过程也严重依赖自己用的Linux环境，重启进Linux拿到结果再回Windows太不方便，想在Windows下配置好环境把自己的程序跑通更不容易。</li>\n<li>要对系统安装某个软件，或者进行一些比较危险的更新操作（要知道Archlinux滚动更新滚挂了太正常了），担心把系统搞挂了，系统备份又实在太麻烦，要真挂了，系统恢复起来更麻烦。</li>\n<li>我一直用Archlinux做主力，然而最近做的某件事情要用某个软件，这个软件官方只给了Ubuntu上的安装方式，Archlinux里面没有相应的包，在Archlinux上手动安装也太不方便。装个Ubuntu，然后暂时用几天Ubuntu吧，也是够折腾的。更何况有时候只是想用一小下而已，怎样才能最小化自己在折腾上浪费的时间呢？</li>\n<li>有的软件官方软件仓库里面没有，而<code>make install</code>的话则会在系统中安装上不被包管理器所管理的文件，将来卸载也不方便，我还是更希望所有的文件都在一个包管理器中管理的。</li>\n<li>听说新版本内核引入了某个牛逼的东西？我就想快速测试一下玩玩，我电脑还有计算在跑着呢，我可不想重启，那就只能用虚拟机尝试了。而且，一定要快速，我可不想为此特地装一个虚拟机。</li>\n</ul>\n<p>上述的这些不方便之处是可以通过自己管理系统时的一些技巧来克服的，本文目的就是来介绍一下这些技巧。通过这些技巧，我们实现的功能是：一台机器上，可以同时安装Windows跟若干Linux系统，Windows下可以通过虚拟机来运行位于本地磁盘的这些Linux系统，而这些Linux系统下也可以通过容器或者虚拟机的方式互相运行。并且这些系统可以非常方便地备份跟删除，也可以随时创建以及运行快照。并且这些Linux系统可以随时打包带走，只需要经过很少的修改，就能直接在U盘或者其他机器上运行。如果要换电脑，或者新装一台电脑，也不需要重新安装系统，只需要把已有的系统同步到新电脑就行。这也正是这篇文章标题的意思。</p>\n<p>为了行文的方便，我们假定读者有一台全新的机器，硬盘还没分区，也还没装任何系统。如果已经什么都装好了，而只是想迁移到我这种管理方式的话，我相信读者能够判断这个安装教程中哪些步骤是需要做的哪些步骤是不需要做的。 另外需要注意的是这不是一个手把手的一步一步的教程，中间有一些显然的步骤我就略去不写了，所以希望读者不要照着文章里的的命令不加思考地一条一条粘贴运行，而是要搞明白这些命令的目的是什么，然后根据你自己的情况来做相应的修改。</p>\n<h3 id=\"分区与子卷\">分区与子卷</h3>\n<p>具体怎么分区我就不说了，随便找个livecd启动进去，然后找到你自己最喜欢的分区程序，按照你的喜好把区分了就好。注意别忘了EFI分区。我这里需要说的是，分区的时候，不论有多少个发行版要安装，总共只给Linux划分两个分区：一个是swap，另一个则是一个大的btrfs分区。那个btrfs分区里面装着所有的文件，包括用户的个人数据，以及所有发行版的rootfs。这两个分区在格式化的时候，一定要给他们取Label，这么做的好处接下来我们很快就会看到。我的习惯是，swap分区的Label我就叫他“swap”，而那个btrfs分区我则叫他“linux”。创建好分区以后，如果格式化工作是在图形的分区管理程序下完成的，那么指定Label是个非常简单的工作，右键属性里面就有。如果是使用命令行工具格式化分区的，则可以使用<code>-L label</code>选项来指定label，比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac13847141676\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmkswap -L swap /dev/sdb4\r\nmkfs.btrfs -L linux /dev/nvme0n1p4</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac13847141676-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac13847141676-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac13847141676-1\"><span class=\"crayon-v\">mkswap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">L</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">swap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">sdb4</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac13847141676-2\"><span class=\"crayon-v\">mkfs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">btrfs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">L</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">nvme0n1p4</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>那个大的btrfs分区上的不同内容是通过btrfs的子卷来管理的，具体来讲就是为自己想安装的每个不同的Linux系统来创建一个单独的子卷。 比如说我电脑上同时安装了Archlinux、Ubuntu、Kali、Debian四个系统，那么的btrfs分区里面就有四个子卷：archlinux、ubuntu、kali、debian。 子卷的创建可以通过<code>btrfs subvolume create &lt;name&gt;</code>命令完成，比如说要创建我这五个子卷，需要做的事情就是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac26711852960\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmount /dev/disk/by-label/linux /mnt\r\ncd /mnt\r\nbtrfs subvolume create archlinux\r\nbtrfs subvolume create ubuntu\r\nbtrfs subvolume create kali\r\nbtrfs subvolume create debian</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac26711852960-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac26711852960-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac26711852960-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac26711852960-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac26711852960-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac26711852960-6\">6</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac26711852960-1\"><span class=\"crayon-v\">mount</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac26711852960-2\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac26711852960-3\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">archlinux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac26711852960-4\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">ubuntu</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac26711852960-5\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">kali</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac26711852960-6\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">create </span><span class=\"crayon-v\">debian</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>如果你只想装一个发行版，比如archlinux，那么只需要archlinux子卷就够了。另外，如果你想把用户数据单独放在一个子卷里，也是完全可以的，不过这里不推荐多个Linux系统共享同一个家目录，因为不同系统上安装的软件不同，同样的软件版本也不相同，即使版本相同，不同发行版也可能应用了不同的patch，这就导致在一个系统上用户家目录里面产生的配置文件，在另一个系统里无法兼容，产生奇怪的行为。</p>\n<h3 id=\"系统安装\">系统安装</h3>\n<p>创建好分区与子卷，下一步就是安装操作系统了。这里分两种情况来讲：第一种情况是你想要全新安装一个Linux操作系统；第二种情况则是你已经有了某个可用的操作系统了，而只是想把这个操作系统迁移到文章所说的管理方式上。</p>\n<h4 id=\"全新安装\">全新安装</h4>\n<p>如果想要全新安装一个操作系统，安装方式上，作者只推荐纯手工安装，而不是用官方给的安装光盘不断点着“下一步”来进行安装。这么做是为了防止官方安装程序做一些我们不想让他做的事情，比如说自动安装grub。对于Archlinux跟Gentoo来讲，唯一的安装方法就是纯手工安装，所以只要按照官方的教程来就好了。对于deb系的系统，可以使用debootstrap程序。对于其他的发行版，可能会找不到手工安装的教程，这时候可以新建一个虚拟机，在虚拟机中使用官方的安装程序不断点击“下一步”来完成安装，然后按照下一节即将介绍的现有系统迁移教程把系统从虚拟机中迁移到现实机器上；除此之外，读者还可以找到发行版官方提供的安装程序的源代码阅读一下，看明白这些安装程序都在干啥，就知道怎么手工安装了，安装程序的代码还是相对简单的，有时间的读者不妨尝试一下。下面来具体说一下安装过程，这里只介绍Archlinux跟deb系。如果有多个Linux系统需要安装，建议先安装并完全配置好其中一个，让这个系统处于可用并且方便使用的状态，然后再在这个可用的系统中安装其他系统。这里我们假设读者已经完成了分区，创建了对应的子卷，并且把那个btrfs分区挂载在了<code>/mnt</code>上。</p>\n<h5 id=\"Archlinux的手动安装\">Archlinux的手动安装</h5>\n<p>Archlinux的手动安装主要还是看<a href=\"https://wiki.archlinux.org/index.php/Installation_guide\" target=\"_blank\" rel=\"external\">官方教程</a>。分区的时候注意按照上文介绍的方法。非常关键的<code>pacstrap</code>那一步注意使用如下命令安装到子卷里，而不是整个btrfs分区中:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac30326238301\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npacstrap -d /mnt/archlinux base</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac30326238301-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac30326238301-1\"><span class=\"crayon-v\">pacstrap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">d</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">archlinux </span><span class=\"crayon-v\">base</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>至于fstab，就不要使用教程中的方法来生成了，我们的管理方式比较非常规，还是自己写fstab比较好。bootloader也要按照本文下文说的方式来安装跟配置。至于其他的设置键盘、设置网络、设置时区等操作，照着教程来就行。</p>\n<h5 id=\"deb系的手动安装\">deb系的手动安装</h5>\n<p>deb系的系统网上找到的教程都是使用发行版自带的安装程序的教程，并没有像Archlinux那么详细的手动安装教程。因为我们想要手动安装，所以我们就不参照网上的deb系的安装教程了。但是我们还是有教程可以参照的，那就是Archlinux的wiki里面<a href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn#Create_a_Debian_or_Ubuntu_environment\" target=\"_blank\" rel=\"external\">关于systemd-nspawn的教程</a>，这个教程里面有一节介绍如何使用debootstrap安装Debian或者Ubuntu。具体安装过程请参照上述教程，其中关键命令如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac39678785599\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndebootstrap --arch amd64 zesty /mnt/ubuntu http://archive.ubuntu.com/ubuntu/</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac39678785599-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac39678785599-1\"><span class=\"crayon-v\">debootstrap</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">arch </span><span class=\"crayon-e\">amd64 </span><span class=\"crayon-v\">zesty</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//archive.ubuntu.com/ubuntu/</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>值得一提的是，我们安装deb系的发行版并不一定要使用deb系的livecd，任何能够安装debootstrap程序的livecd都是可以的。比如说我们完全可以使用Archlinux的livecd来启动，然后安装debootstrap并通过debootstrap来安装Ubuntu。</p>\n<p>注意的是，debootstrap并不会像官方安装程序那样安装一个完整齐全开袋即食的操作系统，而只是安装最基本的软件包，读者需要根据自己的情况单独安装桌面环境等的软件包。同时fstab跟bootloader也要根据本文的方法自己配置。</p>\n<h4 id=\"现有系统迁移\">现有系统迁移</h4>\n<p>Linux系统的迁移其实非常简单，无非就是把rootfs的文件全都拷贝到目的地即可。不过这个过程虽然看似简单，但是还是有一些需要注意的东西的。比如说对于符号链接，如果处理不当，则会不小心把符号链接搞成实体文件，这就不好了。再比如说，文件的权限等元数据的问题，如果处理不当，可能会导致拷贝过程中元数据的丢失。这两种问题，都有可能会导致系统不能正常运行。还有一个需要注意的地方就是，正常运行的操作系统里，会有/proc、/dev等目录，这些目录都是单独的虚拟文件系统，是不需要拷贝的，也是无法拷贝的。</p>\n<p>我们现在假设用户想要把位于A的Ubuntu系统迁移到目标子卷<code>/mnt/ubuntu</code>去。其中，A可能位于虚拟机中，可能位于另一台电脑上，也可能位于本地磁盘。对系统进行迁移，大方向上来讲，需要做的有两步：</p>\n<ol>\n<li>挂载相应分区，设置ssh，保证我们能够访问到A。</li>\n<li>使用<code>rsync</code>或者<code>btrfs send</code>命令来把数据从A发送到目标子卷中去。</li>\n</ol>\n<p>第一步具体怎么做就不说了，分三种情况简单几句话概括一下怎么做：</p>\n<ul>\n<li>如果只是一个分区的话，mount就可以了</li>\n<li>如果是另一台机器，把那台机器配置好ssh，保证root用户可以用ssh访问</li>\n<li>如果是虚拟机，有两种选择，一种是想办法挂载虚拟机的磁盘镜像，然后像情况1那样处理；另一种则是配置好网络跟ssh，像情况2那样处理。具体采取哪种措施请读者根据自己的情况来自行决定。</li>\n</ul>\n<p>第二步我们来分别介绍<code>rsync</code>跟<code>btrfs send</code>两种方法。</p>\n<p><code>rsync</code>的方法<a href=\"https://wiki.archlinux.org/index.php/full_system_backup_with_rsync\" target=\"_blank\" rel=\"external\">这里有教程</a>可以参照。我们现在假设A的ip地址为<code>192.168.88.3</code>。则只需执行如下命令即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac3e580307217\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nrsync -aAXv --exclude={\"/dev/*\",\"/proc/*\",\"/sys/*\",\"/tmp/*\",\"/run/*\",\"/mnt/*\",\"/media/*\",\"/lost+found\"} root@192.168.88.3:/ /mnt/ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac3e580307217-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac3e580307217-1\"><span class=\"crayon-v\">rsync</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">aAXv</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">exclude</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">\"/dev/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/proc/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/sys/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/tmp/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/run/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/mnt/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/media/*\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\"/lost+found\"</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">192.168.88.3</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>这里提醒读者注意自己系统上是否还有其他不想要同步的文件，记得一并排除掉。</p>\n<p><code>btrfs send</code>只在A的rootfs也是btrfs的情况下才能使用。<a href=\"https://btrfs.wiki.kernel.org/index.php/Incremental_Backup\" target=\"_blank\" rel=\"external\">这个方法的教程参见这里</a>。首先需要做的是在A机器上给rootfs创建一个只读快照（注意下面命令是在A机器上执行的）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac44822496740\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume snapshot -r / /ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac44822496740-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac44822496740-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">snapshot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">r</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>注意上面命令中快照的名字要和目标子卷的名字相同，这样可以省去将来改名的麻烦。然后就可以使用<code>btrfs send</code>命令来把快照/ubuntu中的内容发送到目的地了，在这之前我们需要暂时删除我们分区的时候创建的ubuntu子卷，这个子卷会在接收过程中自动重新创建：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac48249957168\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume delete /mnt/ubuntu\r\nssh root@192.168.88.3 btrfs send /ubuntu | btrfs receive /mnt</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac48249957168-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac48249957168-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac48249957168-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac48249957168-2\"><span class=\"crayon-e\">ssh </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-cn\">192.168.88.3</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">btrfs </span><span class=\"crayon-v\">send</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">btrfs </span><span class=\"crayon-v\">receive</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>最后在A机器上把刚刚创建的快照删除就可以了</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac4b888900753\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbtrfs subvolume delete /ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac4b888900753-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac4b888900753-1\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-v\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h3 id=\"bootloader与fstab\">bootloader与fstab</h3>\n<p>系统装好了，我们的fstab还没设置，启动管理器也还没安装配置。下面来讲讲怎么配置这两样东西。我们之前说过一定要给分区取一个Label，玄机在这里。如何在虚拟机中直接运行本地磁盘上安装的Linux，以及如何能把一个系统直接进行打包带走而不需要更改太多配置，关键也在这里。</p>\n<h4 id=\"fstab\">fstab</h4>\n<p>先来说说fstab，fstab总共有五列，分别为fs、mountpoint、type、opts跟dump/pass。这五列分别为什么意思、以及fstab该怎么填，网上一查便知，在此不再赘述。这里只说我们需要做的跟常规不一样的地方。</p>\n<p>第一个要注意的事情是，大家在填写fstab的时候，通常喜欢在fs那一列填写类似<code>/dev/sda4</code>或者<code>UUID=d5acc217-d524-4a2d-a937-bad945a047b2</code>，而在这里这样是不行的，这里我们填写的是形如<code>/dev/disk/by-label/linux</code>这样的东西。也就是说，我们的fstab里面是通过分区的Label来找分区的。这么做的原因是，我们希望我们的rootfs不光能在这台机器上启动，还希望它能在虚拟机的环境中，或者当我们把rootfs打包带走同步到别的机器上的时候，也能正常启动。在这台机器上rootfs所在的分区叫做<code>/dev/sda4</code>，在别的机器上或者虚拟机里就不一定还叫<code>/dev/sda4</code>了。但是我们只要遵守自己的命名规则，所有机器上的这些分区我们都取相同的Label，那么我们的fstab就是放之四海而皆准的，不需要为不同的环境而更改。</p>\n<p>第二个需要注意的问题是，不要填写rootfs的条目。这种做法跟通常发行版或者其他用户的默认做法是非常不相同的。为了理解这一点，先来说说Linux系统的启动过程。通常情况下，Linux启动的时候，首先由bootloader把内核装载到内存，并向内核传递参数告诉内核rootfs的位置。接下来内核就会根据传递的参数，以只读方式挂载rootfs，并执行rootfs中的init程序。init程序会调用相应的初始化程序执行各种初始化操作。其中一项初始化操作就是根据fstab的配置，来重新以读写方式挂载rootfs，并且挂载fstab里面配置的其他各个分区到指定位置。明白了Linux启动的过程，我们就知道，fstab里面的rootfs那一行其实不是必须的。删掉了rootfs那一行，我们只需要通过修改bootloader传递给内核的参数，就可以告诉内核直接以读写而不是只读的方式挂载rootfs。</p>\n<p>那么，我们在写fstab的时候不写rootfs那一项有啥好处呢？好处就是，我们不仅希望我们的系统能在裸机上用，还希望我们的系统能在虚拟机上用。在下文设置qemu虚拟机的时候，我们会以virtfs的方式把我们的子卷传递给虚拟机，这个时候rootfs就已经不再是<code>/dev/disk/by-label/linux</code>了，如果我们把rootfs的挂载方式硬编码到fstab里面，那么会导致init程序的失败，进而无法启动。</p>\n<p>另外有一点值得一提的小技巧是，很多时候我们还有别的一些个分区想要自动挂载。问题在于，这些分区在虚拟机环境中，并不一定是存在的，这就会导致启动的时候由于无法挂载而启动失败。其实系统的设计者早就考虑到这个问题了。如果你不希望fstab中的某些条目自动挂载，在选项里面增加<code>noauto</code>即可。如果你希望一些条目自动挂载，但是这些条目不是那么重要，即使挂载失败也不希望这些条目导致启动失败，可以在选项中增加<code>nofail</code>。这两个选项真的是给我们的系统管理工作提供了非常大的方便。比如说我们可能会在fstab中增加<code>/dev/disk/by-label/swap</code>的条目，以便开机自动将这个分区设置为交换分区供系统使用。然而后面我们会看到，我们设置虚拟机的时候，这个分区在虚拟机环境下，并不一定是可用的。这种情况下，我们希望系统在找不到这个分区的时候直接忽略错误不用swap便是，而不是报错拒绝启动。</p>\n<p>说了这么多，直接贴一个fstab的例子好了：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac51670545288\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntmpfs                  		/tmp	tmpfs	defaults		0 0\r\n/dev/disk/by-label/swap		none	swap	defaults,nofail		0 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac51670545288-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac51670545288-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac51670545288-1\"><span class=\"crayon-v\">tmpfs</span><span class=\"crayon-h\">                  		</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">tmp	</span><span class=\"crayon-e\">tmpfs	</span><span class=\"crayon-i\">defaults</span><span class=\"crayon-h\">		</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac51670545288-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">swap		</span><span class=\"crayon-e\">none	</span><span class=\"crayon-e\">swap	</span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">nofail</span><span class=\"crayon-h\">		</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<h4 id=\"bootloader\">bootloader</h4>\n<p>再来说说启动管理器，这里作者推荐的启动管理器是refind，<a href=\"http://www.rodsbooks.com/refind/installing.html\" target=\"_blank\" rel=\"external\">安装教程官网有</a>，在此不赘述。这里只讲一下启动项怎么写。先贴示例代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac58121623502\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmenuentry archlinux {\r\n	icon EFI/refind/icons/os_arch.png\r\n	volume linux\r\n	loader archlinux/boot/vmlinuz-linux\r\n	options \"root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw\"\r\n	initrd archlinux/boot/initramfs-linux.img\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac58121623502-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac58121623502-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac58121623502-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac58121623502-7\">7</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-1\"><span class=\"crayon-e\">menuentry</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">archlinux</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac58121623502-2\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">icon </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">refind</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">icons</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">os_arch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">png</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-3\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">volume </span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac58121623502-4\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">archlinux</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-5\"><span class=\"crayon-e\">	</span><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=archlinux rw\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac58121623502-6\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">archlinux</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">linux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">img</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac58121623502-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>其中第三行的volume用来指定内核存放的分区，此分区可以通过多种方式来指定，比如通过分区的GUID，但是对我们来说最重要的是可以通过文件系统的Label来指定。我们的rootfs分区Label是”linux”，所以这一行写作<code>volume linux</code>。</p>\n<p>接下来就是指定内核位置、内核参数跟initramfs的位置了。其中loader用来指定内核位置，options用来指定内核参数，initrd则用来指定initramfs的位置。示例中的是Archlinux系统，内核是archlinux子卷中的<code>boot/vmlinuz-linux</code>文件，所以写作<code>loader archlinux/boot/vmlinuz-linux</code>。类似，initrd那一行则写作<code>initrd archlinux/boot/initramfs-linux.img</code>。至于内核参数，<code>root=/dev/disk/by-label/linux</code>告诉内核我们的rootfs所在的分区，<code>rootflags=subvol=archlinux</code>告诉内核挂载名为archlinux的子卷，<code>rw</code>则告诉内核以读写方式挂载。对于Ubuntu系统，这三行应该写作：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac5c022792631\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nloader ubuntu/vmlinuz\r\noptions \"root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw\"\r\ninitrd ubuntu/initrd.img</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac5c022792631-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac5c022792631-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac5c022792631-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac5c022792631-1\"><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">vmlinuz</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac5c022792631-2\"><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=ubuntu rw\"</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac5c022792631-3\"><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">img</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>细心的读者可能已经发现，我们的refind的配置文件中在指定分区的时候用的全是他们的Label，这就保证了这个配置文件的普适性，换台电脑，只要你用同样的管理方式，同样的命名习惯，配置文件里面的东西动都不用动，直接拷贝过去就行。</p>\n<h3 id=\"系统的备份与恢复以及快照的应用\">系统的备份与恢复以及快照的应用</h3>\n<p>由于使用了btrfs的动态卷，所以备份恢复工作做起来非常简单。备份系统只需要创建快照即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac60624561786\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt\r\nbtrfs subvolume snapshot archlinux backup</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac60624561786-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac60624561786-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac60624561786-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac60624561786-2\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">snapshot </span><span class=\"crayon-e\">archlinux </span><span class=\"crayon-v\">backup</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>至于恢复，其实我们根本不需要恢复，直接把快照作为rootfs用就行。我们只需要去refind的配置文件里面，把相应的启动项改改即可。比如说对于Archlinux而言，只需要改成：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac63058921660\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nmenuentry archlinux {\r\n	icon EFI/refind/icons/os_arch.png\r\n	volume linux\r\n	loader backup/boot/vmlinuz-linux\r\n	options \"root=/dev/disk/by-label/linux rootflags=subvol=backup rw\"\r\n	initrd backup/boot/initramfs-linux.img\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac63058921660-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac63058921660-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac63058921660-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac63058921660-7\">7</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-1\"><span class=\"crayon-e\">menuentry</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">archlinux</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac63058921660-2\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">icon </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">refind</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">icons</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">os_arch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">png</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-3\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">volume </span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac63058921660-4\"><span class=\"crayon-e\">	</span><span class=\"crayon-e\">loader </span><span class=\"crayon-v\">backup</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">linux</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-5\"><span class=\"crayon-e\">	</span><span class=\"crayon-i\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"root=/dev/disk/by-label/linux rootflags=subvol=backup rw\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac63058921660-6\"><span class=\"crayon-h\">	</span><span class=\"crayon-e\">initrd </span><span class=\"crayon-v\">backup</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">boot</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">linux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">img</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac63058921660-7\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>如果有强迫症，觉得rootfs名字不叫archlinux很不爽，那其实改名也很简单:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac66671347660\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt\r\nbtrfs subvolume delete archlinux\r\nbtrfs subvolume snapshot backup archlinux</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac66671347660-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac66671347660-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac66671347660-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac66671347660-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">mnt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac66671347660-2\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">delete </span><span class=\"crayon-e\">archlinux</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac66671347660-3\"><span class=\"crayon-e\">btrfs </span><span class=\"crayon-e\">subvolume </span><span class=\"crayon-e\">snapshot </span><span class=\"crayon-e\">backup </span><span class=\"crayon-v\">archlinux</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>其实，btrfs的快照功能不仅可以用来备份与恢复系统，还有很多非常灵活的运用的。比如说我想在系统里面安装一个巨大而又混乱的软件，这个软件我只想用几天干一件事情，干完这件事情我就不想用了。问题是，这个软件在官方的软件仓库并没有，要安装，我只能使用软件提供的安装程序来安装，然而软件并没有提供卸载程序，或者卸载程序卸载的很不彻底，会在系统残留垃圾。我想用这软件，然而又不想脏了我的系统，这该怎么办？很简单：创建一个快照，新增加一条以快照为rootfs的启动项，要用软件了就启动到快照中去，用完这个软件以后把快照删除即可。再比如说，我想要搞个虚拟机跟实体机一起来测试某个东西（比如说测试某些网络协议、测试某些集群管理软件等），这个时候我根本没必要重新用安装光盘去装一个虚拟机，只需要创建一个快照，然后把快照作为虚拟机的rootfs启动即可，具体方法下文会介绍，在此不多说。当然，快照的应用还远远不止我说的这些，更多好玩的应用还待读者自己探索。</p>\n<h3 id=\"Windows下访问Linux\">Windows下访问Linux</h3>\n<p>从文章的刚开头我们就说，有时候我们是有在Windows下运行本地安装的Linux的需求的。这个需求可以通过VirtualBox来满足，只需要在VirtualBox中使用本地磁盘来作虚拟磁盘即可。说起来简单，但是实现起来还是需要折腾一下子的。</p>\n<p>首先我们需要新建一个虚拟机，具体过程不多说，一路“下一步”就行了，唯一需要注意的是，在创建虚拟磁盘的那一步，选择“不添加虚拟硬盘”：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/virt_hdd.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/virt_hdd.png\" alt=\"virt_hdd.png\"></a></p>\n<p>这里我的虚拟机取名为“Linux”。创建完虚拟机了以后，就需要把本地磁盘设置为虚拟磁盘了。VirtualBox只能通过命令来做这件事情，<a href=\"http://www.serverwatch.com/server-tutorials/using-a-physical-hard-drive-with-a-virtualbox-vm.html\" target=\"_blank\" rel=\"external\">教程可以在这里找到</a>。首先要做的是寻找我们安装Linux的磁盘的编号，这个可以在系统自带的磁盘管理程序中找到，在我的机器上这个磁盘编号为2：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/dskmgr.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/dskmgr.png\" alt=\"dskmgr.png\"></a><br>\n知道了磁盘的编号，就可以创建虚拟盘了。这里我们使用的命令如下，注意使用管理员身份运行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac6c326003714\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nVBoxManage internalcommands createrawvmdk -filename \"C:\\Users\\gaoxiang\\VirtualBox VMs\\Linux\\localdisk.vmdk\" -rawdisk \\\\.\\PhysicalDrive2</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac6c326003714-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac6c326003714-1\"><span class=\"crayon-e\">VBoxManage </span><span class=\"crayon-e\">internalcommands </span><span class=\"crayon-v\">createrawvmdk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">filename</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"C:\\Users\\gaoxiang\\VirtualBox VMs\\Linux\\localdisk.vmdk\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">rawdisk</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">PhysicalDrive2</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>有了虚拟磁盘了，就可以将虚拟磁盘添加到虚拟机中去了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/newdisk.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/newdisk.png\" alt=\"newdisk.png\"></a></p>\n<p>虚拟磁盘设置好了，最后一步就是设置EFI了。由于我们之前在分区的时候给文件系统都赋予了Label，并且在refind设置的时候也是用的Label来指定分区，所以同一套refind的配置在虚拟机上也能用。因此我们不需要单独给虚拟机安装bootloader，而是直接用我们之前安装在物理磁盘上的EFI分区中的refind就行。VitualBox默认是不开启EFI的，我们需要在虚拟机的系统设置里面手动勾选EFI：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/efi.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/efi.png\" alt=\"efi.png\"></a><br>\n为了要让VirtualBox自动启动refind，还要对EFI的分区做一些简单的设置，<a href=\"https://wiki.archlinux.org/index.php/VirtualBox#Installation_in_EFI_mode\" target=\"_blank\" rel=\"external\">设置的教程参考这里</a>。设置的时候一定要注意，这些设置一定要是通用的，即同一份文件既能在物理机上正常工作也能在虚拟机上正常工作，不要改完了设置以后虚拟机上能跑了物理机却挂了，这就不好玩了。VirtualBox的EFI在启动的时候会优先选择<code>/EFI/BOOT/BOOTX64.EFI</code>，如果找不到的话，才会启动EFI分区根目录下的<code>startup.nsh</code>中指定的bootloader。知道了这一点，为了实现自动启动refind，首先需要检查一下<code>/EFI/BOOT/BOOTX64.EFI</code>这个文件是否存在，若存在，备份并删除之：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac73304592758\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd EFI/BOOT\r\nmv bootx64.efi bootx64-backup.efi</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac73304592758-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac73304592758-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac73304592758-1\"><span class=\"crayon-e\">cd </span><span class=\"crayon-v\">EFI</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">BOOT</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac73304592758-2\"><span class=\"crayon-e\">mv </span><span class=\"crayon-v\">bootx64</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">efi </span><span class=\"crayon-v\">bootx64</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">backup</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">efi</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>然后就是在EFI分区根目录下新建一个<code>startup.nsh</code>了，这个文件只需要一行，内容如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac79815753763\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n\\EFI\\refind\\refind_x64.efi</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac79815753763-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac79815753763-1\"><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">EFI</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">refind</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">refind_x64</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">efi</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>一切设置完毕，运行虚拟机，就能看到我们熟悉的refind界面了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/refind.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/refind.png\" alt=\"refind.png\"></a><br>\n打开其中的Ubuntu系统，测试一切正常就大功告成了：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/ubuntu.png\" rel=\"group\"><img class=\"aligncenter\" title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/ubuntu.png\" alt=\"ubuntu.png\"></a></p>\n<p>当然，要在虚拟机中使用，还有一些细节性的工作要处理，比如安装VirtualBox的guest需要的相应的内核模块等等，这些在此不谈，读者使用过程中如果发现少啥了，自己装上便是。</p>\n<h3 id=\"Linux下不同发行版的互相访问\">Linux下不同发行版的互相访问</h3>\n<p>我们已经成功地在Windows下运行Linux了，下一步就是想办法在一个Linux系统下访问其他Linux了。由于这些系统都是Linux，而且都在同一个文件系统里面，所以如果只是想要访问一下里面的文件的话，挂载了用就行了。但是很多时候我们还是有需要来运行其他系统里面安装的程序，或者对那个系统进行管理的。应对这种需求有两种解决方案：容器跟虚拟机。</p>\n<p>可能很多读者并不了解这两者的区别，这里简单介绍一下。粗略来讲，虚拟机是通过软件的方式虚拟出一套硬件环境来，并在这套硬件环境中启动内核，然后内核会进行一个完整的开机过程，包括进行相应的初始化，加载init程序等。相比之下，容器则要轻量很多。容器并不会虚拟出自己的硬件环境，也不会额外加载一个内核。容器所做的，就是在现有内核上，运用namespace来创建出一套独立的进程PID、挂载点、网络接口、用户ID等等，由于不同namespace中的这些个ID之类的标识符都是独立的，所以不同namespace中的进程是互相之间看不到对方的，虚拟出来的环境乍看上去就跟在单独运行的一个系统一样，同样有PID为1的init进程，有自己一套独立的rootfs，等等。虚拟机的优点是更不容易被突破，安全性更好，可以使用自己的内核，但是效率也更低。容器的优点是轻便效率高，但是安全性就要稍差一些，也没法使用定制内核。</p>\n<h4 id=\"容器\">容器</h4>\n<p>Linux下大家最熟悉的容器就是chroot了，但是作者并不喜欢chroot，主要原因有两点：</p>\n<ul>\n<li>/proc、 /dev等东西不会自动挂载，每次手动挂载挂的心好累</li>\n<li>没有一个相对完整的开机过程，好多我希望自动启动的服务并不会运行起来</li>\n</ul>\n<p>基于上面的原因，作者在这里推荐的容器是systemd-nspawn。关于systemd-nspawn的介绍跟使用教程，<a href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn\" target=\"_blank\" rel=\"external\">推荐看这里</a>。systemd-nspawn的使用非常简单，假设你的linux分区已经mount到了/mnt上去了，那么你只需要下面步骤就能启动一个systemd-nspawn容器（以Debian为例）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac7f494070786\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncd /mnt/debian\r\nsystemd-nspawn -b</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac7f494070786-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac7f494070786-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac7f494070786-1\"><span class=\"crayon-v\">cd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mnt</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">debian</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac7f494070786-2\"><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nspawn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>然后就能看到刷刷刷的开机界面了，真的是非常的方便快捷。这里还有一点小技巧是，如果嫌每次开容器都要把linux分区挂载到/mnt上太麻烦，可以在<code>/var/lib/machines</code>里面为每个系统新建一个目录，然后在fstab里面设置一下自动把相应的子卷挂载进去：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac85420373047\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/dev/disk/by-label/linux        /var/lib/machines/kali          btrfs           defaults,nofail,noatime,discard,subvol=kali            0 0\r\n/dev/disk/by-label/linux        /var/lib/machines/debian        btrfs           defaults,nofail,noatime,discard,subvol=debian          0 0\r\n/dev/disk/by-label/linux        /var/lib/machines/ubuntu        btrfs           defaults,nofail,noatime,discard,subvol=ubuntu          0 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac85420373047-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac85420373047-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac85420373047-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac85420373047-1\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">kali          </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">kali</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac85420373047-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">debian        </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">debian</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac85420373047-3\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dev</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">disk</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">by</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">linux</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ubuntu        </span><span class=\"crayon-e\">btrfs           </span><span class=\"crayon-v\">defaults</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">nofail</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">noatime</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">discard</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">subvol</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">ubuntu</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0025 seconds] -->\r\n<p>这么做的好处是，根目录位于<code>/var/lib/machines</code>的系统，在启动systemd-nspawn的时候可以直接使用<code>-M</code>选项来指定系统，而不需要进入相应目录。比如如果想启动Ubuntu系统：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac88229900558\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsystemd-nspawn -b -M ubuntu</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac88229900558-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac88229900558-1\"><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nspawn</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">M</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ubuntu</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h4 id=\"虚拟机\">虚拟机</h4>\n<p>如果只是想运行一下其他系统里面的程序，那么容器完全就够用了，但是有的时候我们还是需要玩玩不同的内核的，这就必须得用虚拟机了。通常情况下，大家用虚拟机，都是新建一个磁盘镜像，然后插入安装光盘，然后把光盘安装到镜像上。这么做的坏处，一个是访问镜像中的文件不方便，另一个是，我们在本地已经有安装过若干系统了，不去充分利用一下这些而去再重新往镜像里面安装那实在是舍近求远。那我们就来找一个把子卷当成虚拟机rootfs的方法。困难在于，虚拟机是个很独立的东西，是无法直接访问宿主机的文件系统的。然而幸运的是，Linux的内核虚拟化方案KVM提供了一个把本地文件系统传递给虚拟机的解决方案，用到的东西叫做VirtFS，<a href=\"http://wiki.qemu.org/Documentation/9psetup\" target=\"_blank\" rel=\"external\">相关的文档见这里</a>。</p>\n<p>好消息是，VirtFS是可以作为rootfs的。但是要能正常挂载VirtFS，内核必须要有相应的驱动才行。这里有两种方法可以做到这一点。如果你是自己编译内核的话，那么建议直接将相应的驱动编译进内核而不是模块。根据官网的指示，涉及到的内核配置如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac8e062874159\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCONFIG_NET_9P=y\r\nCONFIG_NET_9P_VIRTIO=y\r\nCONFIG_9P_FS=y\r\nCONFIG_9P_FS_POSIX_ACL=y</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac8e062874159-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac8e062874159-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac8e062874159-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac8e062874159-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac8e062874159-1\"><span class=\"crayon-v\">CONFIG_NET_9P</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac8e062874159-2\"><span class=\"crayon-v\">CONFIG_NET_9P_VIRTIO</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac8e062874159-3\"><span class=\"crayon-v\">CONFIG_9P_FS</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac8e062874159-4\"><span class=\"crayon-v\">CONFIG_9P_FS_POSIX_ACL</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">y</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>如果使用的是发行版提供的内核的话，那么可以修改initramfs的相关设置保证9p、9pnet、9pnet_virtio三个modules能被安装到initramfs里面去。这里以Ubuntu做guest为例，具体做法是修改Ubuntu系统中的<code>/etc/initramfs-tools/modules</code>文件，增加下面三行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac92669302376\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n9p\r\n9pnet\r\n9pnet_virtio</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac92669302376-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6cf7ac92669302376-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac92669302376-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac92669302376-1\"><span class=\"crayon-cn\">9p</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6cf7ac92669302376-2\"><span class=\"crayon-cn\">9pnet</span></div><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac92669302376-3\"><span class=\"crayon-cn\">9pnet_virtio</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>然后重新生成initramfs即可：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac95579255149\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nupdate-initramfs -u</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac95579255149-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac95579255149-1\"><span class=\"crayon-v\">update</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">initramfs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">u</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>内核驱动设置好了，就可以启动qemu虚拟机了，这里假定Ubuntu的rootfs已经被mount到了<code>/var/lib/machines/ubuntu</code>：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6cf7ac98594737321\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nqemu-system-x86_64 -enable-kvm -m 16G -kernel /var/lib/machines/ubuntu/vmlinuz -initrd /var/lib/machines/ubuntu/initrd.img -virtfs local,id=root9p,path=/var/lib/machines/ubuntu,security_model=passthrough,mount_tag=root9p -nographic -append \'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd\'</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6cf7ac98594737321-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6cf7ac98594737321-1\"><span class=\"crayon-v\">qemu</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">system</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">x86_64</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">enable</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">kvm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">16G</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">kernel</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vmlinuz</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">initrd</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">img</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">virtfs </span><span class=\"crayon-v\">local</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">root9p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">var</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">machines</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ubuntu</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">security_model</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">passthrough</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">mount_tag</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">root9p</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">nographic</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">append</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\'root=root9p rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/lib/systemd/systemd\'</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0022 seconds] -->\r\n<p>最后放一张成功的截图：<br>\n<a class=\"fancybox fancybox.image\" href=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/qemu-ubuntu.png\" rel=\"group\"><img title=\"\" src=\"https://zasdfgbnm.github.io/2017/06/29/%E8%83%BD%E5%BD%93%E4%B8%BB%E5%8A%9B%EF%BC%8C%E8%83%BD%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%BF%98%E8%83%BD%E9%9A%8F%E6%97%B6%E6%89%93%E5%8C%85%E5%B8%A6%E8%B5%B0%EF%BC%8CLinux%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B9%88%E5%BC%BA%E5%A4%A7/qemu-ubuntu.png\" alt=\"qemu-ubuntu.png\"></a></p>\n<p>全剧终</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111672\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111672votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111672\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2014/04/e260ae4f5d153b25be87819b25ff0577.jpg', 'full/6085acc0af4696f5d49164561c6bc4f9b590fc26.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('减轻服务器负载的建议和技巧', '2017-07-07', 'http://blog.jobbole.com/111725/', '9098565e7972c6d0a1a0f5f75c2f05cb', 1, 1, 'IT技术, 服务器', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/haowang1989\">王浩</a> 翻译，<a href=\"http://www.jobbole.com/members/8zjl8\">周进林</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://www.lucidchart.com/techblog/2017/06/02/tips-tricks-for-reducing-server-load/\">lucidchart</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>我们公司有个面向服务的架构。其中一个服务是字体服务，字体体系和 unicode 编码范围（unicode range）提供字体数据，为用户上传的字体验证权限。我们没想到这个字体服务会有很高的负载<sup>1</sup>（负载是指线程消耗和 CPU 等待的平均值）。但是去年我们注意到字体服务出人意料地出现高负载，尤其是晚上我们没什么流量的时候。幸运的是，我们发现了这一问题的根本原因，并大幅提升了字体服务的性能和系统整体的稳定性。以下内容是我们的优化过程。</p>\n<figure><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/48bf315aeeae9f3a7ce0b11b7c6ce31e.png\"><img class=\" wp-image-64903 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/48bf315aeeae9f3a7ce0b11b7c6ce31e.png\" alt=\"Figure 1: Server load before and after change. (Fix was released Dec 21.)\" width=\"661\" height=\"191\"></a><br>\n<figcaption style=\"text-align: center;\">图1：修改前后系统复制（12 月 21 日发布修复版本）</figcaption>\n</figure>\n<h3>用火焰图调试</h3>\n<p>我一个同事从 Netflix 公司的 Brendan Gregg 那里发现并部署了一个小巧的火焰图工具。这个工具可以把多个性能检测工具的数据结合起来，生成一张本地方法和 JVM 方法资源使用情况的图象。图里每一个矩形都代表一个栈帧，矩形的宽度代表资源的使用情况，如 CPU 时间，y 轴代表调用栈。你可以简单地通过找出比较宽的矩形来定位出问题所在。这个工具对于调试字体服务的性能是非常宝贵的。</p>\n<figure><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/092148cc9b6180af009d4a106022a936.png\"><img class=\"wp-image-64904 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/092148cc9b6180af009d4a106022a936.png\" alt=\"Figure 2: A flame graph from a font server during high load.\" width=\"556\" height=\"485\"></a><br>\n<figcaption style=\"text-align: center;\">图2：字体服务器高负载情况下的一张火焰图</figcaption>\n</figure>\n<p>我们收集了几张字体服务高负载状态下的火焰图。下面展示了其中一张，图里有一处 JVM 部分几乎到顶。我们很快注意到这些图的规律。绝大部分时间都是消耗在 libz.so（用于 gzip 压缩和解压）上，而 JVM 里的绝大部分时间都是消耗在 XML 转义和 UTF-8 编码上。</p>\n<figure><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/00be5bb53f79bfbbc30d7eebd570113a.png\"><img class=\"wp-image-64905 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/00be5bb53f79bfbbc30d7eebd570113a.png\" alt=\"Figure 3: A flame graph zoomed in to the JVM portion.\" width=\"555\" height=\"485\"></a><br>\n<figcaption style=\"text-align: center;\">图3：在 JVM 部分放大的火焰图</figcaption>\n</figure>\n<h3>为什么这么慢</h3>\n<p>首先，介绍一点关于我们字体服务如何工作的背景。我们将字体数据保存在 Amazon S3 容器中，每一种字体的每一 unicode 编码范围（unicode range）是一个独立的对象。其他服务会为字体体系、一系列 unicode 编码范围（unicode range）或者用户来请求字体数据。字体服务会下载用户请求的字体体系中特定 unicode 编码范围（unicode range）的数据，并返回包含这所有数据的 XML。</p>\n<p>这一功能非常简单，并没有什么明显密集计算的东西。然而，我们遇到了高负载。我们在火焰图的帮助下发现 libz、XML 转义和 UTF8 编码占用了 CPU 大量资源。但是为什么我们花了这么多时间在编码和压缩上呢？记得我刚才说的，晚上负载最高吗？我们的晚上（美国山区标准时）在亚洲是白天。每当晚上我们本地没什么流量的时候，大量其他地区的用户正在用亚洲语言的 unicode 编码范围（unicode range），比如中文、日语和韩语。事实上，相比起来这些类别的字体数据是非常庞大的。这些数据通过 gzip 解压、UTF-8 解码然后 XML 转义、UTF-8 编码最后 gzip 压缩。对于体积很小的基本拉丁文类别，这一过程没什么。然而，CJK 类别比基本拉丁文类别大了两个数量级（1MB 对比 60KB）。对于这些体积大的字体类别，这所有的转换都使得 CPU 吃不消。Gzip 压缩和解压相对很耗资源，XML 转义也没有那么快。</p>\n<h3>怎样加速</h3>\n<p>字体服务响应的内容本质上只是来自 S3 的原始数据。字体服务的确做了其他重要的工作，比如权限验证，查找字体关键字。但是没有理由必须让字体服务从 S3 转发字体数据。我们的解决方案非常简单粗暴，直接返回一系列包含字体数据的 S3 对象的链接，而不是通过字体服务下载然后重新编码字体数据。</p>\n<p>这一修改几乎将字体服务器的负载降为 0（见图1）。客户端服务器也察觉不到任何影响。尽管我们第一次尝试非常成功，但我也应该记住，我们部署的同时增加了功能发布控制，它可以让我们在 100% 启用前，先启用一定比例的请求来测试它能够正常工作。</p>\n<h3>结论</h3>\n<p>通过对生产环境服务器的监控，我们能够定位并删除服务器上没必要的功能。下面是我们这次经历中几个关键的步骤：</p>\n<ol>\n<li>用火焰图等性能检测工具定位那些霸占 CPU 的功能方法。</li>\n<li>压缩和其他编码也会非常耗资源。</li>\n<li>如果客户端能够直接获取到数据，那么直接发给它一个连接而非转发数据会提升整体的性能。（声明：这并不是灵丹妙药，有些情况下会对客户端性能造成损失，因为它必须要做二次请求）。</li>\n</ol>\n<p>#1: 负载是指线程消耗和 CPU 等待的平均值。见 <a href=\"https://en.wikipedia.org/wiki/Load_%28computing%29\">Wikipedia</a>。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/19b948cb00fa062128f45b2b53fa09e2.png\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/d327bdec80a27c733bd7b9edb35d30f4.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111725\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111725votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111725\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/haowang1989\">王浩</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/haowang1989\">\r\n			<img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/47586e0af10336a9ced0cb16d851200f.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            phper @深圳        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/haowang1989\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/haowang1989/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/haowang1989/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 13</a> · <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/ontheroads\"><i class=\"fa fa-weibo\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/06/48bf315aeeae9f3a7ce0b11b7c6ce31e.png', 'full/b115c033c502899f0a878f54b5a62805b0d233b4.jpg'),
('王垠：如何掌握所有的程序语言', '2017-07-07', 'http://blog.jobbole.com/111469/', '939ee37643c72df31691e8a75739908f', 3, 1, '开发, 编程语言', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.yinwang.org/blog-cn/2017/07/06/master-pl\">王垠</a>   </div><p>对的，我这里要讲的不是如何掌握一种程序语言，而是所有的……</p>\n<p>很多编程初学者至今还在给我写信请教，问我该学习什么程序语言，怎么学习。由于我知道标题问题的答案，所以总感觉这个问题是如此“低级”，一直没来得及回复 :P 可是逐渐的，我发现原来不只是小白们有这个问题，就连美国大公司的很多资深工程师，其实也没搞明白。</p>\n<p>今天休闲活动进入第二个星期，稍微闲下来一点，我想来统一回答一下这个搁置已久的“初级问题”。这个话题貌似曾经写过，然而现在我想把它重新写一遍。因为通过跟很多人的交流，我对自己头脑中的（未转化为语言的）想法，有了更精确的表达。</p>\n<p>如果你存在以下的种种困惑，那么这篇文章也许会对你有所帮助：</p>\n<ol>\n<li>你是编程初学者，不知道该选择什么程序语言来入门。</li>\n<li>你是资深的程序员或者团队领导，对新出现的种种语言感到困惑，不知道该“投资”哪种语言。</li>\n<li>你的团队为使用哪种程序语言争论不休，发生各种宗教斗争。</li>\n<li>你追逐潮流采用了某种时髦的语言，结果两个月之后发现深陷泥潭，痛苦不堪……</li>\n</ol>\n<p>虽然我已经不再过问这些世事，然而无可置疑的现实是，程序语言仍然是很重要的话题，这个情况短时间内不会改变。程序员的岗位往往会要求熟悉某些语言，甚至某些奇葩的公司要求你“深入理解 OOP 或者 FP 设计模式”。对于在职的程序员，程序语言至今仍然是可以争得面红耳赤的宗教话题。它的宗教性之强，以至于我在批评和调侃某些语言（比如 Go 语言）的时候，有些人会本能地以为我是另外一种语言（比如 Java）的粉丝。</p>\n<p>显然我不可能是任何一种语言的粉丝，我甚至不是 Yin 语言的粉丝 ;) 对于任何从没见过的语言，我都是直接拿起来就用，而不需要经过学习的过程。看了这篇文章，也许你会明白我为什么可以达到这个效果。理解了这里面的东西，每个程序员都应该可以做到这一点。嗯，但愿吧。</p>\n<h3 id=\"重视语言特性而不是语言\">重视语言特性，而不是语言</h3>\n<p>很多人在乎自己或者别人是否“会”某种语言，对“发明”了某种语言的人倍加崇拜，为各种语言的孰优孰劣争得面红耳赤。这些问题对于我来说都是不存在的。虽然我写文章批评过不少语言的缺陷，在实际工作中我却很少跟人争论这些。如果有其它人在我身边争论，我甚至会戴上耳机，都懒得听他们说什么 ;) 为什么呢？我发现归根结底的原因，是因为我重视的是“语言特性”，而不是整个的“语言”。我能用任何语言写出不错的代码，就算再糟糕的语言也差不了多少。</p>\n<p>任何一种“语言”，都是各种“语言特性”的组合。打个比方吧，一个程序语言就像一台电脑。它的牌子可能叫“联想”，或者“IBM”，或者“Dell”，或者“苹果”。那么，你可以说苹果一定比 IBM 好吗？你不能。你得看看它里面装的是什么型号的处理器，有多少个核，主频多少，有多少 L1 cache，L2 cache……，有多少内存和硬盘，显示器分辨率有多大，显卡是什么 GPU，网卡速度，等等各种“配置”。有时候你还得看各个组件之间的兼容性。</p>\n<p>这些配置对应到程序语言里面，就是所谓“语言特性”。举一些语言特性的例子：</p>\n<ul>\n<li>变量定义</li>\n<li>算术运算</li>\n<li>for 循环语句，while 循环语句</li>\n<li>函数定义，函数调用</li>\n<li>递归</li>\n<li>静态类型系统</li>\n<li>类型推导</li>\n<li>lambda 函数</li>\n<li>面向对象</li>\n<li>垃圾回收</li>\n<li>指针算术</li>\n<li>goto 语句</li>\n</ul>\n<p>这些语言特性，就像你在选择一台电脑的时候，看它里面是什么配置。选电脑的时候，没有人会说 Dell 一定是最好的，他们只会说这个型号里面装的是 Intel 的 i7 处理器，这个比 i5 的好，DDR3 的内存 比 DDR2 的快这么多，SSD 比磁盘快很多，ATI 的显卡是垃圾…… 如此等等。</p>\n<p>程序语言也是一样的道理。对于初学者来说，其实没必要纠结到底要先学哪一种语言，再学哪一种。曾经有人给我发信问这种问题，纠结了好几个星期，结果一个语言都还没开始学。有这纠结的时间，其实都可以把他纠结过的语言全部掌握了。</p>\n<p>初学者往往不理解，每一种语言里面必然有一套“通用”的特性。比如变量，函数，整数和浮点数运算，等等。这些是每个通用程序语言里面都必须有的，一个都不能少。你只要通过“某种语言”学会了这些特性，掌握这些特性的根本概念，就能随时把这些知识应用到任何其它语言。你为此投入的时间基本不会浪费。所以初学者纠结要“先学哪种语言”，这种时间花的很不值得，还不如随便挑一个语言，跳进去。</p>\n<p>很多初学者不了解，一个高明的程序员如果开始用一种新的程序语言，他往往不是去看这个语言的大部头手册或者书籍，而是先有一个需要解决的问题。手头有了问题，他可以用两分钟浏览一下这语言的手册，看看这语言大概长什么样。然后，他直接拿起一段例子代码来开始修改捣鼓，想法把这代码改成自己正想解决的问题。在这个简短的过程中，他很快的掌握了这个语言，并用它表达出心里的想法。</p>\n<p>在这个过程中，随着需求的出现，他可能会问这样的问题：</p>\n<ul>\n<li>这个语言的“变量定义”是什么语法，需要“声明类型”吗，还是可以用“类型推导”？</li>\n<li>它的“类型”是什么语法？是否支持“泛型”？泛型的 “variance” 如何表达？</li>\n<li>这个语言的“函数”是什么语法，“函数调用”是什么语法，可否使用“缺省参数”？</li>\n<li>……</li>\n</ul>\n<p>注意到了吗？上面每一个引号里面的内容，都是一种语言特性（或者叫概念）。这些概念可以存在于任何的语言里面，虽然语法可能不一样，它们的本质都是一样的。比如，有些语言的参数类型写在变量前面，有些写在后面，有些中间隔了一个冒号，有些没有。</p>\n<p>这些实际问题都是随着写实际的代码，解决手头的问题，自然而然带出来的，而不是一开头就抱着语言手册看得仔仔细细。因为掌握了语言特性的人都知道，自己需要的特性，在任何语言里面一定有对应的表达方式。如果没有直接的方式表达，那么一定有某种“绕过方式”。如果有直接的表达方式，那么它只是语法稍微有所不同而已。所以，他是带着问题找特性，就像查字典一样，而不是被淹没于大部头的手册里面，昏昏欲睡一个月才开始写代码。</p>\n<p>掌握了通用的语言特性，剩下的就只剩某些语言“特有”的特性了。研究语言的人都知道，要设计出新的，好的，无害的特性，是非常困难的。所以一般说来，一种好的语言，它所特有的新特性，终究不会超过一两种。如果有个语言号称自己有超过 5 种新特性，那你就得小心了，因为它们带来的和可能不是优势，而是灾难！</p>\n<p>同样的道理，最好的语言研究者，往往不是某种语言的设计者，而是某种关键语言特性的设计者（或者支持者）。举个例子，著名的计算机科学家 Dijkstra 就是“递归”的强烈支持者。现在的语言里面都有递归，然而你可能不知道，早期的程序语言是不支持递归的。直到 Dijkstra 强烈要求 Algol 60 委员会加入对递归的支持，这个局面才改变了。Tony Hoare 也是语言特性设计者。他设计了几个重要的语言特性，却没有设计过任何语言。另外大家不要忘了，有个语言专家叫王垠，他是早期 union type 的支持者和实现者，也是 checked exception 特性的支持者，他在自己的<a href=\"http://www.yinwang.org/blog-cn/2017/05/23/kotlin\">博文</a>里指出了 checked exception 和 union type 之间的关系 :P</p>\n<p>很多人盲目的崇拜语言设计者，只要听到有人设计（或者美其民曰“发明”）了一个语言，就热血沸腾，佩服的五体投地。他们却没有理解，其实所有的程序语言，不过是像 Dell，联想一样的“组装机”。语言特性的设计者，才是像 Intel，AMD，ARM，Qualcomm 那样核心技术的创造者。</p>\n<h3 id=\"合理的入门语言\">合理的入门语言</h3>\n<p>所以初学者要想事半功倍，就应该从一种“合理”的，没有明显严重问题的语言出发，掌握最关键的语言特性，然后由此把这些概念应用到其它语言。哪些是合理的入门语言呢？我个人觉得这些语言都可以用来入门：</p>\n<ul>\n<li>Scheme</li>\n<li>C</li>\n<li>Java</li>\n<li>Python</li>\n<li>JavaScript</li>\n</ul>\n<p>那么相比之下，我不推荐用哪些语言入门呢？</p>\n<ul>\n<li>Shell</li>\n<li>PowerShell</li>\n<li>AWK</li>\n<li>Perl</li>\n<li>PHP</li>\n<li>Basic</li>\n<li>Go</li>\n</ul>\n<p>总的说来，你不应该使用所谓“<a href=\"http://www.yinwang.org/blog-cn/2013/03/29/scripting-language\">脚本语言</a>”作为入门语言，特别是那些源于早期 Unix 系统的脚本语言工具。PowerShell 虽然比 Unix 的 Shell 有所进步，然而它仍然没有摆脱脚本语言的根本问题——他们的设计者不知道他们自己在干什么 :P</p>\n<p>采用脚本语言学编程，一个很严重的问题就是使得学习者抓不住关键。脚本语言往往把一些系统工具性质的东西（比如正则表达式，Web 概念）加入到语法里面，导致初学者为它们浪费太多时间，却没有理解编程最关键的概念：变量，函数，递归，类型……</p>\n<p>不推荐 Go 语言的原因类似，虽然 Go 语言不算脚本语言，然而他的设计者显然不明白自己在干什么。所以使用 Go 语言来学编程，你不能专注于最关键，最好的语言特性。</p>\n<h3 id=\"掌握关键语言特性忽略次要特性\">掌握关键语言特性，忽略次要特性</h3>\n<p>为了达到我之前提到的融会贯通，一通百通的效果，初学者应该专注于语言里面最关键的特性，而不是被次要的内容分心。我发现很多编程培训班和野鸡大学的编程入门课，往往一来就教学生如何使用 printf 打印“Hello World！”，进而要他们记忆 printf 的各种“格式字符”的意义，要他们实现各种复杂格式的打印输出，甚至要求打印到文本文件里，然后再读出来……</p>\n<p>可是殊不知，这种输出输入操作其实根本不算是语言的一部分，而且对于掌握编程的核心概念来说，都是次要的。有些人的 Java 课程进行了好几个星期，居然还在布置各种 printf 的作业。学生写出几百行的 printf，却不理解变量和函数是什么，甚至连算术语句和循环语句都不知道怎么用！这就是为什么很多初学者感觉编程很难，我连 <code class=\"highlighter-rouge\">%d</code>，<code class=\"highlighter-rouge\">%f</code>，<code class=\"highlighter-rouge\">%.2f</code>的含义都记不住，还怎么学编程！</p>\n<p>然而这些野鸡大学的“教授”头衔是如此的洗脑，以至于被他们教过的学生（比如我女朋友）到我这里请教，居然骂我净教一些没用的东西，学了连 printf 的作业都没法完成 :P 你别跟我讲 for 循环，函数什么的了…… 可不可以等几个月，等我背熟了 printf 的用法再学那些啊？</p>\n<p>所以你就发现一旦被差劲的老师教过，这个程序员基本就毁了。就算遇到好的老师，他们也很难纠正过来。</p>\n<h3 id=\"自己动手实现语言特性\">自己动手实现语言特性</h3>\n<p>在基本学会了各种语言特性，能用它们来写代码之后，下一步的进阶就是去实现它们。只有实现了各种语言特性，你才能完完全全的拥有它们，成为它们的主人。否则你就只是它们的使用者，你会永远做语言创造者们的仆人。</p>\n<p>有个大师说得好，完全理解一种语言最好的方法就是自己动手实现它，也就是自己写一个解释器来实现它的语义。但我觉得这句话应该稍微修改一下：完全理解一种“语言特性”最好的方法就是自己亲自实现它。</p>\n<p>注意我在这里把“语言”改为了“语言特性”。你并不需要实现整个语言来达到这个目的，因为我们最终使用的是语言特性。只要你自己实现了一种语言特性，你就能理解这个特性在任何语言里的实现方式和用法。</p>\n<p>举个例子，学习 SICP 的时候，大家都会亲自用 Scheme 实现一个面向对象系统。用 Scheme 实现的面向对象系统，跟 Java，C++，Python 之类的语言语法相去甚远，然而它却能帮助你理解任何这些 OOP 语言里面的“面向对象”这一概念，它甚至能帮助你理解各种面向对象实现的差异。</p>\n<p>这种效果是你直接学习 OOP 语言得不到的，因为在学习 Java，C++，Python 之类语言的时候，你只是一个用户，而用 Scheme 自己动手实现了 OO 系统之后，你成为了一个创造者。</p>\n<p>类似的特性还包括类型推导，类型检查，惰性求值，如此等等。我实现过几乎所有的语言特性，所以任何语言在我的面前，都是可以被任意拆卸组装的玩具，而不再是凌驾于我之上的神圣。</p>\n<h3 id=\"总结\">总结</h3>\n<p>写了这么多，重要的话重复三遍：语言特性，语言特性，语言特性，语言特性！不管是初学者还是资深程序员，应该专注于语言特性，而不是纠结于整个的“语言品牌”。只有这样才能达到融会贯通，拿起任何语言几乎立即就会用，并且写出高质量的代码。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111469\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111469votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111469\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/01/f9dc3a6611e10b616985757498ed6a74.jpg', 'full/9a8539839727cdcb8492a550ef7b35f838a85f14.jpg'),
('15位身份证补全为18位身份证算法', '2017-07-07', 'http://blog.jobbole.com/111556/', '965c6835ed4cba16fd9cb2cfda0a99a2', 1, 2, 'IT技术, 算法', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/10158wsj/p/7050736.html\">我心自在</a>   </div><p>最近在参与一个银行项目-某银行安防系统-反洗钱需求的开发，银行项目的离不开身份证号码，身份证号码作为我国公民的唯一标识，有这非同寻常的意义，由于业务的要求15位的身份证号码无法命中，所以需要补全为18位，一开始自己想着加个年份的前两位，后面再加个X不就行了嘛，后来代码写不下去了，上网查了资料，才知道自己想的是多么天真，还是比较复杂的，折腾了一下午终于有了眉目。</p>\n<h2>一、15位身份证和18位身份证号码结构介绍</h2>\n<p>要进行身份证号码的验证，首先需要了解我国身份证号码的编码规则。我国身份证号码多由若干位数字或者数字与字母混合组成。早期身份证由15位数字构成，这主要是在1980年以前发放的身份证，后来考虑到千年虫问题，因为15位的身份证号码只能为1900年1月1日到1999年12月31日出生的人编号，所以又增加了18位身份证号码编号规则。</p>\n<p>1     2     3     4     5     6     7     8     9     10   11   12   13   14   15</p>\n<p>A     A     A     A     A     A     Y     Y     M    M    D     D     N    N    S</p>\n<p>前六位AAAAAA是身份证编码对象的所在地（出生地）的编码，该号码可由国家统计局公布的相关标准中得到。YY表示出生年的后两位，MM和DD表示出生月和日，不足两位的高位补0，NNS为顺序号，无法确定。S为性别识别码，男性为奇数，女性为偶数。了解了这些，再来写代码就变得容易多了。</p>\n<h2>二、算法实现</h2>\n<p>了解了身份证号码的规则后，我们就可以推断出，身份证的15位转化位需要两步。首先把15位身份证号补全为17位，然后再补全最后一位。但是最后一位是数字还是字母X？这里又出现了问题。我们知道，身份证的最后一位为校验位，那么最后一位是怎么得到的呢？原来，最后一位是由数字1-9组成，超过9的比如11就用字母X表示，否则号码就变成了19位。了解了这些，经过整理得出身份证补全算法实现思想如下：</p>\n<p><strong>step1</strong>、将15位身份证号码加入出生年变为17位</p>\n<p><strong>step2</strong>、将step1得到的身份证17位数分别乘以不同的系数。从第1位到第17位的系数分别为：7-9-10-5-8-4-2-1-6-3-7-9-10-5-8-4-2.</p>\n<p><strong>step3</strong>、将这17位数字和系数相乘的结果相加</p>\n<p><strong>step4</strong>、将step3的结果除以11，得出余数</p>\n<p>由于数字的特殊性，这些余数只可能是0-10这11个数字，身份证最后一位的对应数字为1-0-X-9-8-7-6-5-4-3-2.。例上面的余数结果为3那么对应身份证号码的最后一位就是9，如果是10，身份证最后一位便是2。</p>\n<p>代码如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-5960059d9a702199879665\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic static void main(String[] args) {\r\n        System.out.println(transIDCard15to18(\"370986890623212\"));\r\n        System.out.println(transIDCard15to18(\"370725881105149\"));\r\n    }\r\n    /* 18位标准身份证号\r\n     * 方法用途：15位身份证转化为18位标准证件号\r\n     */\r\n    public static String transIDCard15to18(String IdCardNO){\r\n        String cardNo=null;\r\n        if(null!=IdCardNO&amp;&amp;IdCardNO.trim().length()==15){\r\n            IdCardNO=IdCardNO.trim();\r\n            StringBuffer sb=new StringBuffer(IdCardNO);\r\n            sb.insert(6, \"19\");\r\n            sb.append(transCardLastNo(sb.toString()));\r\n            cardNo=sb.toString();\r\n        }\r\n        return cardNo;\r\n    }\r\n    /* 方法用途：15位补全‘19’位后的身份证号码\r\n     */\r\n    private static String transCardLastNo(String newCardId){\r\n        char[] ch=newCardId.toCharArray();\r\n        int m=0;\r\n        int [] co={7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2};\r\n        char [] verCode=new char[]{\'1\',\'0\',\'X\',\'9\',\'8\',\'7\',\'6\',\'5\',\'4\',\'3\',\'2\'};\r\n        for (int i = 0; i &lt; newCardId.length(); i++) {\r\n            m+=(ch[i]-\'0\')*co[i];\r\n        }\r\n        int residue=m%11;\r\n        return String.valueOf(verCode[residue]);\r\n         \r\n    }</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5960059d9a702199879665-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5960059d9a702199879665-32\">32</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-2\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">println</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">transIDCard15to18</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"370986890623212\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">out</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">println</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">transIDCard15to18</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"370725881105149\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* 18位标准身份证号</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-6\"><span class=\"crayon-c\">     * 方法用途：15位身份证转化为18位标准证件号</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-7\"><span class=\"crayon-c\">     */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">transIDCard15to18</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">IdCardNO</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cardNo</span><span class=\"crayon-o\">=</span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-o\">!=</span><span class=\"crayon-v\">IdCardNO</span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-v\">IdCardNO</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">trim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">length</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">==</span><span class=\"crayon-cn\">15</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">IdCardNO</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">IdCardNO</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">trim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-e\">StringBuffer </span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StringBuffer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">IdCardNO</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-13\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">insert</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">6</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"19\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-14\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">transCardLastNo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">cardNo</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cardNo</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* 方法用途：15位补全‘19’位后的身份证号码</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-20\"><span class=\"crayon-c\">     */</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">transCardLastNo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">newCardId</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">char</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ch</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">newCardId</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toCharArray</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">m</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">co</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-cn\">7</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">9</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">5</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">8</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">6</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">3</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">7</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">9</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">5</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">8</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">verCode</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">\'1\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'0\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'X\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'9\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'8\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'7\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'6\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'5\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'4\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'3\'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">\'2\'</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">newCardId</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">length</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-27\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">m</span><span class=\"crayon-o\">+=</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ch</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-s\">\'0\'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">co</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">residue</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">m</span><span class=\"crayon-o\">%</span><span class=\"crayon-cn\">11</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">valueOf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">verCode</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">residue</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5960059d9a702199879665-31\"><span class=\"crayon-h\">         </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5960059d9a702199879665-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0067 seconds] -->\r\n<p>测试结果如下：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/4de63d1dfe6ae7d0e16eb62169a51728.png\"><img class=\"alignnone wp-image-111567 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/4de63d1dfe6ae7d0e16eb62169a51728.png\" alt=\"1153367-20170619213856382-410871354\" width=\"760\" height=\"154\"></a></p>\n<h2>三、总结</h2>\n<p>身份证号码补全虽然简单，但是前提需要了解我国公民的身份证构成原理才能正确验证，今天将这个学习过程分享给大家，希望对大家有所帮助，学习是个永无止境的过程，只有不断学习才能有进步！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111556\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111556votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111556\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2014/10/9184208f96827c412ab7d3570590ef76.jpg', 'full/506f77aba037cb2bd78064b80470760038a6d491.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('Linux 中高效编写 Bash 脚本的 10 个技巧', '2017-07-07', 'http://blog.jobbole.com/111514/', '9c36e71c307939b4d10f479fb6f902f3', 8, 1, 'IT技术, Bash, Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.tecmint.com/useful-tips-for-writing-bash-scripts-in-linux/\">Aaron Kili</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-8618-1.html\">Linux中国/ch-cn</a>   </div><p>Shell 脚本编程 是你在 Linux 下学习或练习编程的最简单的方式。尤其对 系统管理员要处理着自动化任务，且要开发新的简单的实用程序或工具等（这里只是仅举几例）更是必备技能。</p>\n<p>本文中，我们将分享 10 个写出高效可靠的 bash 脚本的实用技巧，它们包括：</p>\n<h3 id=\"toc_1\">1、 脚本中多写注释</h3>\n<p>这是不仅可应用于 shell 脚本程序中，也可用在其他所有类型的编程中的一种推荐做法。在脚本中作注释能帮你或别人翻阅你的脚本时了解脚本的不同部分所做的工作。</p>\n<p>对于刚入门的人来说，注释用 <code>#</code> 号来定义。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeadc859536934\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# TecMint 是浏览各类 Linux 文章的最佳站点</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeadc859536934-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeadc859536934-1\"><span class=\"crayon-p\"># TecMint 是浏览各类 Linux 文章的最佳站点</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p></p>\n<h3 id=\"toc_2\">2、 当运行失败时使脚本退出</h3>\n<p>有时即使某些命令运行失败，bash 可能继续去执行脚本，这样就影响到脚本的其余部分（会最终导致逻辑错误）。用下面的行的方式在遇到命令失败时来退出脚本执行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeae6824211756\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# 如果命令运行失败让脚本退出执行\r\nset -o errexit \r\n# 或\r\nset -e</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeae6824211756-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeae6824211756-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeae6824211756-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeae6824211756-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeae6824211756-1\"><span class=\"crayon-p\"># 如果命令运行失败让脚本退出执行</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeae6824211756-2\"><span class=\"crayon-v\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">o</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">errexit</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeae6824211756-3\"><span class=\"crayon-p\"># 或</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeae6824211756-4\"><span class=\"crayon-v\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">e</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h3 id=\"toc_3\">3、 当 Bash 用未声明变量时使脚本退出</h3>\n<p>Bash 也可能会使用能导致起逻辑错误的未声明的变量。因此用下面行的方式去通知 bash 当它尝试去用一个未声明变量时就退出脚本执行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeaea172952881\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# 若有用未设置的变量即让脚本退出执行\r\nset -o nounset\r\n# 或\r\nset -u</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaea172952881-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaea172952881-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaea172952881-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaea172952881-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeaea172952881-1\"><span class=\"crayon-p\"># 若有用未设置的变量即让脚本退出执行</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaea172952881-2\"><span class=\"crayon-v\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">o</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nounset</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaea172952881-3\"><span class=\"crayon-p\"># 或</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaea172952881-4\"><span class=\"crayon-v\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">u</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h3 id=\"toc_4\">4、 使用双引号来引用变量</h3>\n<p>当引用时（使用一个变量的值）用双引号有助于防止由于空格导致单词分割开和由于识别和扩展了通配符而导致的不必要匹配。</p>\n<p>看看下面的例子：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeaee946549522\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/bash\r\n# 若命令失败让脚本退出\r\nset -o errexit \r\n# 若未设置的变量被使用让脚本退出\r\nset -o nounset\r\necho \"Names without double quotes\" \r\necho\r\nnames=\"Tecmint FOSSMint Linusay\"\r\nfor name in $names; do\r\n  echo \"$name\"\r\ndone\r\necho\r\necho \"Names with double quotes\" \r\necho\r\nfor name in \"$names\"; do\r\n  echo \"$name\"\r\ndone\r\nexit 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaee946549522-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaee946549522-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-1\"><span class=\"crayon-p\">#!/bin/bash</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-2\"><span class=\"crayon-p\"># 若命令失败让脚本退出</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-3\"><span class=\"crayon-v\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">o</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">errexit</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-4\"><span class=\"crayon-p\"># 若未设置的变量被使用让脚本退出</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-5\"><span class=\"crayon-v\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">o</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nounset</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-6\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Names without double quotes\"</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-7\"><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-8\"><span class=\"crayon-v\">names</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"Tecmint FOSSMint Linusay\"</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-9\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">name </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">names</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">do</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-10\"><span class=\"crayon-h\">  </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$name\"</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-11\"><span class=\"crayon-e\">done</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-12\"><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-13\"><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Names with double quotes\"</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-14\"><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-15\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">name </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$names\"</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">do</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-16\"><span class=\"crayon-h\">  </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$name\"</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaee946549522-17\"><span class=\"crayon-e\">done</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaee946549522-18\"><span class=\"crayon-i\">exit</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>保存文件并退出，接着如下运行一下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeaf2447869625\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ ./names.sh</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf2447869625-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeaf2447869625-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">names</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sh</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<p class=\"article_img\"><img class=\"aligncenter\" title=\"在脚本中用双引号\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201706/17/192227q13jnz3eeqq5pb53.png\" alt=\"在脚本中用双引号\"></p>\n<p class=\"article_img_desc\" style=\"text-align: center;\"><em>在脚本中用双引号</em></p>\n<h3 id=\"toc_5\">5、 在脚本中使用函数</h3>\n<p>除了非常小的脚本（只有几行代码），总是记得用函数来使代码模块化且使得脚本更可读和可重用。</p>\n<p>写函数的语法如下所示：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeaf6418824701\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nfunction check_root(){\r\n  command1; \r\n  command2;\r\n}\r\n# 或\r\ncheck_root(){\r\n  command1; \r\n  command2;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf6418824701-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaf6418824701-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf6418824701-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaf6418824701-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf6418824701-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaf6418824701-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf6418824701-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeaf6418824701-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf6418824701-9\">9</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeaf6418824701-1\"><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">check_root</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaf6418824701-2\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">command1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaf6418824701-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">command2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaf6418824701-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaf6418824701-5\"><span class=\"crayon-p\"># 或</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaf6418824701-6\"><span class=\"crayon-e\">check_root</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaf6418824701-7\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">command1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeaf6418824701-8\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">command2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eeaf6418824701-9\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>写成单行代码时，每个命令后要用终止符号：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeaf9470538187\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncheck_root(){ command1; command2; }</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeaf9470538187-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeaf9470538187-1\"><span class=\"crayon-e\">check_root</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">command1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">command2</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h3 id=\"toc_6\">6、 字符串比较时用 <code>=</code> 而不是 <code>==</code></h3>\n<p>注意 <code>==</code> 是 <code>=</code> 的同义词，因此仅用个单 <code>=</code> 来做字符串比较，例如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeafd941627359\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvalue1=”tecmint.com”\r\nvalue2=”fossmint.com”\r\nif [ \"$value1\" = \"$value2\" ]</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeafd941627359-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeafd941627359-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeafd941627359-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeafd941627359-1\"><span class=\"crayon-v\">value1</span><span class=\"crayon-o\">=</span>”<span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">com</span>”</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeafd941627359-2\"><span class=\"crayon-v\">value2</span><span class=\"crayon-o\">=</span>”<span class=\"crayon-v\">fossmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">com</span>”</div><div class=\"crayon-line\" id=\"crayon-59602a80eeafd941627359-3\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$value1\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$value2\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p></p>\n<h3 id=\"toc_7\">7、 用 <code>$(command)</code> 而不是老旧的 <code><code>command</code></code> 来做代换</h3>\n<p><a class=\"ext\" href=\"https://www.tecmint.com/assign-linux-command-output-to-variable/\" target=\"_blank\" rel=\"external nofollow\">命令代换</a> 是用这个命令的输出结果取代命令本身。用 <code>$(command)</code> 而不是引号 <code><code>command</code></code> 来做命令代换。</p>\n<p>这种做法也是 <a class=\"ext\" href=\"https://www.tecmint.com/shellcheck-shell-script-code-analyzer-for-linux/\" target=\"_blank\" rel=\"external nofollow\">shellcheck tool</a> （可针对 shell 脚本显示警告和建议）所建议的。例如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeb01446187814\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nuser=`echo “$UID”`\r\nuser=$(echo “$UID”)</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeb01446187814-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeb01446187814-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeb01446187814-1\"><span class=\"crayon-v\">user</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span>“<span class=\"crayon-sy\">$</span><span class=\"crayon-i\">UID</span>”<span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeb01446187814-2\"><span class=\"crayon-v\">user</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span>“<span class=\"crayon-sy\">$</span><span class=\"crayon-i\">UID</span>”<span class=\"crayon-sy\">)</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p></p>\n<h3 id=\"toc_8\">8、 用 <code>readonly</code> 来声明静态变量</h3>\n<p>静态变量不会改变；它的值一旦在脚本中定义后不能被修改：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeb04051891010\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nreadonly passwd_file=”/etc/passwd”\r\nreadonly group_file=”/etc/group”</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeb04051891010-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeb04051891010-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeb04051891010-1\"><span class=\"crayon-e\">readonly </span><span class=\"crayon-v\">passwd_file</span><span class=\"crayon-o\">=</span>”<span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">passwd</span>”</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeb04051891010-2\"><span class=\"crayon-e\">readonly </span><span class=\"crayon-v\">group_file</span><span class=\"crayon-o\">=</span>”<span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">group</span>”</div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p></p>\n<h3 id=\"toc_9\">9、 环境变量用大写字母命名，而自定义变量用小写</h3>\n<p>所有的 bash 环境变量用大写字母去命名，因此用小写字母来命名你的自定义变量以避免变量名冲突：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eeb08174188419\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# 定义自定义变量用小写，而环境变量用大写\r\nnikto_file=”$HOME/Downloads/nikto-master/program/nikto.pl”\r\nperl “$nikto_file” -h  “$1”</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eeb08174188419-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eeb08174188419-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eeb08174188419-3\">3</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eeb08174188419-1\"><span class=\"crayon-p\"># 定义自定义变量用小写，而环境变量用大写</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eeb08174188419-2\"><span class=\"crayon-v\">nikto_file</span><span class=\"crayon-o\">=</span>”<span class=\"crayon-sy\">$</span><span class=\"crayon-v\">HOME</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Downloads</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">nikto</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">master</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">program</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">nikto</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">pl</span>”</div><div class=\"crayon-line\" id=\"crayon-59602a80eeb08174188419-3\"><span class=\"crayon-i\">perl</span><span class=\"crayon-h\"> </span>“<span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nikto</span><span class=\"crayon-sy\">_</span>file”<span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">h</span><span class=\"crayon-h\">  </span>“<span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span>”</div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p></p>\n<h3 id=\"toc_10\">10、 总是对长脚本进行调试</h3>\n<p>如果你在写有数千行代码的 bash 脚本，排错可能变成噩梦。为了在脚本执行前易于修正一些错误，要进行一些调试。通过阅读下面给出的指南来掌握此技巧：</p>\n<ol>\n<li><a href=\"https://linux.cn/article-8028-1.html\">如何在 Linux 中启用 Shell 脚本调试模式</a></li>\n<li><a href=\"https://linux.cn/article-8045-1.html\">如何在 Shell 脚本中执行语法检查调试模式</a></li>\n<li><a href=\"https://linux.cn/article-8120-1.html\">如何在 Shell 脚本中跟踪调试命令的执行</a></li>\n</ol>\n<p>本文到这就结束了，你是否有一些其他更好的 bash 脚本编程经验想要分享？若是的话，在下面评论框分享出来吧。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111514\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111514votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111514\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 8 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'https://dn-linuxcn.qbox.me/data/attachment/album/201706/17/192227q13jnz3eeqq5pb53.png', 'full/aba8a39617598b9aa209e097640c72a63135a000.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('软件开发和测试的 30 个最佳实践', '2017-07-07', 'http://blog.jobbole.com/111586/', 'a35c31c7eaba3371c3f60292f71bcac1', 6, 3, '开发, 最佳实践', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/maifansnet\">maifans</a> 翻译，<a href=\"http://www.jobbole.com/members/huanglimin\">黄利民</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://opensource.com/article/17/5/30-best-practices-software-development-and-testing\">Michael Foord</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><div>\n<blockquote><p>这些软件开发和测试的最佳实践，可以帮你节省时间和避免问题。</p></blockquote>\n</div>\n<p>加入一个企业文化和编程实践已经定型的新公司，可能会是一种令人沮丧的经历。当我加入 Ansible 团队后，我决定整理我多年以来所学并为之奋斗的软件工程实践和准则。这是一个不明确的也不够详尽的准则列表，使用它们时需要智慧和灵活性。</p>\n<p>我对测试充满热情，因为我相信良好的测试实践既能确保满足最低质量标准（可悲的是许多软件产品做不到），并能指导和塑造开发本身。本文提到的这些准则，很多是与测试实践和理念相关的。其中一些准则针对 Python 的，但大多数不是。（对于 Python 开发者，<a href=\"https://www.python.org/dev/peps/pep-0008/\">PEP 8</a> 应该是编程风格和指南的首先。）</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fh276i91ycj20xc0m8tcd.jpg\" width=\"620\" height=\"413\"></p>\n<h2>开发和测试的最佳实践</h2>\n<p><strong>1. YAGNI 原则：“<a href=\"https://martinfowler.com/bliki/Yagni.html\" target=\"_blank\">You Aint Gonna Need It</a>”。不要写你认为将来可能需要但现在不需要的代码。</strong>这是为<b>假想的未来用例</b>编码，这些代码将不可避免地变成死代码，或需要重写，因为未来结果<b>总是</b>与想象的稍有不同。</p>\n<p>如果你写代码用于将来的用例，我将在代码评审中对其质疑。（你可能而且必须设计 API，并<b>确保</b>未来的用例可用，但这是不同的问题。）</p>\n<p>这条原则也适用于被注释掉的代码；如果一个被注释掉代码块即将进入一个发布版本，那么它就不应该存在。如果代码可能要还原，请为代码删除创建一个问题单并引用提交对象的哈希字符串。YAGNI 原则是敏捷编程的核心要素，这个话题最好的参考书是 Kent Beck 写的《解析极限编程》（《Extreme Programming Explained》）。</p>\n<p><b></b><strong>2 . 测试不需要测试。</strong>用于测试需要的基础设施、框架和库需要测试。除非你<b>真的需要</b>不要测试浏览器或外部库。测试你写的代码，而不是别人的代码。</p>\n<p><b></b><strong>3.当第三次编写相同的代码时，也是将其提取成通用的辅助函数（并为其编写测试）的正确时机。</strong>测试中的辅助函数不需要测试；但当你将它们剔除出去然后再重用它们时，它们需要测试。到你第三次编写类似代码的时候，你通常会清楚地认识到你正在解决的通用问题的模型是什么。</p>\n<p><b></b>4. 现在来谈谈 API 设计（面向外部的对象API）：<b>把简单的事情做简单了，复杂的事情自然成为可能</b>。首先设计简单的用例，如果有可能最好是零配置或参数化。为更复杂和灵活的用例（如需要）增加<b>选项</b>或额外的 API 方法。</p>\n<p><strong>5. 快速失败。</strong>检查输入，如果遇到无意义输入或非法状态则尽早失败，最好是通过异常或错误响应使问题对调用者变得清晰。允许你的代码处理“有创意”的用例（例如，除非真的需要，否则在做输入验证的时候不要做类型检查）。</p>\n<p><strong>6.单元测试测的是行为单元，而不是实现单元。</strong>我们的目标是在改动实现的情况下不改动行为，也不必更新测试，尽管这个目标不总是能实现。因此在可能的情况下将测试对象视为黑盒，通过公共 API 测试，而不调用私有方法或玩弄状态位。</p>\n<p>在一些复杂的情况可能做不到，如在特定的复杂状态下测试行为，以找到一个偶发的错误。这一点对于写测试非常有帮助，因为它迫使你在写测试代码之前思考你代码的行为以及你将如何测试它。测试首先鼓励更小，更模块化的代码单元，这通常意味着好代码。关于“测试优先”方法有一本很好的入门参考书，就是 Kent Beck 写的《测试驱动开发》(《Test Driven Development by Example》)</p>\n<p><strong>7. 对于单元测试（包括测试基础设施测试），所有代码路径都应该被测到。</strong>100% 覆盖是一个好的开始。你不能覆盖所有可能状态的排列/组合（组合性爆炸），因此这个问题需要考虑。只有当有很好理由的情况下才允许有代码路径未经测试。没有时间<b>不是</b>一个好理由，最终会花费更多的时间。可能的好理由包括：真正的不可测（以任何有意义的方式），现实中不可能发生，或被其它测试覆盖。没有测试的代码是一种债。测量覆盖率和拒绝减少覆盖率 PR(拉取请求) 是确保你在正确的方向演进的一种方式。</p>\n<p><strong>8. 代码是敌人：它可能出错，并且需要维护。</strong>少写代码，删除代码，不要写你不需要的代码。</p>\n<p><strong>9. 随着时间的推移，代码注释不可避免地成为谎言。</strong>在现实中，很少有人在事情变化的时候更新注释。通过良好的命名法和已知的编程风格，努力使你的代码可读和自文档化。</p>\n<p>对于那些晦涩的代码，<b>一定</b>要写注释，例如偶发错误或意外情况的变通方案，或者必要的优化。解释代码的<b>意图</b>和及其原因，而不是解释代码在做什么。（顺便说一句，有些观点认为注释变谎言是有争议的。我仍然认为这是正确的，《程序设计实践》(《The Practice of Programming》)的作者 Kernighan 和 Pike 同意我的观点。）</p>\n<p><strong>10. 防守思维。</strong>总是考虑什么会出错，无效的输入会引发什么，什么可能会失败，这将有助于你在许多错误发生之前发现他们。</p>\n<p><strong>11.无状态和无副作用的单元测试，其逻辑应简单</strong>。将逻辑分解成单独的函数，而不是将逻辑混合到有状态和充满副作用代码中。将有状态代码和有副作用代码，分为较小的更容易模拟的函数和无副作用地单元测试。（测试的开销越小意味着更快的测试）副作用<b>确实</b>需要测试，但是测试一次然后处处模拟它们通常是一个好的模式。</p>\n<p><strong>12. 全局变量不好。</strong>函数优于类型。对象可能比复杂的数据结构更好。</p>\n<p><strong>13.使用 Python 内置类型及其方法将比自己编写的类型运行快（除非你用C语言编写）</strong>。如果性能是一个考虑因素，请尝试弄懂如何使用标准的内置类型，而不是自定义对象。</p>\n<p>14. 依赖注入是一个实用的编程模式，明确你的依赖是什么和它们来自哪里。（对象，方法等以参数的形式接收它们的依赖，而不是实例化新对象本身。）这确实让 API 签名更复杂，所以这里需要权衡。如果一个方法最后为所有的依赖设置了10个参数，那这是一个不错的信号，不管为什么你的代码做得太多。关于依赖注入的权威文章是 Martin Fowler 的《控制反转容器&amp;依赖注入模式》(《Inversion of Control Containers and the Dependency Injection Pattern》)。</p>\n<p><strong>15. 需要模拟测试的代码越多，你的代码就越糟糕。</strong>为了测试一个特定的行为，需要实例化和牵扯的代码越多，代码越糟糕。我们的目标是小型可测试的单元，以及更高级别的集成和功能测试，以测试各单元是否配合正确。</p>\n<p><strong>16. 面向外部的 API 是“预先设计”——同时要考虑未来的用例——真正重要的地方。</strong>改变 API 对我们和用户来说是一种痛苦，造成向后不兼容是可怕的（尽管有时无法避免的）。设计面向外部的 API 要细心，仍然要坚持“把简单的事情做简单”的原则。</p>\n<p><strong>17.如果函数或方法超过 30 行代码，考虑分解它。</strong>一个良好的模块最大约 500 行。测试文件往往比这个要大。</p>\n<p><strong>18 .不要在对象构造函数中工作，这里很难测试而且经常发生意外。</strong>不要在__init__ .py中添加代码（导入命名空间除外）。__init__ .py不是程序员通常<b>期望</b>找代码的地方，所以它是个“惊喜”。</p>\n<p><strong>19. DRY（不要重复自己）在测试中没有在生产代码中要紧。</strong>单个测试文件的可读性比可维护性更重要（跳出模块复用的限制）。这是因为测试是单独被执行和阅读的，而且它们自己不是大系统的一部分。虽然在很多重复的时候创建可重用的组件更方便，但相较于产品代码，测试代码较少考虑。</p>\n<p><strong>20.每当你看到有需要有机会就重构。</strong>编程是关于抽象的，你的抽象映射越接近问题域，代码就越容易理解和维护。随着系统的有机增长，需要改变结构以扩大它们的用例。系统越来越多的抽象和结构，如果不改变它们就成为技术性的债务。它会是更加痛苦的工作（更慢，越来越多的错误）。在特性开发估计中请考虑清除技术债务（重构）的成本。你遗留债务的时间越长，积累的利息就越高。关于重构和和测试的一本很棒的书是 Michael Feathers 的《修改代码的艺术》(《Working Effectively with Legacy Code》)。</p>\n<p><strong>21. 代码正确为第一位，速度快第二位。</strong>在处理性能问题时，在修复错误之前先要做性能剖析。通常瓶颈不是你认为的那样。如果写晦涩的代码的唯一价值就是更快而且你已经做过性能剖析并证明了，那么它实际就是值得的。编写测试定期检测你要做性能剖析的代码，这样可以很容易让你知道你什么时候测试过。测试可以留在测试套件中，以防止性能退化。（通常情况下，添加定时代码总会改变代码的性能特性，使性能工作成为令人沮丧的任务之一。）</p>\n<p><strong>22. 当更小、范围有限的单元测试失败的时候，可以给出更多有价值的信息，告诉你具体是什么错误。</strong>如果一个测试牵涉了半个系统来测试行为，那么它需要更多的调查以确定什么是错误的。一般来说，运行超过 0.1 秒的测试不是单元测试。没有所谓的慢单元测试。用限定范围的单元测试测试行为，你的测试行为扮演了事实上的代码规范。理想情况下如果有人想了解你的代码，他们应该能够把测试套件转换为行为的“文档”。Gary Bernhardt 的《快测，慢测》(《Fast Test, Slow Test》)是关于单元测试实践的一篇很棒的演讲。</p>\n<p><strong>23. ”非我所创“不像人们说的那么坏。</strong>如果代码是我们写的，那么我们知道它是什么，我们知道如何维护它，在我们可以在适当的时候自由地扩展和修改它。这遵循了 YAGNI 原则：我们用那些适合我们需要用例的特定代码，而不用我们不需要的可以做复杂事情的通用代码。另一方面，代码是敌人，拥有必要的代码比拥有更多的代码更好。引入新的依赖关系时要权衡。</p>\n<p><strong>24. 共享代码所有权是我们目标；沉默的知识不是好知识。</strong>这意味着最低限度要讨论或记录设计决策和重要的实施决策。代码评审（Code Review）是开始讨论设计决策的最坏时刻，因为在代码编写后，很难彻底更改。（当然在评审时指出并修改设计错误比没有好。）</p>\n<p><strong>25. 生成器很棒！</strong>它们通常比迭代或重复执行的状态对象更短更容易理解。David Beazley的《系统程序员的生成器诀窍》(《Generator Tricks for Systems Programmers》)是关于生成器一个很好的介绍。</p>\n<p><strong>26.让我们成为工程师！让我们考虑设计、构建健壮并实现良好的系统，而不是做膨胀的有机怪物。</strong>然而编程是一种平衡。我们并不总是建造火箭。过度设计（洋葱架构）同设计不完善的代码一样，处理起来非常痛苦。Robert Martin 的作品几乎都值得一读，《架构之洁：一个工匠的软件结构和设计指南》(《Clean Architecture: A Craftsman’s Guide to Software Structure and Design》)是这个话题一个很好的资源。《设计模式》(《Design Patterns》)是每一位工程师都应该阅读的经典编程书。</p>\n<p><strong>27. 间歇失败的测试会侵蚀测试套件的价值，以至于最终每个人都忽略测试运行结果，因为总有一些失败的事情。</strong>修复或删除间歇性失败测试是痛苦的，但这些努力是值得的。</p>\n<p><strong>28. 一般来说，特别是在测试中，在需要等待一个特定的变化时候不要采用休眠随机时间的方式。</strong>Voodoo（Python 库） 的 sleeps 很难理解而且使你的测试套件变慢。</p>\n<p><strong>29. 至少让你的测试失败一次。</strong>故意加入一个错误，并确保它失败，或在测试的行为不完整的情况下运行测试。否则你不知道你真的在测试什么。瞎写的测试实际上不能测试任何东西或它很可能永远不会失败。</p>\n<p><strong>30. 最后一点：只关注特性改进是开发软件的一种可怕方式。</strong>如果开发者的工作不能确保最好的结果，那么不要让他们为自己的工作感到自豪。不处理技术债务会使开发变慢并最终导致产品更糟，问题更多。</p>\n<p>感谢 Ansible 团队，尤其是 Wayne Witzel，为改善这个列表中的准则而提出的意见和建议。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111586\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111586votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111586\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 6 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/maifansnet\">maifans</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/maifansnet\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2015/04/8fbdaaa5ea6d3b49c8c1c825aafeb5d9.png\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            软件工程师，关注人工智能，关注医疗器械。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/maifansnet\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/maifansnet/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/maifansnet/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 13</a>        </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/06/ff44b5eb59d4099f998494217811a2b9.jpg', 'full/af2aa7503b9a5a4b73437fab997885a3d7f1ae8e.jpg'),
('给非英语母语的人从事开源项目的若干建议', '2017-07-07', 'http://blog.jobbole.com/111506/', 'a374e125ab3d41e57b4634a2be532439', 4, 1, 'IT技术, 开源, 英语', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://opensource.com/article/17/1/non-native-speakers-take-open-source-communities\">opensource.com</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-8619-1.html\">Linux中国/zhousiyu325</a>   </div><p>大多数的开源项目的主要语言都是英语，但是开源项目的用户和贡献者却遍布全球。非英语母语的人在参与这个生态系统时会面临许多沟通和文化上的挑战。</p>\n<p>在这篇文章中，作为不以英语为母语的 OpenStack 的贡献者的我们将会分享一些所面临挑战——如何去克服它们，还有一些好的方案，它们能够减轻不以英语为母语且刚开始从事的人的焦虑。我们的总部在日本、巴西和中国，每天都会与世界各地的大型 OpenStack 社区合作。</p>\n<p>OpenStack 的官方语言是英语，这意味着我们是作为非英语为母语的人士来进行交流。</p>\n<h3 id=\"toc_1\">挑战</h3>\n<p>非英语为母语的人士在开源社区工作时会面临具体沟通挑战：它们与有限的语言技能和文化差异有关。</p>\n<h4 id=\"toc_2\">语言技能</h4>\n<p>让我们来关注在阅读、写作、听力和口语背后的具体语言技能。</p>\n<p><strong>阅读</strong>：这是最简单也是最重要的技能。最简单是因为：如果你不明白写了什么，你有机会再次阅读它，或者需要的话可以多次阅读。如果你遇到了一个不常见的短语、表达式或者缩写，你可以使用一个词典或者翻译器。在另一方面，它是最重要的技能是因为：对大多数开源项目而言，主要的交流方式都是邮件列表和 IRC。</p>\n<p><strong>写作</strong>：英语语法是一个问题，尤其是对句子结构不同的语言而言。这可能会在用电子邮件进行通信和通过 IRC 频道进行通信时产生问题。对一些人来说，写出又长又漂亮的句子比较困难，而普遍依赖于简单句子，这是因为这些易于书写和理解。</p>\n<p><strong>听力</strong>：这对非英语为母语的人来说比阅读和写作更加困难。通常，英语为母语的人之间的对话在非常快的，这就使得那些仍然处于刚从事阶段的人很难理解他们的讨论，同时也限制了他们参与到讨论当中。此外，试图理解一个遍布全球的社区的各种口音也增加了复杂性。有意思的是，美国人的发音往往比其他的容易理解。</p>\n<p><strong>口语</strong>：口语比听力更加的困难，因为参与者的词汇量可能会比较有限。而且，英语的音素和语法通常与那些母语不是英语的人的母语相差很大，这就使得互动更加的难以理解。</p>\n<h4 id=\"toc_3\">文化差异</h4>\n<p>在开源社区与其他人交流时，每种文化都有它自己不同的规范。例如，日本人通常不会明确的说好的或者不，他们认为这是尊重别人的一种方式，可以避免彼此间的争论。这通常与其他的文化大不一样，可能会对所表达的内容造成误解。</p>\n<p>在中国文化中，人们倾向于只是说好的，而不是说不，或者试图商讨。在一个像 OpenStack 这样的分布于全球的社区里，这通常会导致在表达意见时缺乏自信。另外，中国人喜欢首先列出事实，然后在后面给出结论，而这会对来自其他文化中的人造成困惑，因为这不是他们所期望的。</p>\n<p>例如，巴西人可能会认为讨论是以类似的方式进行的；然而，其他文化的反应会很直接和简短，这听起来可能会有点粗鲁。</p>\n<h3 id=\"toc_4\">克服障碍</h3>\n<p>语言技能方面的挑战要比文化差异方面的挑战容易克服。文化差异需要被受到尊重，然而英语技能却总是可以被改善的。</p>\n<p>为了刷新你的语言技能，你应该尽可能多地接触该语言。不要担心你的局限，只管尽自己所能，你终将会得到改善。</p>\n<p>尽可能多的阅读，因为这有助于你积累词汇。通过日常的聊天和邮件列表进行交流也很有帮助。一些工具，如实时字典和翻译器，对这些平台非常有用。</p>\n<p>与别人或者你自己交谈可以帮助你更自如地频繁地说话。进行一对一的对话来表达你的想法比在更大的群体中讨论更容易。</p>\n<h3 id=\"toc_5\">新手的融入</h3>\n<p>来自新手和母语者的一些举措可能会对学习过程产生积极的影响。</p>\n<h4 id=\"toc_6\">新手</h4>\n<p>说出和写下你的意见，并且提出你的问题；参与其中总是一个练习你的英语的很好的机会。不要害怕。</p>\n<p>对于会议，确保你提前准备过，这样你将会对会议主题比较熟悉，而且会对自己要表达的意见更加的自信。</p>\n<p>与英语为母语的人结交朋友，多和他们讨论来提高你的英语技能。</p>\n<p>用英语写博客和技术文章也是不错的主意。</p>\n<h4 id=\"toc_7\">给英语为母语的人士的建议</h4>\n<p>请说话慢一点儿，同时使用一些简单的单词和句子。如果你发现了非英语为母语的人使用英语中的一些错误请不要嘲笑他们，尝试鼓励新来的人表达自己的意见，让他们非常舒适地表达意见。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111506\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111506votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111506\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/05/b94146f42c8e0ca2b0f04ed89b59053c.jpg', 'full/dd36e1ac9db2af41888b4a17b76a865bb91d4510.jpg'),
('性能优化知多少', '2017-07-07', 'http://blog.jobbole.com/111734/', 'a59acd84141cd48da7828b24421ff6cb', 3, 2, 'IT技术, 性能', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/sheng-jie/p/7109385.html\">『圣杰』</a>   </div><p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/7e8f770aaadb755d790b921b68fb2214.png\"></p>\n<div id=\"cnblogs_post_body\">\n<h1 id=\"引言\">1. 引言</h1>\n<p>最近一段时间，系统新版本要发布，在beta客户测试期间，暴露了很多问题，除了一些业务和异常问题外，其他都集中在性能上。有幸接触到这些性能调优的机会，当然要学习总结了。</p>\n<p>性能优化是一个老生常谈的问题了，典型的性能问题如页面响应慢、接口超时，服务器负载高、并发数低，数据库频繁死锁等。而造成性能问题又有很多种，比如磁盘I/O、内存、网络、算法、大数据量等等。我们可以大致把性能问题分为四个层次：代码层次、数据库层次、算法层次、架构层次。<br>\n所以下面我会结合实际性能优化案例，和大家分享下性能调优的工具、方法和技巧。</p>\n<h1 id=\"先说心态\">2. 先说心态</h1>\n<p>说到性能问题，你可能首先就想到的是麻烦或者头大，因为一般性能问题都比较紧急，轻则影响客户体验，重则宕机导致财务损失，而且性能问题比较隐蔽，不易发现。因此一时间无从下手，而这时我们就很容易从心底开始去排斥它，不愿接这烫手的山芋。</p>\n<p>而恰巧，性能调优是体现程序员水平的一个重要指标。</p>\n<blockquote><p>因为处理bug、崩溃、调优、入侵等突发事件比编程本身更能体现平庸程序员与理想程序员的差距。当面对一个未知的问题时，如何定位复杂条件下的核心问题、如何抽丝剥茧地分析问题的潜在原因、如何排除干扰还原一个最小的可验证场景、如何抓住关键数据验证自己的猜测与实验，都是体现程序员思考力的最好场景。是的，在衡量理想程序员的标准上，思考力比经验更加重要。</p></blockquote>\n<p>所以，若你不甘平庸，请拥抱性能调优的每一个机会。当你拥有一个正确的心态，你所面对的性能问题就已经解决了一半。</p>\n<h1 id=\"再说技巧\">3. 再说技巧</h1>\n<p>拿到一个性能问题，不要忙着先上工具，先了解问题出现的背景，问题的严重程度。然后大致根据自己的经验积累作出预估。比如客户来了个性能问题说系统宕机了，已经造成资金损失了。这种涉及到钱的问题，大家都比较敏感，根据自己的level，决定是否要接这个锅。这不是逃避，而是自知之明。</p>\n<p>了解问题背景之后，下一步就来尝试问题重现。如果在测试环境能够重现，那这种问题就很好跟踪分析。如果问题不能稳定重现或仅能在生产环境重现，那问题就相对比较棘手，这时要立刻收集现场证据，包括但不限于抓dump、收集应用程序以及系统日志、关注CPU内存情况、数据库备份等等，之后不妨再尝试重现，比如恢复客户数据库到测试环境重现。</p>\n<p>不管问题能否重现，下一步，我们就要大致对问题进行分类，是代码层次的业务逻辑问题还是数据库层次的操作耗时问题，又或是系统架构的吞吐量问题。那如何确定呢？而我倾向于先从数据库动手。我的习惯做法是，使用数据库监控工具，先跟踪下Sql耗时情况。如果监控到耗时较长的SQL语句，那基本上就是数据库层次的问题，否则就是代码层次。若为代码层次，再研究完代码后，再细化为算法或架构层次问题。</p>\n<p>确定问题种类后，是时候上工具来精准定位问题点了：</p>\n<ul>\n<li>Sql耗时问题，推荐使用免费的<a href=\"https://www.sentryone.com/plan-explorer\">Plan Explorer</a>分析执行计划。</li>\n<li>代码问题定位，优先推荐使用VS自带的Performance Analysis，其次是RedGate的性能分析套件<a href=\"http://www.red-gate.com/products/dotnet-development/dotnet-developer-bundle/\">.NET Developer Bundle</a>；然后还有Jet Brains的<a href=\"http://www.jetbrains.com/profiler/?fromMenu\">dotTrace — .NET performance profiler</a>，<a href=\"http://www.jetbrains.com/dotmemory/?fromMenu\">dotMemory– .NET memory profiler</a>；再然后就是反人类的Windbg；等等。</li>\n</ul>\n<p>精准定位问题点后，就是着手优化了。相信到这一步，就是优化策略的选择了，这里就不展开了。</p>\n<p>优化后，最后当然要进行测试了，毕竟优化了多少，我们也要做到心里有谱才行。</p>\n<p>以上啰啰嗦嗦有点多，下面我们直接上案例。</p>\n<h1 id=\"案例分享\">4. 案例分享</h1>\n<p>下面就分享下我针对代码层面、数据库层面和算法层面的优化案例。</p>\n<h1 id=\"sql优化案例\">4.1. SQL优化案例</h1>\n<blockquote><p>案例1：客户反馈某结算报表统计十天内的数据耗时10mins左右。</p></blockquote>\n<p>由于前几天刚学会用RedGate的分析工具，拿到这个问题，本地尝试重现后，就直接想使用工具分析。然而，这工具在使用webdev模式起站点时，总是报错，而当时时一根筋，老是想解决这个工具的报错问题。结果，白白搞了半天也没搞定。最后不得已放弃工具，转而选择使用sql server profiler去监控sql语句耗时。一跟踪不要紧，问题就直接暴露了，整个全屏的重复sql语句，如下图。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/06c352459b736d66075fe293d43e97f3.png\" alt=\"Sql Profiler监控结果\"></p>\n<p>这下问题就很明显了，八成是代码在循环拼接sql执行语句。根据抓取到sql关键字往代码中去搜索，果然如此。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005f0d7ea6631644446\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#region更新三张表数据结合的中间临时表数据，有上游单据的直接调拨单分多次下推时，只计算一次的调拨数量和价税合计\r\nstring sSql = string.Format(@\r\n\"SELECT FENTRYID FROM {0} GROUP BY FENTRYID HAVING COUNT(FENTRYID) &gt; 1\", sJoinDataTempTable);\r\nusing(IDataReader reader = DBUtils.ExecuteReader(this.Context, sSql)) {\r\n    while (reader.Read()) {\r\n        sbSql.AppendFormat(@\"\r\nUPDATE {0} SET FDIRECTQTY = 0,FALLAMOUNT = 0 \r\nWHERE FSEQ NOT IN (\r\nSELECT TOP 1 FSEQ FROM {0} WHERE FENTRYID = {1}) AND FENTRYID = ({1});\"\r\n, sJoinDataTempTable, Convert.ToInt32(reader[\"FENTRYID\"]));\r\n        listSqlObj.Add(new SqlObject(sbSql.ToString(), new List &lt; SqlParam &gt; ()));\r\n        sbSql.Clear();\r\n    }\r\n}\r\n#endregion</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ea6631644446-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ea6631644446-15\">15</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-1\"><span class=\"crayon-p\">#region更新三张表数据结合的中间临时表数据，有上游单据的直接调拨单分多次下推时，只计算一次的调拨数量和价税合计</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-2\"><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sSql</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-3\"><span class=\"crayon-s\">\"SELECT FENTRYID FROM {0} GROUP BY FENTRYID HAVING COUNT(FENTRYID) &gt; 1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-4\"><span class=\"crayon-e\">using</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IDataReader </span><span class=\"crayon-v\">reader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DBUtils</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ExecuteReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sSql</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Read</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendFormat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-7\"><span class=\"crayon-s\">UPDATE {0} SET FDIRECTQTY = 0,FALLAMOUNT = 0 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-8\"><span class=\"crayon-s\">WHERE FSEQ NOT IN (</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-9\"><span class=\"crayon-s\">SELECT TOP 1 FSEQ FROM {0} WHERE FENTRYID = {1}) AND FENTRYID = ({1});\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-10\"><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Convert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToInt32</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"FENTRYID\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">listSqlObj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SqlObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SqlParam</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Clear</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ea6631644446-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ea6631644446-15\"><span class=\"crayon-p\">#endregion</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>看到这段代码，咱先不评判这段代码的优劣，因为毕竟代码注释清晰，省了我们理清业务的功夫。这段sql主要是想做去重处理，很显然选用了错误的方案。改后代码如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005f0d7eb2167971391\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstring sqlMerge = string.Format(@\"\r\nmerge into {0} t1\r\nusing(\r\nselect min(Fseq) fseq,Fentryid from {0} t2 group by fentryid\r\n) t3 on (t1.fentryid = t3.fentryid and t1.fseq &lt;&gt; t3.fseq)\r\nwhen matched then\r\nupdate set t1.FDIRECTQTY = 0, t1.FALLAMOUNT = 0\r\n\", sJoinDataTempTable);\r\n\r\nlistSqlObj.Add(new SqlObject(sqlMerge, new List &lt; SqlParam &gt; ()));\r\nsbSql.Clear();</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005f0d7eb2167971391-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7eb2167971391-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7eb2167971391-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7eb2167971391-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7eb2167971391-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7eb2167971391-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7eb2167971391-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7eb2167971391-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7eb2167971391-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7eb2167971391-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7eb2167971391-11\">11</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005f0d7eb2167971391-1\"><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sqlMerge</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7eb2167971391-2\"><span class=\"crayon-s\">merge into {0} t1</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7eb2167971391-3\"><span class=\"crayon-s\">using(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7eb2167971391-4\"><span class=\"crayon-s\">select min(Fseq) fseq,Fentryid from {0} t2 group by fentryid</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7eb2167971391-5\"><span class=\"crayon-s\">) t3 on (t1.fentryid = t3.fentryid and t1.fseq &lt;&gt; t3.fseq)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7eb2167971391-6\"><span class=\"crayon-s\">when matched then</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7eb2167971391-7\"><span class=\"crayon-s\">update set t1.FDIRECTQTY = 0, t1.FALLAMOUNT = 0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7eb2167971391-8\"><span class=\"crayon-s\">\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sJoinDataTempTable</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7eb2167971391-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7eb2167971391-10\"><span class=\"crayon-v\">listSqlObj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SqlObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sqlMerge</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SqlParam</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7eb2167971391-11\"><span class=\"crayon-v\">sbSql</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Clear</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>改后测试相同数据量，耗时由10mins降到10s左右。</p>\n<h1 id=\"代码优化案例\">4.2. 代码优化案例</h1>\n<blockquote><p>案例2：客户反馈销售订单100条分录行，保存进行可发量校验时，耗时7mins左右。</p></blockquote>\n<p>拿到这个问题后，本地重现后，监控sql耗时没有异常，那就着重分析代码了。因为可发量校验的业务逻辑极其复杂，又加上又直接再一个类文件实现该功能，3500+行的代码，加上零星注释，真是让人避之不及。逃避不是办法，还是上工具分析一把。<br>\n这次我选用的时VS自带的<strong><a href=\"https://msdn.microsoft.com/en-us/library/ms182372.aspx\">Performance Profiler</a></strong>，开发环境下极其强大的性能调优工具。针对我们当前案例，我们仅需要跟踪指定服务对应的dll即可，使用步骤如下：</p>\n<ol>\n<li>Analyze–&gt;Profiler–&gt;New Performance Session</li>\n<li>打开Performance Explorer</li>\n<li>找到新添加的Performance Session，右键Targets，然后选择Add Target Binary，添加要跟踪的dll文件即可</li>\n<li>将应用跑起来</li>\n<li>选中Performance Session，右键Attach对应进程即可跟踪分析性能了</li>\n<li>在跟踪过程中，可随时暂停跟踪和停止跟踪</li>\n</ol>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/864dcb9eca7c345f430a8da89eac5fd1.png\" alt=\"图示步骤\"></p>\n<p>跟踪结束后本案例跟踪到的采样结果如下图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9647efb1b254108019ea972563dc630f.png\" alt=\"VS Performance Profiler分析报告\"></p>\n<p>同时Performance Profiler也给出了问题的建议，如下图：<br>\n<img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/88c42b11fa5d0dd0e4471c3d0bccaf10.png\" alt=\"VS Performance Profiler分析提示\"></p>\n<p>其中第1、4条大致说明程序I/O消耗大，第一代的GC上存在未及时释放的垃圾占比过高。而根据上图的采样结果，我们可以直接看出是由于再代码中频繁操作DataTable引起的性能瓶颈。走读代码发现的确如此，所有的数量统计都是在代码中循环遍历DataTable进行处理的。而最终的优化策略，就相当于一次大的重构，将所有代码中通过遍历DataTable的计算逻辑全部挪到SQL中去做。由于代码过多，就不再放出。</p>\n<blockquote><p>案例3：客户反馈批量引入1000张订单，耗时40mins左右，且容易中断。</p></blockquote>\n<p>同样，我们还是先尝试本地重写。经测试批量引入101张单据，就耗时5mins左右。下一步打开Sql监控工具也未发现耗时语句。但考虑到是批量导入操作，虽然单个耗时不多，但乘以100这个基数，就明显了。下面我们就使用RedGate的<a href=\"http://www.red-gate.com/products/dotnet-development/ants-performance-profiler/\">Ants Performance Profiler</a>跟踪一下。</p>\n<p>该工具比较直观，可以同时监控代码和SQL执行情况。第一步，New Profiler Session，第二步进行设置，如下图。根据自己的应用程序类别，选择相应的跟踪方式。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/12d765271a5c2637c6242b6a4df95256.png\" alt=\"跟踪设置\"></p>\n<p>针对这个问题，我们跟踪到的调用堆栈和SQL耗时结果如下图：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9610679af9557a4ae695b8b1c675c787.png\" alt=\"调用堆栈监控结果\"></p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/754712efddfa3eb40a7eb32b192db06c.png\" alt=\"SQL监控结果\"></p>\n<p>首先从调用堆栈中的Hit Count，我们可以首先看出它是一个批量过程，因为入口函数仅调用一次；第二个我们可以代码中是循环处理每一个单据，因为Hit Count与我们批量引入的单据数量相符；第三个，突然来了个10201，如果有一定的数字敏感性的话，这次性能问题的原因就被你找到了。这里就不卖关子了，101 x 101 = 10201。<br>\n是不是明白了什么，存在循环嵌套循环的情况。我们走读代码确定一下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005f0d7ebc427802777\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//Save.cs\r\npublic override void EndOperationTransaction(EndOperationTransactionArgs e) {\r\n    //省略其他代码\r\n    foreach(DynamicObject dyItem in e.DataEntitys) {\r\n        //反写收款单\r\n        WriteBackReceiveBill wb = new WriteBackReceiveBill();\r\n        wb.WriteBackForSave(e, this.Context);\r\n    }\r\n}\r\n\r\n//WriteBackReceiveBill .cs\r\npublic void WriteBackForSave(EndOperationTransactionArgs e, Context contx) {\r\n    //省略其他代码：\r\n    foreach(DynamicObject item in e.DataEntitys) {\r\n        //do something \r\n    }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005f0d7ebc427802777-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596005f0d7ebc427802777-17\">17</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-1\"><span class=\"crayon-c\">//Save.cs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">override </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EndOperationTransaction</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EndOperationTransactionArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//省略其他代码</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DynamicObject </span><span class=\"crayon-e\">dyItem </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">DataEntitys</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">//反写收款单</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">WriteBackReceiveBill </span><span class=\"crayon-v\">wb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WriteBackReceiveBill</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wb</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteBackForSave</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Context</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-9\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-10\"> </div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-11\"><span class=\"crayon-c\">//WriteBackReceiveBill .cs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-12\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WriteBackForSave</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">EndOperationTransactionArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Context </span><span class=\"crayon-v\">contx</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//省略其他代码：</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">foreach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">DynamicObject </span><span class=\"crayon-e\">item </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">DataEntitys</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-c\">//do something </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005f0d7ebc427802777-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596005f0d7ebc427802777-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>好嘛，外层套了一个空循环却什么也没做。修改就很简单了，删除无效外层循环即可。</p>\n<h1 id=\"算法优化案例\">4.3. 算法优化案例</h1>\n<blockquote><p>案例4：某全流程跟踪报表超时。</p></blockquote>\n<p>这个报表是用来跟踪所有单据从下单到出库的业务流程数据流转情况。而所有的流程数据都是按照树形结果存储在数据库表中的，类似这样：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1a5f6eb8189dc0b3c9fa092e00488f2e.png\" alt=\"流程树表\"></p>\n<p>图中的流程为：<br>\n销售合同–&gt;销售订单–&gt;发货通知单–&gt;销售出库单</p>\n<p>为了构造流程图，之前的处理方法是把流程数据取回来，通过代码构造流程图。这也就是性能差的原因。</p>\n<p>而针对这种情况，就是考验我们平时经验积累了。对于树形结构的表，我们也是可以通过SQL来进行直接查询的，这就要用到了SQL Server的CTE语法来进行递归查询。关于递归查询，可参考我这篇文章：<a href=\"http://www.jianshu.com/p/ab9d268aa54c\">SQL递归查询知多少</a>。这里就不展开了。</p>\n<h1 id=\"总结\">5.总结</h1>\n<p>性能调优是一个循序渐进的过程，不可能一蹴而就，重在平时的点滴积累。关于工具的选择和使用，本文并未展开，也希望读者也不要纠结与此。当你真正想解决一个问题的时候，相信工具的使用是难不住你的。</p>\n<p>最后就大致总结下我的调优思路：</p>\n<ol>\n<li>调整心态，积极应对</li>\n<li>了解性能背景， 收集证据， 尝试重现</li>\n<li>问题分类，先监控SQL耗时，大致确定是SQL或是代码层次原因</li>\n<li>使用性能分析工具，确定问题点</li>\n<li>调优测试</li>\n</ol>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111734\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111734votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111734\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/7e8f770aaadb755d790b921b68fb2214.png', 'full/5b48951660a3dd574009dd9dfb69981fce68b26a.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('程序员生涯第一生存法则', '2017-07-07', 'http://blog.jobbole.com/111627/', 'a6d7be3180bc17350825a84d5e402c60', 6, 5, '职场, , 程序员, 职场', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://mp.weixin.qq.com/s/deP25x394QP0lSItHFWs4Q\">世相微语</a>   </div><p><strong>程序员的职业生涯，第一生存法则是什么？</strong></p>\n<p>追求理想、兴趣与爱好？ 不免有点奢侈。坚守道德、信仰与纯粹？ 也许太高尚了。</p>\n<p>平衡生活与工作、兼顾家庭与公司、妥善处理人际关系、熟练掌握沟通能力与谈判能力、扩大社交圈、耐得住寂寞、熬得了夜、活到老充电充到老、懂得取舍与妥协、低调做人高调做事… <strong>本文暂不打算灌输这类心灵鸡汤。</strong></p>\n<p>打开格局、扩大视野、开阔眼界、看准趋势、远见卓识，成为华尔街的宽客、CEO、CTO、首席科学家、首席架构师… 不幸的是，<strong>90%的量产程序员穷极一生，也注定无缘赖此生存，因为这个领域，天赋与机遇缺一不可。</strong></p>\n<p>数据结构、设计模式、算法架构、模型抽象、操作系统原理、编译器原理、概率统计、数论、代数、几何、微分… 相信我，<strong>90%的量产程序员编程10年，赖此生存的时间也不超过10天。</strong></p>\n<hr>\n<p>那程序员生涯的第一生存法则是什么？</p>\n<p><strong>很简单，拥抱开源，拥抱变化。</strong><strong>远离远离开源的公司，远离技术落伍许久的团队。</strong></p>\n<p><strong>职业生涯，无论做什么，第一要务是生存，而且应该是越过越舒适的生存。</strong><strong>譬如律师、医生，程序员亦是如此。</strong></p>\n<p>程序员，到 34 岁了，被公司直接或变相辞退了，是挺悲催的。</p>\n<p>但更悲催的是，离开这里，居然无法找到（至少）和之前同水平待遇的工作…</p>\n<hr>\n<p><strong>原因何在？</strong></p>\n<p>因为不少程序员都固执的认为自己所在的公司、所在的部门、所在的团队会基业长青，自己只需要埋头苦干，耕耘好自己的一亩三分地就能安享太平。</p>\n<p><strong>可现实是，你的工作并不是你想象的那样不可替代，你的业务代码也许一个初出茅庐的毕业生就可以接手，你的团队、部门、甚至公司也可能会在你想象不到的时刻宣布解散。</strong></p>\n<p>如果你的工作只是基于公司内部的闭源框架或陈旧的架构体系，调用一下接口，写写业务代码，修复一下bug，离开这里，还剩多少竞争力呢？</p>\n<p>试想一下，同样是业务系统开发，一个基于Spring（称得上Java第一开源框架）、Spark（大数据开源框架）、Kafka（消息中间件）开发的程序员，和一个基于Spriii、Spaaa、Kafff（泛指公司内部专用的框架）开发的程序员，能力相当，走出这家公司谁更吃香？</p>\n<p>再试想一下，同样是应用开发，一个玩转 Spring、Struts、Hibernate（Java开源老三样）的程序员，和一个玩转 Spring、SpringMVC、Mybatis （Java开源新三样）或 Spring Boot 的程序员，水平相当，出去面试谁更可受欢迎？</p>\n<p><strong>即使只是一颗螺丝钉，也要做一颗技术领先，在外界受欢迎的螺丝钉。去哪都能如鱼得水、畅快优游。</strong></p>\n<p><strong>这也是90%的普通程序员，首要应该思考的问题。</strong></p>\n<p>当然，这不是让你心猿意马，而是要时刻保持危机感，否则一不小心就走入了职场死胡同。</p>\n<hr>\n<p><strong>职场上，最好的生存保障是，走出这家公司，我依然能过得很好，或更好。</strong></p>\n<p>公司实行成本优化，开始清退 34+ 的程序员了？挺好，对面那家公司正想双薪挖人。</p>\n<p>项目市场反馈不行，团队面临解散？没事，另外团队的 Leader 前几日刚找我聊了，正希望我加入。</p>\n<p>Salesforce 来推销他们的 SaaS（企业软件即服务）服务了，IT部门又可以优化几个人员了。正好，那家18薪出国游的公司正在招人，技术要求很匹配…</p>\n<hr>\n<p><strong>在一家远离开源的公司，或技术落伍许久的团队，即使你是首席架构、技术总监，熟练掌握公司或团队内部的各种框架，配置和接口倒背如流，还能一一填埋这些框架的各种坑，那又如何？</strong></p>\n<p><strong>35岁了，换了一家公司，也许你又归零成了小白，因为别人不玩你这一套。</strong></p>\n<p>诺基亚塞班系统的专家，别说去微软了，即使去诺西（诺基亚西门子通信的简称），很多都得从头再来。</p>\n<p>百度 Pyramid（细节自行百度）项目组的大拿，还不如一个精通 Hadoop 配置的工程师更有市场。</p>\n<p>SAP、Oracle EBS 开发的资深工程师，选择公司的余地远比不上一个初级 React 工程师。</p>\n<p>之前参加过一些创业项目的路演，遇到过一个项目，创始人是两位博士，号称研发了最先进的深度学习算法，用于医学扫描成像的癌症诊断。</p>\n<p>但是，TensorFlow（谷歌）、CNTK（微软）等深度学习开源框架的图像识别算法，在癌症检测方面也许可以碾压小创业团队所谓的绝门秘笈。挺替他们的投资人担心的…</p>\n<hr>\n<p><strong>目前为止，只说了 90% 的普通程序员，那还有 10% 精英程序员呢？</strong></p>\n<p><strong>毫无疑问，精英程序员更应该拥抱开源，因为那才是实现个人价值，提升个人影响力的最佳途径。</strong></p>\n<p>如果 Spring 没有开源，就不可能获得如此广泛的应用，Rod Johnson（Spring 之父）的影响力也会大打折扣。</p>\n<p>如果 Lucene、Hadoop 没有开源，很多人可能都不知道 Doug Cutting（Lucene、Hadoop 之父）为何许人也。</p>\n<p>如果 Linux、Git 没有开源，也许就没有 Linus Torvalds（Linux、Git 之父）的享誉世界。更重要的是，这个世界可能会被更多的蝗虫入侵。</p>\n<p><em>注：“突然间，到处都是微软的产品了，被蝗虫入侵了似的。我并不是说蝗虫是坏蛋，我喜欢所有的动物和昆虫。” —— 摘自 Linus Torvalds 语录：</em></p>\n<p><strong>诚然，如上的大神毕竟凤毛麟角。但大牛级别的程序员走向开源，带来的个人影响力、声誉、技术伙伴、收入、成就感等，都是实实在在的。</strong></p>\n<hr>\n<p><strong>说了这么多，也许你也挺无奈的，因为你所在的项目所用的技术体系，刚好是公司专有且闭源的，那怎么办？</strong></p>\n<p>你可以默默的把这篇文章转给你们技术领导看看，看他有没有这个思想觉悟。</p>\n<p>如果领导悟性不够，半晌没有回应，你可以提点他一下：无论实习码农，还是技术大牛，现在优秀的人才都拥抱开源去了，我们再这样下去，会招不到优秀的人才的…</p>\n<hr>\n<p><strong>如果非常不幸，你从事的是银行、基金、保险、电信、电力、石油等领域的业务，而且还是古董级别的项目，领导说稳定才是第一位的。那你也有三条路可以走：</strong></p>\n<p>1、祈祷自己早日实现财务自由（据年初的胡润报告，一线城市财富自由门槛是 2.9亿）</p>\n<p>2、祈祷所在的公司（部门）能够基业长青</p>\n<p>3、更新一下简历，准备跳槽吧~</p>\n<p><strong>那这种古董级别的项目怎么办？总得有人维护吧？</strong></p>\n<p><strong>加薪！加薪！加薪！不能给予锦绣未来，就给予更猛烈的薪水吧！</strong></p>\n<hr>\n<p><strong>最后，即使是第一生存法则，也不是金科玉律。因为世上总存在一些奇葩的人，码农这个群体也不例外。</strong></p>\n<p>譬如我找人，最关注的还是逻辑思考能力。写一个新算法，学一门新语言，用一套新框架，不过几周的事情，何必那么纠结。</p>\n<p>不过，玩过 Tensorflow 图像识别与目标检测，跑过 ResNet、Inception 等网络的优先…</p>\n<hr>\n<p><strong>题外话</strong></p>\n<p>本文通篇都是从务实的角度来谈开源的好处，事物都有两面性，那开源的坏处在哪里？</p>\n<p>其实前面也提到了一点，TensorFlow、CNTK 等开源框架的算法，完全可以碾压大多数人工智能创业团队所研发的所谓独门秘诀，特别是通用算法领域。</p>\n<p><strong>也就是说，不少创业团队、研究院、实验室里，一门心思研究底层算法（包括图像识别、语音识别、翻译、NLP等前沿领域）造轮子的精英程序员、研究员可能会因此荒废多年的心血…</strong></p>\n<p>譬如，两个月前，百度推出阿波罗计划，将自家的自动驾驶平台开放。这同时意味着，国内自动驾驶领域的不少创业团队可能会面临被洗牌、解散。如果今后谷歌也来这么一出，行业震荡可想而知。</p>\n<p>前些日子，还听我一位在某大厂研究院视觉识别组的同学说：谷歌物体检测与图像识别的API一开放，他们视觉组辛苦了3、4年的研发心血又白费了…</p>\n<p><strong>可开源是人类社会进化的最优选择，因为只有开源，才能实现人类顶级智慧的充分共享与协作。</strong>除了谷歌、脸书，连一贯封闭的微软、苹果两大巨头都已走向开放。</p>\n<p><strong>开源大潮，浩浩荡荡，顺之者势如破竹，逆之者举步维艰。</strong></p>\n<p>也许自然规律如此，人类宿命如此吧。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111627\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111627votetotal\">5</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111627\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 6 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 3 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2012/08/programmer-developer-at-work.jpg', 'full/bb38d11fb4038702790e0370ed966c50f186ff40.jpg'),
('漫画算法：什么是跳跃表？', '2017-07-07', 'http://blog.jobbole.com/111731/', 'a7e761864e16693a072a866a8afdabb1', 7, 1, '趣文小说, , 算法, 跳跃表', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/bjweimengshu\">玻璃猫</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><p>这是发生在很多年以前的故事……</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/daab64eb4fff66513ac482d07e5ae054.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/890d2a8f840ed95165dcd3df24ed584c.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1ec995966632cc86d75a2511bba11c5c.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/b0c602dc9acb987c129f35169341b74d.jpeg\"></p>\n<p>几天以前……</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/53f3319b898ce41a545b29d930946a2a.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5f1e257214c48a4d8246b9395bb0f0df.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/10dd099feb00060dad6b1339e0db8799.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/45606dfe47cc5586318007d1970f26e5.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0716a40761dbfdbf797543bb24b58945.jpeg\"></p>\n<p>几天之后……</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5f5785668595f59e8ba4778cae9f2d6a.jpeg\"></p>\n<p>拍卖行的商品总数量有几十万件，对应数据库商品表的几十万条记录。</p>\n<p>如果是按照商品名称精确查询还好办，可以直接从数据库查出来，最多也就上百条记录。</p>\n<p>如果是没有商品名称的全量查询怎么办？总不可能把数据库里的所有记录全查出来吧，而且还要支持不同字段的排序。</p>\n<p>所以，只能提前在内存中存储有序的全量商品集合，每一种排序方式都保存成独立的集合，每次请求的时候按照请求的排序种类，返回对应的集合。</p>\n<p>比如按价格字段排序的集合：</p>\n<p>比如按等级字段排序的集合：</p>\n<p>需要注意的是，当时还没有Redis这样的内存数据库，所以小灰只能自己实现一套合适的数据结构来存储。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/8eadcb96909cbebc38292974d5216fab.jpeg\"></p>\n<p>拍卖行商品列表是线性的，最容易表达线性结构的自然是数组和链表。可是，无论是数组还是链表，在插入新商品的时候，都会存在性能问题。</p>\n<p>按照商品等级排序的集合为例，如果使用数组，插入新商品的方式如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/af7f12cccfbda80b967d515acebe79d9.jpeg\"></p>\n<p>如果要插入一个等级是3的商品，首先要知道这个商品应该插入的位置。使用二分查找可以最快定位，这一步时间复杂度是O（logN）。</p>\n<p>插入过程中，原数组中所有大于3的商品都要右移，这一步时间复杂度是O（N）。所以总体时间复杂度是O（N）。</p>\n<p>如果使用链表，插入新商品的方式如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/1bce6be23668647edf9eff28d305c84f.jpeg\"></p>\n<p>如果要插入一个等级是3的商品，首先要知道这个商品应该插入的位置。链表无法使用二分查找，只能和原链表中的节点逐一比较大小来确定位置。这一步的时间复杂度是O（N）。</p>\n<p>插入的过程倒是很容易，直接改变节点指针的目标，时间复杂度O（1）。因此总体的时间复杂度也是O（N）。</p>\n<p>这对于拥有几十万商品的集合来说，这两种方法显然都太慢了。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e3be5ef6ac109306ee1dd169fb6b8df3.jpeg\"></p>\n<p>——————————————</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/00e8f84563ba3fc4e926f4b8b2f5fe7a.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e795edb90cf7d598d733592920657a97.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/d3cd2a28c4e3e48550d33f7fe4a47fd0.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/02717bbe18ec7d1034580481ffa22e7e.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9bfe1887ff9177a8c0f303de054c79fe.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/377693e7b3f37892f42e4e144f92c362.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0b9b3c90dc0681f0af4963d783dff24d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/15ece5c25170a528131c4e7803c8e0e8.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a58d35069f85e181659f2c8dc98cffbc.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/325af9d7f350486e58b41b32bd254227.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c708e4a0c267b5e9f3a37ad309e6c3e8.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/fa5f0684ada4d509f3e978c104f576ac.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4d469cbe0d0afb9bb7cf2c99f266a5f9.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/d972154799e05c43dc61c56cbc182203.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e0ef1f5c4cbfa110713984f06904c97a.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/bb33df3e70571a35b0d38cfa2aa0f719.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c66bd9b6ba634f5df05dfb4931201217.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/757e77b87645239013108a7eac7cac78.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a502d32bad14a5943b78e5ec283eb6a3.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ea99ed67b7cdb47d04c3703f12a64bc4.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e98cfa966bb1cfa58a5e8a11505a3e0f.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/6e5972f05c028476a0b2eb43850a1432.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ea50cbc49ca84c72b94cb693d121c017.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/3063e527ca511c457824b146b3047fb2.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/ad1e060829476ef9de94d33ea246009d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/f0fed037f81a07b51108a6d6468e4235.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/6f7628b9803eaae385222da353b34b83.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0b69b19d022c8a75aa2d83fca3d10066.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/a327ac84038bdf376496a07a5d61d23d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/98b8caa7a5b7da9aaf7999a7f502fd92.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/df485893afb0b40cfec65ce19233faa6.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0c38e0ee3659932960bbc9b3c310fab8.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/dedddf4bf8ad251e479ce73ef0f628c9.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4b8a95bfc81b232d79b2c8056ca454ec.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/4f6bafe8717d30780a0bc7ae1110c37d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/9e92dc231f4069da54a71fa6be3bd12e.jpeg\"></p>\n<p>新节点和各层索引节点逐一比较，确定原链表的插入位置。O（logN）</p>\n<p>把索引插入到原链表。O（1）</p>\n<p>利用抛硬币的随机方式，决定新节点是否提升为上一级索引。结果为“正”则提升并继续抛硬币，结果为“负”则停止。O（logN）</p>\n<p>总体上，跳跃表插入操作的时间复杂度是O（logN），而这种数据结构所占空间是2N，既空间复杂度是 O（N）。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/95b14789cf228b85159be05aa93cbaa4.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0a64ff5e6453328bf1360416339c0adb.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0da2ce061fbca4790c93b0139e66d289.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/86a6084f88fa592dd304e890b72409eb.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/7c32aa5ab5f2c936078f16840eabf1b2.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/41d9de8c654dc43b0f1703b0e29c6590.jpeg\"></p>\n<p>自上而下，查找第一次出现节点的索引，并逐层找到每一层对应的节点。O（logN）</p>\n<p>删除每一层查找到的节点，如果该层只剩下1个节点，删除整个一层（原链表除外）。O（logN）</p>\n<p>总体上，跳跃表删除操作的时间复杂度是O（logN）。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/24f060f88decdf946d1069ce4c82f57d.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e7566dee2274eb9bfcefcc13c1a7494c.jpeg\"></p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/07/869228a1933d8e4a9e8ec81afc0603d5.jpeg\"></p>\n<p>小灰和大黄并不知道，他们的这一解决方案和若干年后Redis当中的Sorted-set不谋而合。而Sorted-set这种有序集合，正是对于跳跃表的改进和应用。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我写出更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏作者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我写出更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/10/2df4a3ede6e684f78858dfde0e7b118f.jpeg\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111731\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111731votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111731\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 7 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 4 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/bjweimengshu\">玻璃猫</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/bjweimengshu\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2016/09/7ce4028f2cece3294efcb3e5caa73af1.jpeg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            互联网公司的码农一枚，喜欢算法和面向对象设计。个人微信号：13522239721 个人订阅号：dreamsee321欢迎一起交流讨论！        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/bjweimengshu\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/bjweimengshu/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/bjweimengshu/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 92</a> · <a title=\"个人微信：bjweimengshu\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/daab64eb4fff66513ac482d07e5ae054.jpeg', 'full/27823440373381b04421fc70634750dfcfca3b30.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('用 C 语言写一个简单的 Unix Shell（1）', '2017-07-07', 'http://blog.jobbole.com/111738/', 'b7afdd1e2e7420b9ab8f1ad96f32df50', 1, 1, 'C/C++, 开发, C语言, shell', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/qdoverture\">效楚</a> 翻译，<a href=\"http://www.jobbole.com/members/upanblack\">Panblack</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://indradhanush.github.io/blog/writing-a-unix-shell-part-1/\">Indradhanush Gupta</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【导读】：作者用 C 语言实现了一个简易的unix shell，通过本文可加深对 shell 和 Unix 系统原理的理解。</p>\n<hr>\n<p>写 Unix shell 是我正在 RC 研究的一个项目。这是第一部分，后续会有一系列的文章。</p>\n<p><strong>免责声明：我不是编写 shell 这个课题的专家，我是一边自学一边分享我的发现。</strong></p>\n<h2>shell 是什么？</h2>\n<p>关于这一点已经有很多书面资料，所以对于它的定义我不会探讨太多细节。只用一句话说明：</p>\n<blockquote><p>shell 是允许你与操作系统的核心作交互的一个界面（interface）。</p></blockquote>\n<h2 id=\"how-does-a-shell-work\">shell 是怎样工作的？</h2>\n<p>shell解析用户输入的命令并执行它。为了能做到这一点，shell的工作流程看起来像这样：</p>\n<ol>\n<li style=\"padding-left: 30px;\">启动shell</li>\n<li style=\"padding-left: 30px;\">等待用户输入</li>\n<li style=\"padding-left: 30px;\">解析用户输入</li>\n<li style=\"padding-left: 30px;\">执行命令并返回结果</li>\n<li style=\"padding-left: 30px;\">回到<span style=\"color: #808080;\">第 2 步</span>。</li>\n</ol>\n<p>但在这整个流程中有一个重要的部分：<strong>进程</strong>。shell是父进程。这是我们的程序的<span style=\"color: #808080;\">主</span>线程，它等待用户输入。然而，由于以下原因，我们不能在<span style=\"color: #808080;\">主</span>线程自身中执行命令：</p>\n<ol>\n<li style=\"padding-left: 30px;\">一个错误的命令会导致整个shell停止工作。我们要避免此情况。</li>\n<li style=\"padding-left: 30px;\">独立的命令应该有他们自己的进程块。这被称为隔离，属于容错（机制）。</li>\n</ol>\n<h2 id=\"fork\">Fork</h2>\n<p>为了能避免此情况，我们使用系统调用 <span style=\"color: #808080;\">fork</span>。我曾以为我理解了 <span style=\"color: #808080;\">fork</span>，直到我用它写了大约4行代码（才发现我没有理解）。</p>\n<p><code class=\"highlighter-rouge\"></code><span style=\"color: #808080;\">fork</span> 创建当前进程的一份拷贝。这份拷贝被称为<span style=\"color: #808080;\">“子进程”</span>，系统中的每个进程都有与它联系在一起的唯一的进程 id（pid）。让我们看以下代码片段：</p>\n<p><a href=\"https://indradhanush.github.io/code/shell-part-1/fork.c\"><i>fork.c</i></a></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d830818775708\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\n\r\nint\r\nmain() {\r\n    pid_t child_pid = fork();\r\n        \r\n    // The child process\r\n    if (child_pid == 0) {\r\n        printf(\"### Child ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    } else {\r\n        printf(\"### Parent ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    }\r\n \r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d830818775708-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d830818775708-19\">19</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-2\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-4\"> </div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-5\"><span class=\"crayon-t\">int</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-6\"><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-8\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// The child process</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Child ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-12\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Parent ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-15\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-17\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d830818775708-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d830818775708-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0028 seconds] -->\r\n<p><span style=\"color: #808080;\">fork</span> 系统调用返回两次，每个进程一次。这一开始听起来是反直觉的。但让我们看一下在底层发生了什么。</p>\n<ol>\n<li style=\"padding-left: 30px;\">通过调用 <span style=\"color: #808080;\">fork</span>，我们在程序中创建了一个新的分支。这与传统的 <span style=\"color: #808080;\">if-else</span> 分支不同。<span style=\"color: #808080;\">fork</span> 对当前进程创建一份拷贝并从中创建了一个新的进程。最终系统调用返回子进程的进程 id。</li>\n<li style=\"padding-left: 30px;\">一旦 <span style=\"color: #808080;\">fork</span> 调用成功，子进程和父进程（我们的代码的主线程）会同时运行。</li>\n</ol>\n<p>为了让你更好理解程序流程，看这个图：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/309a7a84764a07033c28b6ce5511c45c.jpg\"><img class=\"alignnone wp-image-65028 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/309a7a84764a07033c28b6ce5511c45c.jpg\" alt=\"fork\" width=\"594\" height=\"442\"></a></p>\n<p><span style=\"color: #808080;\">fork()</span> 创建了一个新的子进程，但与此同时，父进程的执行并没有停止。子进程执行的开始和结束独立于父进程，反之亦然。</p>\n<p>更进一步讨论以前，先说明一点：<span style=\"color: #808080;\">getpid</span> 系统调用返回当前的进程 id。</p>\n<p>如果你编译并执行这段代码，会得到类似于下面的输出：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d83f669220602\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n### Parent ###\r\nCurrent PID: 85247 and Child PID: 85248\r\n### Child ###\r\nCurrent PID: 85248 and Child PID: 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d83f669220602-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d83f669220602-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d83f669220602-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d83f669220602-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d83f669220602-1\"><span class=\"crayon-p\">### Parent ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d83f669220602-2\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">85247</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">85248</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d83f669220602-3\"><span class=\"crayon-p\">### Child ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d83f669220602-4\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">85248</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>在 <span style=\"color: #808080;\">### Parent ###</span> 下面的片段中，当前进程 ID 是 <span style=\"color: #808080;\">85247</span>，子进程 ID 是 <span style=\"color: #808080;\">85248</span>。注意，子进程的 pid 比父进程的大，表明子进程是在父进程之后创建的。（更新：正如某人在 <a href=\"https://news.ycombinator.com/item?id=14439781\">Hacker News</a> 上正确指出的，这并不是确定的，虽然往往是这样。原因在于，操作系统可能回收无用的老进程 id。）</p>\n<p>在 <span style=\"color: #808080;\">### Child ###</span> 下面的片段中，当前进程 ID 是 <span style=\"color: #808080;\">85248</span>，这与前面片段中子进程的 pid 相同。然而，这里的子进程 pid 为 <span style=\"color: #808080;\">0</span>。</p>\n<p>实际的数字会随着每一次执行而变化。</p>\n<p>你可能在想，我们已经在<span style=\"color: #808080;\">第 9 行</span>明确的给 child_pid 赋了一个值<span style=\"color: #808080;\">（译者注：应该是第7行）</span>，那么 <span style=\"color: #808080;\">child_pid</span> 怎么会在同一个执行流程中呈现两个不同的值，这种想法值得原谅。但是，回想一下，调用 <span style=\"color: #808080;\">fork</span> 创建了一个新进程，这个新进程与当前进程相同。因此，在父进程中，<span style=\"color: #808080;\">child_pid</span> 是刚创建的子进程的实际值，而子进程本身没有自己的子进程，所以 <span style=\"color: #808080;\">child_pid</span> 的值为 <span style=\"color: #808080;\">0</span>。</p>\n<p>因此，为了控制哪些代码在子进程中执行，哪些又在父进程中执行，需要我们在 12 到 16 行定义的 <span style=\"color: #808080;\">if-else</span> 块<span style=\"color: #0000ff;\">（译者注：应该是 10 到 16 行）</span>。当 <span style=\"color: #808080;\">child_pid</span> 为 <span style=\"color: #808080;\">0</span> 时，代码块将在子进程下执行，而 else 块却会在父进程下执行。这些块被执行的顺序是不确定的，取决于操作系统的调度程序。</p>\n<h2>引入确定性</h2>\n<p>让我向你介绍系统调用 <span style=\"color: #808080;\">sleep</span>。引用 linux man 页面的话：</p>\n<blockquote><p>sleep – 暂停执行一段时间</p></blockquote>\n<p>时间间隔以秒为单位。</p>\n<p>让我们给父进程，即我们代码中的 else 块，加一个 sleep(1) 调用：</p>\n<p><a href=\"https://indradhanush.github.io/code/shell-part-1/sleep_parent.c\"><i>sleep_parent.c</i></a></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d844600802318\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\n\r\nint\r\nmain() {\r\n    pid_t child_pid = fork();\r\n\r\n    // The child process\r\n    if (child_pid == 0) {\r\n        printf(\"### Child ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    } else {\r\n        sleep(1); // Sleep for one second\r\n        printf(\"### Parent ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    }\r\n \r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d844600802318-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d844600802318-20\">20</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-2\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-4\"> </div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-5\"><span class=\"crayon-t\">int</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-6\"><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-8\"> </div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// The child process</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Child ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-12\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">sleep</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Sleep for one second</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Parent ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-16\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-18\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596005e94d844600802318-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d844600802318-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p>当你执行这段代码时，输出将类似这样：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d84c721248895\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n### Child ###\r\nCurrent PID: 89743 and Child PID: 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d84c721248895-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d84c721248895-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d84c721248895-1\"><span class=\"crayon-p\">### Child ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d84c721248895-2\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">89743</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>1秒钟以后，你将看到</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d84f436439648\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n### Parent ###\r\nCurrent PID: 89742 and Child PID: 89743</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d84f436439648-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d84f436439648-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d84f436439648-1\"><span class=\"crayon-p\">### Parent ###</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d84f436439648-2\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">89742</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">89743</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>每次执行这段代码时你会看到同样的表现。这是因为：我们在父进程中做了一个阻塞性的 <span style=\"color: #808080;\">sleep</span> 调用，与此同时，操作系统调度程序发现有空闲的 CPU 时间可以给子进程执行。</p>\n<p>类似的，如果你反过来，把 <span style=\"color: #808080;\">sleep(1)</span> 调用加到子进程，也就是我们代码中的 <span style=\"color: #808080;\">if</span> 块里面，你会发现父进程块立刻输出到控制台上。但你也会发现程序终止了。子进程块的输出被转存到<span style=\"color: #808080;\">标准输出</span>。看起来是这样：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d853776238024\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ gcc -lreadline blog/sleep_child.c -o sleep_child &amp;&amp; ./sleep_child\r\n### Parent ###\r\nCurrent PID: 23011 and Child PID: 23012\r\n$ ### Child ###\r\nCurrent PID: 23012 and Child PID: 0</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d853776238024-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d853776238024-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d853776238024-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d853776238024-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d853776238024-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d853776238024-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gcc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">lreadline </span><span class=\"crayon-v\">blog</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sleep_child</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">o</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sleep_child</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sleep_child</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d853776238024-2\"><span class=\"crayon-p\">### Parent ###</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d853776238024-3\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23011</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23012</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d853776238024-4\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">### Child ###</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d853776238024-5\"><span class=\"crayon-e\">Current </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">23012</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">Child</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PID</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>这段源代码可在 <a href=\"https://indradhanush.github.io/code/shell-part-1/sleep_child.c\">sleep_child.c</a> 获取。</p>\n<p>这是因为父进程在 <span style=\"color: #808080;\">printf</span> 语句之后无事可做，被终止了。然而，子进程在 <span style=\"color: #808080;\">sleep</span> 调用处被阻塞了 1 秒钟，之后才执行 <span style=\"color: #808080;\">printf</span> 语句。</p>\n<h2>正确实现的确定性</h2>\n<p>然而，使用 <span style=\"color: #808080;\">sleep</span> 来控制进程的执行流程不是最好的方法，因为你做了一个 <span style=\"color: #808080;\">n 秒</span>的 <span style=\"color: #808080;\">sleep</span> 调用：</p>\n<ol>\n<li style=\"padding-left: 30px;\">你怎么确保不管你等待的是什么，都会在 <span style=\"color: #808080;\">n 秒</span>内完成执行呢？</li>\n<li style=\"padding-left: 30px;\">不管你等待的是什么，要是它在远远早于 <span style=\"color: #808080;\">n 秒</span>时就结束了呢？在此情况下你不必要地闲置了。</li>\n</ol>\n<p>有一种更好的方法是，使用 <span style=\"color: #808080;\">wait</span> 系统调用（或一种变体）来代替。我们将使用 <span style=\"color: #808080;\">waitpid</span> 系统调用。它带有以下参数：</p>\n<ol>\n<li style=\"padding-left: 30px;\">你想要程序等待的进程的进程 ID。</li>\n<li style=\"padding-left: 30px;\">一个变量，用来保存进程如何终止的相关信息。</li>\n<li style=\"padding-left: 30px;\">选项标志，用来定制 <span style=\"color: #808080;\">waitpid</span> 的行为</li>\n</ol>\n<p><a href=\"https://indradhanush.github.io/code/shell-part-1/wait.c\"><i>wait.c</i></a></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596005e94d857484975365\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#include &lt;unistd.h&gt;\r\n#include &lt;sys/wait.h&gt;\r\n\r\nint\r\nmain() {\r\n    pid_t child_pid;\r\n    pid_t wait_result;\r\n    int stat_loc;\r\n\r\n    child_pid = fork();\r\n        \r\n    // The child process\r\n    if (child_pid == 0) {\r\n        printf(\"### Child ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n        sleep(1); // Sleep for one second\r\n    } else {\r\n        wait_result = waitpid(child_pid, &amp;stat_loc, WUNTRACED);\r\n        printf(\"### Parent ###nCurrent PID: %d and Child PID: %dn\",\r\n               getpid(), child_pid);\r\n    }\r\n \r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596005e94d857484975365-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596005e94d857484975365-26\">26</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-1\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-2\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-3\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-4\"><span class=\"crayon-p\">#include &lt;sys/wait.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-6\"><span class=\"crayon-t\">int</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-7\"><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">pid_t </span><span class=\"crayon-v\">wait_result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">stat_loc</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fork</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-13\"><span class=\"crayon-h\">        </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">// The child process</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Child ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-17\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">sleep</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Sleep for one second</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">wait_result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">waitpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">stat_loc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">WUNTRACED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"### Parent ###nCurrent PID: %d and Child PID: %dn\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-22\"><span class=\"crayon-h\">               </span><span class=\"crayon-e\">getpid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">child_pid</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-24\"><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-596005e94d857484975365-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596005e94d857484975365-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0036 seconds] -->\r\n<p>当你执行这段代码，你会发现子进程块立刻被打印，然后等待很短的一段时间（这里我们在 <span style=\"color: #808080;\">printf</span> 后面加了 <span style=\"color: #808080;\">sleep</span>）。父进程等待子进程执行结束，之后就有空执行它自己的命令。</p>\n<p>第一部分到此结束。这篇博客中的所有代码示例可以在<a href=\"https://github.com/indradhanush/indradhanush.github.io/tree/master/code/shell-part-1/\">这里</a>获取。在<a href=\"https://indradhanush.github.io/blog/writing-a-unix-shell-part-2/\">下一篇</a>中，我们将研究怎样在用户输入时接受命令并执行它。敬请期待。</p>\n<p><strong>致谢</strong></p>\n<p>谢谢 <a href=\"https://github.com/saulpw\">Saul Pwanson</a> 帮助我理解 <span style=\"color: #808080;\">fork</span> 的表现方式，谢谢 <a href=\"https://github.com/jaseemabid\">Jaseem Abid</a> 阅读草稿并提出编辑建议。</p>\n<p id=\"resources\"><strong>参考资料</strong></p>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=k6TTj4C0LF0\">EnthusiastiCon – Stefanie Schirmer：《天哪！在 10 分中内构建一个 shell”</a>》</li>\n<li><a href=\"https://linux.die.net/man/\">Linux man 页面</a></li>\n</ul>\n<p>99e05c43dc61c56cbc182203.jpeg”&gt;</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/8204a635b9f0335c5b2e27498c3d5c97.jpg\">\n            \n                            <img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/0fbc02d33dc26bbfebc27f81bea9cdf9.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111738\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111738votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111738\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/qdoverture\">效楚</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/qdoverture\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/72a13d3690f7c6edc018286f0ae732f6.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            本职工作是IC设计，工作中也经常做脚本编写、嵌入式编程等，对软件和文字翻译亦有浓厚的兴趣。        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/qdoverture\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/qdoverture/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/qdoverture/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 12</a>        </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2015/11/746b03c66c6e4568ab9770632e5c69e9.jpg', 'full/6a97cfe7f7f14e4e38447a57e0284a25fe3ecdad.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('七大查找算法', '2017-07-07', 'http://blog.jobbole.com/111629/', 'cc019be26c351dec19513c88ffcb4c59', 3, 2, 'IT技术, 算法', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/maybe2030/p/4715035.html\">Poll的笔记</a>   </div><p>查找是在大量的信息中寻找一个特定的信息元素，在计算机应用中，查找是常用的基本运算，例如编译程序中符号表的查找。本文简单概括性的介绍了常见的七种查找算法，说是七种，其实二分查找、插值查找以及斐波那契查找都可以归为一类——插值查找。插值查找和斐波那契查找是在二分查找的基础上的优化查找算法。树表查找和哈希查找会在后续的博文中进行详细介绍。</p>\n<p>查找定义：根据给定的某个值，在查找表中确定一个其关键字等于给定值的数据元素（或记录）。</p>\n<p>查找算法分类：<br>\n1）静态查找和动态查找；<br>\n注：静态或者动态都是针对查找表而言的。动态表指查找表中有删除和插入操作的表。<br>\n2）无序查找和有序查找。<br>\n无序查找：被查找数列有序无序均可；<br>\n有序查找：被查找数列必须为有序数列。</p>\n<p><strong>平均查找长度（Average Search Length，ASL）：</strong>需和指定key进行比较的关键字的个数的期望值，称为查找算法在查找成功时的平均查找长度。<br>\n对于含有n个数据元素的查找表，查找成功的平均查找长度为：ASL = P<sub>i</sub>*C<sub>i</sub>的和。<br>\nP<sub>i</sub>：查找表中第i个数据元素的概率。<br>\nC<sub>i</sub>：找到第i个数据元素时已经比较过的次数。</p>\n<h3 class=\"First\">1. 顺序查找</h3>\n<p><span style=\"text-decoration: underline;\"><strong>说明：顺序查找适合于存储结构为顺序存储或链接存储的线性表。</strong></span></p>\n<p>查找成功时的平均查找长度为：（假设每个数据元素的概率相等） ASL = 1/n(1+2+3+…+n) = (n+1)/2 ;</p>\n<p>当查找不成功时，需要n+1次比较，时间复杂度为O(n);</p>\n<p>所以，<span style=\"text-decoration: underline;\"><strong>顺序查找的时间复杂度为O(n</strong><strong>)</strong><strong>。</strong></span></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596007996c681865812925\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//顺序查找\r\nint SequenceSearch(int a[], int value, int n)\r\n{\r\n   int i;\r\n   for(i=0; i&lt;n; i++)\r\n   if(a[i]==value)\r\n   return i;\r\n   return -1;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596007996c681865812925-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c681865812925-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596007996c681865812925-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c681865812925-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596007996c681865812925-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c681865812925-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596007996c681865812925-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c681865812925-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596007996c681865812925-9\">9</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596007996c681865812925-1\"><span class=\"crayon-c\">//顺序查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c681865812925-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SequenceSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c681865812925-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c681865812925-4\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c681865812925-5\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">for</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c681865812925-6\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c681865812925-7\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c681865812925-8\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c681865812925-9\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p></p>\n<h3>2. 二分查找</h3>\n<p><strong>说明：元素必须是有序的，如果是无序的则要先进行排序操作。</strong></p>\n<p><strong>基本思想：</strong>也称为是折半查找，属于有序查找算法。用给定值k先与中间结点的关键字比较，中间结点把线形表分成两个子表，若相等则查找成功；若不相等，再根据k与该中间结点关键字的比较结果确定下一步查找哪个子表，这样递归进行，直到查找到或查找结束发现表中没有这样的结点。</p>\n<p><strong>复杂度分析：</strong>最坏情况下，关键词比较次数为log<sub>2</sub>(n+1)，且<strong>期望时间复杂度为O(log<sub>2</sub>n)</strong>；</p>\n<p>注：<strong>折半查找的前提条件是需要有序表顺序存储，对于静态查找表，一次排序后不再变化，折半查找能得到不错的效率。但对于需要</strong><strong>频繁执行插入或删除操作的数据集来说，维护有序的排序会带来不小的工作量，那就不建议使用。——《大话数据结构》</strong></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596007996c68b409715840\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//二分查找（折半查找），版本1\r\nint BinarySearch1(int a[], int value, int n)\r\n{\r\n int low, high, mid;\r\n low = 0;\r\n high = n-1;\r\n while(low&lt;=high)\r\n {\r\n     mid = (low+high)/2;\r\n     if(a[mid]==value)\r\n     return mid;\r\n     if(a[mid]&gt;value)\r\n     high = mid-1;\r\n     if(a[mid]&lt;value)\r\n     low = mid+1;\r\n }\r\n     return -1;\r\n}\r\n\r\n//二分查找，递归版本\r\nint BinarySearch2(int a[], int value, int low, int high)\r\n{\r\n   int mid = low+(high-low)/2;\r\n   if(a[mid]==value)\r\n   return mid;\r\n   if(a[mid]&gt;value)\r\n   return BinarySearch2(a, value, low, mid-1);\r\n   if(a[mid]&lt;value)\r\n   return BinarySearch2(a, value, mid+1, high);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596007996c68b409715840-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c68b409715840-30\">30</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-1\"><span class=\"crayon-c\">//二分查找（折半查找），版本1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch1</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-4\"><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-6\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-7\"><span class=\"crayon-h\"> </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-8\"><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-9\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">mid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-10\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-11\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-12\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-13\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">high</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-14\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-15\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">low</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-16\"><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-17\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-18\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-20\"><span class=\"crayon-c\">//二分查找，递归版本</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-21\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-22\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-23\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-24\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-25\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-26\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-27\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-28\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c68b409715840-29\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BinarySearch2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c68b409715840-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0052 seconds] -->\r\n<p></p>\n<h3>3. 插值查找</h3>\n<p>在介绍插值查找之前，首先考虑一个新问题，为什么上述算法一定要是折半，而不是折四分之一或者折更多呢？</p>\n<p>打个比方，在英文字典里面查“apple”，你下意识翻开字典是翻前面的书页还是后面的书页呢？如果再让你查“zoo”，你又怎么查？很显然，这里你绝对不会是从中间开始查起，而是有一定目的的往前或往后翻。&lt;</p>\n<p>同样的，比如要在取值范围1 ~ 10000 之间 100 个元素从小到大均匀分布的数组中查找5， 我们自然会考虑从数组下标较小的开始查找。</p>\n<p>经过以上分析，折半查找这种查找方式，不是自适应的（也就是说是傻瓜式的）。二分查找中查找点计算如下：</p>\n<p>mid=(low+high)/2, 即mid=low+1/2*(high-low);</p>\n<p>通过类比，我们可以将查找的点改进为如下：</p>\n<p>mid=low+<span style=\"text-decoration: underline; color: #993300;\">(key-a[low])/(a[high]-a[low])</span>*(high-low)，</p>\n<p>也就是将上述的比例参数1/2改进为自适应的，根据关键字在整个有序表中所处的位置，让mid值的变化更靠近关键字key，这样也就间接地减少了比较次数。</p>\n<p><strong>基本思想：</strong>基于二分查找算法，将查找点的选择改进为自适应选择，可以提高查找效率。当然，差值查找也属于有序查找。</p>\n<p>注：<strong>对于表长较大，而关键字分布又比较均匀的查找表来说，插值查找算法的平均性能比折半查找要好的多。反之，数组中如果分布非常不均匀，那么插值查找未必是很合适的选择。</strong></p>\n<p><strong>复杂度分析：查找成功或者失败的时间复杂度均为O(log<sub>2</sub>(log<sub>2</sub>n))。</strong></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596007996c691827148127\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//插值查找\r\nint InsertionSearch(int a[], int value, int low, int high)\r\n{\r\n     int mid = low+(value-a[low])/(a[high]-a[low])*(high-low);\r\n     if(a[mid]==value)\r\n        return mid;\r\n     if(a[mid]&gt;value)\r\n        return InsertionSearch(a, value, low, mid-1);\r\n     if(a[mid]&lt;value)\r\n        return InsertionSearch(a, value, mid+1, high);\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596007996c691827148127-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c691827148127-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596007996c691827148127-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c691827148127-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596007996c691827148127-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c691827148127-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596007996c691827148127-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c691827148127-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596007996c691827148127-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c691827148127-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596007996c691827148127-11\">11</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596007996c691827148127-1\"><span class=\"crayon-c\">//插值查找</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c691827148127-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InsertionSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c691827148127-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c691827148127-4\"><span class=\"crayon-h\">     </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c691827148127-5\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">==</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c691827148127-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c691827148127-7\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c691827148127-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InsertionSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c691827148127-9\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c691827148127-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InsertionSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c691827148127-11\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0033 seconds] -->\r\n<p></p>\n<h3>4. 斐波那契查找</h3>\n<p>在介绍斐波那契查找算法之前，我们先介绍一下很它紧密相连并且大家都熟知的一个概念——黄金分割。</p>\n<p>黄金比例又称黄金分割，是指事物各部分间一定的数学比例关系，即将整体一分为二，较大部分与较小部分之比等于整体与较大部分之比，其比值约为1:0.618或1.618:1。</p>\n<p>0.618被公认为最具有审美意义的比例数字，这个数值的作用不仅仅体现在诸如绘画、雕塑、音乐、建筑等艺术领域，而且在管理、工程设计等方面也有着不可忽视的作用。因此被称为黄金分割。</p>\n<p>大家记不记得斐波那契数列：1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89…….（从第三个数开始，后边每一个数都是前两个数的和）。然后我们会发现，随着斐波那契数列的递增，前后两个数的比值会越来越接近0.618，利用这个特性，我们就可以将黄金比例运用到查找技术中。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/2d0c7fc61e19c487cc2aa6c2b3193ae9.jpg\"><img class=\"aligncenter wp-image-111632 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/2d0c7fc61e19c487cc2aa6c2b3193ae9.jpg\" alt=\"20150323100632467\" width=\"570\" height=\"197\"></a><br>\n<strong>基本思想：</strong>也是二分查找的一种提升算法，通过运用黄金比例的概念在数列中选择查找点进行查找，提高查找效率。同样地，斐波那契查找也属于一种有序查找算法。</p>\n<p>相对于折半查找，一般将待比较的key值与第mid=（low+high）/2位置的元素比较，比较结果分三种情况：</p>\n<p>1）相等，mid位置的元素即为所求</p>\n<p>2）&gt;，low=mid+1;</p>\n<p>3）&lt;，high=mid-1。</p>\n<p>斐波那契查找与折半查找很相似，他是根据斐波那契序列的特点对有序表进行分割的。他要求开始表中记录的个数为某个斐波那契数小1，及n=F(k)-1;</p>\n<p>开始将k值与第F(k-1)位置的记录进行比较(及mid=low+F(k-1)-1),比较结果也分为三种</p>\n<p>1）相等，mid位置的元素即为所求</p>\n<p>2）&gt;，low=mid+1,k-=2;</p>\n<p>说明：low=mid+1说明待查找的元素在[mid+1,high]范围内，k-=2 说明范围[mid+1,high]内的元素个数为n-(F(k-1))= Fk-1-F(k-1)=Fk-F(k-1)-1=F(k-2)-1个，所以可以递归的应用斐波那契查找。</p>\n<p>3）&lt;，high=mid-1,k-=1。</p>\n<p>说明：low=mid+1说明待查找的元素在[low,mid-1]范围内，k-=1 说明范围[low,mid-1]内的元素个数为F(k-1)-1个，所以可以递归 的应用斐波那契查找。</p>\n<p><strong>复杂度分析：<span style=\"text-decoration: underline;\">最坏情况下，时间复杂度为O(log<sub>2</sub>n)，且其期望复杂度也为O(log<sub>2</sub>n)。</span></strong></p>\n<p><strong>C++实现源码：</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596007996c69a772475547\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// 斐波那契查找.cpp#include \"stdafx.h\"\r\n#include &lt;memory&gt;\r\n#include &lt;iostream&gt;\r\nusing namespace std;\r\nconst int max_size=20;//斐波那契数组的长度\r\n\r\n/*构造一个斐波那契数组*/\r\nvoid Fibonacci(int * F)\r\n{\r\n   F[0]=0;\r\n   F[1]=1;\r\n   for(int i=2;i&lt;max_size;++i)\r\n   F[i]=F[i-1]+F[i-2];\r\n}\r\n\r\n/*定义斐波那契查找法*/\r\nint FibonacciSearch(int *a, int n, int key) //a为要查找的数组,n为要查找的数组长度,key为要查找的关键字\r\n{\r\n   int low=0;\r\n   int high=n-1;\r\n\r\n   int F[max_size];\r\n   Fibonacci(F);//构造一个斐波那契数组F\r\n\r\n   int k=0;\r\n   while(n&gt;F[k]-1)//计算n位于斐波那契数列的位置\r\n   ++k;\r\n\r\n   int * temp;//将数组a扩展到F[k]-1的长度\r\n   temp=new int [F[k]-1];\r\n   memcpy(temp,a,n*sizeof(int));\r\n\r\n   for(int i=n;i&lt;F[k]-1;++i)\r\n   temp[i]=a[n-1];\r\n\r\n   while(low&lt;=high)\r\n{\r\n   int mid=low+F[k-1]-1;\r\n   if(key&lt;temp[mid])\r\n{\r\n   high=mid-1;\r\n   k-=1;\r\n}\r\n   else if(key&gt;temp[mid])\r\n{\r\n   low=mid+1;\r\n   k-=2;\r\n}\r\n   else\r\n{\r\n   if(mid&lt;n)\r\n   return mid; //若相等则说明mid即为查找到的位置\r\n   else\r\n   return n-1; //若mid&gt;=n则说明是扩展的数值,返回n-1\r\n}\r\n}\r\n   delete [] temp;\r\n   return -1;\r\n}\r\n\r\n   int main()\r\n{\r\n   int a[] = {0,16,24,35,47,59,62,73,88,99};\r\n   int key=100;\r\n   int index=FibonacciSearch(a,sizeof(a)/sizeof(int),key);\r\n   cout&lt;&lt;key&lt;&lt;\" is located at:\"&lt;&lt;index;\r\n   return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-596007996c69a772475547-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596007996c69a772475547-68\">68</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-1\"><span class=\"crayon-c\">// 斐波那契查找.cpp#include \"stdafx.h\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-2\"><span class=\"crayon-p\">#include &lt;memory&gt;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-3\"><span class=\"crayon-p\">#include &lt;iostream&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">std</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max_size</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">20</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//斐波那契数组的长度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-6\"> </div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-7\"><span class=\"crayon-c\">/*构造一个斐波那契数组*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-8\"><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Fibonacci</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-10\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-11\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-12\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">for</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">max_size</span><span class=\"crayon-sy\">;</span><span class=\"crayon-o\">++</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-13\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-16\"><span class=\"crayon-c\">/*定义斐波那契查找法*/</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-17\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FibonacciSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//a为要查找的数组,n为要查找的数组长度,key为要查找的关键字</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-18\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-19\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-20\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-22\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">max_size</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-23\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">Fibonacci</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//构造一个斐波那契数组F</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-24\"> </div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-25\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-26\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//计算n位于斐波那契数列的位置</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-27\"><span class=\"crayon-h\">   </span><span class=\"crayon-o\">++</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-28\"> </div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-29\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//将数组a扩展到F[k]-1的长度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-30\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">temp</span><span class=\"crayon-o\">=</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-31\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">memcpy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e \">n*</span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-32\"> </div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-33\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">for</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">;</span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-o\">++</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-34\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-35\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-36\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">&lt;=</span><span class=\"crayon-v\">high</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-37\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-38\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-39\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-40\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-41\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">high</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-42\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">-=</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-43\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-44\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-45\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-46\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">low</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-47\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">k</span><span class=\"crayon-o\">-=</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-48\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-49\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-50\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-51\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mid</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">n</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-52\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mid</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//若相等则说明mid即为查找到的位置</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-53\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-54\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">n</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">//若mid&gt;=n则说明是扩展的数值,返回n-1</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-55\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-56\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-57\"><span class=\"crayon-h\">   </span><span class=\"crayon-i\">delete</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-58\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-59\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-60\"> </div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-61\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-62\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-63\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">16</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">24</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">35</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">47</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">59</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">62</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">73</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">88</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">99</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-64\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">100</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-65\"><span class=\"crayon-h\">   </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">FibonacciSearch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">sizeof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-66\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">cout</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-s\">\" is located at:\"</span><span class=\"crayon-o\">&lt;&lt;</span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-596007996c69a772475547-67\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596007996c69a772475547-68\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0087 seconds] -->\r\n<p></p>\n<h3>5. 树表查找</h3>\n<p><strong>5.1 最简单的树表查找算法——二叉树查找算法。</strong></p>\n<p><strong>基本思想：</strong>二叉查找树是先对待查找的数据进行生成树，确保树的左分支的值小于右分支的值，然后在就行和每个节点的父节点比较大小，查找最适合的范围。 这个算法的查找效率很高，但是如果使用这种查找方法要首先创建树。</p>\n<p><strong>二叉查找树</strong>（BinarySearch Tree，也叫二叉搜索树，或称二叉排序树Binary Sort Tree）或者是一棵空树，或者是具有下列性质的二叉树：</p>\n<p>1）若任意节点的左子树不空，则左子树上所有结点的值均小于它的根结点的值；</p>\n<p>2）若任意节点的右子树不空，则右子树上所有结点的值均大于它的根结点的值；</p>\n<p>3）任意节点的左、右子树也分别为二叉查找树。</p>\n<p><strong>二叉查找树性质</strong>：<span style=\"text-decoration: underline;\"><strong>对二叉查找树进行中序遍历，即可得到有序的数列。</strong></span></p>\n<p>不同形态的二叉查找树如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c2a4470f8d2ac2d7739856f175f0a2a6.jpg\"><img class=\"wp-image-111633 size-full aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c2a4470f8d2ac2d7739856f175f0a2a6.jpg\" alt=\"1333691114_6839\" width=\"575\" height=\"431\"></a></p>\n<p>有关二叉查找树的查找、插入、删除等操作的详细讲解，请移步<a id=\"cb_post_title_url\" href=\"http://blog.jobbole.com/79305/\" target=\"_blank\">浅谈算法和数据结构: 七 二叉查找树</a>。</p>\n<p><strong>复杂度分析：<span style=\"text-decoration: underline;\">它和二分查找一样，插入和查找的时间复杂度均为O(logn)，但是在最坏的情况下仍然会有O(n)的时间复杂度。</span>原因在于插入和删除元素的时候，树没有保持平衡（比如，我们查找上图（b）中的“93”，我们需要进行n次查找操作）。我们追求的是在最坏的情况下仍然有较好的时间复杂度，这就是平衡查找树设计的初衷。</strong></p>\n<p>下图为二叉树查找和顺序查找以及二分查找性能的对比图：</p>\n<p><strong><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/0bab1b7848505a289a147555e768c011.png\"><img class=\"aligncenter wp-image-111634 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/0bab1b7848505a289a147555e768c011.png\" alt=\"242110240767812\" width=\"640\" height=\"297\"></a></strong></p>\n<p>基于二叉查找树进行优化，进而可以得到其他的树表查找算法，如平衡树、红黑树等高效算法。</p>\n<p><strong>5.2 平衡查找树之2-3查找树（2-3 Tree）</strong></p>\n<p><strong>2-3查找树定义</strong>：和二叉树不一样，2-3树运行每个节点保存1个或者两个的值。对于普通的2节点(2-node)，他保存1个key和左右两个自己点。对应3节点(3-node)，保存两个Key，2-3查找树的定义如下：</p>\n<p>1）要么为空，要么：</p>\n<p>2）对于2节点，该节点保存一个key及对应value，以及两个指向左右节点的节点，左节点也是一个2-3节点，所有的值都比key要小，右节点也是一个2-3节点，所有的值比key要大。</p>\n<p>3）对于3节点，该节点保存两个key及对应value，以及三个指向左中右的节点。左节点也是一个2-3节点，所有的值均比两个key中的最小的key还要小；中间节点也是一个2-3节点，中间节点的key值在两个跟节点key值之间；右节点也是一个2-3节点，节点的所有key值比两个key中的最大的key还要大。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/820c68356662f10a63a017836542f86e.png\"><img class=\"aligncenter wp-image-111635 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/820c68356662f10a63a017836542f86e.png\" alt=\"252248450292152\" width=\"577\" height=\"347\"></a></p>\n<p><strong>2-3查找树的性质：</strong></p>\n<p><span style=\"text-decoration: underline;\"><strong>1）如果中序遍历2-3查找树，就可以得到排好序的序列；</strong></span></p>\n<p><span style=\"text-decoration: underline;\"><strong>2）在一个完全平衡的2-3查找树中，根节点到每一个为空节点的距离都相同。（这也是平衡树中“平衡”一词的概念，根节点到叶节点的最长距离对应于查找算法的最坏情况，而平衡树中根节点到叶节点的距离都一样，最坏情况也具有对数复杂度。）</strong></span></p>\n<p>性质2）如下图所示：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/5520f67674c24d9ec25056ec9659db69.png\"><img class=\"aligncenter wp-image-111636 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/5520f67674c24d9ec25056ec9659db69.png\" alt=\"252249082017906\" width=\"640\" height=\"137\"></a></p>\n<p><strong>复杂度分析：</strong></p>\n<p>2-3树的查找效率与树的高度是息息相关的。</p>\n<ul>\n<li>在最坏的情况下，也就是所有的节点都是2-node节点，查找效率为lgN</li>\n<li>在最好的情况下，所有的节点都是3-node节点，查找效率为log<sub>3</sub>N约等于0.631lgN</li>\n</ul>\n<p>距离来说，对于1百万个节点的2-3树，树的高度为12-20之间，对于10亿个节点的2-3树，树的高度为18-30之间。</p>\n<p>对于插入来说，只需要常数次操作即可完成，因为他只需要修改与该节点关联的节点即可，不需要检查其他节点，所以效率和查找类似。下面是2-3查找树的效率：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/e67bb0d46b9098cf63784b9fb3a44762.png\"><img class=\"aligncenter wp-image-111637 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e67bb0d46b9098cf63784b9fb3a44762.png\" alt=\"252249104513019\" width=\"997\" height=\"443\"></a></p>\n<p><strong>5.3 平衡查找树之红黑树（Red-Black Tree）</strong></p>\n<p>2-3查找树能保证在插入元素之后能保持树的平衡状态，最坏情况下即所有的子节点都是2-node，树的高度为lgn，从而保证了最坏情况下的时间复杂度。但是2-3树实现起来比较复杂，于是就有了一种简单实现2-3树的数据结构，即红黑树（Red-Black Tree）。</p>\n<p><strong>基本思想：</strong>红黑树的思想就是对2-3查找树进行编码，尤其是对2-3查找树中的3-nodes节点添加额外的信息。红黑树中将节点之间的链接分为两种不同类型，红色链接，他用来链接两个2-nodes节点来表示一个3-nodes节点。黑色链接用来链接普通的2-3节点。特别的，使用红色链接的两个2-nodes来表示一个3-nodes节点，并且向左倾斜，即一个2-node是另一个2-node的左子节点。这种做法的好处是查找的时候不用做任何修改，和普通的二叉查找树相同。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/87bf495966cd746d1c85c18f2bfdd19e.png\"><img class=\"aligncenter wp-image-111638 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/87bf495966cd746d1c85c18f2bfdd19e.png\" alt=\"270024368439888\" width=\"595\" height=\"249\"></a></p>\n<p><strong>红黑树的定义：</strong></p>\n<p>红黑树是一种具有红色和黑色链接的平衡查找树，同时满足：</p>\n<ul>\n<li>红色节点向左倾斜</li>\n<li>一个节点不可能有两个红色链接</li>\n<li>整个树完全黑色平衡，即从根节点到所以叶子结点的路径上，黑色链接的个数都相同。</li>\n</ul>\n<p>下图可以看到红黑树其实是2-3树的另外一种表现形式：如果我们将红色的连线水平绘制，那么他链接的两个2-node节点就是2-3树中的一个3-node节点了。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/b9da2c6adee6a2cf1bfecab40e784c8a.png\"><img class=\"aligncenter wp-image-111639 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/b9da2c6adee6a2cf1bfecab40e784c8a.png\" alt=\"270024403113529\" width=\"594\" height=\"607\"></a></p>\n<p><span style=\"text-decoration: underline;\"><strong>红黑树的性质：整个树完全黑色平衡，即从根节点到所以叶子结点的路径上，黑色链接的个数都相同（2-3树的第2）性质，从根节点到叶子节点的距离都相等）。</strong></span></p>\n<p><span style=\"text-decoration: underline;\"><strong>复杂度分析：最坏的情况就是，红黑树中除了最左侧路径全部是由3-node节点组成，即红黑相间的路径长度是全黑路径长度的2倍。</strong></span></p>\n<p>下图是一个典型的红黑树，从中可以看到最长的路径(红黑相间的路径)是最短路径的2倍：</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/888d499f58cf6554a323d253c8a45d5b.png\"><img class=\"aligncenter wp-image-111640 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/888d499f58cf6554a323d253c8a45d5b.png\" alt=\"270027368747653\" width=\"586\" height=\"230\"></a></p>\n<p><span style=\"text-decoration: underline;\"><strong>红黑树的平均高度大约为logn。</strong></span></p>\n<p>下图是红黑树在各种情况下的时间复杂度，可以看出红黑树是2-3查找树的一种实现，它能保证最坏情况下仍然具有对数的时间复杂度。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/acc945f4b6a4767a1ff9c29188fb3190.png\"><img class=\"aligncenter wp-image-111641 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/acc945f4b6a4767a1ff9c29188fb3190.png\" alt=\"270027378905711\" width=\"640\" height=\"330\"></a></p>\n<p>红黑树这种数据结构应用十分广泛，在多种编程语言中被用作符号表的实现，如：</p>\n<ul>\n<li>Java中的java.util.TreeMap,java.util.TreeSet；</li>\n<li>C++ STL中的：map,multimap,multiset；</li>\n<li>.NET中的：SortedDictionary,SortedSet 等。</li>\n</ul>\n<p><strong>5.4 B树和B+树（B Tree/B+ Tree）</strong></p>\n<p>平衡查找树中的2-3树以及其实现红黑树。2-3树种，一个节点最多有2个key，而红黑树则使用染色的方式来标识这两个key。</p>\n<p>维基百科对B树的定义为“在计算机科学中，B树（B-tree）是一种树状数据结构，它能够存储数据、对其进行排序并允许以O(log n)的时间复杂度运行进行查找、顺序读取、插入和删除的数据结构。B树，概括来说是一个节点可以拥有多于2个子节点的二叉查找树。与自平衡二叉查找树不同，B树为系统最优化<span style=\"text-decoration: underline;\"><strong>大块数据的读和写操作</strong></span>。B-tree算法减少定位记录时所经历的中间过程，从而加快存取速度。普遍运用在<span style=\"text-decoration: underline;\"><strong>数据库</strong></span>和<span style=\"text-decoration: underline;\"><strong>文件系统</strong></span>。</p>\n<p><strong>B树定义：</strong></p>\n<p><strong>B树</strong>可以看作是对2-3查找树的一种扩展，即他允许每个节点有M-1个子节点。</p>\n<ul>\n<li>根节点至少有两个子节点</li>\n<li>每个节点有M-1个key，并且以升序排列</li>\n<li>位于M-1和M key的子节点的值位于M-1 和M key对应的Value之间</li>\n<li>其它节点至少有M/2个子节点</li>\n<li>下图是一个M=4 阶的B树:</li>\n</ul>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c9c21772ceb0abbee6d86aefb194ae7c.png\"><img class=\"aligncenter wp-image-111642 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c9c21772ceb0abbee6d86aefb194ae7c.png\" alt=\"290047034539184\" width=\"640\" height=\"137\"></a></p>\n<p>可以看到B树是2-3树的一种扩展，他允许一个节点有多于2个的元素。B树的插入及平衡化操作和2-3树很相似，这里就不介绍了。下面是往B树中依次插入</p>\n<p><strong>6 10 4 14 5 11 15 3 2 12 1 7 8 8 6 3 6 21 5 15 15 6 32 23 45 65 7 8 6 5 4</strong></p>\n<p>的演示动画：</p>\n<p><img class=\"aligncenter\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fh5p12mz57g20qm06d4qq.gif\" width=\"958\" height=\"229\"></p>\n<p><strong>B+树定义：</strong></p>\n<p><strong>B+</strong>树是对B树的一种变形树，它与B树的差异在于：</p>\n<ul>\n<li>有k个子结点的结点必然有k个关键码；</li>\n<li>非叶结点仅具有索引作用，跟记录有关的信息均存放在叶结点中。</li>\n<li>树的所有叶结点构成一个有序链表，可以按照关键码排序的次序遍历全部记录。</li>\n</ul>\n<p>如下图，是一个B+树:</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/e100192c3d4fc465ee6a35dc20be441e.png\"><img class=\"aligncenter wp-image-111643 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/e100192c3d4fc465ee6a35dc20be441e.png\" alt=\"290050048129679\" width=\"1008\" height=\"208\"></a></p>\n<p>下图是B+树的插入动画：</p>\n<p><img class=\"aligncenter\" src=\"http://wx4.sinaimg.cn/large/7cc829d3gy1fh5p2ef94jg20rz05i7wi.gif\" width=\"1007\" height=\"198\"></p>\n<p><span style=\"text-decoration: underline;\"><strong>B和B+树的区别在于，B+树的非叶子结点只包含导航信息，不包含实际的值，所有的叶子结点和相连的节点使用链表相连，便于区间查找和遍历。</strong></span></p>\n<p>B+ 树的优点在于：</p>\n<ul>\n<li>由于B+树在内部节点上不好含数据信息，因此在内存页中能够存放更多的key。 数据存放的更加紧密，具有更好的空间局部性。因此访问叶子几点上关联的数据也具有更好的缓存命中率。</li>\n<li>B+树的叶子结点都是相链的，因此对整棵树的便利只需要一次线性遍历叶子结点即可。而且由于数据顺序排列并且相连，所以便于区间查找和搜索。而B树则需要进行每一层的递归遍历。相邻的元素可能在内存中不相邻，所以缓存命中性没有B+树好。</li>\n</ul>\n<p><span style=\"text-decoration: underline;\"><strong>但是B树也有优点，其优点在于，由于B树的每一个节点都包含key和value，因此经常访问的元素可能离根节点更近，因此访问也更迅速。</strong></span></p>\n<p>下面是B 树和B+树的区别图：</p>\n<p> </p>\n<p>B/B+树常用于文件系统和数据库系统中，它通过对每个节点存储个数的扩展，使得对连续的数据能够进行较快的定位和访问，能够有效减少查找时间，提高存储的空间局部性从而减少IO操作。它广泛用于文件系统及数据库中，如：</p>\n<ul>\n<li>Windows：HPFS文件系统；</li>\n<li>Mac：HFS，HFS+文件系统；</li>\n<li>Linux：ResiserFS，XFS，Ext3FS，JFS文件系统；</li>\n<li>数据库：ORACLE，MYSQL，SQLSERVER等中。</li>\n</ul>\n<p>有关B/B+树在数据库索引中的应用，请看张洋的《<a href=\"http://blog.jobbole.com/24006/\" target=\"_blank\">MySQL索引背后的数据结构及算法原理</a>》这篇文章，这篇文章对MySQL中的如何使用B+树进行索引有比较详细的介绍，推荐阅读。</p>\n<p><strong>树表查找总结：</strong></p>\n<p>二叉查找树平均查找性能不错，为O(logn)，但是最坏情况会退化为O(n)。在二叉查找树的基础上进行优化，我们可以使用平衡查找树。平衡查找树中的2-3查找树，这种数据结构在插入之后能够进行自平衡操作，从而保证了树的高度在一定的范围内进而能够保证最坏情况下的时间复杂度。但是2-3查找树实现起来比较困难，红黑树是2-3树的一种简单高效的实现，他巧妙地使用颜色标记来替代2-3树中比较难处理的3-node节点问题。红黑树是一种比较高效的平衡查找树，应用非常广泛，很多编程语言的内部实现都或多或少的采用了红黑树。</p>\n<p>除此之外，2-3查找树的另一个扩展——B/B+平衡树，在文件系统和数据库系统中有着广泛的应用。</p>\n<h3><strong>6. 分块查找</strong></h3>\n<p>分块查找又称索引顺序查找，它是顺序查找的一种改进方法。</p>\n<p><strong>算法思想：</strong>将n个数据元素”按块有序”划分为m块（m ≤ n）。每一块中的结点不必有序，但块与块之间必须”按块有序”；即第1块中任一元素的关键字都必须小于第2块中任一元素的关键字；而第2块中任一元素又都必须小于第3块中的任一元素，……</p>\n<p><strong>算法流程：</strong><br>\nstep1 先选取各块中的最大关键字构成一个索引表；<br>\nstep2 查找分两个部分：先对索引表进行二分查找或顺序查找，以确定待查记录在哪一块中；然后，在已确定的块中用顺序法进行查找。</p>\n<h3>7. 哈希查找</h3>\n<p><strong>什么是哈希表（Hash）？</strong></p>\n<div>我们使用一个下标范围比较大的数组来存储元素。可以设计一个函数（哈希函数， 也叫做散列函数），使得每个元素的关键字都与一个函数值（即数组下标）相对应，于是用这个数组单元来存储这个元素；也可以简单的理解为，按照关键字为每一个元素”分类”，然后将这个元素存储在相应”类”所对应的地方。但是，不能够保证每个元素的关键字与函数值是一一对应的，因此极有可能出现对于不同的元素，却计算出了相同的函数值，这样就产生了”冲突”，换句话说，就是把不同的元素分在了相同的”类”之中。后面我们将看到一种解决”冲突”的简便做法。</div>\n<div><span style=\"text-decoration: underline;\"><strong>总的来说，”直接定址”与”解决冲突”是哈希表的两大特点。</strong></span></div>\n<p><strong>什么是哈希函数？</strong></p>\n<p>哈希函数的规则是：通过某种转换关系，使关键字适度的分散到指定大小的的顺序结构中，越分散，则以后查找的时间复杂度越小，空间复杂度越高。</p>\n<p><strong>算法思想：</strong>哈希的思路很简单，如果所有的键都是整数，那么就可以使用一个简单的无序数组来实现：将键作为索引，值即为其对应的值，这样就可以快速访问任意键的值。这是对于简单的键的情况，我们将其扩展到可以处理更加复杂的类型的键。</p>\n<p><strong>算法流程：</strong><br>\n1）用给定的哈希函数构造哈希表；</p>\n<p>2）根据选择的冲突处理方法解决地址冲突；</p>\n<p>（常见的解决冲突的方法：拉链法和线性探测法。详细的介绍可以参见：<a id=\"cb_post_title_url\" href=\"http://blog.jobbole.com/79261/\" target=\"_blank\">浅谈算法和数据结构: 十一 哈希表</a>。）</p>\n<p>3）在哈希表的基础上执行哈希查找。</p>\n<p><span style=\"text-decoration: underline;\"><strong>哈希表是一个在时间和空间上做出权衡的经典例子。如果没有内存限制，那么可以直接将键作为数组的索引。那么所有的查找时间复杂度为O(1)；如果没有时间限制，那么我们可以使用无序数组并进行顺序查找，这样只需要很少的内存。哈希表使用了适度的时间和空间来在这两个极端之间找到了平衡。只需要调整哈希函数算法即可在时间和空间上做出取舍。</strong></span></p>\n<p><strong>复杂度分析</strong>：</p>\n<p>单纯论查找复杂度：对于无冲突的Hash表而言，查找复杂度为O(1)（注意，在查找之前我们需要构建相应的Hash表）。</p>\n<p><strong>使用Hash，我们付出了什么？</strong><br>\n我们在实际编程中存储一个大规模的数据，最先想到的存储结构可能就是map，也就是我们常说的KV pair，经常使用Python的博友可能更有这种体会。使用map的好处就是，我们在后续处理数据处理时，可以根据数据的key快速的查找到对应的value值。map的本质就是Hash表，那我们在获取了超高查找效率的基础上，我们付出了什么？</p>\n<p>Hash是一种典型<strong>以空间换时间</strong>的算法，比如原来一个长度为100的数组，对其查找，只需要遍历且匹配相应记录即可，从空间复杂度上来看，假如数组存储的是byte类型数据，那么该数组占用100byte空间。现在我们采用Hash算法，我们前面说的Hash必须有一个规则，约束键与存储位置的关系，那么就需要一个固定长度的hash表，此时，仍然是100byte的数组，假设我们需要的100byte用来记录键与位置的关系，那么总的空间为200byte,而且用于记录规则的表大小会根据规则，大小可能是不定的。</p>\n<p>Hash算法和其他查找算法的性能对比：<a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/eea75027e83568ebe782611acefbe48d.png\"><img class=\"aligncenter wp-image-111645 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/eea75027e83568ebe782611acefbe48d.png\" alt=\"312301180197071\" width=\"834\" height=\"511\"></a></p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111629\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111629votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111629\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/2d0c7fc61e19c487cc2aa6c2b3193ae9.jpg', 'full/6fea19912aa975484ea8f1389d4c93135791ba7b.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('自学的程序员如何找到好工作？', '2017-07-07', 'http://blog.jobbole.com/111497/', 'd8f9f8f08d6737cb4a3e4987ebbc04cb', 16, 5, '开发, 职场, , 程序员, 职场', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a> 翻译，<a href=\"http://www.jobbole.com/members/liuchang\">刘唱</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"http://brianknapp.me/how-do-self-taught-developers-actually-get-jobs/\">Brian Knapp</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>【伯乐在线导读】：2016 年有位年轻的程序员在 Quora 上提问求助：</p>\n<blockquote><p>我今年 17 岁，从 14 岁开始编程。我主要关注 Java 语言，并在 AP 计算机科学这门课上拿了 5 分。我相当精通 Java（比如语法、主要类、GUI/JFrame 等），HTML5 和 CSS3 也不错。我感觉自己缺乏很多有用的技能，来帮助我在人才市场上推销自己（比如数据库的工作原理，以及我应该使用哪些工具），我很好奇其他人是如何学习这些东西的。我打算去大学拿一个软件开发的学位，但我开始感到有点沮丧，觉得读大学的目的就是为了工作。现在有哪些我应该上的课程，或者应该做的事情吗？</p></blockquote>\n<p><img id=\"pic\" class=\"\" src=\"http://wx1.sinaimg.cn/large/7cc829d3gy1fgqaiwbj8uj20nj0d3757.jpg\" width=\"620\" height=\"345\"></p>\n<h3>下面是 Brain Knapp 的回答分享︰</h3>\n<p>我认为你的看法错了。你觉得你需要上课，让别人来教你，告诉你答案。从根本上讲，自学的程序员能够做不一样的事情。</p>\n<p>自学的程序员和自学的吉他手有很多共同点。我不知道你是否玩过吉他，所以我将向你解释如何自学吉他。</p>\n<p>首先，这一切的开始是由于某人与某个吉他手产生了共鸣。大多数突然想要自学吉他的人，是想要成为另一个吉他手。之后，他们下定决心——“我也可以成为一个吉他手 ”，于是去了当地的乐器店，买了一把二手吉他（因为二手吉他更便宜，但也很酷）。</p>\n<p>接下来可能会有两种情况，要不买一本“吉他入门”或类似的书籍开始自学，要不打开 YouTube，开始学习如何弹奏自己喜爱的歌。那些尝试学习弹奏喜欢的歌的自学者，往往学得更好。</p>\n<p>当年轻的吉他手主动地学习某首歌时，他们往往需要观看视频、打印曲谱、练习和弦等等。然后，根据拿到的视频和曲谱，他们会坐下来尝试重新演绎歌曲。</p>\n<p>经过数小时的练习，不断重复和弦、独奏、节拍等，他们将能够以自己的形式表演那首歌。它不再是原来那首歌，但也够酷。</p>\n<p>然后，他们会拿起另一首歌，重复这个过程。一路走来，他们不断学习节拍、技术以及其他的东西，甚至都没有意识到学习的内容。在知道专业名词和理论前，他们已经懂得如何操作。</p>\n<p><span style=\"color: #000000\">最终，弹吉他变成了一种“直觉”，学习一首新歌也变得习以为常且不再痛苦。吉他的“语言”变得像你我说话那样容易。</span></p>\n<p>这一切的发生，背后是数千小时的艰苦练习。即使每天只练习一小时，也需要耗费数年。</p>\n<p><strong>那么，这和自学的程序员有什么关系呢？</strong></p>\n<p><span style=\"color: #000000\">事实上，真正成就自学的程序员的，就是他们会自己创建东西，很多东西。</span>要成为一个具有卓越技能的出色程序员，你必须创建东西，写代码。</p>\n<p>上课学习理论知识固然是好的，但很多教授不能跳出条条框框的束缚，以自己的方式编程。就算他们努力尝试，也做不出别人愿意用的应用程序。</p>\n<p>这并不是说他们不了解教授的知识，而是说，作为一名教授，他们掌握的技能是研究和理论性理解，而不是写代码和为客户提供价值。</p>\n<p><strong>你看到区别了吗？</strong></p>\n<p>我合作过的最好的程序员，他们的工作方式就是做东西，做很多东西，并且几乎一直这样。</p>\n<p>例如，现在几乎每个人都使用 WordPress。在 WordPress 出现很久之前，我就用 PHP 和 MySQL 创建了 3 到 5 个不同的内容管理系统。我写过游戏、移动应用程序、框架，还有 SAAS 应用程序。</p>\n<p>没人付钱让我做这些事情。我做这些事纯粹是出于好玩、学习或好奇的目的。</p>\n<p>我已经好几年都没有上过课了，即使上了，我也不觉得这会对我的事业有任何帮助。然而，如果我决定坐下来，从头开始创建我自己的计算机语言或操作系统，我打赌我一定能在过程中学到很多有趣的东西。</p>\n<p>是的，我可以带着那些想法上课，但在创建东西，犯下错误，以及真正“体会到”这一切的经历中，相比读一本书或听一次讲座，我能收获更多。</p>\n<p>因此，我给你的建议（如果你做到了，相比没有做的那些人而言，会带给你巨大的优势），就是：</p>\n<p><strong><span style=\"color: #ff0000\">解决一个你想解决的问题</span>。</strong>创建一个用于某件事的软件，解决一些你本人或他人想要通过软件解决的问题。每天为这个软件写代码，晚上写，周末也写，每天都写。即使你每天只花了 15 分钟写代码，也没关系。</p>\n<p>最终，你将得到一个能用的软件，这很不错。</p>\n<p><span style=\"color: #ff0000\"><strong>然后，你再重复这一过程。做一个其他的东西。不断地做。花费大量的时间，通过创建更多的东西来提升你的技能。</strong></span></p>\n<p>做东西的同时，注意在你的网站上保存工作，并将其放在一个作品集中。每次你结束了一个项目，就将它上传到 Hacker News、Reddit 或其他什么网站，并发条关于它的博文。</p>\n<p>你现在仅仅 17 岁，当你 20 岁的时候，你已经轻松地将两千多小时用于锻炼技能，你的个人作品集中也有了大概十到二十多个软件，你学习到的经验是那些仅仅上课的人无法比拟的。</p>\n<p>更重要的是，你已经清楚地告诉别人，你能够独立地写代码，解决问题并给世界带来一些新东西。这是最难能可贵的一点，也是公司在不断追求的一点。</p>\n<p><span style=\"color: #ff0000\"><strong>一旦你找到了工作，请继续在业余时间创建东西，并提升你的工作技能</strong></span>。你的提升速度将比你的同事更快，因为他们在下班回家后看电视，而不是学习、成长或创建东西。他们拿到了薪水就回家享受去了。</p>\n<p>你做的越多，你学的也越多；你学的越多，你的价值就越高；你的价值越高，你就越容易找到工作，你的工资也就更高，这是一个良性循环。</p>\n<p>所以，去做些东西出来。现在就开始写代码吧！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111497\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111497votetotal\">5</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111497\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 16 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 7 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2016/09/9667abaa540914200edd449974fb5538.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            我见青山多妩媚，料青山见我应如是        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/zhj318\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/zhj318/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 20</a> · <a title=\"QQ：574375911\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://wx1.sinaimg.cn/large/7cc829d3gy1fgqaiwbj8uj20nj0d3757.jpg', 'full/47088ef57f09c838c2a3bc97ec1b49801c291a32.jpg'),
('程序员偷偷自动化，每周才工作几小时却拿全薪，这样道德么？', '2017-07-07', 'http://blog.jobbole.com/111742/', 'da181fa9746cff2a3a3ca3f1b082c055', 1, 4, '职场, , 程序员, 自动化', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/liuchang\">刘唱</a> 翻译，<a href=\"http://www.jobbole.com/members/huanglimin\">黄利民</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"http://www.sciencealert.com/programmers-are-secretly-automating-their-jobs-and-only-working-a-few-hours-a-week\">Julie Bort</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>就在上周，程序员们在 StackExchange 上有<a href=\"https://workplace.stackexchange.com/questions/93696/is-it-unethical-for-me-to-not-tell-my-employer-i-ve-automated-my-job/94099#94099\" target=\"_blank\">激烈的讨论</a>，如果偷偷把自己的工作自动化，是不是不道德？</p>\n<p><img class=\"alignnone\" src=\"http://ww2.sinaimg.cn/mw690/63918611gw1f5idukigfrj20fw07yt9o.jpg\" width=\"572\" height=\"286\"></p>\n<p>这次讨论的源于 Etherable 于 6 月 27 日在 StackExchange 上发的一个帖子，全文翻译如下：</p>\n<blockquote><p>我目前在给一家公司的遗留系统工作。这个系统真的是很老了，尽管我的角色是程序员，但我大部分工作却是美化数据。总结一下，我有一堆需求，实际上是每月电子表格中的大量数据，我必须把系统配置好，保证运行。这工作基本就是编写一大堆的 SQL 脚本。</p>\n<p>不过这并不是一份很简单的活，因为最初开发这个系统的人写反了。实际上，创建电子表单的分析师要花很多时间来验证我的工作。原因是我这活太繁杂，易出错。</p>\n<p>正如你猜到的，这活非常枯燥。然而，这份全职工作薪水可观，并且允许远程，我还可以陪儿子。</p>\n<p>这份工作我做到大概 18 个月的时候，我基本摸清了所有套路，然后我编写了一个自动化程序，并且我过去 6 个月的活，都是交给它了。所以，过去要 1 人做 1 个月的事，现在可能 10 分钟就可以了。</p>\n<p>现在的问题是，我是否应该告诉公司？如果我告诉他们了，他们或许采纳自动化程序，然后不要我了。这并不像是一个有着大量 IT 工作的公司，他们是有一个遗留系统，一直来保存所有的客户数据，他们只是需要有人来维护这个系统。</p>\n<p>同时，我也觉得自己做的不对。我的意思是，现在只要我拿到了（公司下发的）规范（spec），然后大约每周运行一次自动化程序。再上报我做完了一部分工作，让他们测试验证。我甚至插入了一些 Bugs，以便让结果看起来更像是人做出来的。</p>\n<p>虽然有时候规范需要修改，加上邮件来回沟通的时间，我每周的实际工作时间约 1-2 小时，但我拿的却是全薪。</p>\n<p>虽然我真的很享受多出来的自由时间，但如果这样不打招呼，继续这样偷偷地做下去，是不是不道德？ 这不比我在欺骗公司。公司从来没有表示他们对我的表现不满意，事实上，他们从雇用我中得到了他们想要的。</p></blockquote>\n<p>这位程序员（Etherable）说，他写了一些脚本，悄悄把原本一周的工作用不到两个小时就做完了，他开始感到有些愧疚了。</p>\n<p>公司雇他做的工作都完成了，但是由于是远程工作，也没告诉他老板脚本的事，因此他基本上整天都在陪儿子。他担心公司发现这些脚本然后解雇他，并非是出于道德原因，而是公司有了脚本以后就不再需要他了。</p>\n<p>他写道：</p>\n<blockquote><p>“不告诉我老板自动化工作的事，不道德吗？……</p>\n<p>你能想象，这大概是世界上最无聊的工作了。但是这也是一份薪水颇丰的全职工作，而且我可以远程工作，在家里陪我的儿子。</p>\n<p>所以我已经做了 18 个月了，在这期间，我差不多发现了所有的套路，在过去的六个月里写了一个程序来帮我完成全部工作。以前别人需要用一个月的时间来清理电子表格，用这个程序大概十分钟就能完成。</p>\n<p>现在的问题是，我要不要告诉他们？如果我说了，他们大概会拿走我的程序然后解雇我。”</p></blockquote>\n<p>还有一件事是：这位程序员也坦白，他会通过故意加一些错误来掩盖自动化的痕迹，“让它看起来像是人工完成的。”</p>\n<p>这个问题也发在了<a href=\"https://news.ycombinator.com/item?id=14656945\"> Hacker News</a> 上，引起了激烈的讨论。</p>\n<p>有趣的是，在参与评论的这几十个程序员中，人们分成了两大阵营：<strong>该行为道德和不道德</strong>。</p>\n<h3>你这不道德</h3>\n<p>Stack Overflow 上的人普遍倾向于这种情况不道德。一个叫 <a href=\"https://workplace.stackexchange.com/questions/93696/is-it-unethical-for-me-to-not-tell-my-employer-i-ve-automated-my-job#comment279618_93700\">Magisch</a> 的用户甚至说这位程序员在“诈骗你的老板”。</p>\n<p><a href=\"https://workplace.stackexchange.com/a/93704\">Joe Strazzere</a> 很好地总结了这一派的观点：</p>\n<ul>\n<li><strong>你用每周 1-2 个小时在家里工作（陪儿子），但是却拿着 40 个小时的工资</strong></li>\n<li><strong>你 6 个月前写的这个程序，但是到现在都没告知你的老板</strong></li>\n<li><strong>几乎每周你都在对你的工作成果撒谎</strong></li>\n<li><strong>你故意在程序里插入错误来挽救你的骗局</strong></li>\n<li><strong>你还要让创建表格的分析师花费相当多的时间来检查你的工作</strong></li>\n<li><strong>你承认“感觉自己做了错事”</strong></li>\n</ul>\n<blockquote><p>即使答案在我看来已经很明显了，但是你个人的道德标准让你得出了这样并没什么问题的结论。尽管我怀疑你知道真相……”</p></blockquote>\n<p>另一个<a href=\"https://workplace.stackexchange.com/a/94099\">程序员 SSight3</a> 承认他曾经也自动化做过类似的工作，但是他说自己不属于不道德的原因是，他告诉了他的老板：</p>\n<blockquote><p>“我的情况是，我本来是要做半年的无脑输入数据的工作，但是我自动化了这个过程并且把方法公开给了我的老板。我现在被分配到一个更适合我的天赋和能力的部门。”</p></blockquote>\n<p>他说这个自动化的工作最终使他免于部门的后期裁员。</p>\n<p>大多数站在认为此行为不道德的阵营的人坚信，即使他不能承认已经用这个脚本多久，以及他的工作时间有多短，他仍有义务告诉他的老板关于脚本的事。</p>\n<h3>错误的动机</h3>\n<p>但是 Hacker News 的朋友们提出了另一种观点。</p>\n<p>很多人认为，<strong>只要公司拿到了他们花钱想要的结果，那这个人用多少时间去完成都无所谓</strong>。尽管这个阵营的人也同意，故意制造一些 bug 确实是错的。</p>\n<p><a href=\"https://news.ycombinator.com/user?id=barrkel\">其中一个人写道</a>：“我不认为这里有什么道德问题，只有交易关系——支付工资，创造价值。如果公司用另一种方法能花更少的钱达到目的，它就会采用这种方法并解雇员工。这种事可以避免吗？这位员工正在为公司创造价值，他正在守护自己（和公司）讨价还价的底线，毕竟公司一直都在剥削员工。”</p>\n<p>另一位程序员表示他在做网页的时候也有<a href=\"https://news.ycombinator.com/item?id=14657663\">相似的境遇</a>，而且受到了负面的影响：</p>\n<blockquote><p>“他们想按小时付费给我，但是我协商要按页数付费。当然了，我是自动化完成工作的。但出乎我意料的是，即使他们花同样的钱得到了同样的结果，我们也明确地达成协议不按时间付费，而是按产量付费，他们还是很讨厌我写程序自动化工作。”</p></blockquote>\n<p>有人<a href=\"https://news.ycombinator.com/item?id=14657672\">指出</a>，在整个 IT 行业，自动化不是特例，而是规则。拿系统管理这个工作来说，这项工作是确保 IT 系统不出故障。“我知道很多系统管理员自动化完成大多数工作，他们自己只是做一些监控和维护，他们很棒，没人因为这件事儿指责他们，事实上，这是很好的实践。”</p>\n<p>另一个人<a href=\"https://news.ycombinator.com/item?id=14659048\">表示同意</a>。“作为一个系统管理员，我工作的 90% 都是自动化完成的。如果出了问题，我会一周七天 24 小时随叫随到，但是工作中的其他时间，我可以做做杂事，看看电影，玩玩游戏。我所知道的每个系统管理员，几乎都是这样的。”</p>\n<p>一个人说他<a href=\"https://news.ycombinator.com/item?id=14658785\">整个职业生涯</a>中都是自动化工作的，从没隐瞒过：</p>\n<blockquote><p>“五年前，我在一家大公司做着一份入门级的夜班。那六个月里，我几乎用脚本完成了所有工作，大部分时间都在看 Netflix，我也没花什么心思去隐瞒我没事做这件事。</p>\n<p>为此公司奖励我一次升职，然后我做了同样的事（自动化工作）并且又升职了两次。我现在的产出是从前的两倍多，我的职责是告诉别人如何自动化工作。”</p></blockquote>\n<p>一位程序员完美<a href=\"https://news.ycombinator.com/item?id=14662152\">总结</a>了 Hacker News 上的观点：</p>\n<blockquote><p>“他（发帖求助的程序员 Etherable）唯一的错误就是，没能充分利用他的才能和潜在的生产力。对此最好的解决办法，就是找一份更好的工作。”</p></blockquote>\n<p>技术人员对自动化工作并不陌生。2015 年，曾经有过这样一个程序员，他离开公司后才被发现自动化到了这样的程度：甚至连用咖啡机煮一杯拿铁都要自动化。详情请看《<strong><a href=\"http://blog.jobbole.com/95222/\" target=\"_blank\">超过 90 秒的任务不自动化，你好意思说自己是黑客？</a></strong>》</p>\n<p>有趣的是，编程对于需要长时间且难以忍受的工作来说是小有名气的。许多技术人员都这样工作。</p>\n<p>但显然也出现了这样的亚文化：一些人在做相反的事情，创造一些没有他们就进行不下去的工作。</p>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我翻译更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏译者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我翻译更多好文章，谢谢！</h4>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/07/acb658caeaa7401d5d7d20f28a1eab52.png\">\n            \n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111742\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111742votetotal\">4</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111742\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 4 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/liuchang\">刘唱</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/liuchang\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2016/06/5f17a18404975a50e3a341f2f8e27d59.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            数据挖掘研究生        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/liuchang\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/liuchang/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/liuchang/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 36</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://blog.csdn.net/github_36299736\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/2577872237\"><i class=\"fa fa-weibo\"></i></a> <a title=\"个人微信：learningDM\" target=\"_blank\" href=\"#\"><i class=\"fa fa-weixin\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://ww2.sinaimg.cn/mw690/63918611gw1f5idukigfrj20fw07yt9o.jpg', 'full/55b1132af682daa4944e35728414d9d865d4670f.jpg'),
('字符串的长度，是字符数量，还是字节数量？', '2017-07-07', 'http://blog.jobbole.com/111578/', 'debc6ba7a658bb45d6cc0ca85638cd2b', 1, 1, 'IT技术, SQL Server, 数据库', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/ljhdo/p/4546081.html\">Vic Liu</a>   </div><p>对于大多数SQL Server编程开发者来说，当计算字符串的长度时，脑海中闪现的第一个函数是：Len(string)，这个“长度”，默认情况下，是指字符的数量，一个英语字符是一个长度，一个汉字是一个长度。大多数的字符串函数，例如charindex，substring，stuff等函数，其位置都是针对字符数量的，这使得Len函数深入人心，但是，一个Unicode字符，占用的字节数量是2Bytes，而一个普通的ASCII字符占用的字节数量是1Byte，当需要计算字符串占用的字节数量时，要如何计算字符串的长度？对于各个类型所占用的字节数量，又该如何计算？带着这个疑问，让我们一睹DataLength函数的庐山真面目。</p>\n<h3>一，字符数量</h3>\n<p>Len(string) 函数返回的数值是字符的数量（number of characters），在统计字符数量时，不包含结尾空格，但是包含前导空格。</p>\n<p>示例，Len 函数返回的是字符的数量，而不是字符的字节数量。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596013341ff10356984339\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndeclare @str_v varchar(10)\r\ndeclare @str_nv nvarchar(10)\r\ndeclare @str_nv_cn nvarchar(10)\r\nset @str_v=\' ab \'\r\nset @str_nv=N\' ab \'\r\nset @str_nv_cn=N\' 悦光阴\'\r\n\r\nselect len(@str_v) as len_v\r\n    ,len(@str_nv) as len_nv\r\n    , len(@str_nv_cn) as str_nv_cn</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596013341ff10356984339-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff10356984339-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff10356984339-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff10356984339-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff10356984339-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff10356984339-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff10356984339-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff10356984339-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff10356984339-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff10356984339-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596013341ff10356984339-1\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">str_v </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff10356984339-2\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">str_nv </span><span class=\"crayon-e\">nvarchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff10356984339-3\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">str_nv_cn </span><span class=\"crayon-e\">nvarchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff10356984339-4\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_v</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\' ab \'</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff10356984339-5\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">N</span><span class=\"crayon-s\">\' ab \'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff10356984339-6\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv_cn</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">N</span><span class=\"crayon-s\">\' 悦光阴\'</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff10356984339-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff10356984339-8\"><span class=\"crayon-e\">select </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_v</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">_</span>v</div><div class=\"crayon-line\" id=\"crayon-596013341ff10356984339-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">_</span>nv</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff10356984339-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">len</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv_cn</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">str_nv_cn</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/324363ff7b01072ed79e2486cb2580e3.png\"><img class=\"alignnone size-full wp-image-111579 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/324363ff7b01072ed79e2486cb2580e3.png\" alt=\"628084-20170328121759045-921067498\"></a></p>\n<h3>二，字节数量</h3>\n<p>对于varchar类型，大家都知道，这是单字节字符，一个字符占用一个字节，总共能够表示的256个字符；而对于nvarchar类型，一个字符占用两个字节，能够表示世界上所有的字符集，一个unicode字符占用两个字节，如果要计算字符串占用的字节数量（number of bytes），请使用DataLength()函数，该函数统计字节数量时，字符串的所有字符都会计算在内，包括前导空格和结尾空格。</p>\n<p>示例，每个unicode字符占2B，ASCII 字符占1B。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596013341ff1a007826726\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndeclare @str_v varchar(10)\r\ndeclare @str_nv nvarchar(10)\r\ndeclare @str_nv_cn nvarchar(10)\r\nset @str_v=\' ab \'\r\nset @str_nv=N\' ab \'\r\nset @str_nv_cn=N\' 悦光阴\'\r\n\r\nselect datalength(@str_v) as len_v\r\n    ,datalength(@str_nv) as len_nv\r\n    , datalength(@str_nv_cn) as str_nv_cn</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596013341ff1a007826726-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1a007826726-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff1a007826726-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1a007826726-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff1a007826726-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1a007826726-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff1a007826726-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1a007826726-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff1a007826726-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1a007826726-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596013341ff1a007826726-1\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">str_v </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1a007826726-2\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">str_nv </span><span class=\"crayon-e\">nvarchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff1a007826726-3\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">str_nv_cn </span><span class=\"crayon-e\">nvarchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1a007826726-4\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_v</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\' ab \'</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff1a007826726-5\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">N</span><span class=\"crayon-s\">\' ab \'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1a007826726-6\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv_cn</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">N</span><span class=\"crayon-s\">\' 悦光阴\'</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff1a007826726-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1a007826726-8\"><span class=\"crayon-e\">select </span><span class=\"crayon-e\">datalength</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_v</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">_</span>v</div><div class=\"crayon-line\" id=\"crayon-596013341ff1a007826726-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">datalength</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">_</span>nv</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1a007826726-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">datalength</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">str_nv_cn</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">str_nv_cn</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/f7ff564bbbb1bbb08e567f1ee128f50a.png\"><img class=\"alignnone size-full wp-image-111580 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/f7ff564bbbb1bbb08e567f1ee128f50a.png\" alt=\"628084-20170328122211139-1419020285\"></a></p>\n<h3>三，依赖字符数量的函数</h3>\n<p>对于字符串函数：left，right，其长度值是指字符的数量；对于含有位置参数的字符串函数，charindex、stuff 和 substring，是以字符数量来计算起始位置和长度。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596013341ff1f619099981\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSTUFF ( character_expression , start , length , replaceWith_expression )\r\nSUBSTRING ( expression ,start , length )\r\nRIGHT ( character_expression , length )\r\nLEFT ( character_expression , length )</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596013341ff1f619099981-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1f619099981-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff1f619099981-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff1f619099981-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596013341ff1f619099981-1\"><span class=\"crayon-e\">STUFF</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">character</span><span class=\"crayon-sy\">_</span>expression<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">start</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">length</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">replaceWith</span><span class=\"crayon-sy\">_</span>expression<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1f619099981-2\"><span class=\"crayon-e\">SUBSTRING</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">expression</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-i\">start</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">length</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff1f619099981-3\"><span class=\"crayon-e\">RIGHT</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">character</span><span class=\"crayon-sy\">_</span>expression<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">length</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff1f619099981-4\"><span class=\"crayon-e\">LEFT</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">character</span><span class=\"crayon-sy\">_</span>expression<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">length</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p></p>\n<h3>四，查看数据类型（Data Type）所占用的存储空间</h3>\n<p>DataLength()函数能过返回任意数据类型的变量所占用的字节数量，在设计表的schema时，为column定义窄的数据类型，在存储海量数据行时，该函数十分有用。</p>\n<p>例如，对于datetime类型占用固定的8B，DateTime2数据类型存储日期和时间，占用的存储空间不固定。根据存储的时间部分 fractional seconds precision来确定DateTime2的Storage Size，6 bytes for precisions less than 3; 7 bytes for precisions 3 and 4. All other precisions require 8 bytes.</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-596013341ff23396491955\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" touchscreen minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndeclare @dt1 datetime\r\ndeclare @dt2 datetime2(2)\r\ndeclare @dt3 datetime2(4)\r\n\r\nset @dt1=getdate()\r\nset @dt2=getdate()\r\nset @dt3=SYSDATETIME()\r\n\r\nselect DATALENGTH(@dt1),DATALENGTH(@dt2),DATALENGTH(@dt3),@dt1,@dt2,@dt3</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-596013341ff23396491955-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff23396491955-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff23396491955-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff23396491955-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff23396491955-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff23396491955-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff23396491955-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-596013341ff23396491955-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-596013341ff23396491955-9\">9</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-596013341ff23396491955-1\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">dt1 </span><span class=\"crayon-e\">datetime</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff23396491955-2\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">dt2 </span><span class=\"crayon-e\">datetime2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff23396491955-3\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">dt3 </span><span class=\"crayon-e\">datetime2</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff23396491955-4\"> </div><div class=\"crayon-line\" id=\"crayon-596013341ff23396491955-5\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt1</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">getdate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff23396491955-6\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt2</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">getdate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-596013341ff23396491955-7\"><span class=\"crayon-i\">set</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt3</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">SYSDATETIME</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-596013341ff23396491955-8\"> </div><div class=\"crayon-line\" id=\"crayon-596013341ff23396491955-9\"><span class=\"crayon-e\">select </span><span class=\"crayon-e\">DATALENGTH</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">DATALENGTH</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">DATALENGTH</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt3</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt2</span><span class=\"crayon-sy\">,</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">dt3</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/65ccc2c189f61e5fd1b6b6c0669ae320.jpg\"><img class=\"alignnone size-medium wp-image-111581 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/65ccc2c189f61e5fd1b6b6c0669ae320-300x17.jpg\" alt=\"628084-20160919162750918-586033428\"></a></p>\n<p>如果对time的精度（Precision）要求不是很高，保留2位毫秒，使用datetime2(2)，比其他类型节省存储空间。</p>\n<p> </p>\n<p>参考doc：</p>\n<p><a href=\"https://msdn.microsoft.com/en-us/library/ms181984(v=sql.110).aspx\" target=\"_blank\">String Functions (Transact-SQL)</a></p>\n<p><a href=\"https://msdn.microsoft.com/en-us/library/ms190329.aspx\" target=\"_blank\">LEN (Transact-SQL)</a></p>\n<p><a href=\"https://msdn.microsoft.com/en-us/library/ms173486.aspx\" target=\"_blank\">DATALENGTH (Transact-SQL)</a></p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111578\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111578votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111578\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/06/324363ff7b01072ed79e2486cb2580e3.png', 'full/0350eb7e24e8ac39d26bdfcb3077783204129a76.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('浅析 Linux 的共享内存与 tmpfs 文件系统', '2017-07-07', 'http://blog.jobbole.com/111665/', 'e04a2d4d18843ec489eef7404d5f0e1c', 0, 1, 'IT技术, Linux', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://blog.chinaunix.net/uid-28541347-id-5763124.html\">lvyilong316</a>   </div><h2><b>前言</b><b></b></h2>\n<p>共享内存主要用于进程间通信，Linux有两种共享内存(Shared Memory)机制：</p>\n<p>(1) ** System V shared memory(shmget/shmat/shmdt) **</p>\n<p>Original shared memory mechanism, still widely used Sharing between unrelated processes.</p>\n<p>(2) ** POSIX shared memory(shm_open/shm_unlink) **</p>\n<p>Sharing between unrelated processes, without overhead of filesystem I/O Intended to be simpler and better than older APIs.</p>\n<p>另外，在Linux中不得不提一下内存映射（也可用于进程间通信）：</p>\n<p>** Shared mappings – mmap(2) **</p>\n<p>l Shared anonymous mappings：Sharing between related processes only (related via fork())</p>\n<p>l Shared file mappings：Sharing between unrelated processes, backed by file in filesystem</p>\n<p>System V共享内存历史悠久，使用也很广范，很多类Unix系统都支持。一般来说，我们在写程序时也通常使用第一种。这里不再讨论如何使用它们，关于POSIX共享内存的详细介绍可以参考<a href=\"http://man7.org/linux/man-pages/man7/shm_overview.7.html\">这里1</a>,<a href=\"http://man7.org/training/download/posix_shm_slides.pdf\">这里2</a>。</p>\n<p>** 讲到那么多，那么问题来了，共享内存与tmpfs有什么关系？ **</p>\n<p align=\"justify\">The POSIX shared memory object implementation on Linux 2.4 makes use of a dedicated filesystem, which is normally mounted under /dev/shm.</p>\n<p>    从这里可以看到，POSIX共享内存是基于tmpfs来实现的。实际上，更进一步，不仅PSM(POSIX shared memory)，而且SSM(System V shared memory)在内核也是基于tmpfs实现的。</p>\n<h2><b>tmpfs介绍</b><b></b></h2>\n<p>下面是内核文档中关于tmpfs的介绍：</p>\n<p align=\"justify\">tmpfs has the following uses:</p>\n<p align=\"justify\">1) There is always a kernel internal mount which you will not see at all. This is used for shared anonymous mappings and SYSV shared memory.</p>\n<p align=\"justify\">This mount does not depend on CONFIG_TMPFS. If CONFIG_TMPFS is not set, the user visible part of tmpfs is not build. But the internal mechanisms are always present.</p>\n<p align=\"justify\">2) glibc 2.2 and above expects tmpfs to be mounted at /dev/shm for POSIX shared memory (shm_open, shm_unlink). Adding the following line to /etc/fstab should take care of this:</p>\n<p align=\"justify\">tmpfs /dev/shm tmpfs defaults 0 0</p>\n<p align=\"justify\">Remember to create the directory that you intend to mount tmpfs on if necessary.</p>\n<p align=\"justify\">This mount is not needed for SYSV shared memory. The internal mount is used for that. (In the 2.3 kernel versions it was necessary to mount the predecessor of tmpfs (shm fs) to use SYSV shared memory)</p>\n<p>从这里可以看到tmpfs主要有两个作用：</p>\n<p><b>    </b><b>（1）用于SYSV共享内存，还有匿名内存映射；这部分由内核管理，用户不可见；</b><b></b></p>\n<p><b>    </b><b>（2）用于POSIX共享内存，由用户负责mount，而且一般mount到/dev/shm；依赖于CONFIG_TMPFS;</b><b></b></p>\n<p>到这里，我们可以了解，SSM与PSM之间的区别，也明白了/dev/shm的作用。</p>\n<p>下面我们来做一些测试：</p>\n<h2><b>测试</b><b></b></h2>\n<p>我们将/dev/shm的tmpfs设置为64M：</p>\n<p><i># mount -size=64M -o remount /dev/shm# df -lh</i></p>\n<p>Filesystem                  Size  Used Avail Use% Mounted on</p>\n<p>tmpfs                          64M     0   64M   0% /dev/shm</p>\n<p>SYSV共享内存的最大大小为32M：</p>\n<p><i># cat /proc/sys/kernel/shmmax</i></p>\n<p>33554432</p>\n<h3><b>(1)创建65M的system V共享内存失败：</b><b></b></h3>\n<p><i># ipcmk -M 68157440                   </i></p>\n<p>ipcmk: create share memory failed: Invalid argument</p>\n<p>这是正常的。</p>\n<h3><b>(2)将shmmax调整为65M</b><b></b></h3>\n<p><i># echo 68157440 &gt; /proc/sys/kernel/shmmax# cat /proc/sys/kernel/shmmax             </i></p>\n<p>68157440<i># ipcmk -M 68157440                       </i></p>\n<p>Shared memory id: 0<i># ipcs -m</i></p>\n<p>—— Shared Memory Segments ——–</p>\n<p>key        shmid      owner      perms      bytes      nattch     status</p>\n<p>0xef46b249 0          root       644        68157440   0</p>\n<p>可以看到system v共享内存的大小并不受/dev/shm的影响。</p>\n<h3><b>(3)创建POSIX共享内存</b></h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6f945c5f802975141\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmopen shmopen.c -lrt*/#include &lt;unistd.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;sys/stat.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;sys/mman.h&gt;\r\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char *argv[])\r\n{\r\n    int fd;\r\n    void* result;\r\n    fd = shm_open(\"/shm1\", O_RDWR|O_CREAT, 0644);\r\n    if(fd &lt; 0){\r\n        printf(\"shm_open failed\\n\");\r\n        exit(1);\r\n    }\r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c5f802975141-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c5f802975141-19\">19</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-1\"><span class=\"crayon-c\">/*gcc -o shmopen shmopen.c -lrt*/</span><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-3\"><span class=\"crayon-p\">#include &lt;sys/stat.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-4\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-5\"><span class=\"crayon-p\">#include &lt;sys/mman.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-6\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-7\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-8\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shm_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/shm1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shm_open failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c5f802975141-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c5f802975141-19\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p><i># ./shmopen# ls -lh /dev/shm/shm1</i></p>\n<p>-rw-r–r– 1 root root 65M Mar  3 06:19 /dev/shm/shm1</p>\n<p>仅管/dev/shm只有64M,但创建65M的POSIX SM也可以成功。</p>\n<h3><b>(4)向POSIX SM写数据</b></h3>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6f945c6a632181187\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmwrite shmwrite.c -lrt*/#include &lt;unistd.h&gt;\r\n#include &lt;fcntl.h&gt;\r\n#include &lt;sys/stat.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;sys/mman.h&gt;\r\n#include &lt;stdio.h&gt;\r\n#include &lt;stdlib.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char *argv[])\r\n{\r\n    int fd;\r\n    void* result;\r\n    fd = shm_open(\"/shm1\", O_RDWR|O_CREAT, 0644);\r\n    if(fd &lt; 0){\r\n         printf(\"shm_open failed\\n\");\r\n         exit(1);\r\n    }\r\n    if (ftruncate(fd, MAP_SIZE) &lt; 0){\r\n        printf(\"ftruncate failed\\n\");\r\n        exit(1);\r\n    }\r\n    result = mmap(NULL, MAP_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);\r\n    if(result == MAP_FAILED){\r\n        printf(\"mapped failed\\n\");\r\n        exit(1);\r\n    }\r\n    /* ... operate result pointer */\r\n    printf(\"memset\\n\");\r\n    memset(result, 0, MAP_SIZE);\r\n    //shm_unlink(\"/shm1\");\r\n    return 0;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6a632181187-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6a632181187-32\">32</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-1\"><span class=\"crayon-c\">/*gcc -o shmwrite shmwrite.c -lrt*/</span><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-2\"><span class=\"crayon-p\">#include &lt;fcntl.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-3\"><span class=\"crayon-p\">#include &lt;sys/stat.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-4\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-5\"><span class=\"crayon-p\">#include &lt;sys/mman.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-6\"><span class=\"crayon-p\">#include &lt;stdio.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-7\"><span class=\"crayon-p\">#include &lt;stdlib.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-8\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">void</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shm_open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/shm1\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_RDWR</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">O_CREAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0644</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-15\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shm_open failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-16\"><span class=\"crayon-h\">         </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">ftruncate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"ftruncate failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mmap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PROT_READ</span><span class=\"crayon-o\">|</span><span class=\"crayon-v\">PROT_WRITE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SHARED</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_FAILED</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"mapped failed\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">exit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-26\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/* ... operate result pointer */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">printf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"memset\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">memset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//shm_unlink(\"/shm1\");</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6a632181187-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6a632181187-32\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0039 seconds] -->\r\n<p><i># ./shmwrite</i></p>\n<p>memset</p>\n<p>Bus error</p>\n<p>可以看到，写65M的数据会报Bus error错误。</p>\n<p>但是，却可以在/dev/shm创建新的文件：</p>\n<p><i># ls -lh /dev/shm/ -lh</i></p>\n<p>总用量 64M</p>\n<p>-rw-r–r– 1 root root 65M 3月   3 15:23 shm1</p>\n<p>-rw-r–r– 1 root root 65M 3月   3 15:24 shm2</p>\n<p>这很正常，ls显示的是inode-&gt;size。</p>\n<p><i># stat /dev/shm/shm2</i></p>\n<p>File: “/dev/shm/shm2”</p>\n<p>Size: 68157440        Blocks: 0          IO Block: 4096   普通文件</p>\n<p>Device: 10h/16d Inode: 217177      Links: 1</p>\n<p>Access: (0644/-rw-r–r–)  Uid: (    0/    root)   Gid: (    0/    root)</p>\n<p>Access: 2015-03-03 15:24:28.025985167 +0800</p>\n<p>Modify: 2015-03-03 15:24:28.025985167 +0800</p>\n<p>Change: 2015-03-03 15:24:28.025985167 +0800</p>\n<h3><b>(5)向SYS V共享内存写数据</b><b></b></h3>\n<p>将System V共享内存的最大值调整为65M(/dev/shm仍然为64M)。</p>\n<p><i># cat /proc/sys/kernel/shmmax</i></p>\n<p>68157440</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6f945c6f164805463\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n/*gcc -o shmv shmv.c*/#include &lt;sys/ipc.h&gt;\r\n#include &lt;sys/shm.h&gt;\r\n#include &lt;sys/types.h&gt;\r\n#include &lt;unistd.h&gt;\r\n#define MAP_SIZE 68157440\r\nint main(int argc, char** argv){\r\n    int shm_id,i;\r\n    key_t key;\r\n    char temp;\r\n    char *p_map;\r\n    char* name = \"/dev/shm/shm3\";\r\n    key = ftok(name,0);\r\n    if(key==-1)\r\n        perror(\"ftok error\");\r\n    shm_id=shmget(key,MAP_SIZE,IPC_CREAT);\r\n    if(shm_id==-1)\r\n    {\r\n        perror(\"shmget error\");\r\n        return;\r\n    }\r\n    p_map=(char*)shmat(shm_id,NULL,0);\r\n    memset(p_map, 0, MAP_SIZE);\r\n    if(shmdt(p_map)==-1)\r\n        perror(\" detach error \");\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c6f164805463-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c6f164805463-25\">25</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-1\"><span class=\"crayon-c\">/*gcc -o shmv shmv.c*/</span><span class=\"crayon-p\">#include &lt;sys/ipc.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-2\"><span class=\"crayon-p\">#include &lt;sys/shm.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-3\"><span class=\"crayon-p\">#include &lt;sys/types.h&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-4\"><span class=\"crayon-p\">#include &lt;unistd.h&gt;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-5\"><span class=\"crayon-p\">#define MAP_SIZE 68157440</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-6\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">argv</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">i</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">key_t </span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/dev/shm/shm3\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">key</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ftok</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"ftok error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">shmget</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">key</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">IPC_CREAT</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"shmget error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">p_map</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">char</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-e\">shmat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">shm_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">memset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MAP_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">shmdt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p_map</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">==</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c6f164805463-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">perror</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\" detach error \"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c6f164805463-25\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p><i>#./shmv</i></p>\n<p>却可以正常执行。</p>\n<h3><b>(7)结论</b><b></b></h3>\n<p>虽然System V与POSIX共享内存都是通过tmpfs实现，但是受的限制却不相同。也就是说/proc/sys/kernel/shmmax只会影响SYS V共享内存，/dev/shm只会影响Posix共享内存。<b>实际上，System V与Posix共享内存本来就是使用的两个不同的tmpfs实例(instance)</b>。</p>\n<h2><b>内核分析</b><b></b></h2>\n<p>内核在初始化时，会自动mount一个tmpfs文件系统，挂载为shm_mnt：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6f945c73446613043\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//mm/shmem.cstatic struct file_system_type \r\nshmem_fs_type = {\r\n    .owner = THIS_MODULE,\r\n   .name = \"tmpfs\",\r\n    .get_sb = shmem_get_sb,\r\n    .kill_sb = kill_litter_super,\r\n};\r\n\r\nint __init shmem_init(void) {\r\n    ...\r\n    error = register_filesystem(&amp;shmem_fs_type);\r\n    if (error) \r\n    {\r\n        printk(KERN_ERR \"Could not register tmpfs\\n\");\r\n        goto out2;\r\n    }\r\n    ///挂载tmpfs(用于SYS V) \r\n    shm_mnt = vfs_kern_mount(&amp;shmem_fs_type, MS_NOUSER,shmem_fs_type.name, NULL);</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c73446613043-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c73446613043-18\">18</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-1\"><span class=\"crayon-c\">//mm/shmem.cstatic struct file_system_type </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-2\"><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">owner</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">THIS_MODULE</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-4\"><span class=\"crayon-h\">   </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tmpfs\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">get_sb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_get_sb</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">kill_sb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kill_litter_super</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-8\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-9\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__init </span><span class=\"crayon-e\">shmem_init</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">register_filesystem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">printk</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">KERN</span><span class=\"crayon-sy\">_</span>ERR<span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Could not register tmpfs\\n\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c73446613043-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">///挂载tmpfs(用于SYS V) </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c73446613043-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">shm_mnt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vfs_kern_mount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MS_NOUSER</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">shmem_fs_type</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0025 seconds] -->\r\n<p>/dev/shm的mount与普通文件mount的流程类似，不再讨论。但是，<b>值得注意的是，/dev/shm默认的大小为当前物理内存的1/2</b>：</p>\n<p>shmem_get_sb –&gt; shmem_fill_super</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6f945c77135758561\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n//mem/shmem.c\r\nint shmem_fill_super(struct super_block *sb, void *data, int silent)\r\n{\r\n    ...\r\n#ifdef CONFIG_TMPFS \r\n/*\r\n* Per default we only allow half of the physical ram per\r\n* tmpfs instance, limiting inodes to one per page of lowmem;\r\n* but the internal instance is left unlimited.\r\n*/\r\n    if (!(sb-&gt;s_flags &amp; MS_NOUSER)) {///内核会设置MS_NOUSER \r\n        sbinfo-&gt;max_blocks = shmem_default_max_blocks();\r\n        sbinfo-&gt;max_inodes = shmem_default_max_inodes();\r\n        if (shmem_parse_options(data, sbinfo, false)) {\r\n            err = -EINVAL;\r\n            goto failed;\r\n        }\r\n    }\r\n    sb-&gt;s_export_op = &amp;shmem_export_ops;\r\n#else\r\n...\r\n\r\n#ifdef CONFIG_TMPFS\r\nstatic unsigned long shmem_default_max_blocks(void) {\r\n    return totalram_pages / 2;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c77135758561-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c77135758561-26\">26</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-1\"><span class=\"crayon-c\">//mem/shmem.c</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_fill_super</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">super_block *</span><span class=\"crayon-v\">sb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">silent</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-5\"><span class=\"crayon-p\">#ifdef CONFIG_TMPFS </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-6\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-7\"><span class=\"crayon-c\">* Per default we only allow half of the physical ram per</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-8\"><span class=\"crayon-c\">* tmpfs instance, limiting inodes to one per page of lowmem;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-9\"><span class=\"crayon-c\">* but the internal instance is left unlimited.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-10\"><span class=\"crayon-c\">*/</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">s_flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MS_NOUSER</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-c\">///内核会设置MS_NOUSER </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_blocks</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_inodes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_inodes</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">shmem_parse_options</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-15\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EINVAL</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-16\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">failed</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">sb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">s_export_op</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">shmem_export_ops</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-20\"><span class=\"crayon-p\">#else</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-21\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-22\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-23\"><span class=\"crayon-p\">#ifdef CONFIG_TMPFS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-24\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_default_max_blocks</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">void</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c77135758561-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">totalram_pages</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c77135758561-26\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0031 seconds] -->\r\n<p>可以看到：由于内核在mount tmpfs时，指定了MS_NOUSER，所以该tmpfs没有大小限制，因此，SYS V共享内存能够使用的内存空间只受/proc/sys/kernel/shmmax限制；而用户通过挂载的/dev/shm，默认为物理内存的1/2。</p>\n<p>注意CONFIG_TMPFS.</p>\n<p>另外，在/dev/shm创建文件走VFS接口，而SYS V与匿名映射却是通过shmem_file_setup实现：</p>\n<h2><b>SIGBUS</b><b></b></h2>\n<p>当应用访问共享内存对应的地址空间，如果对应的物理PAGE还没有分配，就会调用fault方法，分配失败，就会返回OOM或者BIGBUS错误：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-595ff6f945c7b225027321\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic const struct vm_operations_struct shmem_vm_ops = {\r\n    .fault = shmem_fault,\r\n#ifdef CONFIG_NUMA \r\n    .set_policy = shmem_set_policy,\r\n    .get_policy = shmem_get_policy,\r\n#endif\r\n};\r\n\r\nstatic int shmem_fault(struct vm_area_struct *vma, struct vm_fault *vmf)\r\n{\r\n    struct inode *inode = vma-&gt;vm_file-&gt;f_path.dentry-&gt;d_inode;\r\n    int error;\r\n    int ret = VM_FAULT_LOCKED;\r\n    error = shmem_getpage(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page, SGP_CACHE, &amp;ret);\r\n    if (error)\r\n        return ((error == -ENOMEM) ? VM_FAULT_OOM : VM_FAULT_SIGBUS);\r\n    return ret;\r\n}\r\n\r\nshmem_getpage –&gt; shmem_getpage_gfp：\r\n/*\r\n * shmem_getpage_gfp - find page in cache, or get from swap, or allocate\r\n *\r\n * If we allocate a new one we do not mark it dirty. That\'s up to the\r\n * vm. If we swap it in we mark it dirty since we also free the swap\r\n * entry since a page cannot live in both the swap and page cache\r\n */\r\nstatic int shmem_getpage_gfp(struct inode *inode, pgoff_t index,\r\nstruct page **pagep, enum sgp_type sgp, gfp_t gfp, int *fault_type) \r\n{\r\n    ...\r\n    if (sbinfo-&gt;max_blocks) { ///dev/shm会有该值 \r\n        if (percpu_counter_compare(&amp;sbinfo-&gt;used_blocks,sbinfo-&gt;max_blocks) &gt;= 0) {\r\n            error = -ENOSPC;\r\n            goto unacct;\r\n        }\r\n    percpu_counter_inc(&amp;sbinfo-&gt;used_blocks);\r\n    }\r\n    //分配一个物理PAGE\r\n    page = shmem_alloc_page(gfp, info, index);\r\n    if (!page) {\r\n        error = -ENOMEM;\r\n        goto decused;\r\n    }\r\n    SetPageSwapBacked(page);\r\n    __set_page_locked(page);\r\n    error = mem_cgroup_cache_charge(page, current-&gt;mm,gfp &amp; GFP_RECLAIM_MASK); ///mem_cgroup检查\r\nif (!error)\r\n    error = shmem_add_to_page_cache(page, mapping, index, gfp, NULL);</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-595ff6f945c7b225027321-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-595ff6f945c7b225027321-49\">49</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">vm_operations_struct </span><span class=\"crayon-v\">shmem_vm_ops</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fault</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_fault</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-3\"><span class=\"crayon-p\">#ifdef CONFIG_NUMA </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">set_policy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_set_policy</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">get_policy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_get_policy</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-6\"><span class=\"crayon-p\">#endif</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-8\"> </div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-9\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_fault</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">vm_area_struct *</span><span class=\"crayon-v\">vma</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">vm_fault *</span><span class=\"crayon-v\">vmf</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">inode *</span><span class=\"crayon-v\">inode</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vma</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">vm_file</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">f_path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">dentry</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">d_inode</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ret</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_LOCKED</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_getpage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">inode</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vmf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">pgoff</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">vmf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SGP_CACHE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">ret</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOMEM</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_OOM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">VM_FAULT_SIGBUS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ret</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-18\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-20\"><span class=\"crayon-v\">shmem</span><span class=\"crayon-sy\">_</span>getpage<span class=\"crayon-h\"> </span>–<span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">shmem_getpage</span><span class=\"crayon-sy\">_</span>gfp：</div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-21\"><span class=\"crayon-c\">/*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-22\"><span class=\"crayon-c\"> * shmem_getpage_gfp - find page in cache, or get from swap, or allocate</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-23\"><span class=\"crayon-c\"> *</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-24\"><span class=\"crayon-c\"> * If we allocate a new one we do not mark it dirty. That\'s up to the</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-25\"><span class=\"crayon-c\"> * vm. If we swap it in we mark it dirty since we also free the swap</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-26\"><span class=\"crayon-c\"> * entry since a page cannot live in both the swap and page cache</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-27\"><span class=\"crayon-c\"> */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-28\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_getpage_gfp</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">inode *</span><span class=\"crayon-v\">inode</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pgoff_t </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-29\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">page *</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">pagep</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">enum</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sgp_type </span><span class=\"crayon-v\">sgp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">gfp_t </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">fault_type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-30\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-31\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-32\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">///dev/shm会有该值 </span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">percpu_counter_compare</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">used_blocks</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">max_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-34\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOSPC</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-35\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">unacct</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">percpu_counter_inc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sbinfo</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">used_blocks</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">//分配一个物理PAGE</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-40\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">page</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_alloc_page</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">info</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ENOMEM</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">decused</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-44\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">SetPageSwapBacked</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-46\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">__set_page_locked</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mem_cgroup_cache_charge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">current</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">mm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">gfp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">GFP_RECLAIM_MASK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">///mem_cgroup检查</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-595ff6f945c7b225027321-48\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">error</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-595ff6f945c7b225027321-49\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">shmem_add_to_page_cache</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">page</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mapping</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">gfp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0077 seconds] -->\r\n<p></p>\n<h2><b>共享内存与CGROUP</b><b></b></h2>\n<p>目前，共享内存的空间计算在第一个访问共享内存的group，参考：</p>\n<p>l http://lwn.net/Articles/516541/</p>\n<p>l https://www.kernel.org/doc/Documentation/cgroups/memory.txt</p>\n<h2><b>POSIX共享内存与Docker</b><b></b></h2>\n<p>目前Docker将/dev/shm限制为64M，却没有提供参数，这种做法比较糟糕。如果应用使用大内存的POSIX共享内存，必然会导致问题。 参考:</p>\n<p>l https://github.com/docker/docker/issues/2606</p>\n<p>l https://github.com/docker/docker/pull/4981</p>\n<h2><b>总结</b><b></b></h2>\n<p>(1)POSIX共享内存与SYS V共享内存在内核都是通过tmpfs实现，但对应两个不同的tmpfs实例，相互独立。</p>\n<p>(2)通过/proc/sys/kernel/shmmax可以限制SYS V共享内存(单个)的最大值，通过/dev/shm可以限制POSIX共享内存的最大值(所有之和)。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111665\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111665votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111665\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2016/11/59d49abe8909a122bc2c9aa43b71e3bb.png', 'full/d3d1a5ad957de059084690efae6fdfaa3527e1c3.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('创业公司操蛋的面试过程', '2017-07-07', 'http://blog.jobbole.com/111585/', 'e996399cd77b5e76c3d56717474e9813', 1, 3, '职场, , 技术面试, 面试', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a> 翻译，<a href=\"http://www.jobbole.com/members/huanglimin\">黄利民</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://zachholman.com/posts/startup-interviewing-is-fucked/\">Zach Holman</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>硅谷充满了下面这种创业公司，它们疯狂崇拜在面试中能够答对几道编码难题的候选人，并认为雇佣这些人最终会带来双赢的局面：能够解决算法难题宣告着伴随着他们的加入，背后的 VC 公司一定能获得高利益回报。</p>\n<blockquote>\n<p class=\"Tweet-text e-entry-title\" dir=\"ltr\" lang=\"en\">创业公司：我们正在招募能够革新和改变世界的人！</p>\n<p>面试官：请把这个字符移动到此数组上。</p></blockquote>\n<p>大多数创业公司的用户基础为零，但它们仍有可能成功。尽管技术很少是创业公司成功的原因，但我们依然不切实际地将编程谜题作为招聘的最佳标准。</p>\n<h3>了解你的需求</h3>\n<p>面试中遇到的问题，与工作中遇到的问题，两者存在相当广泛的差距。因此人们总是好奇，创业公司是如何脱离初期的孵化阶段。</p>\n<p>我是一名产品工程师。我没有正式的 CS 背景，但我会做 Web 相关的东西，并且还很擅长。在过去的 10 个月中，我一直在不断地进行面试，从未如此近距离得面对视图、控制器、甚至模型。并不是每个公司都坚持使用编程谜题作为招聘的技术指标，但使用这种方法的公司，基本上都完全聚焦在解决现实世界中不存在的奇特算法问题。</p>\n<blockquote><p>面试官： 怎样写一个完成此操作的方法？</p>\n<p>我：在 Ruby 中写一行代码。</p>\n<p>面试官：OK，那如果现在你不能使用标准库呢？想象一下这是一个 200 GB的文件，你必须在 Ruby 的内存中完成所有操作。</p>\n<p>我：我 TM 为什么要这样做？</p></blockquote>\n<p>诚然，对于一些工作而言，合格的面试要求“完全正确的”算法。但看看周围，有多少小型、不到 50 人的创业公司在做着这样的工作？业内有个不为人知的秘密，<span style=\"color: #ff0000;\">就是大部分创业公司在头几年，做的都是“响当当的”CRUD（增删改查）应用程序，并且认为能够产生最大影响的全面、多样化的人才，往往能够身兼数职</span>。</p>\n<p>我喜欢的一些推文谈到了这一点：</p>\n<blockquote><p>16 年 1 月 27 日</p>\n<p><strong>Trek Glowacki</strong> @trek</p>\n<p>我一直在推特上追踪那些我们面试过，但最终被排除出局的面试者的职业生涯。原来我们几乎都错了。</p>\n<p><strong>Trek Glowacki</strong> @trek</p>\n<p>…我们有一个叫“酒吧大佬”的小组，主要由缺乏“CS 基础”的候选人组成。原来我们错过了这么多优秀的人才。</p></blockquote>\n<p>你更需要担心的是，你是否招错人了！</p>\n<h3 id=\"power-dynamics\">动力学</h3>\n<p>现在的趋势是，公司普遍采用编程谜题来招人，这往往让那些不擅长技术面试但其他方面优秀的人才，在面试中失利。</p>\n<p>基于算法的难题通常是这么来的：面试官陶醉在自我欣赏、自命不凡的氛围中，想出了一些他们认为能够体现聪明才智的东西。 （解决前面那种算法题的）可靠方法是，从一开始就采用递归思路来解决问题。（这对于面试官而言，是一种诱惑。）如果这行不通，请再次尝试一次通过，而不是在 O(n) 操作中尝试。此时，即使只节约了额外的 1 ms，也一定能向公司证明你的价值。</p>\n<p>从这个角度来看，你马上给未来的同事（应征者）传达了一个信息，“正确答案只有我知道，而我希望你能得到它”。这样会让他们更有压力，因为你向他暗示了存在着一个正确答案。</p>\n<p>在我的职业生涯中，我完成的每一个产品都没有所谓的正确答案。它更像是雕刻大理石雕像：你对想要呈现的东西有一个模糊的概念和理解，而你必须通过不断地削减、雕琢它，来最终获得一个可能的结果。你和你的队友在此过程中一起获得最终答案，而不是以一个先入为主的答案，来指导你的同事独自获得它。</p>\n<h3 id=\"collaborate\">合作</h3>\n<p>这就是为什么有时我在面试过程中，强烈地主张结对编程。拿出一个小时，用于减少 Bug 或一起想要获得的功能。今天没有发生什么有趣的事吗？这个 Bug 太“无聊”了吗？好吧，那你为什么要这样做呢？如果这是候选人在工作中会实际碰到的<strong>典型问题</strong>，那么你值得在面试中一试。此外，即使只是最简单的错误修复，你也可以从别人那里学到很多东西。</p>\n<p>一起做一些真正的东西。这样做<strong>完全能够改变你的动力</strong>，我一直是这样强调的。从前你独自努力地寻找一个只有你知道的秘密，但现在你们团队合作，钻研一个答案未知的难题。以前你们是独立对抗，而现在则是团队合作。这会让你的候选人放心，更容易施展技能。</p>\n<h3 id=\"no-one-has-any-idea-what-theyre-doing\">没有人知道他们在做什么</h3>\n<p>技术面试中还有很多疯狂的事，我听说过，并且也曾经历过。</p>\n<p>Max Howell 曾为软件开发者创造过热门的一个工具  (Homebrew)，你可能听说过他在 2015 年在谷歌面试时被拒。谷歌面试官认为他不是一个合格的开发人员，因为他没能在白板上写出（二叉树翻转）算法。</p>\n<p>去年，我参加了一场巨头创业公司的面试，争取工程主管的职位，而当时公司的高速发展导致了一些基本问题，使得数百名开发商的产品无法顺利出货。我和公司的 CEO 和 CTO 进行了一次很好的讨论，关于对整个流程、CI、部署和管理架构进行全面的改革。然而，当我进入非编程领导岗位的最后一轮面试时，内容则几乎完全是由初级开发者问我初级的 JavaScript 问题。我在这样的情况下退缩了。</p>\n<hr>\n<p>你看，我现在明白了，面试需要花费时间和精力，而大多数人只想回到做事的阶段。提出一个标准化问题可以让你以更少的精力做更多的事，并让你比较不同候选人的能力。</p>\n<p>但是，选择的候选人是否合适，这需要花费长时间来检验。大多数处于初期阶段的创业公司，对候选人（特别针对早期员工）所需要的技能集太过炫目和繁杂了。它们期望候选人懂得：产品、代码、营销、设计，会沟通，并且饱含热情。你不能像微软或苹果那样过滤掉其他人。它们是大公司，让我第一个提醒你：你并不是它们，你有不同的优先事项。</p>\n<p>在我看来，你需要做更多的工作，但它会让公司变得更好，并招揽到更优秀的人才。但是我又知道什么呢，反正我也没通过那些操蛋的面试！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111585\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111585votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111585\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 6 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n	\r\n	<h3 class=\"widget-title\">\r\n	关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a>\r\n	</h3>\r\n	<div class=\"alignleft\">\r\n		<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">\r\n			<img src=\"http://jbcdn2.b0.upaiyun.com/2016/09/9667abaa540914200edd449974fb5538.jpg\">\r\n		</a>\r\n	</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            我见青山多妩媚，料青山见我应如是        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/zhj318\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/zhj318/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 20</a> · <a title=\"QQ：574375911\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a>         </span>\r\n    </div>\r\n	<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/04/b2be6a040296beff733db89b9cef0ab1.jpg', 'full/2f774db07a589d09c8c152c0bb471f04c956412e.jpg'),
('不再迷惑，无值和 NULL 值', '2017-07-07', 'http://blog.jobbole.com/111541/', 'ef6c307e280a8e27315c464cf98bb302', 3, 1, 'IT技术, , NULL, TSQL, 数据库, 无值', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/ljhdo/p/5128417.html\">Vic Liu</a>   </div><p>在关系型数据库的世界中，无值和NULL值的区别是什么？一直被这个问题困扰着，甚至在写TSQL脚本时，心有戚戚焉，害怕因为自己的一知半解，挖了坑，贻害后来人，于是，本着上下求索，不达通幽不罢休的决心（开个玩笑），遂有此文。</p>\n<p>学习过关系型数据库的伙伴都知道，NULL是指不确定的值，在数据库中绝对是噩梦的存在；而空值，一般对字符串类型而言，指没有任何值的字符串类型，为字符类型的变量设置为空值：set @vs=”，空值跟无值不同。有人可能会问，无值是什么？无值，是指数据表中没有任何数据。无值和不确定值，单从字面意思上来看，两者之间的定义很清楚，一旦深究，这两者之间的关系，有时令人十分迷惑（confused），这是因为，在特定条件下，无值会转换为NULL值。</p>\n<h3>一，举个栗子，理解无值和NULL值的区别</h3>\n<p>比如，创建一个临时表，在不插入任何数据时，该数据表是空的，没有任何值，对其执行select命令，将不会返回任何数据值：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80edd8f932251565\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncreate table #temp\r\n(\r\nid int null\r\n)</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80edd8f932251565-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80edd8f932251565-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80edd8f932251565-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80edd8f932251565-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80edd8f932251565-1\"><span class=\"crayon-e\">create </span><span class=\"crayon-v\">table</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#temp</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80edd8f932251565-2\"><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-59602a80edd8f932251565-3\"><span class=\"crayon-e\">id </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80edd8f932251565-4\"><span class=\"crayon-sy\">)</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>创建一个标量类型的变量，在不初始化时，该变量的值是不确定的，其值是NULL：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80edd99160418802\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndeclare @vs int</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80edd99160418802-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80edd99160418802-1\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">vs </span><span class=\"crayon-t\">int</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>创建一个表类型变量，在不初始化时，该表变量没有任何数据，是无值的：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80edd9d435684606\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndeclare @vt as table\r\n(\r\nid int null\r\n)</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80edd9d435684606-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80edd9d435684606-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80edd9d435684606-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80edd9d435684606-4\">4</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80edd9d435684606-1\"><span class=\"crayon-r\">declare</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">vt </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">table</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80edd9d435684606-2\"><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-59602a80edd9d435684606-3\"><span class=\"crayon-e\">id </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80edd9d435684606-4\"><span class=\"crayon-sy\">)</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>总结一下，声明一个标量型变量，如果没有对变量进行初始化，其值是不确定的，是NULL值；对于表变量，临时表和基础表，如果没有插入任何数据，该表没有任何数据，是无值的。</p>\n<h3>二，无值和NULL值的转换</h3>\n<p>在开始本节之前，先为变量赋值，简单的一个select命令就可以完成变量的赋值：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80edda0314280803\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nselect @vs=1</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80edda0314280803-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80edda0314280803-1\"><span class=\"crayon-i\">select</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">vs</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>有些朋友思维比较活跃，立马会想到：“用select命令可以从表中取值为变量赋值”，对，但是，赋值方法不是我求索的重点，我关注的是从表中取值为变量赋值的结果。</p>\n<p><strong>1，从空表中为变量赋值</strong></p>\n<p>如果数据表是空表，没有任何值，那么数据库引擎不会执行赋值语句，变量保持原有值不变：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80edda4952005878\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nselect @vs=id\r\nfrom #temp</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80edda4952005878-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80edda4952005878-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80edda4952005878-1\"><span class=\"crayon-i\">select</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">vs</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">id</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80edda4952005878-2\"><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#temp</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>但是，如果采用以下方式，那么数据库引擎会执行赋值语句，由于空表不返回任何值，数据库引擎会把无值转换为不确定值NULL：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80edda7980116347\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nselect @vs=(select top 1 id\r\nfrom #temp)</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80edda7980116347-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80edda7980116347-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80edda7980116347-1\"><span class=\"crayon-i\">select</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">vs</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">select </span><span class=\"crayon-i\">top</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">id</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80edda7980116347-2\"><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#temp)</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>诧异吗？无值和NULL值的转换，居然从不起眼的变量赋值开始。<strong>注意，当不返回任何值时，数据库引擎不确定返回值，就把无值转换为NULL值。</strong></p>\n<p><strong>2，从空表中计算聚合</strong></p>\n<p>空表是没有任何数据的表，计算聚合会产生怎样的结果？</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eddaa122164069\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nselect count(0) as count_all\r\n    ,count(id) as count_id\r\n    ,max(id) as max_id\r\n    ,min(id) as min_id\r\n    ,avg(id) as avg_id\r\n    ,sum(id) as sum_id\r\nfrom #temp</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eddaa122164069-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddaa122164069-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddaa122164069-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddaa122164069-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddaa122164069-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddaa122164069-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddaa122164069-7\">7</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eddaa122164069-1\"><span class=\"crayon-e\">select </span><span class=\"crayon-e\">count</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">_</span>all</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddaa122164069-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">count</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line\" id=\"crayon-59602a80eddaa122164069-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddaa122164069-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">min</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line\" id=\"crayon-59602a80eddaa122164069-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">avg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">avg</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddaa122164069-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">sum</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sum_id</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eddaa122164069-7\"><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#temp</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>当统计数据行数时，返回的是0；当计算聚合函数（max，min，avg和sum）的聚合值时，由于无值可以聚合，数据库引擎不能确定这些聚合函数的返回值，因此，数据库引擎返回NULL值。</p>\n<p style=\"text-align: center\"><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/aa7d9f4278af95b35311f5d41c7b9fa2.png\"><img class=\"alignnone size-medium wp-image-111574\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/aa7d9f4278af95b35311f5d41c7b9fa2-300x39.png\" alt=\"628084-20170620110230601-1550885802\"></a></p>\n<h3>三，聚合函数忽略NULL值</h3>\n<p>一般情况下，除了count(0)，count(*)之外，聚合函数都会忽略NULL值，而统计非NULL值，如果读者有疑问，可以查看我的博客《<a id=\"cb_post_title_url\" class=\"postTitle2\" href=\"http://www.cnblogs.com/ljhdo/p/4950586.html\">TSQL 聚合函数忽略NULL值</a>》。如果只知聚合函数忽略NULL值，而不知空表也会产生结果为NULL的聚合值，轻易得出聚合函数不会返回NULL值的定论，那就很尴尬。楼主曾遇到过一次“意外”，在一次调试脚本代码的过程中，我遇到max聚合函数返回NULL值的情况，当时一脸懵逼，直接怀疑自己之前的所学。</p>\n<p>当聚合列值都是NULL值时，由于聚合函数忽略NULL值，因此，当计算聚合函数（max，min，avg和sum）的聚合值时，由于无值可以聚合，数据库引擎不能确定这些聚合函数的返回值，因此，数据库引擎返回NULL值。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a80eddae108697105\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninsert into #temp(id)\r\nvalues(null)\r\n\r\nselect count(0) as count_all\r\n    ,count(id) as count_id\r\n    ,max(id) as max_id\r\n    ,min(id) as min_id\r\n    ,avg(id) as avg_id\r\n    ,sum(id) as sum_id\r\nfrom #temp</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a80eddae108697105-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddae108697105-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddae108697105-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddae108697105-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddae108697105-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddae108697105-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddae108697105-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddae108697105-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a80eddae108697105-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a80eddae108697105-10\">10</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a80eddae108697105-1\"><span class=\"crayon-e\">insert </span><span class=\"crayon-v\">into</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#temp(id)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddae108697105-2\"><span class=\"crayon-e\">values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59602a80eddae108697105-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddae108697105-4\"><span class=\"crayon-e\">select </span><span class=\"crayon-e\">count</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">_</span>all</div><div class=\"crayon-line\" id=\"crayon-59602a80eddae108697105-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">count</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddae108697105-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">max</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line\" id=\"crayon-59602a80eddae108697105-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">min</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">min</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddae108697105-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">avg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">avg</span><span class=\"crayon-sy\">_</span>id</div><div class=\"crayon-line\" id=\"crayon-59602a80eddae108697105-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">sum</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sum_id</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a80eddae108697105-10\"><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#temp</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p>聚合函数（max,min,sum,avg和count）忽略null值，但不代表聚合函数不返回null值：如果数据表为空表，或聚合列值都是null，那么max,min,sum,avg聚合函数返回null值，而count 聚合函数返回0。聚合函数的共性：<span id=\"mt3\" class=\"sentence SentenceHover\">Null values are ignored。</span></p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/06/67f68fb73135e2a336466ab69fe7df28.png\"><img class=\"size-medium wp-image-111576 aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/06/67f68fb73135e2a336466ab69fe7df28-300x37.png\" alt=\"628084-20170620112538616-1090159798\"></a></p>\n<p>不再迷惑：<strong>当不返回任何值时，数据库引擎不确定返回值，就把无值转换为NULL值。</strong></p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111541\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111541votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111541\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/06/aa7d9f4278af95b35311f5d41c7b9fa2-300x39.png', 'full/233e3fbaa3d4c54374b5477ad13750ab622a9d4c.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('我是如何开始踏上 bash 脚本编程之路的？', '2017-07-07', 'http://blog.jobbole.com/111509/', 'f65b12bcb444cfbc3d0109311fbdd75c', 1, 2, 'IT技术, , Bash', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://opensource.com/article/17/5/how-i-learned-bash-scripting\">Sandra Mccann</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-8617-1.html\">Linux中国/xllc</a>   </div><p>我前几天写了一个脚本。对于一些人来说，这句话听起来没什么了不起的。而对于另一些人来说，这句话意义重大。要知道，我不是一个程序员，而是一个作家。</p>\n<h3 id=\"toc_1\">我需要解决什么？</h3>\n<p>我的问题相当简单：我需要将工程文件进行分类。这些文件可以从一个网站 URL 以 .zip 的格式下载。当我正手工将它们拷贝到我的电脑桌面，并移动到一个已按照我文件分类的需要进行了结构化的目录时，一位作家同事给我提了建议：<em>“不就是写个脚本的事吗？”</em></p>\n<p>我心想：<em>“就写个脚本？”</em>——说得好像这是世界上最容易做的事情一样。</p>\n<h3 id=\"toc_2\">Google 是如何解救我的？</h3>\n<p>同事的问题促使我思考，并且经过思考后，我进行了 Google 搜索。</p>\n<p><strong>Linux 上使用的是什么脚本编程语言？</strong></p>\n<p>这是我第一个 Google 搜索的准则。也许很多人心里会想：“她太笨了！”是的，我很笨。不过，这的确使我走上了一条解决问题的道路。最常见的搜索结果是 Bash 。嗯，我听说过 Bash 。呃，我要分类的文件中有一个里面就有 Bash，那无处不在的 <code>#!/bin/bash</code> 。我重新看了下那个文件，我知道它的用途，因为我需要将它分类。</p>\n<p>这引导我进行了下一个 Google 搜索。</p>\n<p><strong>如何从一个 URL 下载 zip 文件？</strong></p>\n<p>那确实是我的基本任务。我有一个带有 .zip 文件的 URL ，它包含有所有我需要分类的文件，所以我寻求万能的 Google 的帮助。搜索到的精华内容和其它一些结果引导我使用 Curl 。但最重要的是：我不仅找到了 Curl ，其中一条置顶的搜索结果还展示了一个使用 Curl 去下载并解压 .zip 文件的 Bash 脚本。这超出了我本来想寻求的答案，但那也使我意识到在 Google 搜索具体的请求可以得到我写这个脚本需要的信息。所以，在这个收获的推动下，我写了最简单的脚本：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a828b34d173514810\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/sh\r\ncurl http://rather.long.url | tar -xz -C my_directory --strip-components=1</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a828b34d173514810-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b34d173514810-2\">2</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a828b34d173514810-1\"><span class=\"crayon-p\">#!/bin/sh</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b34d173514810-2\"><span class=\"crayon-e\">curl </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//rather.long.url | tar -xz -C my_directory --strip-components=1</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>我迫不及待地运行看看。但我发现一个问题： URL 是会变的，根据我要访问的文件的分组不同而不同。我有新的问题需要解决，这使我进行了下一轮搜索。</p>\n<p><strong>参数如何传递给 Bash 脚本？</strong></p>\n<p>我需要以不同的 URL 和不同的最终目录来运行此脚本。 Google 向我展示了如何使用 <code>$1</code>、<code>$2</code> 等等来替换我在命令行中运行脚本时输入的内容。比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a828b357908128693\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbash myscript.sh http://rather.long.url my_directory</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a828b357908128693-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a828b357908128693-1\"><span class=\"crayon-e\">bash </span><span class=\"crayon-v\">myscript</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sh </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//rather.long.url my_directory</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>这就好多了。一切如我所愿，灵活，实用。最重要的是我只要输入一条简短的命令就可以节省 30 分钟无聊的复制、粘贴工作。这个早上的时间花得值得。</p>\n<p>然后我发现还有一个问题：我很健忘，并且我知道我几个月才运行一次这个脚本。这留给我两个疑问：</p>\n<ul>\n<li>我要如何记得运行脚本时输入什么（URL 先，还是目录先）？</li>\n<li>如果我被货车撞了，其它作家如何知道该怎样运行我的脚本？</li>\n</ul>\n<p>我需要一个使用说明 —— 如果我使用不正确，则脚本会提示。比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a828b35c650871011\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nusage: bash yaml-fetch.sh &lt;\'snapshot_url\'&gt; &lt;directory&gt;</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a828b35c650871011-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a828b35c650871011-1\"><span class=\"crayon-v\">usage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bash </span><span class=\"crayon-v\">yaml</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">fetch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sh</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-s\">\'snapshot_url\'</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">directory</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>否则，则直接运行脚本。我的下一个搜索是：</p>\n<p><strong>如何在 Bash 脚本里使用 “if/then/else”?</strong></p>\n<p>幸运的是，我已经知道编程中 <code>if/then/else</code> 的存在。我只要找出如何使用它的方法。在这个过程中，我也学到了如何在 Bash 脚本里使用 <code>echo</code> 打印。我的最终成果如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59602a828b35f207815199\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/sh\r\nURL=$1\r\nDIRECTORY=$2\r\nif [ $# -eq 0 ];\r\n then\r\n echo \"usage: bash yaml-fetch.sh &lt;\'snapshot_url\'&gt; &lt;directory&gt;\".\r\n else\r\n# 如果目录不存在则创建它\r\n echo \'create directory\'\r\n mkdir $DIRECTORY\r\n # 下载并解压 yaml 文件\r\n echo \'fetch and untar the yaml files\'\r\n curl $URL | tar -xz -C $DIRECTORY --strip-components=1\r\nfi</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59602a828b35f207815199-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59602a828b35f207815199-14\">14</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-1\"><span class=\"crayon-p\">#!/bin/sh</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-2\"><span class=\"crayon-v\">URL</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-3\"><span class=\"crayon-v\">DIRECTORY</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">2</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-4\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-p\"># -eq 0 ];</span></div><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-6\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"usage: bash yaml-fetch.sh &lt;\'snapshot_url\'&gt; &lt;directory&gt;\"</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-7\"><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-8\"><span class=\"crayon-p\"># 如果目录不存在则创建它</span></div><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-9\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\'create directory\'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-10\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">mkdir</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">DIRECTORY</span></div><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-11\"><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># 下载并解压 yaml 文件</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-12\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\'fetch and untar the yaml files\'</span></div><div class=\"crayon-line\" id=\"crayon-59602a828b35f207815199-13\"><span class=\"crayon-h\"> </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">URL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tar</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">xz</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">DIRECTORY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">strip</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">components</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59602a828b35f207815199-14\"><span class=\"crayon-v\">fi</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p></p>\n<h3 id=\"toc_3\">Google 和脚本编程如何颠覆我的世界？</h3>\n<p>好吧，这稍微有点夸大，不过现在是 21 世纪，学习新东西（特别是稍微简单的东西）比以前简单多了。我所学到的（除了如何写一个简短的、自动分类的 Bash 脚本之外）是如果我有疑问，那么有很大可能性是其它人在之前也有过相同的疑问。当我困惑时，我可以问下一个问题，再下一个问题。最后，我不仅拥有了脚本，还拥有了可以一直拥有并可以简化其它任务的新技能，这是我之前所没有的。</p>\n<p>别止步于第一个脚本（或者编程的第一步）。这是一个技能，和其它的技能并无不同，有大量的信息可以在这一路上帮助你。你无需阅读大量的书或参加一个月的课程。你可以像婴儿学步那样简单地开始写脚本，然后掌握技能并建立自信。人们总有写成千上万行代码的需求，并对它进行分支、合并、修复错误。但是，通过简单的脚本或其它方式来自动化、简单化任务的需求也一样强烈。这样的一个小脚本和小小的自信就能够让你启程脚本编程之路。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111509\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111509votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111509\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/05/77d80105fd15f2465894827e23cc4842.jpeg', 'full/d1b17b98748a74826464a08e6d30a4ee1b15b171.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('ASP.NET Core 2.0 新功能汇总', '2017-07-07', 'http://blog.jobbole.com/111534/', 'f7fa476bb742d228be961501bbcc2938', 0, 1, '开发, .NET Core', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/savorboard/p/aspnetcore2-feature.html\">Savorboard</a>   </div><div>\n<h3 id=\"前言\">前言</h3>\n<p>ASP.NET Core 的变化和发展速度是飞快的，当你发现你还没有掌握 ASP.NET Core 1.0 的时候， 2.0 已经快要发布了，目前 2.0 处于 Preview 1 版本，意味着功能已经基本确定，还没有学习过 ASP.NET Core 的同学可以直接从 2.0 开始学起，但是如果你已经掌握了 1.0 的话，那么你只需要了解在 2.0 中增加和修改的一些功能即可。</p>\n<p>每一次大版本的发布和升级，总会带给开发人员一些惊喜和令人兴奋的特性，有关 ASP.NET Core 本次的 2.0 版本的新特性，主要集中在几个部分上。</p>\n<h3 id=\"sdk-的变化\">SDK 的变化</h3>\n<p>PS: 目前如果你想在VS中体验 ASP.NET Core 2.0 全部特性的话，你需要 VS 2017.3 预览版本。当然你可以使用 VS Core 来快速了解。</p>\n<p>.NET Core 2.0 Priview 的下载地址：<br>\n<a href=\"https://www.microsoft.com/net/core/preview#windowscmd\">https://www.microsoft.com/net/core/preview#windowscmd</a></p>\n<p>完成之后可以在 cmd 中使用以下命令查看版本。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/ab55900c39118415725f32ac7906f437.png\"></p>\n<p><strong>变化1</strong>：添加了如下图箭头所指新命令。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/c1586e500a04c565a23bbe72f2cf2f0d.png\"></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2dd2961088174\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ndotnet new razor\r\ndotnet new nugetconfig\r\ndotnet new page\r\ndotnet new viewimports\r\ndotnet new viewstart</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dd2961088174-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dd2961088174-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dd2961088174-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dd2961088174-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dd2961088174-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2dd2961088174-1\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">razor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dd2961088174-2\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nugetconfig</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dd2961088174-3\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">page</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dd2961088174-4\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">viewimports</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dd2961088174-5\"><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">viewstart</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p>添加了这些新的cli命令。 其中 <code>viewimports</code>,<code>viewstart</code> 即为Razor视图中的_xxx.cshtml那两个文件.</p>\n<p><strong>变化2</strong>： <code>dotnet new xxx</code> 将会自动还原 NuGet 包，不需要你再次进行 <code>dotnet restore</code> 命令了。</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2ddc155161488\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nG:SampleASPNETCore2 &gt; dotnet new mvc\r\n\r\nThe template \"ASP.NET Core Web App (Model-View-Controller)\" was created successfully.\r\nThis template contains technologies from parties other than Microsoft, see https://aka.ms/template-3pn for details.\r\n\r\nProcessing post-creation actions...\r\nRunning \'dotnet restore\' on G:SampleASPNETCore2ASPNETCore2.csproj...\r\nRestore succeeded.</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2ddc155161488-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2ddc155161488-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2ddc155161488-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2ddc155161488-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2ddc155161488-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2ddc155161488-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2ddc155161488-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2ddc155161488-8\">8</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2ddc155161488-1\"><span class=\"crayon-v\">G</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">SampleASPNETCore2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">dotnet </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mvc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2ddc155161488-2\"> </div><div class=\"crayon-line\" id=\"crayon-59600c03d2ddc155161488-3\"><span class=\"crayon-e\">The </span><span class=\"crayon-i\">template</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"ASP.NET Core Web App (Model-View-Controller)\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">was </span><span class=\"crayon-e\">created </span><span class=\"crayon-v\">successfully</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2ddc155161488-4\"><span class=\"crayon-r\">This</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">template </span><span class=\"crayon-e\">contains </span><span class=\"crayon-e\">technologies </span><span class=\"crayon-e\">from </span><span class=\"crayon-e\">parties </span><span class=\"crayon-e\">other </span><span class=\"crayon-e\">than </span><span class=\"crayon-v\">Microsoft</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">see </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//aka.ms/template-3pn for details.</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2ddc155161488-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2ddc155161488-6\"><span class=\"crayon-e\">Processing </span><span class=\"crayon-v\">post</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">creation </span><span class=\"crayon-v\">actions</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2ddc155161488-7\"><span class=\"crayon-i\">Running</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\'dotnet restore\'</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">on</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">G</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">SampleASPNETCore2ASPNETCore2</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">csproj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2ddc155161488-8\"><span class=\"crayon-e\">Restore </span><span class=\"crayon-v\">succeeded</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n\n</div>\n<h3 id=\"csproj-项目文件\">*.csproj 项目文件</h3>\n<p>在 2.0 中，当创建一个 MVC 项目的时候，生成的 csporj 项目文件如下：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/97fdfcb1ba546862f303e979c9e1abf6.png\"></p>\n<p>其中，红色箭头部分为新增内容，我们依次来看一下：</p>\n<p><strong>MvcRazorCompileOnPublish</strong>：</p>\n<p>在 1.0 版本中，如果我们需要在发布的时候编译 MVC 中的 Views 文件夹为DLL的话，需要引用<br>\n<code>Microsoft.AspNetCore.Mvc.Razor.ViewCompilation</code> 这个 NuGet 包，而现在已经不需要了，这个功能已经默认的集成在了SDK中，只需要在csporj添加配置即可，在发布的时候将会自动打包 Views 文件夹中的 *.cshtml 文件为 DLL 程序集。</p>\n<p><strong>PackageTargetFallback</strong></p>\n<p>这个配置项是用来配置当前程序集支持的目标框架。</p>\n<p><strong>UserSecretsId</strong></p>\n<p>这个是用来存储程序中使用的机密，以前是存储在 <code>project.json</code> 文件中，现在你可以在这里进行配置了。</p>\n<p>有关 UserSecrets 的更多信息，可以查看我的<a href=\"http://www.cnblogs.com/savorboard/p/dotnetcore-user-secrets.html\">这篇博客文章</a>。</p>\n<p><strong>MVC 相关包</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2de1907164341\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n&lt;packagereference include=\"Microsoft.AspNetCore.All\" version=\"2.0.0-preview1-final\"/&gt;</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de1907164341-1\">1</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2de1907164341-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">packagereference </span><span class=\"crayon-v\">include</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"Microsoft.AspNetCore.All\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">version</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"2.0.0-preview1-final\"</span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>在 Core MVC 2.0 中，所有MVC相关的NuGet 包都被集成到了这个<code>Microsoft.AspNetCore.All</code>包中，它是一个元数据包，包含了大量的东西，其中包括：Authorization, Authentication, Identity, CORS, Localization, Logging, Razor, Kestrel 等，除了这些它还附加了 EntityFramework, SqlServer, Sqlite 等包。</p>\n<p>有些同学可能会觉得这样会引用了很多项目中使用不到的程序集，导致发布后的程序变得很庞大，不过我要告诉你不必担心，发布后的程序集不但不会变得很大，反而会小很多，因为 Microsoft 把所有的这些依赖全部都集成到了sdk中，也就是说当你安装sdk的之后，MVC相关的包就已经安装到了你的系统上。</p>\n<p>这样的好处是你不用担心更新Nuget包或者删除的时候，因为大量的版本不一致问题导致隐藏的冲突问题，另外一个好处就是，这样对于很多新手的话就很友好 2333，他们不需要知道他们什么情况下会从那个NuGet 包中获取自己需要的信息。</p>\n<p><strong>现在</strong>，发布后的文件夹是如此简洁： 大小 4.3M</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/45fbe5a1339d55457e306c99537e2275.png\"></p>\n<p>再贴个<strong>以前的</strong> 发布后的文件夹你们感受一下: 大小 16.5M</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/06/4ed198a340b62b14d8b07293a2729a09.png\"></p>\n<p>有些同学可能好奇他们把那些引用的 MVC 包放到哪里了，默认情况下他们位于这个目录：</p>\n<p><code>C:Program Filesdotnetstorex64netcoreapp2.0</code></p>\n<h3 id=\"新的-program.cs-和-startup.cs\">新的 Program.cs 和 Startup.cs</h3>\n<p>现在，当创建一个 ASP.NET Core 2.0 MVC 程序的时候，Program 和 Startup 已经发生了变化，他们已经变成了这样：</p>\n<p><em>Program.cs</em></p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2de6839475849\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic class Program\r\n{\r\n    public static void Main(string[] args)\r\n    {\r\n        BuildWebHost(args).Run();\r\n    }\r\n\r\n    public static IWebHost BuildWebHost(string[] args) =&gt;\r\n        WebHost.CreateDefaultBuilder(args)\r\n            .UseStartup&lt;Startup&gt;()\r\n            .Build();\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de6839475849-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2de6839475849-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de6839475849-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2de6839475849-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de6839475849-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2de6839475849-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de6839475849-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2de6839475849-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de6839475849-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2de6839475849-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2de6839475849-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2de6839475849-12\">12</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2de6839475849-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Program</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2de6839475849-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2de6839475849-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2de6839475849-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2de6839475849-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">BuildWebHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Run</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2de6839475849-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2de6839475849-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2de6839475849-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IWebHost </span><span class=\"crayon-e\">BuildWebHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2de6839475849-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">WebHost</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">CreateDefaultBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2de6839475849-10\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UseStartup</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Startup</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2de6839475849-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2de6839475849-12\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n\n</div>\n<p><em>Startup.cs</em></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2deb562110309\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic class Startup\r\n{\r\n    public Startup(IConfiguration configuration)\r\n    {\r\n        Configuration = configuration;\r\n    }\r\n    \r\n    public IConfiguration Configuration { get; }\r\n    \r\n    public void ConfigureServices(IServiceCollection services)\r\n    {\r\n        services.AddMvc();\r\n    }\r\n\r\n    public void Configure(IApplicationBuilder app, IHostingEnvironment env)\r\n    {\r\n        if (env.IsDevelopment())\r\n        {\r\n            app.UseDeveloperExceptionPage();\r\n        }\r\n        else\r\n        {\r\n            app.UseExceptionHandler(\"/Home/Error\");\r\n        }\r\n\r\n        app.UseStaticFiles();\r\n\r\n        app.UseMvc(routes =&gt;\r\n        {\r\n            routes.MapRoute(\r\n                name: \"default\",\r\n                template: \"{controller=Home}/{action=Index}/{id?}\");\r\n        });\r\n    }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2deb562110309-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2deb562110309-35\">35</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Startup</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Startup</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-7\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-9\"><span class=\"crayon-h\">    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ConfigureServices</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IServiceCollection </span><span class=\"crayon-v\">services</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">services</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddMvc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-14\"> </div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configure</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IApplicationBuilder </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IHostingEnvironment </span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-16\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsDevelopment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseDeveloperExceptionPage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-23\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseExceptionHandler</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"/Home/Error\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-25\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseStaticFiles</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-27\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseMvc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">routes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">routes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">MapRoute</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"default\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-32\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">template</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"{controller=Home}/{action=Index}/{id?}\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2deb562110309-34\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2deb562110309-35\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0034 seconds] -->\r\n<p>可以发现，新的 Program.cs 中和 Startup.cs 中的内容已经变得很简单了，少了很多比如 appsetting.json 文件的添加，日志中间件， Kertrel ， HostingEnvironment 等，那么是怎么回事呢？ 其他他们已经被集成到了 <code>WebHost.CreateDefaultBuilder</code> 这个函数中，那么我们跟进源码来看一下内部是怎么做的。</p>\n<h4 id=\"webhost.createdefaultbuilder\">WebHost.CreateDefaultBuilder</h4>\n<p>下面是 <code>WebHost.CreateDefaultBuilder</code> 这个函数的源码：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2df0371154363\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic static IWebHostBuilder CreateDefaultBuilder(string[] args)\r\n{\r\n    var builder = new WebHostBuilder()\r\n        .UseKestrel()\r\n        .UseContentRoot(Directory.GetCurrentDirectory())\r\n        .ConfigureAppConfiguration((hostingContext, config) =&gt;\r\n        {\r\n            var env = hostingContext.HostingEnvironment;\r\n\r\n            config.AddJsonFile(\"appsettings.json\", optional: true, reloadOnChange: true)\r\n                  .AddJsonFile($\"appsettings.{env.EnvironmentName}.json\", optional: true, reloadOnChange: true);\r\n\r\n            if (env.IsDevelopment())\r\n            {\r\n                var appAssembly = Assembly.Load(new AssemblyName(env.ApplicationName));\r\n                if (appAssembly != null)\r\n                {\r\n                    config.AddUserSecrets(appAssembly, optional: true);\r\n                }\r\n            }\r\n\r\n            config.AddEnvironmentVariables();\r\n\r\n            if (args != null)\r\n            {\r\n                config.AddCommandLine(args);\r\n            }\r\n        })\r\n        .ConfigureLogging((hostingContext, logging) =&gt;\r\n        {\r\n            logging.UseConfiguration(hostingContext.Configuration.GetSection(\"Logging\"));\r\n            logging.AddConsole();\r\n            logging.AddDebug();\r\n        })\r\n        .UseIISIntegration()\r\n        .UseDefaultServiceProvider((context, options) =&gt;\r\n        {\r\n            options.ValidateScopes = context.HostingEnvironment.IsDevelopment();\r\n        })\r\n        .ConfigureServices(services =&gt;\r\n        {\r\n            services.AddTransient&lt;IConfigureOptions&lt;KestrelServerOptions&gt;, KestrelServerOptionsSetup&gt;();\r\n        });\r\n\r\n    return builder;\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df0371154363-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df0371154363-46\">46</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IWebHostBuilder </span><span class=\"crayon-e\">CreateDefaultBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">builder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebHostBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseKestrel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseContentRoot</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Directory</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetCurrentDirectory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureAppConfiguration</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">env</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">HostingEnvironment</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-10\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddJsonFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"appsettings.json\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">optional</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reloadOnChange</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-11\"><span class=\"crayon-h\">                  </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddJsonFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"appsettings.{env.EnvironmentName}.json\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">optional</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reloadOnChange</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-12\"> </div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-13\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsDevelopment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-14\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-15\"><span class=\"crayon-h\">                </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appAssembly</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Assembly</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Load</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AssemblyName</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ApplicationName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-16\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">appAssembly</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-17\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-18\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddUserSecrets</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">appAssembly</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">optional</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-19\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-20\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-22\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddEnvironmentVariables</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-24\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-26\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddCommandLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-27\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureLogging</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-31\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseConfiguration</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">hostingContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetSection</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Logging\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-32\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddConsole</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-33\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">logging</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddDebug</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-34\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseIISIntegration</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseDefaultServiceProvider</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-38\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ValidateScopes</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">HostingEnvironment</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsDevelopment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-39\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureServices</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">services</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-41\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-42\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">services</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">AddTransient</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">IConfigureOptions</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">KestrelServerOptions</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">KestrelServerOptionsSetup</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-44\"> </div><div class=\"crayon-line\" id=\"crayon-59600c03d2df0371154363-45\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">builder</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df0371154363-46\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0066 seconds] -->\r\n\n</div>\n<p>可看到，新的方式已经隐藏了很多细节，帮助我们完成了大部分的配置工作。但是你知道怎么样来自定义这些中间件或者配置也是必要的技能之一。</p>\n<h3 id=\"appsettings.json-的变化\">appsettings.json 的变化</h3>\n<p>在 appsettings.json 中，我们可以定义 Kestrel 相关的配置，应用程序会在启动的时候使用该配置进行Kerstrel的启动。</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2df4287332900\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n{\r\n    \"Kestrel\": {\r\n        \"Endpoints\": {\r\n            \"Localhost\": {\r\n                \"Address\": \"127.0.0.1\",\r\n                \"Port\": \"9000\"\r\n            },\r\n            \"LocalhostHttps\": {\r\n                \"Address\": \"127.0.0.1\",\r\n                \"Port\": \"9001\",\r\n                \"Certificate\": \"Https\"\r\n            }\r\n        }\r\n    },\r\n    \"Certificate\": {\r\n        \"HTTPS\": {\r\n            \"Source\": \"Store\",\r\n            \"StoreLocation\": \"LocalMachine\",\r\n            \"StoreName\": \"MyName\",\r\n            \"Subject\": \"CN=localhost\",\r\n            \"AllowInvalid\": true\r\n        }\r\n    },\r\n    \"Logging\": {\r\n        \"IncludeScopes\": false,\r\n        \"LogLevel\": {\r\n            \"Default\": \"Warning\"\r\n        }\r\n    }\r\n}</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2df4287332900-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2df4287332900-30\">30</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-s\">\"Kestrel\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Endpoints\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-4\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Localhost\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-5\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Address\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"127.0.0.1\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-6\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Port\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"9000\"</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-7\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-8\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"LocalhostHttps\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-9\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Address\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"127.0.0.1\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-10\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Port\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"9001\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-11\"><span class=\"crayon-h\">                </span><span class=\"crayon-s\">\"Certificate\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Https\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-s\">\"Certificate\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"HTTPS\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-17\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Source\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Store\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"StoreLocation\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"LocalMachine\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"StoreName\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"MyName\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-20\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Subject\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"CN=localhost\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-21\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"AllowInvalid\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-24\"><span class=\"crayon-h\">    </span><span class=\"crayon-s\">\"Logging\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"IncludeScopes\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"LogLevel\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-27\"><span class=\"crayon-h\">            </span><span class=\"crayon-s\">\"Default\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Warning\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2df4287332900-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2df4287332900-30\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0027 seconds] -->\r\n\n</div>\n<p>以上配置内容配置了 Kertrel 启动的时候使用的本地地址和端口，以及在生产环境需要使用的 HTTPS 的配置项，通常情况下关于 HTTPS 的节点配置部分应该位于 appsettings.Production.json 文件中。</p>\n<p>现在，<code>dotnet run</code>在启动的时候将同时监听 9000, 和 9001 端口。</p>\n<h3 id=\"日志的变化\">日志的变化</h3>\n<p>在 ASP.NET Core 2.0 中关于日志的变化是非常令人欣慰的，因为它现在不是作为MVC中间件配置的一部分了，而是 Host 的一部分，这句话好像有点别扭，囧~。 这意味着你可以记录到更加底层产生的一些错误信息了。</p>\n<p>现在你可以这样来扩展日志配置。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2dfa567667280\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n  public static IWebHost BuildWebHost(string[] args) =&gt;\r\n        WebHost.CreateDefaultBuilder(args)\r\n        .UseStartup&lt;Startup&gt;()\r\n        .ConfigureLogging(factory=&gt;{你的配置})\r\n        .Build();</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfa567667280-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfa567667280-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfa567667280-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfa567667280-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfa567667280-5\">5</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2dfa567667280-1\"><span class=\"crayon-h\">  </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IWebHost </span><span class=\"crayon-e\">BuildWebHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfa567667280-2\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">WebHost</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">CreateDefaultBuilder</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfa567667280-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UseStartup</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Startup</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfa567667280-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ConfigureLogging</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">factory</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">{</span>你的配置<span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfa567667280-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p></p>\n<h3 id=\"全新的-razor-pages\">全新的 Razor Pages</h3>\n<p>ASP.NET Core 2.0 引入的另外一个令人兴奋的特性就是 Razor Pages。提供了另外一种方式可以让你在做Web 页面开发的时候更加的沉浸式编程，或者叫 page-focused 。额…它有点像以前 Web Form Page，它隶属于 MVC 框架的一部分，但是他们没有 Controller。</p>\n<p>你可以通过 <code>dotnet new razor</code> 命令来新建一个 Razor Pages 类型的<strong>应用程序</strong>。</p>\n<p>Razor Pages 的 cshtml 页面代码可能看起来是这样的：</p>\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n		<div id=\"crayon-59600c03d2dfe931394185\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-mac print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n		\r\n			<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n			<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n			<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n			<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n@ page\r\n\r\n@{\r\n    var message = \"Hello, World!\";\r\n}\r\n\r\n&lt;html&gt;\r\n&lt;body&gt;\r\n    &lt;p&gt;@ message&lt;/p&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;</textarea></div>\r\n			<div class=\"crayon-main\" style=\"\">\r\n				<table class=\"crayon-table\">\r\n					<tr class=\"crayon-row\">\r\n				<td class=\"crayon-nums \" data-settings=\"show\">\r\n					<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfe931394185-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfe931394185-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfe931394185-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfe931394185-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfe931394185-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfe931394185-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfe931394185-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfe931394185-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfe931394185-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-59600c03d2dfe931394185-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-59600c03d2dfe931394185-11\">11</div></div>\r\n				</td>\r\n						<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-59600c03d2dfe931394185-1\"><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">page</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfe931394185-2\"> </div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfe931394185-3\"><span class=\"crayon-sy\">@</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfe931394185-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Hello, World!\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfe931394185-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfe931394185-6\"> </div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfe931394185-7\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">html</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfe931394185-8\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">body</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfe931394185-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-59600c03d2dfe931394185-10\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">body</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-59600c03d2dfe931394185-11\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">html</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n					</tr>\r\n				</table>\r\n			</div>\r\n		</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n\n</div>\n<p>Razor Pages 的页面必须具有 <code>@page</code> 标记。他们可能还会有一个 <code>*.cshtml.cs</code> 的 class 文件，对应的页面相关的一些代码，是不是很像 Web Form 呢？</p>\n<p>有同学可能会问了，没有 Controller 是怎么路由的呢？ 实际上，他们是通过文件夹物理路径的方式进行导航，比如：</p>\n<table>\n<thead>\n<tr>\n<th>文件名和路径</th>\n<th>匹配的URL</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>/Pages/Index.cshtml</td>\n<td><code>/</code> or <code>/Index</code></td>\n</tr>\n<tr>\n<td>/Pages/Contact.cshtml</td>\n<td><code>/Contact</code></td>\n</tr>\n<tr>\n<td>/Pages/Store/Contact.cshtml</td>\n<td><code>/Store/Contact</code></td>\n</tr>\n</tbody>\n</table>\n<p>有关 Razor Pages的更多信息可以看这里：<br>\n<a href=\"https://docs.microsoft.com/en-us/aspnet/core/razor-pages/\">https://docs.microsoft.com/en-us/aspnet/core/razor-pages</a></p>\n<h3 id=\"总结\">总结</h3>\n<p>可以看到，在 ASP.NET Core 2.0 中，给我们的开发过程带来了很多便利和帮助，他们包括 Program 等的改进，包括 MVC 相关 NuGet 包的集成，包括appsetting.json的服务器配置，以及令人惊讶的Razor Page，是不是已经迫不及待的期待正式版的发布呢？</p>\n</div>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111534\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111534votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111534\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/06/a691babb749ea56405877127a4d45736.png', 'full/e4f781fe9bcbb1b14511417240112232bbec89cd.jpg');
INSERT INTO `article` (`title`, `create_date`, `url`, `url_object_id`, `fav_nums`, `praise_nums`, `tag_list`, `content`, `front_image_url`, `front_image_path`) VALUES
('每个程序员都需要知道一些游戏网络知识', '2017-07-07', 'http://blog.jobbole.com/111711/', 'fac35b12c02fb27f44780851ac24f152', 2, 2, 'IT技术, 游戏开发', '<div class=\"entry\">\r\n\r\n        			<div class=\"textwidget\"></div>\n		\r\n		<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"http://gafferongames.com/networking-for-game-programmers/what-every-programmer-needs-to-know-about-game-networking/\">GLENN FIEDLER</a>   译文出处：<a target=\"_blank\" href=\"https://my.oschina.net/u/1859679/blog/911474\">wier</a>   </div><p>这是一篇翻译文章，主要针对游戏的网络设计，目前主流的网络游戏实现方案都有讲解，如果对英文更感兴趣，请查看原文地址，你若是觉得有翻译不妥的地方，欢迎留言指正。</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/07/c39de1bb884eaa81287bd08dab06403d.jpg\"><img class=\"aligncenter wp-image-111712 size-full\" src=\"http://jbcdn2.b0.upaiyun.com/2017/07/c39de1bb884eaa81287bd08dab06403d.jpg\" alt=\"084635_zdwT_1859679\" width=\"900\" height=\"500\"></a></p>\n<p>作为一个程序员，你有没有想象过多人游戏是如何实现的？</p>\n<p>在外行人看来游戏很神奇：两个或者更多的玩家在网络上分享共同的经历，就像他们真实的存在于相同的虚拟的世界一样。游戏看起来犹如一个巨大的魔术，奇妙而又刺激，但作为一个开发人员我们知道，真实的情况和我们所看到的并不一样，那只是一种错觉。你感受到的共享现实，实际上是在那个时刻内，由你自己的独特视角和位置所感知的近似情况。</p>\n<h1 id=\"h1_0\"><strong>Peer-to-Peer 帧同步</strong></h1>\n<p>最初的游戏是通过peer-to-peer来联网的，每个计算机通过网状拓扑的结构的彼此连接并交换信息。你仍然可以看到这种模型存在于RTS游戏中，而且基于某些原因它还很有趣，也许是因为它是大多数人认为游戏网络工作方式的第一种方式。</p>\n<p>处理游戏信息的基本思想就是把游戏的数据抽象并转换成一系列命令消息，当处理每个转换的时候就直接演变为游戏的状态。比如:移动单位、攻击物体、建造建筑。这一切都需要在线的每个玩家机器，从一个初始化命令开始之后，都运行完全相同的命令和转换数据。</p>\n<p>当然了，这只是一个过于简单的解释，同时也隐去了很多细节，不过我们通过这个基本的思路可以知道RTS游戏的网络是如何工作的。如果你想知道更多网络模型，请点击:<a href=\"http://www.gamasutra.com/view/feature/3094/1500_archers_on_a_288_network_.php\" target=\"_blank\" rel=\"nofollow\">1500 Archers on a 28.8: Network Programming in Age of Empires and Beyond</a>.</p>\n<p>这些看起来是如此简单和优雅，但不幸的它们有几个因素限制者我们。</p>\n<p>第一个限制，要保证游戏状态完全确定一致的是异常困难，特别是保持每台机器上每个转换输出都保持相同。比如，一个单位在两台机器上有略微不同的路径，在一台机器上早一些到达并开始了战斗，结果反败为胜，而在另一台机器上，由于稍微晚一些到达而失败。就像一只蝴蝶扇动了翅膀，然后在世界的另一边导致了飓风的出现，随着时间的推移，一个微小的区别就会导致两边完全的不同步。</p>\n<p>第二个限制，为了保证游戏的所有玩家输出一致，这就需要等到所有玩家的当前回合数据都到达之后才可以模拟播放这一回合动作。这就意味着游戏中的每一个玩家都需要等待网络延迟最高的那个玩家。RTS游戏通常代表性地通过立即提供音频反馈与（或是）播放吟唱（过渡）动画来掩盖这段延迟，但是最终真正影响游戏的动作要在这段延迟过去之后才能进行。</p>\n<p>第三个限制，因为游戏中状态改变的同步是通过发送命令信息来同步的。所以为了游戏中玩家状态都一致，需要所有的玩家都要从相同的初始状态来开始游戏。这意味着每个玩家必须在开始游戏之前先加入房间然后一起开始游戏，尽管理论上也可以支持让某些玩家晚些加入游戏，但是在一场进行中的游戏中获得一个完全确定的起始点的难度相当大，所以这种情况并不常见。</p>\n<p>尽管有这些因素限制困扰者我们，不过这个模型还是很适合RTS游戏的，并且它仍然存在于今天的游戏当中，例如“<strong>Command and Conquer</strong>”、“<strong>Age of Empires</strong>”与“<strong>Starcraft</strong>”等。原因就是在RTS游戏中，里面包含了上千多的单位，这些单位都有自己的状态需要同步，而且他们数据量都太大了，很难用来在玩家之间交换。别无选择，我们只能通过这些游戏状态改变的命令来同步。</p>\n<p>所以以上这些就是 peer-to-peer 帧同步的网路游戏模型的介绍了，对于其他类型的游戏，最先进的技术已经开始出现了。让我们现在从<strong>Doom</strong>, <strong>Quake </strong>以及 <strong>Unreal</strong>经典游戏中开始一起观察动作游戏的技术演化。</p>\n<h1 id=\"h1_1\"><strong>客户端/服务器（c/s架构）</strong></h1>\n<p>在动作游戏的时代，以上帧同步的限制在<strong>Doom </strong>游戏中变得更加明显，尽管在局域网中体验还不错，但在对于互联网的用户来说它体验太糟糕了：</p>\n<p>尽管可以使用一个猫（调制解调器）把两个<strong>Doom </strong>机器通过互联网连接在一起，但他们一起游戏会异常缓慢。范围从无法游戏（例如:14.4Kbps PPP 连接)到稍微可以玩(例如 ：28.8Kbps 猫运行一个被SLIP驱动压缩的数据)之间游戏联机都异常缓慢。由于这些连接方式只是边际效用，本文将仅关注直接的网络连接。</p>\n<p>这个问题是因为Doom网络部分本来就是只为局域网而设计的，并且使用了前面介绍的peer-to-peer 帧同步模型。每一回合每个玩家的输入的信息（比如关键按键等）都与其他人进行同步通知，并且任何玩家在播放这一帧动画之前，必须得等到所有其他玩家的关键按键信息都被接收到，才可以去模拟播放。</p>\n<p>也就是说，在你可以转身（转换），移动或者射击之前，你必须等待延迟最大的猫（调制调解器）玩家的输入。只是想想上述那个人所写的“这些连接方式只是边际效用”就会让人咬牙切齿和沮丧了。</p>\n<p>为了改变这种现状，只能在局域网以及大学网络和大型企业才能获得良好连接而进行游戏，是需要改变这种网络模型了。在1996年，这变成了现实并被实现了，John Carmack当时 发布雷神之锤，他采用客户端/服务器（C/S）架构代替了P2P模型。</p>\n<p>如今游戏中的玩家可以不必再运行相同的代码以及直接相互通信，每个玩家的机器是都是一个“客户端”，他们都通过一台叫做“服务器”的机器进行通信交互。游戏的最终状态确定不再依赖于每台客户端机器来共同确认，而是由服务器来确定最终结果。每个客户端如同一个哑终端，用来展示一个近似值的表演，真是的游戏状态是运行于服务器之上。</p>\n<p>在一个纯粹的c/s架构中，你不必在本地运行游戏代码，而是把一些例如按键、鼠标移动，点击等输入信息发送到服务器。服务器会在游戏世界中更新你的玩家状态，然后再封包一个包含你角色信息以及临近玩家数据的包回复给你的客户端。所有的客户端在每个消息更新的间隙做一个插值预测，以改善在每个状态更新期间，物体可以平滑的移动，如此，你就有一个可以联网的客户端/服务器架构的游戏了。</p>\n<p>这已经是向前迈出了极大的一步。游戏的体验依赖于客户端和服务器的连接，而不是游戏中延迟最大的那个玩家。如此可以支持玩家在游戏中自由的进入和退出，同时由于客户端/服务器降低了平均每位玩家的带宽，从而可以增加更多的在线玩家。</p>\n<p>但是这里仍然有一些问题存在于 c/s 架构中:</p>\n<p>我记得我交代了所有从DOO到Quake中关于网络的决策，但是重要的是我正在使用错误的假设来做一个好的网络游戏。我原先设计的目标是网络延迟&lt;200ｍs。人们通过一个好的网络供应商连接互联网，从而可以获得一个好的游戏体验。但事与愿违，世界上99%的用户使用猫(调制调解器)通过 slip或者ppp 进行连接，而他们常常都会通过槽糕而又拥挤的ISP。这会带来最低300+ms 的 网络延迟。一个消息要经过，客户端&gt;用户猫&gt;ISP猫&gt;服务器&gt;ISP猫&gt;用户猫&gt;客户端。上帝，这太逊了。</p>\n<p>OK,我做了一个错误的设定。我在家里使用T1 宽带，所以我只是不了解在PPP网络下的生活。我现在就解决它。</p>\n<p>这个问题当然是延迟。</p>\n<p>接下来John在他发布QuakeWorld的时候将改变这个行业。</p>\n<h1 id=\"h1_2\"><strong>客户端预测（<strong>Client-Side Prediction</strong>）</strong></h1>\n<p>在原来的Quake游戏中，你会感觉到电脑与服务器之间的延迟。比如，你按键向前移动，在你真正移动之前，你需要等到数据包发送服务器然后再回复到你的客户端，你才可以真正的移动。按键开火，在你的射击之前同样需要相同的等待。</p>\n<p>如果你玩过任何FPS游戏，比如:Modern Warfar,你会发现并没有延迟发生。那么fps游戏是如何做到在多人情况下，你的动作看起来并没有延迟？</p>\n<p>这个问题被分为两个部分来解决。第一个部分是客户端移动预测，这事John Carmack 为 QuakeWorld游戏多开发的，后来被合并到了Tim Sweeney的虚幻网络模块。第二个部分就是延迟补偿，它是有Valve公司的Yahn Bernier在Counterstrike所开发。那么在这个章节，我们把焦点放在第一部分——隐藏用户移动的延迟。</p>\n<p>当写到关于他即将发布的QuakeWorld计划的时候，John Carmack 讲到:</p>\n<p>我现在允许客户端可以预测用户的移动，直到服务器的权威信息回复之前。这是一个重大的结构变更。客户端需要知道关于对象的硬度、摩擦力、重力等一系列基础属性。我很伤心的看到，客户端仅作为一个终端存在将会离开，但作为一个实用主义者，我必须超越这种理想情怀。</p>\n<p>那么现在我们为了消除延迟，客户端需要运行更多的代码。它现在不再是一个只把输入发送给服务器然后再把返回信息进行插入的哑终端。现在客户端的机器可以运行一部分游戏代码，它可以在本地预测你的角色移动并且可以即时响应你的输入。</p>\n<p>现在当你即刻按键向前，你的游戏会立刻向前移动，不会再去等待数据往返一次客户端和服务器之间才来回应你的操作。</p>\n<p>这种方式的难点不在于预测，这种预测工作，就像正常的游戏代码一样 —— 根据玩家的输入，及时地更新游戏角色的状态。而难点在于，当客户端和服务器对于玩家角色所做的事情（动作）核检不一致的时候，客户端如何基于服务器信息进行更正。</p>\n<p>现在你会想，hey，如果代码运行在客户端——为何不以客户端的信息为准？客户端可以自己的为角色模拟运行代码，并且只需要在每次发送数据包时告知服务器这些信息。如果每个客户端都对服务器发送相同的信息，告诉服务器“这是我现在的位置信息”，那么将会带来这样的问题。客户端会很容易被黑客攻击并控制，这样在RPG游戏中，一个作弊便可以立即躲避对方技能击中，或者当你射击的时候瞬间移动到你的身后。</p>\n<p>所以在FPS游戏中，尽快每个玩家的客户端可以预测他们自己的角色进行操作移动，但最终每个玩家的角色状态绝对以服务器为准。就像Tim Sweeney 在所写的文章<a href=\"http://unreal.epicgames.com/Network.htm\" target=\"_blank\" rel=\"nofollow\">The Unreal Networking Architecture</a>中描述的一样：“服务器才是主人”。</p>\n<p>这就是有趣的地方。如果客户端和服务器产生了不一致，客户端必须基于服务器的信息为准并更新，但是由于客户端和服务器之前有延迟，服务器的修正必然是过去的动作。比如，如果信息从客户端到服务器耗时100ms，然后返回又耗时100ms，那么任何服务器的的修正都是客户端200ms之前的行为动作，这个时间正好是客户端预测角色移动的时间。</p>\n<p>如果客户端每个动作都会被服务器修正，那么你将会看客户端被拉回了原先的位置，如此客户端将做不了任何预先预测的运算。那么我们如何解决这个问题，依然可以保持客户端提前预测？</p>\n<p>解决方案就是在客户端创建一个buffer，然后用来循环保持角色的状态以及本来玩家的输入。当客户端收到了服务器的更正信息时候，它首先丢弃掉buffer里面比（服务器回复的）更正状态要老的状态信息，然后基于（更正的）正确的状态重放存储在buffer里面的输入信息，重发的这些输入信息的范围是从正确状态到当前预测时间之间。如此实际上，客户端只是看似无形中“倒带和重放”当地玩家角色运动的最后n帧，同时保持世界其他地方没有变化。</p>\n<p>这种方法可以让玩家感觉在控制游戏的时候没有延迟，同时也改善了客户端和服务器之间代码运行的一致性——在同等输入的情况下保持一致的结果。当然了，修正的情况很少发生，Tim Sweeney 如此描述:</p>\n<p>…对于客户端和服务器最好的是：所有情况下，服务器都是权威的。几乎所有的时间，客户端模拟的和服务器的数据都是一致，所以客户端的位置很少被修正。只有的少数罕见的情况下，例如一个玩家被火箭击中，或者和一个敌人（怪物）碰撞上，那么客户端本地的情况有可能需要被修正。</p>\n<p>也就是说，只有当玩家的角色被一些外部事件影响玩家的输入，并且这些不能被客户端预测时，玩家的位置（行为）需要被服务器修正。当然，如果玩家试图作弊，必然会被服务器修正。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111711\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111711votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111711\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n	</div>', 'http://jbcdn2.b0.upaiyun.com/2017/07/c39de1bb884eaa81287bd08dab06403d.jpg', 'full/41b4657e9821155bd3325ef1334ebce10189b7f6.jpg');

--
-- Indexes for dumped tables
--

--
-- Indexes for table `article`
--
ALTER TABLE `article`
  ADD PRIMARY KEY (`url_object_id`);

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
